<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="app-title-head">ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ (USD)</title>

  <!-- Chart.js í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¡œì»¬ íŒŒì¼) -->
  <script src="../scripts/chart.js"></script>
  <!-- chartjs-plugin-datalabels í”ŒëŸ¬ê·¸ì¸ (ë¡œì»¬ íŒŒì¼) -->
  <script src="../scripts/chartjs-plugin-datalabels.min.js"></script>

</head>
<body>
  <header class="app-header">
    <h1 id="app-title">ğŸ’° ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ (USD)</h1>
    <div class="language-selector-wrapper">
      <label for="language-select" class="sr-only" id="language-label">ì–¸ì–´ ì„ íƒ</label>
      <select id="language-select">
        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
      </select>
    </div>
  </header>

  <main>
    <div class="card">
      <h2 id="income-title">ì›”ê¸‰</h2>
      <label for="income" id="income-label">ì„¸ì „ ì›”ê¸‰ì•¡ ($)</label>
      <input type="number" id="income" placeholder="0">
    </div>

    <!-- Category Section Template -->
    <div class="card" data-category="taxes">
      <h2 id="tax-title">ì„¸ê¸ˆ</h2>
      <label for="taxes-type" id="tax-type-label">ì„¸ê¸ˆ ì¢…ë¥˜</label>
      <select id="taxes-type" class="category-select">
        <option value="" disabled selected id="tax-select-placeholder">ì„¸ê¸ˆ ì¢…ë¥˜ ì„ íƒ</option>
        <option value="federal_withholding">Federal Withholding</option>
        <option value="state_tax_ca">State Tax (CA)</option>
        <option value="oasdi_social_security">OASDI (Social Security)</option>
        <option value="medicare">Medicare</option>
        <option value="ca_sdi">CA SDI</option>
        <option value="custom" id="tax-option-custom">ì§ì ‘ ì…ë ¥</option>
      </select>
      <div class="category-input-container" style="display: none;">
        <input type="text" class="custom-name-input" placeholder="ì„¸ê¸ˆ í•­ëª©ëª… ì…ë ¥" style="display: none;">
        <input type="number" class="amount-input" placeholder="ê¸ˆì•¡ ($)">
        <button class="add-item-btn" id="tax-apply-button">ì ìš©</button>
      </div>
      <div class="item-list" id="taxes-list"></div>
    </div>

    <div class="card" data-category="preTax">
      <h2 id="pre-tax-title">ì„¸ì „ ê³µì œ</h2>
      <label for="preTax-type" id="pre-tax-type-label">ê³µì œ í•­ëª©</label>
      <select id="preTax-type" class="category-select">
        <option value="" disabled selected id="pre-tax-select-placeholder">ê³µì œ í•­ëª© ì„ íƒ</option>
        <option value="four_01k_traditional">401k Traditional</option>
        <option value="medical_premium">Medical Premium</option>
        <option value="dental_premium">Dental Premium</option>
        <option value="vision_premium">Vision Premium</option>
        <option value="mseap">MSEAP</option>
        <option value="custom" id="pre-tax-option-custom">ì§ì ‘ ì…ë ¥</option>
      </select>
      <div class="category-input-container" style="display: none;">
        <input type="text" class="custom-name-input" placeholder="ê³µì œ í•­ëª©ëª… ì…ë ¥" style="display: none;">
        <input type="number" class="amount-input" placeholder="ê¸ˆì•¡ ($)">
        <button class="add-item-btn" id="pre-tax-apply-button">ì ìš©</button>
      </div>
      <div class="item-list" id="preTax-list"></div>
    </div>

    <div class="card" data-category="postTax">
      <h2 id="post-tax-title">ì„¸í›„ ê³µì œ</h2>
      <label for="postTax-type" id="post-tax-type-label">ê³µì œ í•­ëª©</label>
      <select id="postTax-type" class="category-select">
        <option value="" disabled selected id="post-tax-select-placeholder">ê³µì œ í•­ëª© ì„ íƒ</option>
        <option value="four_01k_roth">401k Roth</option>
        <option value="legal_services">Legal Services</option>
        <option value="ltd">LTD</option>
        <option value="stock_purchase_plan">Stock Purchase Plan</option>
        <option value="ad_and_d">AD&D</option>
        <option value="critical_illness">Critical Illness</option>
        <option value="accident_insurance">Accident Insurance</option>
        <option value="custom" id="post-tax-option-custom">ì§ì ‘ ì…ë ¥</option>
      </select>
      <div class="category-input-container" style="display: none;">
        <input type="text" class="custom-name-input" placeholder="ê³µì œ í•­ëª©ëª… ì…ë ¥" style="display: none;">
        <input type="number" class="amount-input" placeholder="ê¸ˆì•¡ ($)">
        <button class="add-item-btn" id="post-tax-apply-button">ì ìš©</button>
      </div>
      <div class="item-list" id="postTax-list"></div>
    </div>

    <div class="card">
      <h2 id="expense-management-title">ì§€ì¶œ ê´€ë¦¬</h2>
      <div class="flex">
        <div style="flex: 1;">
          <label for="category" id="category-label">ì¹´í…Œê³ ë¦¬</label>
          <select id="category"></select>
        </div>
        <div style="flex: 2;">
          <label for="expense-name" id="expense-name-label">í•­ëª©ëª…</label>
          <input type="text" id="expense-name" placeholder="ì˜ˆ: ì›”ì„¸">
        </div>
        <div style="flex: 1;">
          <label for="expense-amount" id="expense-amount-label">ê¸ˆì•¡</label>
          <input type="number" id="expense-amount" placeholder="$">
        </div>
      </div>
      <div class="category-input-container">
          <label for="new-category" class="sr-only" id="new-category-label">ìƒˆ ì¹´í…Œê³ ë¦¬ëª…</label>
          <input type="text" id="new-category" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥" style="flex: 1;">
          <button id="add-category-button" style="flex-shrink: 0; width: auto;">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
      </div>
      <button id="add-expense-button" style="width: 100%; margin-top: 1rem;">ì§€ì¶œ ì¶”ê°€</button>
      <div class="item-list" id="expenses-list"></div>
    </div>

    <div class="card">
      <h2 id="monthly-financial-status-title">ğŸ“Š ì›”ë³„ ì¬ë¬´ í˜„í™©</h2>
      <div class="income-flow">
        <!-- Flow items will be dynamically updated by JS -->
      </div>
      <div class="summary-cards">
        <!-- Summary cards will be dynamically updated by JS -->
      </div>
    </div>

    <div class="card chart-container">
      <h2 id="financial-analysis-chart-title">ğŸ“ˆ ì¬ë¬´ ë¶„ì„ ì°¨íŠ¸</h2>
      <div class="charts-grid">
        <div>
          <h3 id="income-flow-chart-title">ìê¸ˆ íë¦„ ë°°ë¶„ (ì´ ìˆ˜ì… ëŒ€ë¹„)</h3>
          <canvas id="incomeFlowChart"></canvas>
        </div>
        <div>
          <h3 id="expense-category-chart-title">ì§€ì¶œ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘ (ì´ ì§€ì¶œ ëŒ€ë¹„)</h3>
          <canvas id="expenseCategoryChart"></canvas>
        </div>
      </div>
    </div>

    <div class="utility-buttons">
      <button class="utility-btn" id="save-button">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      <button class="utility-btn" id="load-button">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="utility-btn print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
      <button class="utility-btn" id="reset-button" style="background-color: var(--danger-color);">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let state = {
        language: 'ko',
        income: 0,
        taxes: [], // { id, name, amount }
        preTax: [],
        postTax: [],
        expenses: [], // { id, category, name, amount }
        expenseCategories: ['ì£¼ê±°', 'êµí†µ', 'ì‹ë¹„', 'ìƒí™œ', 'ì˜¤ë½', 'ê¸°íƒ€'],
      };

      // --- TRANSLATIONS (i18n) ---
      const translations = {
        ko: {
          'app-title': 'ğŸ’° ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ (USD)', 'income-title': 'ì›”ê¸‰', 'income-label': 'ì„¸ì „ ì›”ê¸‰ì•¡ ($)', 'tax-title': 'ì„¸ê¸ˆ', 'tax-type-label': 'ì„¸ê¸ˆ ì¢…ë¥˜', 'tax-select-placeholder': 'ì„¸ê¸ˆ ì¢…ë¥˜ ì„ íƒ', 'tax-option-custom': 'ì§ì ‘ ì…ë ¥', 'tax-custom-name-placeholder': 'ì„¸ê¸ˆ í•­ëª©ëª… ì…ë ¥', 'tax-apply-button': 'ì ìš©', 'pre-tax-title': 'ì„¸ì „ ê³µì œ', 'pre-tax-type-label': 'ê³µì œ í•­ëª©', 'pre-tax-select-placeholder': 'ê³µì œ í•­ëª© ì„ íƒ', 'pre-tax-option-custom': 'ì§ì ‘ ì…ë ¥', 'pre-tax-custom-name-placeholder': 'ê³µì œ í•­ëª©ëª… ì…ë ¥', 'pre-tax-apply-button': 'ì ìš©', 'post-tax-title': 'ì„¸í›„ ê³µì œ', 'post-tax-type-label': 'ê³µì œ í•­ëª©', 'post-tax-select-placeholder': 'ê³µì œ í•­ëª© ì„ íƒ', 'post-tax-option-custom': 'ì§ì ‘ ì…ë ¥', 'post-tax-custom-name-placeholder': 'ê³µì œ í•­ëª©ëª… ì…ë ¥', 'post-tax-apply-button': 'ì ìš©', 'expense-management-title': 'ì§€ì¶œ ê´€ë¦¬', 'category-label': 'ì¹´í…Œê³ ë¦¬', 'expense-name-label': 'í•­ëª©ëª…', 'expense-name-placeholder': 'ì˜ˆ: ì›”ì„¸', 'expense-amount-label': 'ê¸ˆì•¡', 'new-category-label': 'ìƒˆ ì¹´í…Œê³ ë¦¬ëª…', 'new-category-placeholder': 'ìƒˆ ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥', 'add-category-button': 'ì¹´í…Œê³ ë¦¬ ì¶”ê°€', 'add-expense-button': 'ì§€ì¶œ ì¶”ê°€', 'monthly-financial-status-title': 'ğŸ“Š ì›”ë³„ ì¬ë¬´ í˜„í™©', 'financial-analysis-chart-title': 'ğŸ“ˆ ì¬ë¬´ ë¶„ì„ ì°¨íŠ¸', 'income-flow-chart-title': 'ìê¸ˆ íë¦„ ë°°ë¶„ (ì´ ìˆ˜ì… ëŒ€ë¹„)', 'expense-category-chart-title': 'ì§€ì¶œ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘ (ì´ ì§€ì¶œ ëŒ€ë¹„)', 'save-button': 'ğŸ’¾ ì €ì¥í•˜ê¸°', 'load-button': 'ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°', 'print-button': 'ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°', 'reset-button': 'ğŸ”„ ì´ˆê¸°í™”',
           gross_income_label: "ì„¸ì „ ì›”ê¸‰ (ì´ ìˆ˜ì…)", pre_tax_deductions_label: "ì„¸ì „ ê³µì œ", taxable_income_label: "ê³¼ì„¸ ì†Œë“", tax_total_label: "ì„¸ê¸ˆ", post_tax_deductions_label: "ì„¸í›„ ê³µì œ", total_deductions_taxes_label: "ì´ ê³µì œ ë° ì„¸ê¸ˆ", net_income_label: "ìˆœìˆ˜ì… (ì‹¤ìˆ˜ë ¹ì•¡)", total_expenses_card_label: "ì´ ì§€ì¶œ", total_expenses_card_sub: "(ìˆœìˆ˜ì…ì—ì„œ ì‚¬ìš©)", remaining_balance_card_label: "ë‚¨ì€ ì”ì•¡", remaining_balance_card_sub: "(ì €ì¶•/íˆ¬ì ê°€ëŠ¥)", expenses_percentage_text: "ì´ ìˆ˜ì…ì˜", remaining_percentage_text: "ì´ ìˆ˜ì…ì˜",
        },
        en: {
          'app-title': 'ğŸ’° Budget Management System (USD)', 'income-title': 'Salary', 'income-label': 'Gross Monthly Salary ($)', 'tax-title': 'Taxes', 'tax-type-label': 'Tax Type', 'tax-select-placeholder': 'Select tax type', 'tax-option-custom': 'Custom', 'tax-custom-name-placeholder': 'Enter tax name', 'tax-apply-button': 'Apply', 'pre-tax-title': 'Pre-Tax Deductions', 'pre-tax-type-label': 'Deduction Item', 'pre-tax-select-placeholder': 'Select deduction', 'pre-tax-option-custom': 'Custom', 'pre-tax-custom-name-placeholder': 'Enter deduction name', 'pre-tax-apply-button': 'Apply', 'post-tax-title': 'Post-Tax Deductions', 'post-tax-type-label': 'Deduction Item', 'post-tax-select-placeholder': 'Select deduction', 'post-tax-option-custom': 'Custom', 'post-tax-custom-name-placeholder': 'Enter deduction name', 'post-tax-apply-button': 'Apply', 'expense-management-title': 'Expense Management', 'category-label': 'Category', 'expense-name-label': 'Item Name', 'expense-name-placeholder': 'e.g., Rent', 'expense-amount-label': 'Amount', 'new-category-label': 'New Category Name', 'new-category-placeholder': 'Enter new category name', 'add-category-button': 'Add Category', 'add-expense-button': 'Add Expense', 'monthly-financial-status-title': 'ğŸ“Š Monthly Financial Status', 'financial-analysis-chart-title': 'ğŸ“ˆ Financial Analysis Charts', 'income-flow-chart-title': 'Fund Flow Distribution (vs. Gross Income)', 'expense-category-chart-title': 'Expense Breakdown by Category (vs. Total Expenses)', 'save-button': 'ğŸ’¾ Save', 'load-button': 'ğŸ“‚ Load', 'print-button': 'ğŸ–¨ï¸ Print', 'reset-button': 'ğŸ”„ Reset',
           gross_income_label: "Gross Salary (Total Income)", pre_tax_deductions_label: "Pre-Tax Deductions", taxable_income_label: "Taxable Income", tax_total_label: "Taxes", post_tax_deductions_label: "Post-Tax Deductions", total_deductions_taxes_label: "Total Deductions & Taxes", net_income_label: "Net Income (Take-Home Pay)", total_expenses_card_label: "Total Expenses", total_expenses_card_sub: "(spent from Net Income)", remaining_balance_card_label: "Remaining Balance", remaining_balance_card_sub: "(for Savings/Investments)", expenses_percentage_text: "of Gross Income", remaining_percentage_text: "of Gross Income",
        },
        zh: {
          'app-title': 'ğŸ’° é¢„ç®—ç®¡ç†ç³»ç»Ÿ (USD)', 'income-title': 'è–ªæ°´', 'income-label': 'ç¨å‰æœˆè–ª ($)', 'tax-title': 'ç¨æ¬¾', 'tax-type-label': 'ç¨ç§', 'tax-select-placeholder': 'é€‰æ‹©ç¨ç§', 'tax-option-custom': 'è‡ªå®šä¹‰', 'tax-custom-name-placeholder': 'è¾“å…¥ç¨é¡¹åç§°', 'tax-apply-button': 'åº”ç”¨', 'pre-tax-title': 'ç¨å‰æ‰£é™¤', 'pre-tax-type-label': 'æ‰£é™¤é¡¹ç›®', 'pre-tax-select-placeholder': 'é€‰æ‹©æ‰£é™¤é¡¹ç›®', 'pre-tax-option-custom': 'è‡ªå®šä¹‰', 'pre-tax-custom-name-placeholder': 'è¾“å…¥æ‰£é™¤åç§°', 'pre-tax-apply-button': 'åº”ç”¨', 'post-tax-title': 'ç¨åæ‰£é™¤', 'post-tax-type-label': 'æ‰£é™¤é¡¹ç›®', 'post-tax-select-placeholder': 'é€‰æ‹©æ‰£é™¤é¡¹ç›®', 'post-tax-option-custom': 'è‡ªå®šä¹‰', 'post-tax-custom-name-placeholder': 'è¾“å…¥æ‰£é™¤åç§°', 'post-tax-apply-button': 'åº”ç”¨', 'expense-management-title': 'æ”¯å‡ºç®¡ç†', 'category-label': 'ç±»åˆ«', 'expense-name-label': 'é¡¹ç›®åç§°', 'expense-name-placeholder': 'ä¾‹å¦‚ï¼šæˆ¿ç§Ÿ', 'expense-amount-label': 'é‡‘é¢', 'new-category-label': 'æ–°ç±»åˆ«åç§°', 'new-category-placeholder': 'è¾“å…¥æ–°ç±»åˆ«åç§°', 'add-category-button': 'æ·»åŠ ç±»åˆ«', 'add-expense-button': 'æ·»åŠ æ”¯å‡º', 'monthly-financial-status-title': 'ğŸ“Š æ¯æœˆè´¢åŠ¡çŠ¶å†µ', 'financial-analysis-chart-title': 'ğŸ“ˆ è´¢åŠ¡åˆ†æå›¾è¡¨', 'income-flow-chart-title': 'èµ„é‡‘æµåˆ†é… (ä¸æ€»æ”¶å…¥ç›¸æ¯”)', 'expense-category-chart-title': 'æŒ‰ç±»åˆ«åˆ’åˆ†çš„æ”¯å‡ºæ˜ç»† (ä¸æ€»æ”¯å‡ºç›¸æ¯”)', 'save-button': 'ğŸ’¾ ä¿å­˜', 'load-button': 'ğŸ“‚ åŠ è½½', 'print-button': 'ğŸ–¨ï¸ æ‰“å°', 'reset-button': 'ğŸ”„ é‡ç½®',
           gross_income_label: "æ€»è–ªæ°´ (æ€»æ”¶å…¥)", pre_tax_deductions_label: "ç¨å‰æ‰£é™¤", taxable_income_label: "åº”ç¨æ”¶å…¥", tax_total_label: "ç¨æ¬¾", post_tax_deductions_label: "ç¨åæ‰£é™¤", total_deductions_taxes_label: "æ€»æ‰£é™¤å’Œç¨æ¬¾", net_income_label: "å‡€æ”¶å…¥ (å®å¾—å·¥èµ„)", total_expenses_card_label: "æ€»æ”¯å‡º", total_expenses_card_sub: "(ä»å‡€æ”¶å…¥ä¸­æ”¯å‡º)", remaining_balance_card_label: "å‰©ä½™ä½™é¢", remaining_balance_card_sub: "(ç”¨äºå‚¨è“„/æŠ•èµ„)", expenses_percentage_text: "æ€»æ”¶å…¥çš„", remaining_percentage_text: "æ€»æ”¶å…¥çš„",
        },
      };

      // --- DOM SELECTORS ---
      const incomeInput = document.getElementById('income');
      const langSelect = document.getElementById('language-select');
      const categorySections = document.querySelectorAll('.card[data-category]');
      const addCategoryBtn = document.getElementById('add-category-button');
      const newCategoryInput = document.getElementById('new-category');
      const expenseCategorySelect = document.getElementById('category');
      const addExpenseBtn = document.getElementById('add-expense-button');
      const expenseNameInput = document.getElementById('expense-name');
      const expenseAmountInput = document.getElementById('expense-amount');
      const expensesListContainer = document.getElementById('expenses-list');

      // --- UTILITY FUNCTIONS ---
      const formatCurrency = (amount) => amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      // --- TRANSLATION FUNCTION ---
      const setLanguage = (lang) => {
          state.language = lang;
          const t = translations[lang];
          document.querySelectorAll('[id]').forEach(el => {
              const key = el.id.replace(/-label|-title|-button|-placeholder|-text|-sub|-card/g, '');
              if (t[key]) {
                  if (el.placeholder) el.placeholder = t[key];
                  else if (el.tagName === 'OPTION') el.textContent = t[key];
                  else el.innerHTML = t[key];
              }
          });
          document.documentElement.lang = lang.split('-')[0];
          // Update dynamic text
          fullUpdate();
      };
      
      // --- RENDER FUNCTIONS ---
      const renderCategorizedList = (category) => {
        const listContainer = document.getElementById(`${category}-list`);
        listContainer.innerHTML = '';
        state[category].forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'item';
          itemDiv.innerHTML = `
            <span class="item-name">${item.name}</span>
            <div class="flex items-center gap-2">
                <span class="item-amount">-$${formatCurrency(item.amount)}</span>
                <button class="item-delete-btn" data-id="${item.id}" data-category="${category}">X</button>
            </div>
          `;
          listContainer.appendChild(itemDiv);
        });
      };

      const renderExpenseCategories = () => {
        expenseCategorySelect.innerHTML = '';
        state.expenseCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          expenseCategorySelect.appendChild(option);
        });
      };

      const renderExpensesList = () => {
        expensesListContainer.innerHTML = '';
        state.expenses.forEach(exp => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'item';
          itemDiv.innerHTML = `
             <span class="item-name">${exp.category}: ${exp.name}</span>
             <div class="flex items-center gap-2">
                <span class="item-amount">-$${formatCurrency(exp.amount)}</span>
                <button class="item-delete-btn" data-id="${exp.id}" data-category="expenses">X</button>
            </div>
          `;
          expensesListContainer.appendChild(itemDiv);
        });
      };

      // --- CALCULATE & UPDATE SUMMARY ---
      const calculateAndUpdateAll = () => {
        const t = translations[state.language];
        const income = state.income || 0;

        const preTaxDeductions = state.preTax.reduce((sum, item) => sum + item.amount, 0);
        const taxableIncome = income - preTaxDeductions;
        const taxTotal = state.taxes.reduce((sum, item) => sum + item.amount, 0);
        const postTaxDeductions = state.postTax.reduce((sum, item) => sum + item.amount, 0);
        const totalDeductionsAndTaxes = preTaxDeductions + taxTotal + postTaxDeductions;
        const netIncome = income - totalDeductionsAndTaxes;
        const expensesTotal = state.expenses.reduce((sum, item) => sum + item.amount, 0);
        const remainingBalance = netIncome - expensesTotal;

        // Render Income Flow
        const incomeFlowContainer = document.querySelector('.income-flow');
        incomeFlowContainer.innerHTML = `
          <div class="flow-item"><span class="flow-label">${t.gross_income_label}</span> <span class="flow-amount">$${formatCurrency(income)} <em class="percentage highlighted-percentage">(100.0%)</em></span></div>
          <div class="flow-arrow">â†“</div>
          <div class="flow-item highlighted"><span class="flow-label">${t.pre_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(preTaxDeductions)} <em class="percentage highlighted-percentage">(${(preTaxDeductions / income * 100 || 0).toFixed(1)}%)</em></span></div>
          <div class="flow-arrow">â†“</div>
          <div class="flow-item"><span class="flow-label"><strong>${t.taxable_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(taxableIncome)} <em class="percentage highlighted-percentage">(${(taxableIncome / income * 100 || 0).toFixed(1)}%)</em></span></div>
          <div class="flow-arrow">â†“</div>
          <div class="flow-item highlighted"><span class="flow-label">${t.tax_total_label}</span> <span class="flow-amount">-$${formatCurrency(taxTotal)} <em class="percentage highlighted-percentage">(${(taxTotal / income * 100 || 0).toFixed(1)}%)</em></span></div>
          <div class="flow-arrow">â†“</div>
          <div class="flow-item highlighted"><span class="flow-label">${t.post_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(postTaxDeductions)} <em class="percentage highlighted-percentage">(${(postTaxDeductions / income * 100 || 0).toFixed(1)}%)</em></span></div>
          <div class="flow-arrow">â†“</div>
           <div class="flow-item info"><span class="flow-label"><strong>${t.total_deductions_taxes_label}</strong></span> <span class="flow-amount">-$${formatCurrency(totalDeductionsAndTaxes)} <em class="percentage highlighted-percentage">(${(totalDeductionsAndTaxes / income * 100 || 0).toFixed(1)}%)</em></span></div>
          <div class="flow-arrow">â†“</div>
          <div class="flow-item result"><span class="flow-label"><strong>${t.net_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(netIncome)} <em class="percentage highlighted-percentage">(${(netIncome / income * 100 || 0).toFixed(1)}%)</em></span></div>
        `;

        // Render Summary Cards
        const summaryCardsContainer = document.querySelector('.summary-cards');
        summaryCardsContainer.innerHTML = `
          <div class="summary-card">
            <div class="card-label">${t.total_expenses_card_label}</div>
            <div class="card-amount negative">$${formatCurrency(expensesTotal)}</div>
            <div class="card-sub">${t.total_expenses_card_sub}</div>
            <div class="card-percentage">${t.expenses_percentage_text} <span class="highlighted-percentage">${(expensesTotal / income * 100 || 0).toFixed(1)}%</span></div>
          </div>
          <div class="summary-card accent">
            <div class="card-label">${t.remaining_balance_card_label}</div>
            <div class="card-amount ${remainingBalance < 0 ? 'negative' : ''}">$${formatCurrency(remainingBalance)}</div>
            <div class="card-sub">${t.remaining_balance_card_sub}</div>
            <div class="card-percentage">${t.remaining_percentage_text} <span class="highlighted-percentage">${(remainingBalance / income * 100 || 0).toFixed(1)}%</span></div>
          </div>
        `;

        // Update Charts
        updateCharts({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions, expensesTotal, remainingBalance });
      };

      // --- CHARTING ---
      let incomeFlowChart, expenseCategoryChart;
      const updateCharts = ({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions, expensesTotal, remainingBalance }) => {
        const income = state.income || 0;
        if (income === 0) { // Clear charts if no income
            if (incomeFlowChart) incomeFlowChart.destroy();
            if (expenseCategoryChart) expenseCategoryChart.destroy();
            return;
        }

        const incomeFlowCtx = document.getElementById('incomeFlowChart').getContext('2d');
        const expenseCategoryCtx = document.getElementById('expenseCategoryChart').getContext('2d');

        const otherDeductions = preTaxDeductions + postTaxDeductions;
        const actualNet = income - taxTotal - otherDeductions;
        
        if (incomeFlowChart) incomeFlowChart.destroy();
        incomeFlowChart = new Chart(incomeFlowCtx, {
          type: 'doughnut',
          data: {
            labels: ['Net Income', 'Taxes', 'Other Deductions'],
            datasets: [{
              data: [actualNet > 0 ? actualNet : 0, taxTotal, otherDeductions],
              backgroundColor: ['#7ed321', '#d0021b', '#f5a623'],
            }]
          },
          options: {
             responsive: true,
             plugins: {
                legend: { position: 'top' },
                datalabels: {
                   formatter: (value, ctx) => {
                      let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                      let percentage = (value * 100 / sum).toFixed(1) + '%';
                      return percentage;
                   },
                   color: '#fff',
                }
             }
          },
           plugins: [ChartDataLabels],
        });
        
        const expenseData = state.expenseCategories.map(cat => {
            return state.expenses
                .filter(exp => exp.category === cat)
                .reduce((sum, exp) => sum + exp.amount, 0);
        });

        if (expenseCategoryChart) expenseCategoryChart.destroy();
        expenseCategoryChart = new Chart(expenseCategoryCtx, {
          type: 'pie',
          data: {
            labels: state.expenseCategories,
            datasets: [{
              data: expenseData,
              backgroundColor: ['#4a90e2', '#50e3c2', '#f5a623', '#bd10e0', '#b8e986', '#7ed321', '#4a4a4a']
            }]
          },
          options: {
             responsive: true,
             plugins: {
                legend: { position: 'top' },
                datalabels: {
                   formatter: (value, ctx) => {
                      let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                      if (sum === 0) return '0%';
                      let percentage = (value * 100 / sum).toFixed(1) + '%';
                      return percentage;
                   },
                   color: '#fff',
                }
             }
          },
           plugins: [ChartDataLabels],
        });
      };
      
      const fullUpdate = () => {
        renderExpenseCategories();
        renderExpensesList();
        renderCategorizedList('taxes');
        renderCategorizedList('preTax');
        renderCategorizedList('postTax');
        calculateAndUpdateAll();
      };

      // --- EVENT HANDLERS ---
      incomeInput.addEventListener('input', (e) => {
        state.income = parseFloat(e.target.value) || 0;
        calculateAndUpdateAll();
      });

      categorySections.forEach(section => {
        const category = section.dataset.category;
        const select = section.querySelector('.category-select');
        const inputContainer = section.querySelector('.category-input-container');
        const customNameInput = section.querySelector('.custom-name-input');
        const amountInput = section.querySelector('.amount-input');
        const addButton = section.querySelector('.add-item-btn');

        select.addEventListener('change', () => {
          if (select.value) {
            inputContainer.style.display = 'flex';
            customNameInput.style.display = select.value === 'custom' ? 'block' : 'none';
            if (select.value === 'custom') {
              customNameInput.focus();
            } else {
              amountInput.focus();
            }
          } else {
            inputContainer.style.display = 'none';
          }
        });
        
        addButton.addEventListener('click', () => {
          const amount = parseFloat(amountInput.value);
          if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount.');
            return;
          }
          
          let name;
          if (select.value === 'custom') {
            name = customNameInput.value.trim();
            if (!name) {
              alert('Please enter a name for the custom item.');
              return;
            }
          } else {
            name = select.options[select.selectedIndex].text;
          }
          
          // Check for duplicates
          if(state[category].some(item => item.name.toLowerCase() === name.toLowerCase())) {
            alert(`'${name}' already exists in this category.`);
            return;
          }

          state[category].push({ id: generateId(), name, amount });
          
          // Reset fields
          amountInput.value = '';
          customNameInput.value = '';
          select.value = '';
          inputContainer.style.display = 'none';
          
          renderCategorizedList(category);
          calculateAndUpdateAll();
        });
      });
      
      document.body.addEventListener('click', (e) => {
        if (e.target.classList.contains('item-delete-btn')) {
            const { id, category } = e.target.dataset;
            state[category] = state[category].filter(item => item.id !== id);
            fullUpdate();
        }
      });

      addCategoryBtn.addEventListener('click', () => {
        const newCategory = newCategoryInput.value.trim();
        if (newCategory && !state.expenseCategories.includes(newCategory)) {
          state.expenseCategories.push(newCategory);
          newCategoryInput.value = '';
          renderExpenseCategories();
        } else if (state.expenseCategories.includes(newCategory)) {
          alert('Category already exists.');
        }
      });
      
      addExpenseBtn.addEventListener('click', () => {
          const category = expenseCategorySelect.value;
          const name = expenseNameInput.value.trim();
          const amount = parseFloat(expenseAmountInput.value);

          if (!category || !name || isNaN(amount) || amount <= 0) {
              alert('Please fill all expense fields with valid data.');
              return;
          }
          
          state.expenses.push({ id: generateId(), category, name, amount });

          expenseNameInput.value = '';
          expenseAmountInput.value = '';
          
          renderExpensesList();
          calculateAndUpdateAll();
      });
      
      // Language and data persistence buttons
      langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

      document.getElementById('save-button').addEventListener('click', () => {
        try {
          localStorage.setItem('budgetAppData', JSON.stringify(state));
          alert('Data saved successfully!');
        } catch (error) {
          console.error('Failed to save data:', error);
          alert('Failed to save data. Local storage might be full or disabled.');
        }
      });

      document.getElementById('load-button').addEventListener('click', () => {
        const savedData = localStorage.getItem('budgetAppData');
        if (savedData) {
          try {
            const loadedState = JSON.parse(savedData);
            // Simple merge to avoid breaking app with old data structures
             Object.assign(state, loadedState);
            // Re-populate inputs from loaded state
            incomeInput.value = state.income;
            langSelect.value = state.language;
            setLanguage(state.language); // this will trigger a full update
            alert('Data loaded successfully!');
          } catch(error) {
            console.error('Failed to parse saved data:', error);
            alert('Failed to load data. It might be corrupted.');
          }
        } else {
          alert('No saved data found.');
        }
      });
      
      document.getElementById('reset-button').addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
            localStorage.removeItem('budgetAppData');
            // Re-initialize state to default
            state = {
                language: state.language, // Keep language setting
                income: 0,
                taxes: [], preTax: [], postTax: [],
                expenses: [],
                expenseCategories: ['ì£¼ê±°', 'êµí†µ', 'ì‹ë¹„', 'ìƒí™œ', 'ì˜¤ë½', 'ê¸°íƒ€'],
            };
            incomeInput.value = '';
            setLanguage(state.language); // This triggers a full refresh
            alert('Data has been reset.');
        }
      });
      
      // --- INITIALIZATION ---
      const savedLang = localStorage.getItem('budgetAppLang');
      if (savedLang) {
          langSelect.value = savedLang;
          setLanguage(savedLang);
      } else {
          setLanguage('ko');
      }

    });
  </script>
</body>
</html>
