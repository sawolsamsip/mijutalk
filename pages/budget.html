<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title-head">Kuatiañe'ẽ Rerekuaha Mba'ehetave rehegua (USD)</title>

    <!-- Chart.js oĩva'ekue (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- chartjs-plugin-datalabels tembipuru (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- CSS oñemonguatia'ỹva ojeguerojerovia hag̃ua -->
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #F44336;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --card-bg: #fff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .app-header {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Tembipuru ojejapo hag̃ua pantalla michĩvévape */
        }

        .app-header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
            flex-grow: 1; /* Tembipuru réra oheja hag̃ua oñemoguyrukuere */
        }

        .language-selector-wrapper {
            margin-left: 20px; /* Tembipuru réra rendaha */
        }

        #language-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            font-size: 1rem;
            cursor: pointer;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .card label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Ojoaju hag̃ua oñemonguatia'ỹvape */
            color: var(--text-color);
        }

        .card input[type="number"],
        .card input[type="text"],
        .card select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box; /* Oñemoĩve hag̃ua padding width-pe */
            color: var(--text-color);
            background-color: var(--light-bg);
        }

        .card input[type="number"]:focus,
        .card input[type="text"]:focus,
        .card select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .flex {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Tembipuru ojejapo hag̃ua */
        }

        .flex > div {
            flex: 1; /* Oñemomýi hag̃ua hekopete */
            min-width: 120px; /* Ancho mínimo para elementos flexibles */
        }

        .category-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .category-input-container input[type="text"],
        .category-input-container input[type="number"] {
            flex: 1;
            min-width: 100px; /* Oñemonguatia'ỹva nomichĩri hag̃ua hetave */
        }

        .category-input-container button {
            flex-shrink: 0; /* Ñanduti nome'ẽi hag̃ua */
            width: auto;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-input-container button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .category-input-container button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Ñanduti apañuái vorekuérape g̃uarã */
        .add-item-btn,
        .update-item-btn,
        .cancel-item-btn {
            flex-grow: 1;
            max-width: 120px; /* Ñanduti anchura ypykuérape g̃uarã */
        }

        .update-item-btn {
            background-color: var(--secondary-color) !important; /* Ñanduti apañuái */
        }
        .update-item-btn:hover {
            background-color: #1976d2 !important;
        }

        .cancel-item-btn {
            background-color: #6c757d !important; /* Ñanduti apañuái */
        }
        .cancel-item-btn:hover {
            background-color: #5a6268 !important;
        }

        .hidden {
            display: none !important; /* Ñanduti oñembotapykueva'erã */
        }

        .item-list {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: bold;
            flex-grow: 1;
            margin-right: 10px;
        }

        .item-amount {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap; /* Nomichĩri hag̃ua mba'ehetave */
        }

        .item-edit-btn,
        .item-delete-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .item-edit-btn {
            color: var(--secondary-color);
        }
        .item-edit-btn:hover {
            background-color: rgba(33, 150, 243, 0.1);
        }

        .item-delete-btn {
            color: var(--danger-color);
        }
        .item-delete-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        /* Mba'ehetave */
        .income-flow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
        }

        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 8px;
            background-color: var(--light-bg);
            align-items: center;
        }

        .flow-item.highlighted {
            background-color: #fce8d2; /* Ñanduti jepy'apy */
        }

        .flow-item.info {
            background-color: #e3f2fd; /* Ñanduti marandu */
            border-left: 4px solid var(--secondary-color);
        }

        .flow-item.result {
            background-color: #d4edda; /* Ñanduti mba'ehetave */
            border-left: 4px solid var(--primary-color);
            font-size: 1.1em;
            font-weight: bold;
        }

        .flow-arrow {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
        }

        .flow-label {
            font-weight: bold;
        }

        .flow-amount {
            white-space: nowrap;
        }

        .percentage {
            font-size: 0.9em;
            color: #666;
            margin-left: 5px;
        }

        .highlighted-percentage {
            color: var(--danger-color); /* Ñanduti jepy'apy */
        }
        .flow-item.result .highlighted-percentage {
            color: var(--primary-color); /* Ñanduti mba'ehetave */
        }


        /* Ñanduti vorekuéra */
        .summary-cards {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 5px solid var(--primary-color); /* Ñanduti */
        }

        .summary-card.accent {
            border-color: var(--accent-color);
        }

        .card-label {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        .card-amount {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .card-amount.negative {
            color: var(--danger-color);
        }

        .card-sub {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .card-percentage {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: bold;
        }

        /* Ta'anga */
        .chart-container {
            padding-bottom: 40px; /* Ta'anga jeroviaha */
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr; /* Ta'anga michĩva */
            gap: 30px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr; /* Ta'anga tuicháva */
            }
        }

        .charts-grid > div {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .charts-grid h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Ñanduti rembiapo */
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .utility-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .utility-btn:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
        }

        .utility-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .utility-btn.print {
            background-color: #607d8b;
        }
        .utility-btn.print:hover {
            background-color: #455a64;
        }

        .utility-btn[style*="background-color: var(--danger-color);"] {
            background-color: var(--danger-color);
        }
        .utility-btn[style*="background-color: var(--danger-color);"]:hover {
            background-color: #d32f2f;
        }


        /* Modal apañuái */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            max-width: 400px;
            width: 90%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: scaleIn 0.3s ease-out forwards;
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--text-color);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-button.alert-ok {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-button.alert-ok:hover {
            background-color: #45a049;
        }

        .modal-button.confirm-yes {
            background-color: var(--danger-color);
            color: white;
        }
        .modal-button.confirm-yes:hover {
            background-color: #d32f2f;
        }

        .modal-button.confirm-no {
            background-color: #6c757d;
            color: white;
        }
        .modal-button.confirm-no:hover {
            background-color: #5a6268;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Accessibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Mba'ehetave rerekuaha */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .language-selector-wrapper {
                margin-left: 0;
                width: 100%;
            }
            
            #language-select {
                width: 100%;
            }

            .flex,
            .category-input-container,
            .summary-cards,
            .utility-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .flex > div,
            .category-input-container input,
            .category-input-container button,
            .summary-card,
            .utility-btn {
                width: 100%;
                min-width: unset;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 id="app-title">💰 Kuatiañe'ẽ Rerekuaha Mba'ehetave (USD)</h1>
        <div class="language-selector-wrapper">
            <label for="language-select" class="sr-only" id="language-label">Ñe'ẽ Jeporu</label>
            <select id="language-select">
                <option value="ko">🇰🇷 Koreano</option>
                <option value="en">🇺🇸 Inglés</option>
                <option value="zh">🇨🇳 Chino Sencillo</option>
            </select>
        </div>
    </header>

    <main>
        <div class="card">
            <h2 id="income-title">Sueldo Jasykue</h2>
            <label for="income" id="income-label">Sueldo Jasykue (USD)</label>
            <input type="number" id="income" placeholder="0">
        </div>

        <!-- Tembipuru Vore -->
        <div class="card" data-category="taxes">
            <h2 id="tax-title">Impuesto</h2>
            <label for="taxes-type" id="tax-type-label">Impuesto Renda</label>
            <select id="taxes-type" class="category-select">
                <option value="" disabled selected id="tax-select-placeholder">Eiporavo Impuesto Renda</option>
                <option value="federal_withholding">Federal Withholding</option>
                <option value="state_tax_ca">Estado Impuesto (CA)</option>
                <option value="oasdi_social_security">OASDI (Seguridad Social)</option>
                <option value="medicare">Medicare</option>
                <option value="ca_sdi">CA SDI</option>
                <option value="custom" id="tax-option-custom">Eiporavo Ñandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Impuesto Renda" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="tax-add-button">Toañadí</button>
            </div>
            <div class="item-list" id="taxes-list"></div>
        </div>

        <!-- Tembipuru Ñanduti Vore -->
        <div class="card" data-category="preTax">
            <h2 id="pre-tax-title">Impuesto Ñanduti</h2>
            <label for="preTax-type" id="pre-tax-type-label">Tembipuru Ñanduti</label>
            <select id="preTax-type" class="category-select">
                <option value="" disabled selected id="pre-tax-select-placeholder">Eiporavo Tembipuru Ñanduti</option>
                <option value="four_01k_traditional">401k Tradicional</option>
                <option value="medical_premium">Médico Seguro</option>
                <option value="dental_premium">Dental Seguro</option>
                <option value="vision_premium">Visión Seguro</option>
                <option value="mseap">MSEAP</option>
                <option value="custom" id="pre-tax-option-custom">Eiporavo Ñandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Tembipuru Ñanduti" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="pre-tax-add-button">Toañadí</button>
            </div>
            <div class="item-list" id="preTax-list"></div>
        </div>

        <!-- Tembipuru Arakatupy Vore -->
        <div class="card" data-category="postTax">
            <h2 id="post-tax-title">Impuesto Arakatupy</h2>
            <label for="postTax-type" id="post-tax-type-label">Tembipuru Arakatupy</label>
            <select id="postTax-type" class="category-select">
                <option value="" disabled selected id="post-tax-select-placeholder">Eiporavo Tembipuru Arakatupy</option>
                <option value="four_01k_roth">401k Roth</option>
                <option value="legal_services">Servicios Legales</option>
                <option value="ltd">LTD</option>
                <option value="stock_purchase_plan">Plán Opa Ñemurã</option>
                <option value="ad_and_d">AD&D</option>
                <option value="critical_illness">Ñembyasy Tuichavéva</option>
                <option value="accident_insurance">Aseguro Ñembyasy rehegua</option>
                <option value="custom" id="post-tax-option-custom">Eiporavo Ñandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Tembipuru Arakatupy" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="post-tax-add-button">Toañadí</button>
            </div>
            <div class="item-list" id="postTax-list"></div>
        </div>

        <!-- Tembipuru Rerekuaha Vore -->
        <div class="card">
            <h2 id="expense-management-title">Mba'ehetave Rerekuaha</h2>
            <div class="flex">
                <div style="flex: 1;">
                    <label for="category" id="category-label">Vore</label>
                    <select id="category"></select>
                </div>
                <div style="flex: 2;">
                    <label for="expense-name" id="expense-name-label">Héra</label>
                    <input type="text" id="expense-name" placeholder="Techapyrã: Alquiler">
                </div>
                <div style="flex: 1;">
                    <label for="expense-amount" id="expense-amount-label">Mba'ehetave</label>
                    <input type="number" id="expense-amount" placeholder="$">
                </div>
            </div>
            <div class="category-input-container">
                <label for="new-category" class="sr-only" id="new-category-label">Vore Pyahu Héra</label>
                <input type="text" id="new-category" placeholder="Eiporavo Vore Pyahu Héra" style="flex: 1;">
                <button id="add-category-button" style="flex-shrink: 0; width: auto;">Toañadí Vore</button>
            </div>
            <button id="add-expense-button" style="width: 100%; margin-top: 1rem;">Toañadí Mba'ehetave</button>
            <div class="item-list" id="expenses-list"></div>
        </div>

        <!-- Mba'ehetave Jasykue Vore -->
        <div class="card">
            <h2 id="monthly-financial-status-title">📊 Mba'ehetave Jasykue</h2>
            <div class="income-flow">
                <!-- Mba'ehetave oñemonguatia'ỹva ojeguerojerovia hag̃ua JS rupi -->
            </div>
            <div class="summary-cards">
                <!-- Mba'ehetave oñemonguatia'ỹva ojeguerojerovia hag̃ua JS rupi -->
            </div>
        </div>

        <!-- Mba'ehetave Ñanduti Vore -->
        <div class="card chart-container">
            <h2 id="financial-analysis-chart-title">📈 Mba'ehetave Ñanduti</h2>
            <div class="charts-grid">
                <div>
                    <h3 id="income-flow-chart-title">Mba'ehetave Jasykue (Mba'ehetave Ñanduti)</h3>
                    <canvas id="incomeFlowChart"></canvas>
                </div>
                <div>
                    <h3 id="expense-category-chart-title">Mba'ehetave Vorekuéra (Mba'ehetave Ñanduti)</h3>
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ñanduti Rembiapo Vore -->
        <div class="utility-buttons">
            <button class="utility-btn" id="save-button">💾 Ñongatu</button>
            <button class="utility-btn" id="load-button">📂 Karga</button>
            <button class="utility-btn print" onclick="window.print()">🖨️ Ñongatu</button>
            <button class="utility-btn" id="reset-button" style="background-color: var(--danger-color);">🔄 Ñembopyahu</button>
        </div>
    </main>

    <!-- Modal Apapaha -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message" class="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <!-- JavaScript oñemonguatia'ỹva -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Ñanduti ñembopyahu ---
            // Kóva oñemonguatia'ỹva ojeguerojerovia hag̃ua ñanduti.
            // Chart.js ha ChartDataLabels oñemboguatava'erã HTML-gui.
            Chart.register(ChartDataLabels);

            // --- ESTADO REREKUAHARÃ ---
            let state = {
                language: 'ko',
                income: 0,
                taxes: [], // { id, héra, mba'ehetave }
                preTax: [],
                postTax: [],
                expenses: [], // { id, vore, héra, mba'ehetave }
                expenseCategories: ['Óga', 'Tape', 'Tembi'u', 'Tekove', 'Vy'a', 'Ambue'],
            };

            // --- Ñe'ẽ JEPORUPY (i18n) ---
            const translations = {
                ko: {
                    'app-title': '💰 Kuatiañe\'ẽ Rerekuaha Mba\'ehetave (USD)', 'income-title': 'Sueldo Jasykue', 'income-label': 'Sueldo Jasykue (USD)', 
                    'tax-title': 'Impuesto', 'tax-type-label': 'Impuesto Renda', 'tax-select-placeholder': 'Eiporavo Impuesto Renda', 'tax-option-custom': 'Eiporavo Ñandejara', 'tax_custom_name_placeholder': 'Eiporavo Impuesto Renda', 'tax-amount-placeholder': 'Mba\'ehetave ($)', 'tax-add-button': 'Toañadí', 'tax-update-button': 'Ñembopyahu', 'tax-cancel-button': 'Ñembopyahu', 
                    'pre-tax-title': 'Impuesto Ñanduti', 'pre-tax-type-label': 'Tembipuru Ñanduti', 'pre-tax-select-placeholder': 'Eiporavo Tembipuru Ñanduti', 'pre-tax-option-custom': 'Eiporavo Ñandejara', 'pre_tax_custom_name_placeholder': 'Eiporavo Tembipuru Ñanduti', 'pre-tax-amount-placeholder': 'Mba\'ehetave ($)', 'pre-tax-add-button': 'Toañadí', 'pre-tax-update-button': 'Ñembopyahu', 'pre-tax-cancel-button': 'Ñembopyahu', 
                    'post-tax-title': 'Impuesto Arakatupy', 'post-tax-type-label': 'Tembipuru Arakatupy', 'post-tax-select-placeholder': 'Eiporavo Tembipuru Arakatupy', 'post-tax-option-custom': 'Eiporavo Ñandejara', 'post_tax_custom_name_placeholder': 'Eiporavo Tembipuru Arakatupy', 'post-tax-amount-placeholder': 'Mba\'ehetave ($)', 'post-tax-add-button': 'Toañadí', 'post-tax-update-button': 'Ñembopyahu', 'post-tax-cancel-button': 'Ñembopyahu',
                    'expense-management-title': 'Mba\'ehetave Rerekuaha', 'category-label': 'Vore', 'expense-name-label': 'Héra', 'expense-name-placeholder': 'Techapyrã: Alquiler', 'expense-amount-label': 'Mba\'ehetave', 
                    'new-category-placeholder': 'Eiporavo Vore Pyahu Héra', 'add-category-button': 'Toañadí Vore', 'add-expense-button': 'Toañadí Mba\'ehetave', 'update-expense-button': 'Ñembopyahu Mba\'ehetave', 'cancel-expense-button': 'Ñembopyahu',
                    'monthly-financial-status-title': '📊 Mba\'ehetave Jasykue', 'financial-analysis-chart-title': '📈 Mba\'ehetave Ñanduti', 'income-flow-chart-title': 'Mba\'ehetave Jasykue (Mba\'ehetave Ñanduti)', 'expense-category-chart-title': 'Mba\'ehetave Vorekuéra (Mba\'ehetave Ñanduti)', 
                    'save-button': '💾 Ñongatu', 'load-button': '📂 Karga', 'print-button': '🖨️ Ñongatu', 'reset-button': '🔄 Ñembopyahu',
                    gross_income_label: "Sueldo Ñanduti (Mba'ehetave Ñanduti)", pre_tax_deductions_label: "Ñanduti Tembipuru", taxable_income_label: "Mba'ehetave Ñanduti", tax_total_label: "Impuesto", post_tax_deductions_label: "Impuesto Arakatupy", total_deductions_taxes_label: "Mba'ehetave Ñanduti ha Impuesto", net_income_label: "Mba'ehetave Jasykue", 
                    total_expenses_card_label: "Mba'ehetave Ñanduti", total_expenses_card_sub: "(Mba'ehetave Jasykue guive)", remaining_balance_card_label: "Mba'ehetave Opytava'erã", remaining_balance_card_sub: "(Ñongatu/Mba'ehetave Ñanduti)", expenses_percentage_text: "Mba'ehetave Ñanduti", remaining_percentage_text: "Mba'ehetave Ñanduti",
                    alert_valid_amount: "Eiporavo mba'ehetave hekopete.", alert_custom_name: "Eiporavo mba'ehetave héra.", alert_item_exists: "' ko vorepe oĩma.", alert_fill_all_fields: "Emyanyhẽ opa mba'ehetave rendaha hekopete.", alert_category_exists: "Vore oĩma.",
                    confirm_reset: "¿Nde rehenói mba'ehetave rembopyahu hag̃ua? Ko mba'e nombyai hag̃ua.", alert_data_saved: "Mba'ehetave oñongatu hekopete!", alert_save_failed: "Mba'ehetave oñongatu'ỹva.", alert_data_loaded: "Mba'ehetave okarga hekopete!", alert_load_failed: "Mba'ehetave okarga'ỹva. Ikatu oñembyai.", alert_no_data: "Mba'ehetave oñongatu'ỹva.", alert_data_reset: "Mba'ehetave oñembopyahu.",
                    confirm_delete_item: "¿Nde rehenói mba'ehetave rembopyahu hag̃ua?" 
                },
                en: {
                    'app-title': '💰 Budget Management System (USD)', 'income-title': 'Salary', 'income-label': 'Gross Monthly Salary ($)', 
                    'tax-title': 'Taxes', 'tax-type-label': 'Tax Type', 'tax-select-placeholder': 'Select tax type', 'tax-option-custom': 'Custom', 'tax_custom_name_placeholder': 'Enter tax name', 'tax-amount-placeholder': 'Amount ($)', 'tax-add-button': 'Add', 'tax-update-button': 'Update', 'tax-cancel-button': 'Cancel', 
                    'pre-tax-title': 'Pre-Tax Deductions', 'pre-tax-type-label': 'Deduction Item', 'pre-tax-select-placeholder': 'Select deduction', 'pre-tax-option-custom': 'Custom', 'pre_tax_custom_name_placeholder': 'Enter deduction name', 'pre-tax-amount-placeholder': 'Amount ($)', 'pre-tax-add-button': 'Add', 'pre-tax-update-button': 'Update', 'pre-tax-cancel-button': 'Cancel', 
                    'post-tax-title': 'Post-Tax Deductions', 'post-tax-type-label': 'Deduction Item', 'post-tax-select-placeholder': 'Select deduction', 'post-tax-option-custom': 'Custom', 'post_tax_custom_name_placeholder': 'Enter deduction name', 'post-tax-amount-placeholder': 'Amount ($)', 'post-tax-add-button': 'Add', 'post-tax-update-button': 'Update', 'post-tax-cancel-button': 'Cancel',
                    'expense-management-title': 'Expense Management', 'category-label': 'Category', 'expense-name-label': 'Item Name', 'expense-name-placeholder': 'e.g., Rent', 'expense-amount-label': 'Amount', 
                    'new-category-placeholder': 'Enter new category name', 'add-category-button': 'Add Category', 'add-expense-button': 'Add Expense', 'update-expense-button': 'Update Expense', 'cancel-expense-button': 'Cancel', 
                    'monthly-financial-status-title': '📊 Monthly Financial Status', 'financial-analysis-chart-title': '📈 Financial Analysis Charts', 'income-flow-chart-title': 'Fund Flow Distribution (vs. Gross Income)', 'expense-category-chart-title': 'Expense Breakdown by Category (vs. Total Expenses)', 
                    'save-button': '💾 Save', 'load-button': '📂 Load', 'print-button': '🖨️ Print', 'reset-button': '🔄 Reset',
                    gross_income_label: "Gross Salary (Total Income)", pre_tax_deductions_label: "Pre-Tax Deductions", taxable_income_label: "Taxable Income", tax_total_label: "Taxes", post_tax_deductions_label: "Post-Tax Deductions", total_deductions_taxes_label: "Total Deductions & Taxes", net_income_label: "Net Income (Take-Home Pay)", 
                    total_expenses_card_label: "Total Expenses", total_expenses_card_sub: "(spent from Net Income)", remaining_balance_card_label: "Remaining Balance", remaining_balance_card_sub: "(for Savings/Investments)", expenses_percentage_text: "of Gross Income", remaining_percentage_text: "of Gross Income",
                    alert_valid_amount: "Please enter a valid amount.", alert_custom_name: "Please enter a name for the custom item.", alert_item_exists: "' already exists in this category.", alert_fill_all_fields: "Please fill all expense fields with valid data.", alert_category_exists: "Category already exists.",
                    confirm_reset: "Are you sure you want to reset all data? This cannot be undone.", alert_data_saved: "Data saved successfully!", alert_save_failed: "Failed to save data.", alert_data_loaded: "Data loaded successfully!", alert_load_failed: "Failed to load data. It might be corrupted.", alert_no_data: "No saved data found.", alert_data_reset: "Data has been reset.",
                    confirm_delete_item: "Are you sure you want to delete this item?"
                },
                zh: {
                    'app-title': '💰 预算管理系统 (USD)', 'income-title': '薪水', 'income-label': '세전 월급액 ($)', 
                    'tax-title': '세금', 'tax-type-label': '세종', 'tax-select-placeholder': '선택 세종', 'tax-option-custom': '自定义', 'tax_custom_name_placeholder': '输入税项名称', 'tax-amount-placeholder': '金額 ($)', 'tax-add-button': '添加', 'tax-update-button': '更新', 'tax-cancel-button': '取消', 
                    'pre-tax-title': '세전 공제', 'pre-tax-type-label': '공제 항목', 'pre-tax-select-placeholder': '선택 공제 항목', 'pre-tax-option-custom': '自定义', 'pre_tax_custom_name_placeholder': '输入扣除名称', 'pre-tax-amount-placeholder': '金額 ($)', 'pre-tax-add-button': '添加', 'pre-tax-update-button': '更新', 'tax-cancel-button': '取消', 
                    'post-tax-title': '세후 공제', 'post-tax-type-label': '공제 항목', 'post-tax-select-placeholder': '선택 공제 항목', 'post-tax-option-custom': '自定义', 'post_tax_custom_name_placeholder': '输入扣除名称', 'post-tax-amount-placeholder': '金額 ($)', 'post-tax-add-button': '添加', 'post-tax-update-button': '更新', 'post-tax-cancel-button': '取消',
                    'expense-management-title': '지출 관리', 'category-label': '类别', 'expense-name-label': '항목명', 'expense-name-placeholder': '예: 월세', 'expense-amount-label': '金額', 
                    'new-category-placeholder': '输入新类别名称', 'add-category-button': '添加类别', 'add-expense-button': '添加支出', 'update-expense-button': '更新支出', 'cancel-expense-button': '取消', 
                    'monthly-financial-status-title': '📊 每월 재무 현황', 'financial-analysis-chart-title': '📈 재무 분석 차트', 'income-flow-chart-title': '資金流分配 (與總收入相比)', 'expense-category-chart-title': '按类别划分的支出明细 (與總支出相比)', 
                    'save-button': '💾 保存', 'load-button': '📂 加载', 'print-button': '🖨️ 인쇄하기', 'reset-button': '🔄 초기화',
                    gross_income_label: "총薪수 (총收入)", pre_tax_deductions_label: "세전 공제", taxable_income_label: "应税收入", tax_total_label: "세금", post_tax_deductions_label: "세후 공제", total_deductions_taxes_label: "总 공제 및 세금", net_income_label: "净收入 (实得工资)", 
                    total_expenses_card_label: "总支出", total_expenses_card_sub: "(从净收入中支出)", remaining_balance_card_label: "剩余余额", remaining_balance_card_sub: "(用於储蓄/投资)", expenses_percentage_text: "총收入의", remaining_percentage_text: "총收入의",
                    alert_valid_amount: "请输入有效金額。", alert_custom_name: "请输入自定义项目的名称。", alert_item_exists: "' 已存在于此类别中。", alert_fill_all_fields: "请用有效数据填写所有费用字段。", alert_category_exists: "类别已存在。",
                    confirm_reset: "您确定要重置所有数据吗？此操作无法撤销。", alert_data_saved: "数据保存成功！", alert_save_failed: "数据保存失败。", alert_data_loaded: "数据加载成功！", alert_load_failed: "加载数据失败。数据可能已损坏。", alert_no_data: "未找到保存的数据。", alert_data_reset: "数据已重置。",
                    confirm_delete_item: "您确定要删除此项目吗？"
                },
            };

            // --- DOM REREKUAHARÃ ---
            const incomeInput = document.getElementById('income');
            const langSelect = document.getElementById('language-select');
            const categorySections = document.querySelectorAll('.card[data-category]');
            const addCategoryBtn = document.getElementById('add-category-button');
            const newCategoryInput = document.getElementById('new-category');
            const expenseCategorySelect = document.getElementById('category');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expensesListContainer = document.getElementById('expenses-list');
            const addExpenseBtn = document.getElementById('add-expense-button'); // Ñanduti ojejapova'ekue "Toañadí Mba'ehetave"
            let updateExpenseBtn = null; // Pyahu "Ñembopyahu Mba'ehetave"
            let cancelExpenseBtn = null; // Pyahu "Ñembopyahu Mba'ehetave"

            // Modal tembipuru
            const customModalOverlay = document.getElementById('custom-modal-overlay');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            // --- MODAL REMBIAPO ---
            // Ohechauka apañuái modal-pe peteĩ marandu ha "OK" ñanduti.
            const showAlertDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `<button class="modal-button alert-ok">OK</button>`;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.alert-ok').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve();
                    };
                });
            };

            // Ohechauka ñembopyahu modal-pe peteĩ marandu ha "Sí/No" ñanduti.
            const showConfirmDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `
                        <button class="modal-button confirm-yes">Héẽ</button>
                        <button class="modal-button confirm-no">Nahániri</button>
                    `;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.confirm-yes').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(true);
                    };
                    modalButtons.querySelector('.confirm-no').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(false);
                    };
                });
            };

            // --- REMBIAPO PORÃ ---
            // Oñemboheko mba'ehetave ojeguerojerovia hag̃ua mokõi decimal ha coma-re.
            const formatCurrency = (amount) => (amount ? amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00');
            // Ojejapo ID pyahu tembipuru reraha hag̃ua.
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // --- ÑE'Ẽ JEPORUPY ---
            // Oñemboheko ñe'ẽ ha oñemonguatia'ỹva ojeguerojerovia hag̃ua opa mba'e.
            const setLanguage = (lang) => {
                state.language = lang;
                localStorage.setItem('budgetAppLang', lang); // Ñongatu ñe'ẽ oĩva'ekue
                const t = translations[lang];

                // Oñemonguatia'ỹva ojeguerojerovia hag̃ua opa mba'e oĩva'ekue ID-pe
                document.querySelectorAll('[id]').forEach(el => {
                    const keyWithSuffix = el.id.replace(/-/g, '_'); // Ñe'ẽ JEPORUPY ID-pe
                    const key = el.id.replace(/-label|-title|-button|-placeholder|-text|-sub|-card/g, ''); // Ñe'ẽ JEPORUPY ID-pe

                    if (t[keyWithSuffix]) {
                        el.innerHTML = t[keyWithSuffix];
                    } else if (t[key]) {
                        // Ñanduti: oñemonguatia'ỹva, oñemonguatia'ỹva
                        if (el.placeholder !== undefined) el.placeholder = t[key];
                        else el.innerHTML = t[key];
                    }
                });
                
                // Oñemonguatia'ỹva ojeguerojerovia hag̃ua opa mba'e oĩva'ekue ID-pe
                document.querySelector('[data-category="taxes"] .custom-name-input').placeholder = t.tax_custom_name_placeholder;
                document.querySelector('[data-category="taxes"] .amount-input').placeholder = t['tax-amount-placeholder'];
                // Toañadí-mba'e-btn oñemonguatia'ỹva ojeguerojerovia hag̃ua
                if (document.querySelector('[data-category="taxes"] .add-item-btn')) {
                    document.querySelector('[data-category="taxes"] .add-item-btn').textContent = t['tax-add-button'];
                }
                
                document.querySelector('[data-category="preTax"] .custom-name-input').placeholder = t.pre_tax_custom_name_placeholder;
                document.querySelector('[data-category="preTax"] .amount-input').placeholder = t['pre-tax-amount-placeholder'];
                if (document.querySelector('[data-category="preTax"] .add-item-btn')) {
                    document.querySelector('[data-category="preTax"] .add-item-btn').textContent = t['pre-tax-add-button'];
                }

                document.querySelector('[data-category="postTax"] .custom-name-input').placeholder = t.post_tax_custom_name_placeholder;
                document.querySelector('[data-category="postTax"] .amount-input').placeholder = t['post-tax-amount-placeholder'];
                if (document.querySelector('[data-category="postTax"] .add-item-btn')) {
                    document.querySelector('[data-category="postTax"] .add-item-btn').textContent = t['post-tax-add-button'];
                }


                document.getElementById('expense-name').placeholder = t['expense-name-placeholder'];
                document.getElementById('expense-amount').placeholder = t['expense-amount-label']; 
                document.getElementById('new-category').placeholder = t['new-category-placeholder'];
                document.getElementById('add-expense-button').textContent = t['add-expense-button']; 

                // Ñanduti: Ñembopyahu/Ñembopyahu
                if (updateExpenseBtn) updateExpenseBtn.textContent = t['update-expense-button'];
                if (cancelExpenseBtn) cancelExpenseBtn.textContent = t['cancel-expense-button'];

                // Ñanduti ñembopyahu/ñembopyahu
                categorySections.forEach(section => {
                    const category = section.dataset.category;
                    const updateBtn = section.querySelector('.update-item-btn');
                    const cancelBtn = section.querySelector('.cancel-item-btn');
                    const addBtn = section.querySelector('.add-item-btn'); // Toañadí mba'e

                    if (updateBtn) updateBtn.textContent = t[`${category}-update-button`];
                    if (cancelBtn) cancelBtn.textContent = t[`${category}-cancel-button`];
                    if (addBtn) addBtn.textContent = t[`${category}-add-button`]; // Toañadí mba'e
                });

                document.documentElement.lang = lang.split('-')[0]; // Ñanduti ñembopyahu
                fullUpdate(); // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            };
            
            // --- ÑANDUTI REMBIAPO ---
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua Impuesto renda, Impuesto Ñanduti, Impuesto Arakatupy.
            const renderCategorizedList = (category) => {
                const listContainer = document.getElementById(`${category}-list`);
                listContainer.innerHTML = '';
                state[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(item.amount)}</span>
                            <button class="item-edit-btn" data-id="${item.id}" data-category="${category}">Ñembopyahu</button>
                            <button class="item-delete-btn" data-id="${item.id}" data-category="${category}">X</button>
                        </div>
                    `;
                    listContainer.appendChild(itemDiv);
                });
            };

            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua Mba'ehetave vore.
            const renderExpenseCategories = () => {
                expenseCategorySelect.innerHTML = '';
                state.expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    expenseCategorySelect.appendChild(option);
                });
            };

            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua Mba'ehetave.
            const renderExpensesList = () => {
                expensesListContainer.innerHTML = '';
                state.expenses.forEach(exp => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${exp.category}: ${exp.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(exp.amount)}</span>
                            <button class="item-edit-btn" data-id="${exp.id}" data-category="expenses">Ñembopyahu</button>
                            <button class="item-delete-btn" data-id="${exp.id}" data-category="expenses">X</button>
                        </div>
                    `;
                    expensesListContainer.appendChild(itemDiv);
                });
            };

            // --- Ñanduti ñembopyahu ---
            // Oñemboheko opa mba'ehetave ñanduti ha oñemonguatia'ỹva.
            const calculateAndUpdateAll = () => {
                const t = translations[state.language];
                const income = state.income || 0;

                const preTaxDeductions = state.preTax.reduce((sum, item) => sum + item.amount, 0);
                const taxableIncome = Math.max(0, income - preTaxDeductions);
                const taxTotal = state.taxes.reduce((sum, item) => sum + item.amount, 0);
                const postTaxDeductions = state.postTax.reduce((sum, item) => sum + item.amount, 0);
                const totalDeductionsAndTaxes = preTaxDeductions + taxTotal + postTaxDeductions;
                const netIncome = Math.max(0, income - totalDeductionsAndTaxes);
                const expensesTotal = state.expenses.reduce((sum, item) => sum + item.amount, 0);
                const remainingBalance = netIncome - expensesTotal;

                const incomeFlowContainer = document.querySelector('.income-flow');
                incomeFlowContainer.innerHTML = `
                    <div class="flow-item"><span class="flow-label">${t.gross_income_label}</span> <span class="flow-amount">$${formatCurrency(income)} <em class="percentage highlighted-percentage">(100.0%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.pre_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(preTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? preTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item"><span class="flow-label"><strong>${t.taxable_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(taxableIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxableIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.tax_total_label}</span> <span class="flow-amount">-$${formatCurrency(taxTotal)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxTotal / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.post_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(postTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? postTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item info"><span class="flow-label"><strong>${t.total_deductions_taxes_label}</strong></span> <span class="flow-amount">-$${formatCurrency(totalDeductionsAndTaxes)} <em class="percentage highlighted-percentage">(${(income > 0 ? totalDeductionsAndTaxes / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item result"><span class="flow-label"><strong>${t.net_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(netIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? netIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                `;

                const summaryCardsContainer = document.querySelector('.summary-cards');
                summaryCardsContainer.innerHTML = `
                    <div class="summary-card">
                        <div class="card-label">${t.total_expenses_card_label}</div>
                        <div class="card-amount negative">$${formatCurrency(expensesTotal)}</div>
                        <div class="card-sub">${t.total_expenses_card_sub}</div>
                        <div class="card-percentage">${t.expenses_percentage_text} <span class="highlighted-percentage">${(income > 0 ? expensesTotal / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                    <div class="summary-card accent">
                        <div class="card-label">${t.remaining_balance_card_label}</div>
                        <div class="card-amount ${remainingBalance < 0 ? 'negative' : ''}">$${formatCurrency(remainingBalance)}</div>
                        <div class="card-sub">${t.remaining_balance_card_sub}</div>
                        <div class="card-percentage">${t.remaining_percentage_text} <span class="highlighted-percentage">${(income > 0 ? remainingBalance / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                `;

                updateCharts({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions });
            };

            // --- TA'ANGA ÑANDUTI ---
            let incomeFlowChart, expenseCategoryChart;
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua ta'anga.
            const updateCharts = ({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions }) => {
                const incomeFlowCtx = document.getElementById('incomeFlowChart')?.getContext('2d');
                const expenseCategoryCtx = document.getElementById('expenseCategoryChart')?.getContext('2d');

                if (!incomeFlowCtx || !expenseCategoryCtx) return;

                // Ta'anga oñemonguatia'ỹva ojeguerojerovia hag̃ua
                incomeFlowCtx.canvas.parentNode.style.height = '350px';
                incomeFlowCtx.canvas.parentNode.style.position = 'relative';
                expenseCategoryCtx.canvas.parentNode.style.height = '350px';
                expenseCategoryCtx.canvas.parentNode.style.position = 'relative';

                if (incomeFlowChart) incomeFlowChart.destroy();
                incomeFlowChart = new Chart(incomeFlowCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mba\'ehetave Jasykue', 'Impuesto', 'Ñanduti Tembipuru', 'Impuesto Arakatupy'],
                        datasets: [{
                            data: [Math.max(0, netIncome), taxTotal, preTaxDeductions, postTaxDeductions],
                            backgroundColor: ['#7ed321', '#d0021b', '#f5a623', '#4a90e2'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
                
                const expenseData = state.expenseCategories.map(cat => state.expenses.filter(exp => exp.category === cat).reduce((sum, exp) => sum + exp.amount, 0));

                if (expenseCategoryChart) expenseCategoryChart.destroy();
                expenseCategoryChart = new Chart(expenseCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: state.expenseCategories,
                        datasets: [{
                            data: expenseData,
                            backgroundColor: ['#4a90e2', '#50e3c2', '#f5a623', '#bd10e0', '#b8e986', '#7ed321', '#4a4a4a', '#9013fe', '#f8e71c', '#d0021b']
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
            };
            
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            const fullUpdate = () => {
                renderExpenseCategories();
                renderExpensesList();
                renderCategorizedList('taxes');
                renderCategorizedList('preTax');
                renderCategorizedList('postTax');
                calculateAndUpdateAll();
            };

            // --- ÑANDUTI REMBIAPO ---
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            incomeInput.addEventListener('input', (e) => {
                state.income = parseFloat(e.target.value) || 0;
                calculateAndUpdateAll();
            });

            // Ñanduti ñembopyahu/ñembopyahu
            categorySections.forEach(section => {
                const category = section.dataset.category;
                const select = section.querySelector('.category-select');
                const inputContainer = section.querySelector('.category-input-container');
                const customNameInput = section.querySelector('.custom-name-input');
                const amountInput = section.querySelector('.amount-input');
                const addButton = section.querySelector('.add-item-btn');
                
                // Pyahu ñanduti.
                // Ñanduti oñembotapykueva'erã.
                let updateButton = section.querySelector('.update-item-btn');
                let cancelButton = section.querySelector('.cancel-item-btn');

                if (!updateButton) {
                    updateButton = document.createElement('button');
                    updateButton.className = 'update-item-btn hidden'; // Ñanduti oñembotapykueva'erã
                    inputContainer.appendChild(updateButton);
                }
                if (!cancelButton) {
                    cancelButton = document.createElement('button');
                    cancelButton.className = 'cancel-item-btn hidden utility-btn'; // Ñanduti oñembotapykueva'erã
                    cancelButton.style.backgroundColor = '#6c757d'; 
                    inputContainer.appendChild(cancelButton);
                }

                // Estado oñemonguatia'ỹva
                let editingItemId = null;

                /**
                 * Oñemboheko edit mode vorepe.
                 * Oñemboheko ñanduti ha oñemonguatia'ỹva.
                 * @param {boolean} isEditing - True oñemonguatia'ỹva, False oñemonguatia'ỹva.
                 * @param {object | null} item - Tembipuru oñemonguatia'ỹva (oñemonguatia'ỹva).
                 */
                const setSectionEditMode = (isEditing, item = null) => {
                    const t = translations[state.language]; 
                    if (isEditing) {
                        // Ñanduti oñembotapykueva'erã.
                        addButton.classList.add('hidden');
                        updateButton.classList.remove('hidden');
                        cancelButton.classList.remove('hidden');
                        // Ñanduti oñemonguatia'ỹva
                        updateButton.textContent = t[`${category}-update-button`];
                        cancelButton.textContent = t[`${category}-cancel-button`];

                        if (item) {
                            editingItemId = item.id;
                            // Ñanduti: item.héra oĩma.
                            const optionExists = Array.from(select.options).some(option => option.value === item.name);
                            if (optionExists && select.querySelector(`option[value="${item.name}"]`)) { 
                                select.value = item.name;
                                customNameInput.style.display = 'none';
                            } else {
                                select.value = 'custom';
                                customNameInput.value = item.name;
                                customNameInput.style.display = 'block';
                            }
                            amountInput.value = item.amount;
                            inputContainer.style.display = 'flex'; // Ñanduti oñemonguatia'ỹva
                            amountInput.focus(); // Ñanduti oñemonguatia'ỹva
                        }
                    } else {
                        // Ñanduti ñembopyahu, oñemonguatia'ỹva.
                        addButton.classList.remove('hidden');
                        updateButton.classList.add('hidden');
                        cancelButton.classList.add('hidden');
                        addButton.textContent = t[`${category}-add-button`]; // Ñanduti oñemonguatia'ỹva
                        editingItemId = null; // Estado oñemonguatia'ỹva
                        
                        // Ñanduti: select.value oñembopyahu'ỹva.
                        customNameInput.value = '';
                        amountInput.value = '';
                        customNameInput.style.display = 'none'; // Ñanduti oñembotapykueva'erã
                        
                        // Ñanduti: inputContainer oñembotapykueva'erã.
                        if (!select.value) { // Kóva oñemonguatia'ỹva
                            inputContainer.style.display = 'none'; 
                        }
                    }
                };

                // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
                section.setEditMode = setSectionEditMode;

                // Ñanduti oñemonguatia'ỹva.
                select.addEventListener('change', () => {
                    // Ñanduti oñemonguatia'ỹva
                    // Ñanduti oñemonguatia'ỹva
                    // Ñanduti oñemonguatia'ỹva
                    // Ñanduti oñemonguatia'ỹva
                    setSectionEditMode(false); 

                    // Ñanduti oñemonguatia'ỹva
                    if (select.value) { // Ñanduti oñemonguatia'ỹva
                        inputContainer.style.display = 'flex'; // Ñanduti oñemonguatia'ỹva
                        amountInput.value = ''; // Ñanduti oñemonguatia'ỹva
                        
                        if (select.value === 'custom') {
                            customNameInput.style.display = 'block';
                            customNameInput.value = ''; // Ñanduti oñemonguatia'ỹva
                            customNameInput.focus();
                        } else {
                            customNameInput.style.display = 'none';
                            customNameInput.value = ''; // Ñanduti oñemonguatia'ỹva
                            amountInput.focus();
                        }
                    } else {
                        // Ñanduti oñemonguatia'ỹva
                        inputContainer.style.display = 'none';
                        customNameInput.style.display = 'none';
                        amountInput.value = '';
                        customNameInput.value = ''; // Ñanduti oñemonguatia'ỹva
                    }
                });
                
                // Toañadí mba'e (ñanduti ojejapova'ekue "Apply" ñanduti)
                addButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }
                    
                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }
                    
                    // Ñanduti oñemonguatia'ỹva
                    if(state[category].some(item => item.name.toLowerCase() === name.toLowerCase())) { await showAlertDialog(`'${name}'` + t.alert_item_exists); return; }

                    state[category].push({ id: generateId(), name, amount });
                    
                    setSectionEditMode(false); // Ñanduti oñemonguatia'ỹva
                    fullUpdate(); // Ñanduti oñemonguatia'ỹva
                });

                // Ñanduti ñembopyahu
                updateButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }

                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }

                    // Ñanduti oñemonguatia'ỹva
                    if(state[category].some(item => item.id !== editingItemId && item.name.toLowerCase() === name.toLowerCase())) {
                        await showAlertDialog(`'${name}'` + t.alert_item_exists); return;
                    }

                    state[category] = state[category].map(item =>
                        item.id === editingItemId ? { ...item, name, amount } : item
                    );
                    
                    setSectionEditMode(false); // Ñanduti oñemonguatia'ỹva
                    fullUpdate(); // Ñanduti oñemonguatia'ỹva
                });

                // Ñanduti ñembopyahu
                cancelButton.addEventListener('click', () => {
                    setSectionEditMode(false); // Ñanduti oñemonguatia'ỹva
                });
            });
            
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            document.body.addEventListener('click', async (e) => {
                if (e.target.classList.contains('item-delete-btn')) {
                    const { id, category } = e.target.dataset;
                    // Ñanduti oñemonguatia'ỹva
                    if (await showConfirmDialog(translations[state.language].confirm_delete_item)) {
                        state[category] = state[category].filter(item => item.id !== id);
                        fullUpdate();
                    } 
                } else if (e.target.classList.contains('item-edit-btn')) {
                    const { id, category } = e.target.dataset;
                    const itemToEdit = state[category].find(item => item.id === id);

                    if (itemToEdit) {
                        // Ñanduti oñemonguatia'ỹva
                        if (category === 'expenses') {
                            // Ñanduti oñemonguatia'ỹva
                            expenseCategorySelect.value = itemToEdit.category;
                            expenseNameInput.value = itemToEdit.name;
                            expenseAmountInput.value = itemToEdit.amount;

                            addExpenseBtn.classList.add('hidden');
                            // Ñanduti oñemonguatia'ỹva
                            if (!updateExpenseBtn) { 
                                const expenseButtonContainer = addExpenseBtn.parentNode;
                                updateExpenseBtn = document.createElement('button');
                                updateExpenseBtn.id = 'update-expense-button';
                                updateExpenseBtn.textContent = translations[state.language]['update-expense-button'];
                                updateExpenseBtn.style.width = '100%';
                                updateExpenseBtn.style.marginTop = '1rem';
                                expenseButtonContainer.insertBefore(updateExpenseBtn, addExpenseBtn);

                                cancelExpenseBtn = document.createElement('button');
                                cancelExpenseBtn.id = 'cancel-expense-button';
                                cancelExpenseBtn.textContent = translations[state.language]['cancel-expense-button'];
                                cancelExpenseBtn.className = 'utility-btn';
                                cancelExpenseBtn.style.width = '100%';
                                cancelExpenseBtn.style.marginTop = '1rem';
                                cancelExpenseBtn.style.backgroundColor = '#6c757d';
                                expenseButtonContainer.insertBefore(cancelExpenseBtn, addExpenseBtn);

                                // Ñanduti oñemonguatia'ỹva
                                updateExpenseBtn.addEventListener('click', async () => {
                                    const t = translations[state.language];
                                    const categoryVal = expenseCategorySelect.value;
                                    const name = expenseNameInput.value.trim();
                                    const amount = parseFloat(expenseAmountInput.value);

                                    if (!categoryVal || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }

                                    state.expenses = state.expenses.map(exp =>
                                        exp.id === editingItemIdForExpenses ? { ...exp, category: categoryVal, name, amount } : exp
                                    );
                                    resetExpenseForm();
                                    fullUpdate();
                                });

                                cancelExpenseBtn.addEventListener('click', () => {
                                    resetExpenseForm();
                                });
                            }
                            updateExpenseBtn.classList.remove('hidden');
                            cancelExpenseBtn.classList.remove('hidden');
                            editingItemIdForExpenses = id; // Ñanduti oñemonguatia'ỹva
                        } else {
                            // Ñanduti oñemonguatia'ỹva
                            const section = document.querySelector(`.card[data-category="${category}"]`);
                            // Ñanduti oñemonguatia'ỹva
                            if (section && section.setEditMode) {
                                section.setEditMode(true, itemToEdit); // Ñanduti oñemonguatia'ỹva
                            }
                        }
                    }
                }
            });

            // Ñanduti oñemonguatia'ỹva
            const resetExpenseForm = () => {
                expenseCategorySelect.value = state.expenseCategories[0]; // Ñanduti oñemonguatia'ỹva
                expenseNameInput.value = '';
                expenseAmountInput.value = '';
                addExpenseBtn.classList.remove('hidden');
                if (updateExpenseBtn) updateExpenseBtn.classList.add('hidden');
                if (cancelExpenseBtn) cancelExpenseBtn.classList.add('hidden');
                editingItemIdForExpenses = null;
            };
            let editingItemIdForExpenses = null; // Ñanduti oñemonguatia'ỹva

            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            addCategoryBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const newCategory = newCategoryInput.value.trim();
                if (newCategory && !state.expenseCategories.includes(newCategory)) {
                    state.expenseCategories.push(newCategory);
                    newCategoryInput.value = '';
                    renderExpenseCategories();
                } else if (state.expenseCategories.includes(newCategory)) {
                    await showAlertDialog(t.alert_category_exists);
                }
            });
            
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            addExpenseBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const category = expenseCategorySelect.value;
                const name = expenseNameInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);

                if (!category || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }
                
                state.expenses.push({ id: generateId(), category, name, amount });
                resetExpenseForm(); // Ñanduti oñemonguatia'ỹva
                fullUpdate();
            });
            
            // Ñe'ẽ jeporu.
            langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

            // Ñongatu ñanduti oĩva'ekue local storage-pe.
            document.getElementById('save-button').addEventListener('click', async () => {
                const t = translations[state.language];
                try {
                    localStorage.setItem('budgetAppData', JSON.stringify(state));
                    await showAlertDialog(t.alert_data_saved);
                } catch (error) {
                    console.error('Mba\'ehetave oñongatu\'ỹva:', error);
                    await showAlertDialog(t.alert_save_failed);
                }
            });

            // Karga ñanduti oĩva'ekue local storage-pe.
            document.getElementById('load-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const savedData = localStorage.getItem('budgetAppData');
                if (savedData) {
                    try {
                        const loadedState = JSON.parse(savedData);
                        // Mba'ehetave oñemonguatia'ỹva ojeguerojerovia hag̃ua
                        state.income = loadedState.income || 0;
                        state.taxes = Array.isArray(loadedState.taxes) ? loadedState.taxes : [];
                        state.preTax = Array.isArray(loadedState.preTax) ? loadedState.preTax : [];
                        state.postTax = Array.isArray(loadedState.postTax) ? loadedState.postTax : [];
                        state.expenses = Array.isArray(loadedState.expenses) ? loadedState.expenses : [];
                        state.expenseCategories = Array.isArray(loadedState.expenseCategories) ? loadedState.expenseCategories : ['Óga', 'Tape', 'Tembi\'u', 'Tekove', 'Vy\'a', 'Ambue'];
                        
                        langSelect.value = loadedState.language || 'ko';
                        setLanguage(langSelect.value); // Ñanduti ñembopyahu
                        await showAlertDialog(t.alert_data_loaded);
                    } catch(error) {
                        console.error('Mba\'ehetave okarga\'ỹva:', error);
                        await showAlertDialog(t.alert_load_failed);
                    }
                } else {
                    await showAlertDialog(t.alert_no_data);
                }
            });
            
            // Oñembopyahu opa mba'ehetave.
            document.getElementById('reset-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const confirmed = await showConfirmDialog(t.confirm_reset);
                if (confirmed) {
                    localStorage.removeItem('budgetAppData');
                    // Mba'ehetave oñemonguatia'ỹva ojeguerojerovia hag̃ua
                    state = { 
                        language: state.language, 
                        income: 0, 
                        taxes: [], 
                        preTax: [], 
                        postTax: [], 
                        expenses: [], 
                        expenseCategories: ['Óga', 'Tape', 'Tembi\'u', 'Tekove', 'Vy\'a', 'Ambue'], 
                    };
                    incomeInput.value = '';
                    setLanguage(state.language); // Ñanduti ñembopyahu
                    await showAlertDialog(t.alert_data_reset);
                }
            });
            
            // --- ÑANDUTI REMBIAPO ---
            // Oñemonguatia'ỹva ojeguerojerovia hag̃ua
            const savedLang = localStorage.getItem('budgetAppLang') || 'ko';
            langSelect.value = savedLang;
            setLanguage(savedLang); // Ñanduti ñembopyahu
        });
    </script>
</body>
</html>
