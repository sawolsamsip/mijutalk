<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ ì¬ë¬´ í”Œë˜ë„ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --text-color: #2c3e50;
            --light-gray: #f9f9f9;
            --medium-gray: #7f8c8d;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        h1, h2 {
            color: var(--text-color);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input, select, button {
            padding: 12px;
            margin: 8px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .card label:not(.sr-only) {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        select {
            height: 46px;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }
        .delete-btn {
            background: var(--danger);
            padding: 8px 12px;
            width: auto;
        }
        .edit-btn, .save-edit-btn {
            background: var(--warning);
            padding: 8px 12px;
            width: auto;
            margin-right: 5px;
        }
        .save-edit-btn {
            background: var(--success);
        }
        .cancel-edit-btn {
            background: var(--medium-gray);
            padding: 8px 12px;
            width: auto;
            margin-right: 5px;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .flex > div {
            flex: 1;
        }
        .flex input, .flex select {
            margin: 0;
        }

        .item-list {
            margin-top: 20px;
        }
        .expense-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .expense-item-content {
            flex: 1;
            min-width: 150px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .expense-item-amount {
            min-width: 100px;
            text-align: right;
            padding-right: 10px;
        }
        .expense-item-actions {
            display: flex;
            flex-shrink: 0;
        }
        .expense-item input[type="text"],
        .expense-item input[type="number"] {
            width: auto;
            flex: 1;
            margin: 0;
            padding: 8px;
        }
        .badge {
            background: #eee;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .income-flow {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .flow-item.highlighted {
            border-left: 4px solid var(--danger);
        }
        .flow-item.result {
            border-left: 4px solid var(--success);
            font-weight: bold;
        }
        .flow-item.info { /* For total deductions/taxes */
            border-left: 4px solid var(--warning);
            font-weight: bold;
        }
        .flow-arrow {
            text-align: center;
            color: var(--medium-gray);
            margin: 2px 0;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card.accent {
            border-top: 4px solid var(--primary);
        }
        .card-label {
            font-size: 1em;
            color: var(--medium-gray);
            margin-bottom: 5px;
        }
        .card-amount {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        .card-amount.positive {
            color: var(--success);
        }
        .card-amount.negative {
            color: var(--danger);
        }
        .card-sub {
            font-size: 0.7em;
            color: #bdc3c7;
        }
        .card-percentage {
            font-size: 0.8em;
            color: var(--medium-gray);
            margin-top: 5px;
            font-weight: bold;
        }
        .card-percentage .highlighted-percentage {
            color: var(--primary); /* Highlight color for percentages */
            font-weight: bold;
        }
        .utility-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .utility-btn {
            background: #95a5a6;
            padding: 10px 15px;
            width: auto;
        }
        .utility-btn.print {
            background: #9b59b6;
        }
        .category-input-container {
            display: none;
            margin-top: 8px;
        }
        #tax-custom-container .flex,
        #pre-tax-custom-container .flex,
        #post-tax-custom-container .flex,
        #category-input-container.flex {
            align-items: center;
        }
        #tax-custom-container input,
        #pre-tax-custom-container input,
        #post-tax-custom-container input,
        #category-input-container input {
            margin-right: 10px;
        }
        #tax-custom-container button,
        #pre-tax-custom-container button,
        #post-tax-custom-container button,
        #category-input-container button {
            flex-shrink: 0;
            width: auto;
        }

        .total-summary {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .total-summary .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .total-summary .summary-label {
            color: var(--medium-gray);
        }
        .total-summary .summary-value {
            font-weight: bold;
        }
        .total-summary .percentage {
            color: var(--primary);
            font-size: 0.8em;
            margin-left: 5px;
            font-weight: bold;
        }
        .flow-amount .percentage {
            color: var(--primary); /* Highlighted percentage */
            font-size: 0.8em;
            font-style: normal;
            margin-left: 3px;
            font-weight: bold;
        }
        .flow-item.result .percentage {
            color: var(--success); /* Green for positive results */
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* Chart specific styles */
        .chart-container {
            margin-top: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- ì°¨íŠ¸ ë†’ì´ ë¬¸ì œ í•´ê²° ë° ë Œë”ë§ ê°œì„ ì„ ìœ„í•œ ì½”ë“œ --- */
        .charts-grid > div {
            position: relative;
            height: 350px; /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì˜ ê³ ì • ë†’ì´ */
            display: flex; /* flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ canvasë¥¼ ì¤‘ì•™ì— ë°°ì¹˜í•˜ê±°ë‚˜ í¬ê¸° ì¡°ì ˆ */
            justify-content: center;
            align-items: center;
        }

        .charts-grid canvas {
            max-width: 100%; /* ë¶€ëª¨ ë„ˆë¹„ì— ë§ì¶”ê³  */
            max-height: 100%; /* ë¶€ëª¨ ë†’ì´ì— ë§ì¶”ë˜ */
            height: 100% !important; /* í•­ìƒ 100%ë¥¼ ìœ ì§€í•˜ë„ë¡ ê°•ì œ */
            width: 100% !important; /* í•­ìƒ 100%ë¥¼ ìœ ì§€í•˜ë„ë¡ ê°•ì œ */
        }
        /* ------------------------------------------------ */


        @media (max-width: 600px) {
            .flex {
                flex-direction: column;
                align-items: stretch;
            }
            .flex > div {
                flex: auto;
            }
            .utility-buttons {
                flex-wrap: wrap;
            }
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .expense-item-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            #tax-custom-container .flex,
            #pre-tax-custom-container .flex,
            #post-tax-custom-container .flex,
            #category-input-container.flex {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
            }
            #tax-custom-container input,
            #pre-tax-custom-container input,
            #post-tax-custom-container input,
            #category-input-container input {
                flex: 1;
                min-width: 120px;
            }
            #tax-custom-container button,
            #pre-tax-custom-container button,
            #post-tax-custom-container button,
            #category-input-container button {
                width: auto;
                flex-shrink: 0;
            }
            .charts-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            /* ì‘ì€ í™”ë©´ì—ì„œë„ ì°¨íŠ¸ ë†’ì´ ìœ ì§€ */
            .charts-grid > div {
                height: 300px; /* ëª¨ë°”ì¼ ë“± ì‘ì€ í™”ë©´ì—ì„œ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ë†’ì´ ì¡°ì • */
            }
        }
        @media print {
            body {
                padding: 0;
                background: white;
            }
            .card, .chart-container {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            button, .utility-buttons, .category-input-container {
                display: none;
            }
            input, select {
                border: none;
                padding: 0;
            }
            .expense-item-actions {
                display: none;
            }
            canvas { /* Ensure charts are visible in print */
                max-width: 100%;
                height: auto !important;
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š ê°€ê³„ ì¬ë¬´ í”Œë˜ë„ˆ</h1>

    <div class="card">
        <h2>ğŸ’° ìˆ˜ì… ë° ì§€ì¶œ ê¸°ë¡</h2>
        <div class="flex">
            <div>
                <label for="item-name">í•­ëª©</label>
                <input type="text" id="item-name" placeholder="í•­ëª©ëª… (ì˜ˆ: ê¸‰ì—¬, ì‹ë¹„)" required>
            </div>
            <div>
                <label for="item-amount">ê¸ˆì•¡</label>
                <input type="number" id="item-amount" placeholder="ê¸ˆì•¡ (ìˆ«ìë§Œ)" required min="0">
            </div>
            <div>
                <label for="item-type">ìœ í˜•</label>
                <select id="item-type">
                    <option value="income">ìˆ˜ì…</option>
                    <option value="expense">ì§€ì¶œ</option>
                </select>
            </div>
            <div>
                <label for="item-category">ì¹´í…Œê³ ë¦¬</label>
                <select id="item-category">
                    </select>
            </div>
            <div>
                <button id="add-item-btn">ì¶”ê°€</button>
            </div>
        </div>
        <div id="category-input-container" class="flex">
            <div>
                <label for="new-category-name" class="sr-only">ìƒˆ ì¹´í…Œê³ ë¦¬ëª…</label>
                <input type="text" id="new-category-name" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ëª…">
            </div>
            <div>
                <label for="new-category-type" class="sr-only">ìœ í˜•</label>
                <select id="new-category-type">
                    <option value="income">ìˆ˜ì…</option>
                    <option value="expense">ì§€ì¶œ</option>
                </select>
            </div>
            <div>
                <button id="add-category-btn" class="save-edit-btn">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
            </div>
            <div>
                <button id="cancel-add-category-btn" class="cancel-edit-btn">ì·¨ì†Œ</button>
            </div>
        </div>
        <button id="toggle-category-input-btn" class="utility-btn">ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬</button>
    </div>

    <div class="card item-list">
        <h2>ğŸ“Š ê±°ë˜ ë‚´ì—­</h2>
        <div id="transaction-list">
            </div>
    </div>

    <div class="card">
        <h2>ğŸ“ˆ ì¬ë¬´ ë¶„ì„ ì°¨íŠ¸</h2>
        <div class="charts-grid">
            <div>
                <h3>ìê¸ˆ íë¦„ ë°°ë¶„ (ì´ ìˆ˜ì… ëŒ€ë¹„)</h3>
                <canvas id="incomeFlowChart"></canvas>
            </div>
            <div>
                <h3>ì§€ì¶œ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘ (ì´ ì§€ì¶œ ëŒ€ë¹„)</h3>
                <canvas id="expenseCategoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card income-flow">
        <h2>ğŸ’° ìˆœì´ìµ ë° ìê¸ˆ íë¦„</h2>
        <div id="income-flow-details">
            </div>
        <div class="total-summary">
            <div class="summary-row">
                <span class="summary-label">ì´ ìˆ˜ì…</span>
                <span class="summary-value" id="total-income">0ì›</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">ì´ ì§€ì¶œ</span>
                <span class="summary-value" id="total-expense">0ì›</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">ìˆœì´ìµ</span>
                <span class="summary-value" id="net-profit">0ì›</span>
            </div>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card accent">
            <div class="card-label">ì´ ìì‚°</div>
            <div class="card-amount positive" id="total-assets-display">0ì›</div>
            <div class="card-sub">í˜„ì¬ ê°€ìš© ìì‚°</div>
        </div>
        <div class="summary-card">
            <div class="card-label">ì†Œë¹„ìœ¨</div>
            <div class="card-amount" id="spending-ratio-display">0%</div>
            <div class="card-sub">ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œ</div>
        </div>
        <div class="summary-card">
            <div class="card-label">ì €ì¶•ë¥ </div>
            <div class="card-amount" id="savings-ratio-display">0%</div>
            <div class="card-sub">ìˆ˜ì… ëŒ€ë¹„ ì €ì¶•</div>
        </div>
    </div>

    <div class="card utility-buttons">
        <button id="clear-all-data-btn" class="utility-btn danger">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
        <button id="print-report-btn" class="utility-btn print">ë³´ê³ ì„œ ì¸ì‡„</button>
    </div>

    <script>
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ì „ì—­ ë³€ìˆ˜
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || { income: [], expense: [] };
        let incomeFlowItems = JSON.parse(localStorage.getItem('incomeFlowItems')) || [];

        const defaultExpenseCategories = ['ì‹ë¹„', 'ì£¼ê±°', 'êµí†µ', 'í†µì‹ ', 'ì˜ë£Œ', 'êµìœ¡', 'ë¬¸í™”ìƒí™œ', 'ì˜ë¥˜ë¯¸ìš©', 'ê²½ì¡°ì‚¬', 'ê¸°íƒ€ ì§€ì¶œ'];
        const defaultIncomeCategories = ['ê¸‰ì—¬', 'ë¶€ìˆ˜ì…', 'íˆ¬ììˆ˜ì…', 'ìš©ëˆ', 'ê¸°íƒ€ ìˆ˜ì…'];

        let incomeFlowChartInstance;
        let expenseCategoryChartInstance;

        // HTML ìš”ì†Œ ì°¸ì¡°
        const itemForm = document.getElementById('add-item-btn');
        const itemNameInput = document.getElementById('item-name');
        const itemAmountInput = document.getElementById('item-amount');
        const itemTypeSelect = document.getElementById('item-type');
        const itemCategorySelect = document.getElementById('item-category');
        const transactionListDiv = document.getElementById('transaction-list');
        const totalIncomeDisplay = document.getElementById('total-income');
        const totalExpenseDisplay = document.getElementById('total-expense');
        const netProfitDisplay = document.getElementById('net-profit');
        const totalAssetsDisplay = document.getElementById('total-assets-display');
        const spendingRatioDisplay = document.getElementById('spending-ratio-display');
        const savingsRatioDisplay = document.getElementById('savings-ratio-display');
        const incomeFlowDetailsDiv = document.getElementById('income-flow-details');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        const printReportBtn = document.getElementById('print-report-btn');

        const toggleCategoryInputBtn = document.getElementById('toggle-category-input-btn');
        const categoryInputContainer = document.getElementById('category-input-container');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const newCategoryTypeSelect = document.getElementById('new-category-type');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');

        // ì‚¬ìš©ì ì •ì˜ ì†Œë“ íë¦„ í•­ëª©ì„ ìœ„í•œ ìš”ì†Œë“¤
        const preTaxCustomContainer = document.createElement('div');
        preTaxCustomContainer.id = 'pre-tax-custom-container';
        preTaxCustomContainer.innerHTML = `
            <div class="flex">
                <div>
                    <label for="pre-tax-custom-name">ì„¸ì „ ê³µì œ í•­ëª©ëª…</label>
                    <input type="text" id="pre-tax-custom-name" placeholder="êµ­ë¯¼ì—°ê¸ˆ, ê±´ê°•ë³´í—˜ ë“±">
                </div>
                <div>
                    <label for="pre-tax-custom-amount">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="pre-tax-custom-amount" placeholder="ê¸ˆì•¡" min="0">
                </div>
                <div>
                    <button id="add-pre-tax-custom" class="save-edit-btn">ì¶”ê°€</button>
                </div>
                <div>
                    <button id="cancel-pre-tax-custom" class="cancel-edit-btn">ì·¨ì†Œ</button>
                </div>
            </div>
        `;
        preTaxCustomContainer.style.display = 'none';

        const postTaxCustomContainer = document.createElement('div');
        postTaxCustomContainer.id = 'post-tax-custom-container';
        postTaxCustomContainer.innerHTML = `
            <div class="flex">
                <div>
                    <label for="post-tax-custom-name">ì„¸í›„ ê³µì œ í•­ëª©ëª…</label>
                    <input type="text" id="post-tax-custom-name" placeholder="ëŒ€ì¶œ ìƒí™˜, ë³´í—˜ë£Œ ë“±">
                </div>
                <div>
                    <label for="post-tax-custom-amount">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="post-tax-custom-amount" placeholder="ê¸ˆì•¡" min="0">
                </div>
                <div>
                    <button id="add-post-tax-custom" class="save-edit-btn">ì¶”ê°€</button>
                </div>
                <div>
                    <button id="cancel-post-tax-custom" class="cancel-edit-btn">ì·¨ì†Œ</button>
                </div>
            </div>
        `;
        postTaxCustomContainer.style.display = 'none';

        document.querySelector('.income-flow').prepend(postTaxCustomContainer);
        document.querySelector('.income-flow').prepend(preTaxCustomContainer);

        // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        };

        // ë°ì´í„° ì €ì¥
        const saveData = () => {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            localStorage.setItem('incomeFlowItems', JSON.stringify(incomeFlowItems));
            updateUI();
        };

        // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸
        const updateCategoryOptions = () => {
            itemCategorySelect.innerHTML = ''; // Clear existing options

            const currentType = itemTypeSelect.value;
            let categoriesToDisplay = [];

            if (currentType === 'income') {
                categoriesToDisplay = [...defaultIncomeCategories, ...(customCategories.income || [])];
            } else { // expense
                categoriesToDisplay = [...defaultExpenseCategories, ...(customCategories.expense || [])];
            }

            categoriesToDisplay.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                itemCategorySelect.appendChild(option);
            });

            // If no category is selected, select the first one if available
            if (itemCategorySelect.options.length > 0 && !itemCategorySelect.value) {
                itemCategorySelect.value = itemCategorySelect.options[0].value;
            }
        };

        // ì´ˆê¸° ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ë¡œë“œ
        updateCategoryOptions();

        // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
        itemForm.addEventListener('click', (e) => {
            if (e.target.id === 'add-item-btn') {
                const name = itemNameInput.value.trim();
                const amount = parseFloat(itemAmountInput.value);
                const type = itemTypeSelect.value;
                const category = itemCategorySelect.value;
                const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                if (name && !isNaN(amount) && amount > 0) {
                    transactions.push({ id: Date.now(), name, amount, type, category, date });
                    itemNameInput.value = '';
                    itemAmountInput.value = '';
                    itemCategorySelect.value = itemCategorySelect.options[0] ? itemCategorySelect.options[0].value : ''; // Reset to first category
                    saveData();
                } else {
                    alert('í•­ëª©ëª…ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
        });

        // ê±°ë˜ ë‚´ì—­ ë Œë”ë§
        const renderTransactions = () => {
            transactionListDiv.innerHTML = '';
            transactions.forEach(transaction => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'expense-item';
                itemDiv.dataset.id = transaction.id;

                const amountClass = transaction.type === 'income' ? 'positive' : 'negative';
                const sign = transaction.type === 'income' ? '+' : '-';

                itemDiv.innerHTML = `
                    <div class="expense-item-content">
                        <span class="badge">${transaction.category}</span>
                        <span class="item-name">${transaction.name}</span>
                        <span class="item-date">(${transaction.date})</span>
                    </div>
                    <div class="expense-item-amount ${amountClass}">
                        ${sign}${formatMoney(transaction.amount)}
                    </div>
                    <div class="expense-item-actions">
                        <button class="edit-btn">ìˆ˜ì •</button>
                        <button class="delete-btn">ì‚­ì œ</button>
                    </div>
                `;
                transactionListDiv.appendChild(itemDiv);
            });
        };

        // ê±°ë˜ ë‚´ì—­ ìˆ˜ì •/ì‚­ì œ
        transactionListDiv.addEventListener('click', (e) => {
            const id = parseInt(e.target.closest('.expense-item').dataset.id);
            const index = transactions.findIndex(t => t.id === id);

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    transactions.splice(index, 1);
                    saveData();
                }
            } else if (e.target.classList.contains('edit-btn')) {
                const itemDiv = e.target.closest('.expense-item');
                const transaction = transactions[index];

                itemDiv.innerHTML = `
                    <div class="expense-item-content">
                        <input type="text" class="edit-name" value="${transaction.name}">
                        <input type="number" class="edit-amount" value="${transaction.amount}" min="0">
                    </div>
                    <div class="expense-item-actions">
                        <button class="save-edit-btn">ì €ì¥</button>
                        <button class="cancel-edit-btn">ì·¨ì†Œ</button>
                    </div>
                `;
            } else if (e.target.classList.contains('save-edit-btn')) {
                const itemDiv = e.target.closest('.expense-item');
                const newName = itemDiv.querySelector('.edit-name').value.trim();
                const newAmount = parseFloat(itemDiv.querySelector('.edit-amount').value);

                if (newName && !isNaN(newAmount) && newAmount > 0) {
                    transactions[index].name = newName;
                    transactions[index].amount = newAmount;
                    saveData();
                } else {
                    alert('ìœ íš¨í•œ í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            } else if (e.target.classList.contains('cancel-edit-btn')) {
                saveData(); // Simply re-render to revert
            }
        });

        // ìš”ì•½ ì •ë³´ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const updateUI = () => {
            renderTransactions();
            updateSummaries();
            updateCharts();
            renderIncomeFlowDetails();
        };

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        const updateSummaries = () => {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalIncome - totalExpense;

            const totalAssets = totalIncome - totalExpense; // ì˜ˆì‹œ: ë‹¨ìˆœ ì´ ìˆ˜ì… - ì´ ì§€ì¶œë¡œ ìì‚° ê³„ì‚° (í˜„ê¸ˆì„± ìì‚°)
            const spendingRatio = totalIncome > 0 ? ((totalExpense / totalIncome) * 100).toFixed(1) : 0;
            const savingsRatio = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;

            totalIncomeDisplay.textContent = formatMoney(totalIncome);
            totalExpenseDisplay.textContent = formatMoney(totalExpense);
            netProfitDisplay.textContent = formatMoney(netProfit);

            totalAssetsDisplay.textContent = formatMoney(totalAssets);
            totalAssetsDisplay.className = `card-amount ${totalAssets >= 0 ? 'positive' : 'negative'}`;

            spendingRatioDisplay.textContent = `${spendingRatio}%`;
            savingsRatioDisplay.textContent = `${savingsRatio}%`;

            if (spendingRatioDisplay.nextElementSibling && spendingRatioDisplay.nextElementSibling.classList.contains('card-sub')) {
                const spendingRatioCard = spendingRatioDisplay.closest('.summary-card');
                if (spendingRatioCard) {
                    const percentageDiv = document.createElement('div');
                    percentageDiv.className = 'card-percentage';
                    percentageDiv.innerHTML = `ì†Œë¹„ìœ¨: <span class="highlighted-percentage">${spendingRatio}%</span>`;
                    // Check if already exists to prevent duplicates
                    if (!spendingRatioCard.querySelector('.card-percentage')) {
                         // Spending ratio card usually doesn't have its own percentage area
                         // This is just to demonstrate where it might go if needed, but current design has it in card-amount
                    }
                }
            }
        };

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const updateCharts = () => {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            // ì†Œë“ íë¦„ ë°°ë¶„ (íŒŒì´ ì°¨íŠ¸)
            const preTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            const postTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .reduce((sum, item) => sum + item.amount, 0);

            let availableIncome = totalIncome;
            let taxAmount = 0; // ì„¸ê¸ˆ ê³„ì‚° ë¡œì§ ì¶”ê°€ í•„ìš”

            // ì„¸ê¸ˆ ê³„ì‚° (ì˜ˆì‹œ: ì†Œë“ì˜ 10%ë¥¼ ì„¸ê¸ˆìœ¼ë¡œ ê°€ì •)
            // ì´ ë¶€ë¶„ì€ ì‹¤ì œ ì„¸ìœ¨ ë° ê³µì œ í•­ëª©ì— ë”°ë¼ ë³µì¡í•˜ê²Œ ê³„ì‚°ë˜ì–´ì•¼ í•¨
            if (totalIncome > 0) {
                taxAmount = totalIncome * 0.1; // ê°„ë‹¨í•œ ì˜ˆì‹œ ì„¸ê¸ˆ
                availableIncome = totalIncome - preTaxDeductions - taxAmount;
            } else {
                availableIncome = 0;
            }

            const remainingBalance = availableIncome - postTaxDeductions - totalExpense;

            const incomeFlowData = {
                labels: ['ì„¸ì „ ê³µì œ', 'ì„¸ê¸ˆ', 'ì„¸í›„ ê³µì œ', 'ì´ ì§€ì¶œ', 'ë‚¨ì€ ì”ì•¡'],
                datasets: [{
                    data: [
                        preTaxDeductions,
                        taxAmount,
                        postTaxDeductions,
                        totalExpense,
                        Math.max(0, remainingBalance) // ì”ì•¡ì´ ë§ˆì´ë„ˆìŠ¤ë©´ 0ìœ¼ë¡œ í‘œì‹œ
                    ],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }]
            };

            if (incomeFlowChartInstance) {
                incomeFlowChartInstance.data = incomeFlowData;
                incomeFlowChartInstance.update();
            } else {
                const ctx = document.getElementById('incomeFlowChart').getContext('2d');
                incomeFlowChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: incomeFlowData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ë”°ë¦„
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${formatMoney(value)} (${percentage}%)`; // ì—¬ê¸°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
                                    }
                                }
                            },
                            legend: {
                                position: 'right', // ë²”ë¡€ ìœ„ì¹˜
                            }
                            // datalabels: { // Chart.js Datalabels Plugin ì‚¬ìš© ì‹œ
                            //     formatter: (value, ctx) => {
                            //         const total = ctx.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                            //         const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            //         return percentage;
                            //     },
                            //     color: '#fff',
                            //     font: {
                            //         weight: 'bold'
                            //     }
                            // }
                        }
                    }
                });
            }

            // ì§€ì¶œ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘ (ë„ë„› ì°¨íŠ¸)
            const expenseCategoryMap = transactions
                .filter(t => t.type === 'expense')
                .reduce((map, t) => {
                    map[t.category] = (map[t.category] || 0) + t.amount;
                    return map;
                }, {});

            const expenseCategories = Object.keys(expenseCategoryMap);
            const expenseAmounts = Object.values(expenseCategoryMap);
            const expenseColors = expenseCategories.map((_, i) => `hsl(${i * 60}, 70%, 60%)`); // ë™ì  ìƒ‰ìƒ

            const expenseCategoryData = {
                labels: expenseCategories,
                datasets: [{
                    data: expenseAmounts,
                    backgroundColor: expenseColors,
                    hoverBackgroundColor: expenseColors
                }]
            };

            if (expenseCategoryChartInstance) {
                expenseCategoryChartInstance.data = expenseCategoryData;
                expenseCategoryChartInstance.update();
            } else {
                const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
                expenseCategoryChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: expenseCategoryData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ë”°ë¦„
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${formatMoney(value)} (${percentage}%)`; // ì—¬ê¸°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
                                    }
                                }
                            },
                            legend: {
                                position: 'right', // ë²”ë¡€ ìœ„ì¹˜
                            }
                            // datalabels: { // Chart.js Datalabels Plugin ì‚¬ìš© ì‹œ
                            //     formatter: (value, ctx) => {
                            //         const total = ctx.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                            //         const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            //         return percentage;
                            //     },
                            //     color: '#fff',
                            //     font: {
                            //         weight: 'bold'
                            //     }
                            // }
                        }
                    }
                });
            }
        };

        // ìˆœì´ìµ ë° ìê¸ˆ íë¦„ ìƒì„¸ ë‚´ì—­ ë Œë”ë§
        const renderIncomeFlowDetails = () => {
            incomeFlowDetailsDiv.innerHTML = '';
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            let currentBalance = totalIncome;

            const addFlowItem = (label, amount, className = '') => {
                const percentage = totalIncome > 0 ? ((amount / totalIncome) * 100).toFixed(1) : 0;
                const sign = amount >= 0 ? '+' : '-'; // Make sure sign is correct for deductions too
                const flowItem = document.createElement('div');
                flowItem.className = `flow-item ${className}`;
                flowItem.innerHTML = `
                    <span>${label}</span>
                    <span class="flow-amount ${amount < 0 ? 'negative' : ''}">${sign}${formatMoney(Math.abs(amount))}
                        <span class="percentage">(${percentage}%)</span>
                    </span>
                `;
                incomeFlowDetailsDiv.appendChild(flowItem);
            };

            const addArrow = () => {
                const arrow = document.createElement('div');
                arrow.className = 'flow-arrow';
                arrow.innerHTML = '&#x2193;'; // Down arrow
                incomeFlowDetailsDiv.appendChild(arrow);
            };

            addFlowItem('ì´ ìˆ˜ì…', totalIncome, 'result');
            addArrow();

            // ì„¸ì „ ê³µì œ
            const preTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            if (preTaxDeductions > 0) {
                addFlowItem('ì„¸ì „ ê³µì œ ì´ê³„', -preTaxDeductions, 'highlighted info');
                currentBalance -= preTaxDeductions;
                addArrow();
            }
            incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .forEach(item => {
                    const percentage = totalIncome > 0 ? ((item.amount / totalIncome) * 100).toFixed(1) : 0;
                    incomeFlowDetailsDiv.innerHTML += `
                        <div class="flow-item sub-item">
                            <span>${item.name}</span>
                            <span class="flow-amount negative">-${formatMoney(item.amount)} <span class="percentage">(${percentage}%)</span></span>
                            <button class="delete-flow-item-btn delete-btn" data-id="${item.id}" data-type="${item.type}">ì‚­ì œ</button>
                        </div>
                    `;
                });

            // ì„¸ê¸ˆ (ì„ì‹œ ê³„ì‚°)
            let taxAmount = 0;
            if (totalIncome > 0) {
                taxAmount = totalIncome * 0.1; // 10%
                currentBalance -= taxAmount;
                addFlowItem('ì˜ˆìƒ ì„¸ê¸ˆ', -taxAmount, 'highlighted info');
                addArrow();
            }

            // ì„¸í›„ ê³µì œ
            const postTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            if (postTaxDeductions > 0) {
                addFlowItem('ì„¸í›„ ê³µì œ ì´ê³„', -postTaxDeductions, 'highlighted info');
                currentBalance -= postTaxDeductions;
                addArrow();
            }
            incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .forEach(item => {
                    const percentage = totalIncome > 0 ? ((item.amount / totalIncome) * 100).toFixed(1) : 0;
                    incomeFlowDetailsDiv.innerHTML += `
                        <div class="flow-item sub-item">
                            <span>${item.name}</span>
                            <span class="flow-amount negative">-${formatMoney(item.amount)} <span class="percentage">(${percentage}%)</span></span>
                            <button class="delete-flow-item-btn delete-btn" data-id="${item.id}" data-type="${item.type}">ì‚­ì œ</button>
                        </div>
                    `;
                });

            // ì´ ì§€ì¶œ
            if (totalExpense > 0) {
                addFlowItem('ì´ ì§€ì¶œ', -totalExpense, 'highlighted');
                currentBalance -= totalExpense;
                addArrow();
            }

            addFlowItem('ìµœì¢… ì”ì•¡', currentBalance, 'result');

            // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì‚­ì œ ë²„íŠ¼)
            incomeFlowDetailsDiv.querySelectorAll('.delete-flow-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToDelete = parseInt(e.target.dataset.id);
                    incomeFlowItems = incomeFlowItems.filter(item => item.id !== idToDelete);
                    saveData();
                });
            });
        };

        // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ ì¶”ê°€/ì·¨ì†Œ ë²„íŠ¼ í† ê¸€
        toggleCategoryInputBtn.addEventListener('click', () => {
            categoryInputContainer.style.display = categoryInputContainer.style.display === 'flex' ? 'none' : 'flex';
            newCategoryNameInput.value = ''; // Clear input on toggle
        });

        cancelAddCategoryBtn.addEventListener('click', () => {
            categoryInputContainer.style.display = 'none';
            newCategoryNameInput.value = '';
        });

        addCategoryBtn.addEventListener('click', () => {
            const newCategoryName = newCategoryNameInput.value.trim();
            const newCategoryType = newCategoryTypeSelect.value;
            if (newCategoryName) {
                if (!customCategories[newCategoryType].includes(newCategoryName)) {
                    customCategories[newCategoryType].push(newCategoryName);
                    saveData();
                    updateCategoryOptions(); // Update select options
                    alert(`'${newCategoryName}' (${newCategoryType === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'}) ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    newCategoryNameInput.value = ''; // Clear input
                    categoryInputContainer.style.display = 'none'; // Hide input area
                } else {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
                }
            } else {
                alert('ìƒˆ ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        // ìˆ˜ì…/ì§€ì¶œ ì„ íƒ ë³€ê²½ ì‹œ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸
        itemTypeSelect.addEventListener('change', updateCategoryOptions);


        // ì†Œë“ íë¦„ í•­ëª© ì¶”ê°€ í† ê¸€ ë° ë¡œì§
        document.querySelector('.income-flow h2').addEventListener('click', () => {
            // í—¤ë” í´ë¦­ ì‹œ ìƒì„¸ í•­ëª© ì¶”ê°€ UI í† ê¸€
            const isPreTaxVisible = preTaxCustomContainer.style.display === 'flex';
            const isPostTaxVisible = postTaxCustomContainer.style.display === 'flex';

            if (!isPreTaxVisible && !isPostTaxVisible) {
                preTaxCustomContainer.style.display = 'flex';
                postTaxCustomContainer.style.display = 'flex';
            } else {
                preTaxCustomContainer.style.display = 'none';
                postTaxCustomContainer.style.display = 'none';
            }
        });

        // ì„¸ì „ ê³µì œ í•­ëª© ì¶”ê°€
        document.getElementById('add-pre-tax-custom').addEventListener('click', () => {
            const name = document.getElementById('pre-tax-custom-name').value.trim();
            const amount = parseFloat(document.getElementById('pre-tax-custom-amount').value);
            if (name && !isNaN(amount) && amount > 0) {
                incomeFlowItems.push({ id: Date.now(), name, amount, type: 'pre-tax' });
                document.getElementById('pre-tax-custom-name').value = '';
                document.getElementById('pre-tax-custom-amount').value = '';
                saveData();
            } else {
                alert('í•­ëª©ëª…ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì„¸ì „ ê³µì œ í•­ëª© ì¶”ê°€ ì·¨ì†Œ
        document.getElementById('cancel-pre-tax-custom').addEventListener('click', () => {
            document.getElementById('pre-tax-custom-name').value = '';
            document.getElementById('pre-tax-custom-amount').value = '';
            preTaxCustomContainer.style.display = 'none';
        });

        // ì„¸í›„ ê³µì œ í•­ëª© ì¶”ê°€
        document.getElementById('add-post-tax-custom').addEventListener('click', () => {
            const name = document.getElementById('post-tax-custom-name').value.trim();
            const amount = parseFloat(document.getElementById('post-tax-custom-amount').value);
            if (name && !isNaN(amount) && amount > 0) {
                incomeFlowItems.push({ id: Date.now(), name, amount, type: 'post-tax' });
                document.getElementById('post-tax-custom-name').value = '';
                document.getElementById('post-tax-custom-amount').value = '';
                saveData();
            } else {
                alert('í•­ëª©ëª…ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì„¸í›„ ê³µì œ í•­ëª© ì¶”ê°€ ì·¨ì†Œ
        document.getElementById('cancel-post-tax-custom').addEventListener('click', () => {
            document.getElementById('post-tax-custom-name').value = '';
            document.getElementById('post-tax-custom-amount').value = '';
            postTaxCustomContainer.style.display = 'none';
        });

        // ëª¨ë“  ë°ì´í„° ì‚­ì œ
        clearAllDataBtn.addEventListener('click', () => {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                transactions = [];
                customCategories = { income: [], expense: [] };
                incomeFlowItems = [];
                saveData();
                updateCategoryOptions(); // Reset categories
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ë³´ê³ ì„œ ì¸ì‡„
        printReportBtn.addEventListener('click', () => {
            window.print();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ UI ì—…ë°ì´íŠ¸
        updateUI();

        // Chart.js DataLabels Plugin ë“±ë¡ (ì„ íƒ ì‚¬í•­: ì£¼ì„ í•´ì œ ì‹œ ì‚¬ìš©)
        // Chart.register(ChartDataLabels);
    </script>
</body>
</html>
