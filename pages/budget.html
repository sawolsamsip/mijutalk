<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title-head">예산 관리 시스템 (USD)</title>

    <!-- Chart.js 핵심 라이브러리 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- chartjs-plugin-datalabels 플러그인 (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- Inline CSS for styling -->
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #F44336;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --card-bg: #fff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .app-header {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .app-header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
            flex-grow: 1; /* Allow title to take available space */
        }

        .language-selector-wrapper {
            margin-left: 20px; /* Space from title */
        }

        #language-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            font-size: 1rem;
            cursor: pointer;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .card label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Ensures label takes full width for input below */
            color: var(--text-color);
        }

        .card input[type="number"],
        .card input[type="text"],
        .card select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
            color: var(--text-color);
            background-color: var(--light-bg);
        }

        .card input[type="number"]:focus,
        .card input[type="text"]:focus,
        .card select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .flex {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Allow wrapping for responsiveness */
        }

        .flex > div {
            flex: 1; /* Distribute space evenly */
            min-width: 120px; /* Minimum width for flex items */
        }

        .category-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .category-input-container input[type="text"],
        .category-input-container input[type="number"] {
            flex: 1;
            min-width: 100px; /* Ensure inputs don't become too small */
        }

        .category-input-container button {
            flex-shrink: 0; /* Prevent buttons from shrinking */
            width: auto;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-input-container button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .category-input-container button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Specific button styles for add/update/cancel within sections */
        .add-item-btn,
        .update-item-btn,
        .cancel-item-btn {
            flex-grow: 1;
            max-width: 120px; /* Limit button width within flex container */
        }

        .update-item-btn {
            background-color: var(--secondary-color) !important; /* Override general button style */
        }
        .update-item-btn:hover {
            background-color: #1976d2 !important;
        }

        .cancel-item-btn {
            background-color: #6c757d !important; /* Specific neutral color */
        }
        .cancel-item-btn:hover {
            background-color: #5a6268 !important;
        }

        .hidden {
            display: none !important; /* Force hide element */
        }

        .item-list {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: bold;
            flex-grow: 1;
            margin-right: 10px;
        }

        .item-amount {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap; /* Prevent wrapping for amounts */
        }

        .item-edit-btn,
        .item-delete-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .item-edit-btn {
            color: var(--secondary-color);
        }
        .item-edit-btn:hover {
            background-color: rgba(33, 150, 243, 0.1);
        }

        .item-delete-btn {
            color: var(--danger-color);
        }
        .item-delete-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        /* Income Flow */
        .income-flow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
        }

        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 8px;
            background-color: var(--light-bg);
            align-items: center;
        }

        .flow-item.highlighted {
            background-color: #fce8d2; /* Light orange for deductions/taxes */
        }

        .flow-item.info {
            background-color: #e3f2fd; /* Light blue for info */
            border-left: 4px solid var(--secondary-color);
        }

        .flow-item.result {
            background-color: #d4edda; /* Light green for net income */
            border-left: 4px solid var(--primary-color);
            font-size: 1.1em;
            font-weight: bold;
        }

        .flow-arrow {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
        }

        .flow-label {
            font-weight: bold;
        }

        .flow-amount {
            white-space: nowrap;
        }

        .percentage {
            font-size: 0.9em;
            color: #666;
            margin-left: 5px;
        }

        .highlighted-percentage {
            color: var(--danger-color); /* For deductions */
        }
        .flow-item.result .highlighted-percentage {
            color: var(--primary-color); /* For positive results */
        }


        /* Summary Cards */
        .summary-cards {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 5px solid var(--primary-color); /* Default border */
        }

        .summary-card.accent {
            border-color: var(--accent-color);
        }

        .card-label {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        .card-amount {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .card-amount.negative {
            color: var(--danger-color);
        }

        .card-sub {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .card-percentage {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: bold;
        }

        /* Charts */
        .chart-container {
            padding-bottom: 40px; /* Extra padding for chart legends/labels */
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr; /* Single column on small screens */
            gap: 30px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
            }
        }

        .charts-grid > div {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .charts-grid h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Utility Buttons */
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .utility-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .utility-btn:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
        }

        .utility-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .utility-btn.print {
            background-color: #607d8b;
        }
        .utility-btn.print:hover {
            background-color: #455a64;
        }

        .utility-btn[style*="background-color: var(--danger-color);"] {
            background-color: var(--danger-color);
        }
        .utility-btn[style*="background-color: var(--danger-color);"]:hover {
            background-color: #d32f2f;
        }


        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            max-width: 400px;
            width: 90%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: scaleIn 0.3s ease-out forwards;
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--text-color);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-button.alert-ok {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-button.alert-ok:hover {
            background-color: #45a049;
        }

        .modal-button.confirm-yes {
            background-color: var(--danger-color);
            color: white;
        }
        .modal-button.confirm-yes:hover {
            background-color: #d32f2f;
        }

        .modal-button.confirm-no {
            background-color: #6c757d;
            color: white;
        }
        .modal-button.confirm-no:hover {
            background-color: #5a6268;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .language-selector-wrapper {
                margin-left: 0;
                width: 100%;
            }
            
            #language-select {
                width: 100%;
            }

            .flex,
            .category-input-container,
            .summary-cards,
            .utility-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .flex > div,
            .category-input-container input,
            .category-input-container button,
            .summary-card,
            .utility-btn {
                width: 100%;
                min-width: unset;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 id="app-title">� 예산 관리 시스템 (USD)</h1>
        <div class="language-selector-wrapper">
            <label for="language-select" class="sr-only" id="language-label">언어 선택</label>
            <select id="language-select">
                <option value="ko">🇰🇷 한국어</option>
                <option value="en">🇺🇸 English</option>
                <option value="zh">🇨🇳 简体中文</option>
            </select>
        </div>
    </header>

    <main>
        <div class="card">
            <h2 id="income-title">월급</h2>
            <label for="income" id="income-label">세전 월급액 ($)</label>
            <input type="number" id="income" placeholder="0">
        </div>

        <!-- Taxes Section -->
        <div class="card" data-category="taxes">
            <h2 id="tax-title">세금</h2>
            <label for="taxes-type" id="tax-type-label">세금 종류</label>
            <select id="taxes-type" class="category-select">
                <option value="" disabled selected id="tax-select-placeholder">세금 종류 선택</option>
                <option value="federal_withholding">Federal Withholding</option>
                <option value="state_tax_ca">State Tax (CA)</option>
                <option value="oasdi_social_security">OASDI (Social Security)</option>
                <option value="medicare">Medicare</option>
                <option value="ca_sdi">CA SDI</option>
                <option value="custom" id="tax-option-custom">직접 입력</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="세금 항목명 입력" style="display: none;">
                <input type="number" class="amount-input" placeholder="금액 ($)">
                <button class="add-item-btn" id="tax-add-button">추가</button>
            </div>
            <div class="item-list" id="taxes-list"></div>
        </div>

        <!-- Pre-Tax Deductions Section -->
        <div class="card" data-category="preTax">
            <h2 id="pre-tax-title">세전 공제</h2>
            <label for="preTax-type" id="pre-tax-type-label">공제 항목</label>
            <select id="preTax-type" class="category-select">
                <option value="" disabled selected id="pre-tax-select-placeholder">공제 항목 선택</option>
                <option value="four_01k_traditional">401k Traditional</option>
                <option value="medical_premium">Medical Premium</option>
                <option value="dental_premium">Dental Premium</option>
                <option value="vision_premium">Vision Premium</option>
                <option value="mseap">MSEAP</option>
                <option value="custom" id="pre-tax-option-custom">직접 입력</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="공제 항목명 입력" style="display: none;">
                <input type="number" class="amount-input" placeholder="금액 ($)">
                <button class="add-item-btn" id="pre-tax-add-button">추가</button>
            </div>
            <div class="item-list" id="preTax-list"></div>
        </div>

        <!-- Post-Tax Deductions Section -->
        <div class="card" data-category="postTax">
            <h2 id="post-tax-title">세후 공제</h2>
            <label for="postTax-type" id="post-tax-type-label">공제 항목</label>
            <select id="postTax-type" class="category-select">
                <option value="" disabled selected id="post-tax-select-placeholder">공제 항목 선택</option>
                <option value="four_01k_roth">401k Roth</option>
                <option value="legal_services">Legal Services</option>
                <option value="ltd">LTD</option>
                <option value="stock_purchase_plan">Stock Purchase Plan</option>
                <option value="ad_and_d">AD&D</option>
                <option value="critical_illness">Critical Illness</option>
                <option value="accident_insurance">Accident Insurance</option>
                <option value="custom" id="post-tax-option-custom">직접 입력</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="공제 항목명 입력" style="display: none;">
                <input type="number" class="amount-input" placeholder="금액 ($)">
                <button class="add-item-btn" id="post-tax-add-button">추가</button>
            </div>
            <div class="item-list" id="postTax-list"></div>
        </div>

        <!-- Expense Management Section -->
        <div class="card">
            <h2 id="expense-management-title">지출 관리</h2>
            <div class="flex">
                <div style="flex: 1;">
                    <label for="category" id="category-label">카테고리</label>
                    <select id="category"></select>
                </div>
                <div style="flex: 2;">
                    <label for="expense-name" id="expense-name-label">항목명</label>
                    <input type="text" id="expense-name" placeholder="예: 월세">
                </div>
                <div style="flex: 1;">
                    <label for="expense-amount" id="expense-amount-label">금액</label>
                    <input type="number" id="expense-amount" placeholder="$">
                </div>
            </div>
            <div class="category-input-container">
                <label for="new-category" class="sr-only" id="new-category-label">새 카테고리명</label>
                <input type="text" id="new-category" placeholder="새 카테고리명 입력" style="flex: 1;">
                <button id="add-category-button" style="flex-shrink: 0; width: auto;">카테고리 추가</button>
            </div>
            <button id="add-expense-button" style="width: 100%; margin-top: 1rem;">지출 추가</button>
            <div class="item-list" id="expenses-list"></div>
        </div>

        <!-- Monthly Financial Status Section -->
        <div class="card">
            <h2 id="monthly-financial-status-title">📊 월별 재무 현황</h2>
            <div class="income-flow">
                <!-- Flow items will be dynamically updated by JS -->
            </div>
            <div class="summary-cards">
                <!-- Summary cards will be dynamically updated by JS -->
            </div>
        </div>

        <!-- Financial Analysis Charts Section -->
        <div class="card chart-container">
            <h2 id="financial-analysis-chart-title">📈 재무 분석 차트</h2>
            <div class="charts-grid">
                <div>
                    <h3 id="income-flow-chart-title">자금 흐름 배분 (총 수입 대비)</h3>
                    <canvas id="incomeFlowChart"></canvas>
                </div>
                <div>
                    <h3 id="expense-category-chart-title">지출 카테고리별 비중 (총 지출 대비)</h3>
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Utility Buttons Section -->
        <div class="utility-buttons">
            <button class="utility-btn" id="save-button">💾 저장하기</button>
            <button class="utility-btn" id="load-button">📂 불러오기</button>
            <button class="utility-btn print" onclick="window.print()">🖨️ 인쇄하기</button>
            <button class="utility-btn" id="reset-button" style="background-color: var(--danger-color);">🔄 초기화</button>
        </div>
    </main>

    <!-- Custom Modal Structure -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message" class="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <!-- Inline JavaScript for functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- IMPORTANT: Register Chart.js plugins ---
            // This is crucial for datalabels to appear on charts.
            // Ensure Chart.js and ChartDataLabels are loaded from HTML before this point.
            Chart.register(ChartDataLabels);

            // --- STATE MANAGEMENT ---
            let state = {
                language: 'ko',
                income: 0,
                taxes: [], // { id, name, amount }
                preTax: [],
                postTax: [],
                expenses: [], // { id, category, name, amount }
                expenseCategories: ['주거', '교통', '식비', '생활', '오락', '기타'],
            };

            // --- TRANSLATIONS (i18n) ---
            const translations = {
                ko: {
                    'app-title': '💰 예산 관리 시스템 (USD)', 'income-title': '월급', 'income-label': '세전 월급액 ($)', 
                    'tax-title': '세금', 'tax-type-label': '세금 종류', 'tax-select-placeholder': '세금 종류 선택', 'tax-option-custom': '직접 입력', 'tax_custom_name_placeholder': '세금 항목명 입력', 'tax-amount-placeholder': '금액 ($)', 'tax-add-button': '추가', 'tax-update-button': '업데이트', 'tax-cancel-button': '취소', 
                    'pre-tax-title': '세전 공제', 'pre-tax-type-label': '공제 항목', 'pre-tax-select-placeholder': '공제 항목 선택', 'pre-tax-option-custom': '직접 입력', 'pre_tax_custom_name_placeholder': '공제 항목명 입력', 'pre-tax-amount-placeholder': '금액 ($)', 'pre-tax-add-button': '추가', 'pre-tax-update-button': '업데이트', 'pre-tax-cancel-button': '취소', 
                    'post-tax-title': '세후 공제', 'post-tax-type-label': '공제 항목', 'post-tax-select-placeholder': '공제 항목 선택', 'post-tax-option-custom': '직접 입력', 'post_tax_custom_name_placeholder': '공제 항목명 입력', 'post-tax-amount-placeholder': '금액 ($)', 'post-tax-add-button': '추가', 'post-tax-update-button': '업데이트', 'post-tax-cancel-button': '취소',
                    'expense-management-title': '지출 관리', 'category-label': '카테고리', 'expense-name-label': '항목명', 'expense-name-placeholder': '예: 월세', 'expense-amount-label': '금액', 
                    'new-category-placeholder': '새 카테고리명 입력', 'add-category-button': '카테고리 추가', 'add-expense-button': '지출 추가', 'update-expense-button': '지출 업데이트', 'cancel-expense-button': '취소',
                    'monthly-financial-status-title': '📊 월별 재무 현황', 'financial-analysis-chart-title': '📈 재무 분석 차트', 'income-flow-chart-title': '자금 흐름 배분 (총 수입 대비)', 'expense-category-chart-title': '지출 카테고리별 비중 (총 지출 대비)', 
                    'save-button': '💾 저장하기', 'load-button': '📂 불러오기', 'print-button': '🖨️ 인쇄하기', 'reset-button': '🔄 초기화',
                    gross_income_label: "세전 월급 (총 수입)", pre_tax_deductions_label: "세전 공제", taxable_income_label: "과세 소득", tax_total_label: "세금", post_tax_deductions_label: "세후 공제", total_deductions_taxes_label: "총 공제 및 세금", net_income_label: "순수입 (실수령액)", 
                    total_expenses_card_label: "총 지출", total_expenses_card_sub: "(순수입에서 사용)", remaining_balance_card_label: "남은 잔액", remaining_balance_card_sub: "(저축/투자 가능)", expenses_percentage_text: "총 수입의", remaining_percentage_text: "총 수입의",
                    alert_valid_amount: "올바른 금액을 입력하세요.", alert_custom_name: "사용자 지정 항목의 이름을 입력하세요.", alert_item_exists: "' 이미 이 카테고리에 존재합니다.", alert_fill_all_fields: "모든 지출 필드를 올바른 데이터로 채우세요.", alert_category_exists: "카테고리가 이미 존재합니다.",
                    confirm_reset: "모든 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.", alert_data_saved: "데이터가 성공적으로 저장되었습니다.", alert_save_failed: "데이터 저장에 실패했습니다.", alert_data_loaded: "데이터를 성공적으로 불러왔습니다.", alert_load_failed: "데이터 불러오기에 실패했습니다. 데이터가 손상되었을 수 있습니다.", alert_no_data: "저장된 데이터가 없습니다.", alert_data_reset: "데이터가 초기화되었습니다.",
                    confirm_delete_item: "정말로 이 항목을 삭제하시겠습니까?" 
                },
                en: {
                    'app-title': '💰 Budget Management System (USD)', 'income-title': 'Salary', 'income-label': 'Gross Monthly Salary ($)', 
                    'tax-title': 'Taxes', 'tax-type-label': 'Tax Type', 'tax-select-placeholder': 'Select tax type', 'tax-option-custom': 'Custom', 'tax_custom_name_placeholder': 'Enter tax name', 'tax-amount-placeholder': 'Amount ($)', 'tax-add-button': 'Add', 'tax-update-button': 'Update', 'tax-cancel-button': 'Cancel', 
                    'pre-tax-title': 'Pre-Tax Deductions', 'pre-tax-type-label': 'Deduction Item', 'pre-tax-select-placeholder': 'Select deduction', 'pre-tax-option-custom': 'Custom', 'pre_tax_custom_name_placeholder': 'Enter deduction name', 'pre-tax-amount-placeholder': 'Amount ($)', 'pre-tax-add-button': 'Add', 'pre-tax-update-button': 'Update', 'pre-tax-cancel-button': 'Cancel', 
                    'post-tax-title': 'Post-Tax Deductions', 'post-tax-type-label': 'Deduction Item', 'post-tax-select-placeholder': 'Select deduction', 'post-tax-option-custom': 'Custom', 'post_tax_custom_name_placeholder': 'Enter deduction name', 'post-tax-amount-placeholder': 'Amount ($)', 'post-tax-add-button': 'Add', 'post-tax-update-button': 'Update', 'post-tax-cancel-button': 'Cancel',
                    'expense-management-title': 'Expense Management', 'category-label': 'Category', 'expense-name-label': 'Item Name', 'expense-name-placeholder': 'e.g., Rent', 'expense-amount-label': 'Amount', 
                    'new-category-placeholder': 'Enter new category name', 'add-category-button': 'Add Category', 'add-expense-button': 'Add Expense', 'update-expense-button': 'Update Expense', 'cancel-expense-button': 'Cancel', 
                    'monthly-financial-status-title': '📊 Monthly Financial Status', 'financial-analysis-chart-title': '📈 Financial Analysis Charts', 'income-flow-chart-title': 'Fund Flow Distribution (vs. Gross Income)', 'expense-category-chart-title': 'Expense Breakdown by Category (vs. Total Expenses)', 
                    'save-button': '💾 Save', 'load-button': '📂 Load', 'print-button': '🖨️ Print', 'reset-button': '🔄 Reset',
                    gross_income_label: "Gross Salary (Total Income)", pre_tax_deductions_label: "Pre-Tax Deductions", taxable_income_label: "Taxable Income", tax_total_label: "Taxes", post_tax_deductions_label: "Post-Tax Deductions", total_deductions_taxes_label: "Total Deductions & Taxes", net_income_label: "Net Income (Take-Home Pay)", 
                    total_expenses_card_label: "Total Expenses", total_expenses_card_sub: "(spent from Net Income)", remaining_balance_card_label: "Remaining Balance", remaining_balance_card_sub: "(for Savings/Investments)", expenses_percentage_text: "of Gross Income", remaining_percentage_text: "of Gross Income",
                    alert_valid_amount: "Please enter a valid amount.", alert_custom_name: "Please enter a name for the custom item.", alert_item_exists: "' already exists in this category.", alert_fill_all_fields: "Please fill all expense fields with valid data.", alert_category_exists: "Category already exists.",
                    confirm_reset: "Are you sure you want to reset all data? This cannot be undone.", alert_data_saved: "Data saved successfully!", alert_save_failed: "Failed to save data.", alert_data_loaded: "Data loaded successfully!", alert_load_failed: "Failed to load data. It might be corrupted.", alert_no_data: "No saved data found.", alert_data_reset: "Data has been reset.",
                    confirm_delete_item: "Are you sure you want to delete this item?"
                },
                zh: {
                    'app-title': '💰 预算管理系统 (USD)', 'income-title': '薪水', 'income-label': '세전 월급액 ($)', 
                    'tax-title': '세금', 'tax-type-label': '세종', 'tax-select-placeholder': '선택 세종', 'tax-option-custom': '自定义', 'tax_custom_name_placeholder': '输入税项名称', 'tax-amount-placeholder': '金額 ($)', 'tax-add-button': '添加', 'tax-update-button': '更新', 'tax-cancel-button': '取消', 
                    'pre-tax-title': '세전 공제', 'pre-tax-type-label': '공제 항목', 'pre-tax-select-placeholder': '선택 공제 항목', 'pre-tax-option-custom': '自定义', 'pre_tax_custom_name_placeholder': '输入扣除名称', 'pre-tax-amount-placeholder': '金額 ($)', 'pre-tax-add-button': '添加', 'pre-tax-update-button': '更新', 'pre-tax-cancel-button': '取消', 
                    'post-tax-title': '세후 공제', 'post-tax-type-label': '공제 항목', 'post-tax-select-placeholder': '선택 공제 항목', 'post-tax-option-custom': '自定义', 'post_tax_custom_name_placeholder': '输入扣除名称', 'post-tax-amount-placeholder': '金額 ($)', 'post-tax-add-button': '添加', 'post-tax-update-button': '更新', 'post-tax-cancel-button': '取消',
                    'expense-management-title': '지출 관리', 'category-label': '类别', 'expense-name-label': '항목명', 'expense-name-placeholder': '예: 월세', 'expense-amount-label': '金額', 
                    'new-category-placeholder': '输入新类别名称', 'add-category-button': '添加类别', 'add-expense-button': '添加支出', 'update-expense-button': '更新支出', 'cancel-expense-button': '取消', 
                    'monthly-financial-status-title': '📊 每월 재무 현황', 'financial-analysis-chart-title': '📈 재무 분석 차트', 'income-flow-chart-title': '資金流分配 (與總收入相比)', 'expense-category-chart-title': '按类别划分的支出明细 (與總支出相比)', 
                    'save-button': '💾 保存', 'load-button': '📂 加载', 'print-button': '🖨️ 인쇄하기', 'reset-button': '🔄 초기화',
                    gross_income_label: "총薪수 (총收入)", pre_tax_deductions_label: "세전 공제", taxable_income_label: "应税收入", tax_total_label: "세금", post_tax_deductions_label: "세후 공제", total_deductions_taxes_label: "总 공제 및 세금", net_income_label: "净收入 (实得工资)", 
                    total_expenses_card_label: "总支出", total_expenses_card_sub: "(从净收入中支出)", remaining_balance_card_label: "剩余余额", remaining_balance_card_sub: "(用於储蓄/投资)", expenses_percentage_text: "총收入의", remaining_percentage_text: "총收入의",
                    alert_valid_amount: "请输入有效金額。", alert_custom_name: "请输入自定义项目的名称。", alert_item_exists: "' 已存在于此类别中。", alert_fill_all_fields: "请用有效数据填写所有费用字段。", alert_category_exists: "类别已存在。",
                    confirm_reset: "您确定要重置所有数据吗？此操作无法撤销。", alert_data_saved: "数据保存成功！", alert_save_failed: "数据保存失败。", alert_data_loaded: "数据加载成功！", alert_load_failed: "加载数据失败。数据可能已损坏。", alert_no_data: "未找到保存的数据。", alert_data_reset: "数据已重置。",
                    confirm_delete_item: "您确定要删除此项目吗？"
                },
            };

            // --- DOM SELECTORS ---
            const incomeInput = document.getElementById('income');
            const langSelect = document.getElementById('language-select');
            const categorySections = document.querySelectorAll('.card[data-category]');
            const addCategoryBtn = document.getElementById('add-category-button');
            const newCategoryInput = document.getElementById('new-category');
            const expenseCategorySelect = document.getElementById('category');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expensesListContainer = document.getElementById('expenses-list');
            const addExpenseBtn = document.getElementById('add-expense-button'); // Original "Add Expense" button
            let updateExpenseBtn = null; // New "Update Expense" button
            let cancelExpenseBtn = null; // New "Cancel Expense" button

            // Modal elements
            const customModalOverlay = document.getElementById('custom-modal-overlay');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            // --- CUSTOM MODAL FUNCTIONS ---
            // Displays an alert-style modal with a message and an "OK" button.
            const showAlertDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `<button class="modal-button alert-ok">OK</button>`;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.alert-ok').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve();
                    };
                });
            };

            // Displays a confirmation-style modal with a message and "Yes/No" buttons.
            const showConfirmDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `
                        <button class="modal-button confirm-yes">Yes</button>
                        <button class="modal-button confirm-no">No</button>
                    `;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.confirm-yes').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(true);
                    };
                    modalButtons.querySelector('.confirm-no').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(false);
                    };
                });
            };

            // --- UTILITY FUNCTIONS ---
            // Formats a number as currency with two decimal places and commas.
            const formatCurrency = (amount) => (amount ? amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00');
            // Generates a unique ID for list items.
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // --- TRANSLATION FUNCTION ---
            // Sets the application language and updates all translatable elements.
            const setLanguage = (lang) => {
                state.language = lang;
                localStorage.setItem('budgetAppLang', lang); // Save language preference
                const t = translations[lang];

                // Update text content and placeholders for elements with matching IDs
                document.querySelectorAll('[id]').forEach(el => {
                    const keyWithSuffix = el.id.replace(/-/g, '_'); // Convert hyphen-case ID to snake_case for potential translation keys
                    const key = el.id.replace(/-label|-title|-button|-placeholder|-text|-sub|-card/g, ''); // Extract base key

                    if (t[keyWithSuffix]) {
                        el.innerHTML = t[keyWithSuffix];
                    } else if (t[key]) {
                        // For placeholders, ensure it's an input/textarea
                        if (el.placeholder !== undefined) el.placeholder = t[key];
                        else el.innerHTML = t[key];
                    }
                });
                
                // Explicitly update placeholders for dynamic/complex elements that might not match simple ID patterns
                document.querySelector('[data-category="taxes"] .custom-name-input').placeholder = t.tax_custom_name_placeholder;
                document.querySelector('[data-category="taxes"] .amount-input').placeholder = t['tax-amount-placeholder'];
                // The add-item-btn text needs to be updated here for initial load
                if (document.querySelector('[data-category="taxes"] .add-item-btn')) {
                    document.querySelector('[data-category="taxes"] .add-item-btn').textContent = t['tax-add-button'];
                }
                
                document.querySelector('[data-category="preTax"] .custom-name-input').placeholder = t.pre_tax_custom_name_placeholder;
                document.querySelector('[data-category="preTax"] .amount-input').placeholder = t['pre-tax-amount-placeholder'];
                if (document.querySelector('[data-category="preTax"] .add-item-btn')) {
                    document.querySelector('[data-category="preTax"] .add-item-btn').textContent = t['pre-tax-add-button'];
                }

                document.querySelector('[data-category="postTax"] .custom-name-input').placeholder = t.post_tax_custom_name_placeholder;
                document.querySelector('[data-category="postTax"] .amount-input').placeholder = t['post-tax-amount-placeholder'];
                if (document.querySelector('[data-category="postTax"] .add-item-btn')) {
                    document.querySelector('[data-category="postTax"] .add-item-btn').textContent = t['post-tax-add-button'];
                }


                document.getElementById('expense-name').placeholder = t['expense-name-placeholder'];
                document.getElementById('expense-amount').placeholder = t['expense-amount-label']; 
                document.getElementById('new-category').placeholder = t['new-category-placeholder'];
                document.getElementById('add-expense-button').textContent = t['add-expense-button']; 

                // If update/cancel buttons exist, update their text
                if (updateExpenseBtn) updateExpenseBtn.textContent = t['update-expense-button'];
                if (cancelExpenseBtn) cancelExpenseBtn.textContent = t['cancel-expense-button'];

                // Update button texts for section-specific update/cancel buttons
                categorySections.forEach(section => {
                    const category = section.dataset.category;
                    const updateBtn = section.querySelector('.update-item-btn');
                    const cancelBtn = section.querySelector('.cancel-item-btn');
                    const addBtn = section.querySelector('.add-item-btn'); // Also update add button text

                    if (updateBtn) updateBtn.textContent = t[`${category}-update-button`];
                    if (cancelBtn) cancelBtn.textContent = t[`${category}-cancel-button`];
                    if (addBtn) addBtn.textContent = t[`${category}-add-button`]; // Important: update 'Add' button text too
                });

                document.documentElement.lang = lang.split('-')[0]; // Set the HTML lang attribute
                fullUpdate(); // Re-render all components with new language
            };
            
            // --- RENDER FUNCTIONS ---
            // Renders the list of taxes, pre-tax, or post-tax items.
            const renderCategorizedList = (category) => {
                const listContainer = document.getElementById(`${category}-list`);
                listContainer.innerHTML = '';
                state[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(item.amount)}</span>
                            <button class="item-edit-btn" data-id="${item.id}" data-category="${category}">수정</button>
                            <button class="item-delete-btn" data-id="${item.id}" data-category="${category}">X</button>
                        </div>
                    `;
                    listContainer.appendChild(itemDiv);
                });
            };

            // Renders the expense category dropdown.
            const renderExpenseCategories = () => {
                expenseCategorySelect.innerHTML = '';
                state.expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    expenseCategorySelect.appendChild(option);
                });
            };

            // Renders the list of expenses.
            const renderExpensesList = () => {
                expensesListContainer.innerHTML = '';
                state.expenses.forEach(exp => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${exp.category}: ${exp.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(exp.amount)}</span>
                            <button class="item-edit-btn" data-id="${exp.id}" data-category="expenses">수정</button>
                            <button class="item-delete-btn" data-id="${exp.id}" data-category="expenses">X</button>
                        </div>
                    `;
                    expensesListContainer.appendChild(itemDiv);
                });
            };

            // --- CALCULATE & UPDATE SUMMARY ---
            // Calculates all financial summaries and updates the UI.
            const calculateAndUpdateAll = () => {
                const t = translations[state.language];
                const income = state.income || 0;

                const preTaxDeductions = state.preTax.reduce((sum, item) => sum + item.amount, 0);
                const taxableIncome = Math.max(0, income - preTaxDeductions);
                const taxTotal = state.taxes.reduce((sum, item) => sum + item.amount, 0);
                const postTaxDeductions = state.postTax.reduce((sum, item) => sum + item.amount, 0);
                const totalDeductionsAndTaxes = preTaxDeductions + taxTotal + postTaxDeductions;
                const netIncome = Math.max(0, income - totalDeductionsAndTaxes);
                const expensesTotal = state.expenses.reduce((sum, item) => sum + item.amount, 0);
                const remainingBalance = netIncome - expensesTotal;

                const incomeFlowContainer = document.querySelector('.income-flow');
                incomeFlowContainer.innerHTML = `
                    <div class="flow-item"><span class="flow-label">${t.gross_income_label}</span> <span class="flow-amount">$${formatCurrency(income)} <em class="percentage highlighted-percentage">(100.0%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.pre_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(preTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? preTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item"><span class="flow-label"><strong>${t.taxable_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(taxableIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxableIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.tax_total_label}</span> <span class="flow-amount">-$${formatCurrency(taxTotal)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxTotal / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.post_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(postTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? postTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item info"><span class="flow-label"><strong>${t.total_deductions_taxes_label}</strong></span> <span class="flow-amount">-$${formatCurrency(totalDeductionsAndTaxes)} <em class="percentage highlighted-percentage">(${(income > 0 ? totalDeductionsAndTaxes / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-item result"><span class="flow-label"><strong>${t.net_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(netIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? netIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                `;

                const summaryCardsContainer = document.querySelector('.summary-cards');
                summaryCardsContainer.innerHTML = `
                    <div class="summary-card">
                        <div class="card-label">${t.total_expenses_card_label}</div>
                        <div class="card-amount negative">$${formatCurrency(expensesTotal)}</div>
                        <div class="card-sub">${t.total_expenses_card_sub}</div>
                        <div class="card-percentage">${t.expenses_percentage_text} <span class="highlighted-percentage">${(income > 0 ? expensesTotal / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                    <div class="summary-card accent">
                        <div class="card-label">${t.remaining_balance_card_label}</div>
                        <div class="card-amount ${remainingBalance < 0 ? 'negative' : ''}">$${formatCurrency(remainingBalance)}</div>
                        <div class="card-sub">${t.remaining_balance_card_sub}</div>
                        <div class="card-percentage">${t.remaining_percentage_text} <span class="highlighted-percentage">${(income > 0 ? remainingBalance / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                `;

                updateCharts({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions });
            };

            // --- CHARTING ---
            let incomeFlowChart, expenseCategoryChart;
            // Updates the Chart.js charts with current financial data.
            const updateCharts = ({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions }) => {
                const incomeFlowCtx = document.getElementById('incomeFlowChart')?.getContext('2d');
                const expenseCategoryCtx = document.getElementById('expenseCategoryChart')?.getContext('2d');

                if (!incomeFlowCtx || !expenseCategoryCtx) return;

                // Ensure charts are responsive and prevent infinite growth.
                incomeFlowCtx.canvas.parentNode.style.height = '350px';
                incomeFlowCtx.canvas.parentNode.style.position = 'relative';
                expenseCategoryCtx.canvas.parentNode.style.height = '350px';
                expenseCategoryCtx.canvas.parentNode.style.position = 'relative';

                if (incomeFlowChart) incomeFlowChart.destroy();
                incomeFlowChart = new Chart(incomeFlowCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Net Income', 'Taxes', 'Pre-Tax Deductions', 'Post-Tax Deductions'],
                        datasets: [{
                            data: [Math.max(0, netIncome), taxTotal, preTaxDeductions, postTaxDeductions],
                            backgroundColor: ['#7ed321', '#d0021b', '#f5a623', '#4a90e2'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
                
                const expenseData = state.expenseCategories.map(cat => state.expenses.filter(exp => exp.category === cat).reduce((sum, exp) => sum + exp.amount, 0));

                if (expenseCategoryChart) expenseCategoryChart.destroy();
                expenseCategoryChart = new Chart(expenseCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: state.expenseCategories,
                        datasets: [{
                            data: expenseData,
                            backgroundColor: ['#4a90e2', '#50e3c2', '#f5a623', '#bd10e0', '#b8e986', '#7ed321', '#4a4a4a', '#9013fe', '#f8e71c', '#d0021b']
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
            };
            
            // Performs a full UI update and recalculation.
            const fullUpdate = () => {
                renderExpenseCategories();
                renderExpensesList();
                renderCategorizedList('taxes');
                renderCategorizedList('preTax');
                renderCategorizedList('postTax');
                calculateAndUpdateAll();
            };

            // --- EVENT HANDLERS ---
            // Updates income when input changes.
            incomeInput.addEventListener('input', (e) => {
                state.income = parseFloat(e.target.value) || 0;
                calculateAndUpdateAll();
            });

            // Event listeners for tax, pre-tax, and post-tax sections.
            categorySections.forEach(section => {
                const category = section.dataset.category;
                const select = section.querySelector('.category-select');
                const inputContainer = section.querySelector('.category-input-container');
                const customNameInput = section.querySelector('.custom-name-input');
                const amountInput = section.querySelector('.amount-input');
                const addButton = section.querySelector('.add-item-btn');
                
                // Create or get the update and cancel buttons.
                // Ensure they are hidden by default by adding the 'hidden' class.
                let updateButton = section.querySelector('.update-item-btn');
                let cancelButton = section.querySelector('.cancel-item-btn');

                if (!updateButton) {
                    updateButton = document.createElement('button');
                    updateButton.className = 'update-item-btn hidden'; // Ensure hidden initially
                    inputContainer.appendChild(updateButton);
                }
                if (!cancelButton) {
                    cancelButton = document.createElement('button');
                    cancelButton.className = 'cancel-item-btn hidden utility-btn'; // Ensure hidden initially
                    cancelButton.style.backgroundColor = '#6c757d'; 
                    inputContainer.appendChild(cancelButton);
                }

                // State to keep track of the item being edited for THIS specific section
                let editingItemId = null;

                /**
                 * Sets the edit mode for the current category section.
                 * Controls visibility of add/update/cancel buttons and populates inputs.
                 * @param {boolean} isEditing - True to enter edit mode, false to exit.
                 * @param {object | null} item - The item object to edit (if entering edit mode).
                 */
                const setSectionEditMode = (isEditing, item = null) => {
                    const t = translations[state.language]; 
                    if (isEditing) {
                        // Hide 'Add' button, show 'Update' and 'Cancel'
                        addButton.classList.add('hidden');
                        updateButton.classList.remove('hidden');
                        cancelButton.classList.remove('hidden');
                        // Update button texts based on current language
                        updateButton.textContent = t[`${category}-update-button`];
                        cancelButton.textContent = t[`${category}-cancel-button`];

                        if (item) {
                            editingItemId = item.id;
                            // Check if the item.name exists as a standard option value
                            const optionExists = Array.from(select.options).some(option => option.value === item.name);
                            if (optionExists && select.querySelector(`option[value="${item.name}"]`)) { 
                                select.value = item.name;
                                customNameInput.style.display = 'none';
                            } else {
                                select.value = 'custom';
                                customNameInput.value = item.name;
                                customNameInput.style.display = 'block';
                            }
                            amountInput.value = item.amount;
                            inputContainer.style.display = 'flex'; // Ensure visible when editing
                            amountInput.focus(); // Focus amount for editing
                        }
                    } else {
                        // Exit edit mode, return to add mode
                        addButton.classList.remove('hidden');
                        updateButton.classList.add('hidden');
                        cancelButton.classList.add('hidden');
                        addButton.textContent = t[`${category}-add-button`]; // Revert add button text
                        editingItemId = null; // Clear editing state
                        
                        // Clear inputs, but do NOT touch select.value here
                        customNameInput.value = '';
                        amountInput.value = '';
                        customNameInput.style.display = 'none'; // Hide custom input
                        
                        // If the current select.value is empty (placeholder), then hide inputContainer.
                        // Otherwise, leave it visible (as it would be in normal add mode after selection).
                        if (!select.value) { // This check is crucial
                            inputContainer.style.display = 'none'; 
                        }
                    }
                };

                // Assign the setSectionEditMode function to the section for external calls (e.g., from item-edit-btn click)
                section.setEditMode = setSectionEditMode;

                // Toggle visibility of input fields based on select choice.
                select.addEventListener('change', () => {
                    // Always reset to 'add' mode whenever the select changes, to ensure button states are correct.
                    // This also clears inputs and hides update/cancel buttons.
                    setSectionEditMode(false); 

                    // Now, based on the NEW selection, adjust input visibility.
                    if (select.value) { // If a valid option (not placeholder) is selected
                        inputContainer.style.display = 'flex'; // Show the main input container
                        amountInput.value = ''; // Always clear amount when changing selection
                        
                        if (select.value === 'custom') {
                            customNameInput.style.display = 'block';
                            customNameInput.value = ''; // Clear custom name for a new custom entry
                            customNameInput.focus();
                        } else {
                            customNameInput.style.display = 'none';
                            customNameInput.value = ''; // Ensure custom input is cleared even if hidden
                            amountInput.focus();
                        }
                    } else {
                        // If the placeholder is selected (value is empty), hide everything related to input.
                        inputContainer.style.display = 'none';
                        customNameInput.style.display = 'none';
                        amountInput.value = '';
                        customNameInput.value = ''; // Ensure custom name is also cleared
                    }
                });
                
                // Add item handler (original 'Apply' button, now 'Add')
                addButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }
                    
                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }
                    
                    // Check for duplicate name, case-insensitive
                    if(state[category].some(item => item.name.toLowerCase() === name.toLowerCase())) { await showAlertDialog(`'${name}'` + t.alert_item_exists); return; }

                    state[category].push({ id: generateId(), name, amount });
                    
                    setSectionEditMode(false); // Reset inputs after adding
                    fullUpdate(); // Re-render lists and charts
                });

                // Update item handler
                updateButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }

                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }

                    // Check for duplicate name, excluding the item currently being edited
                    if(state[category].some(item => item.id !== editingItemId && item.name.toLowerCase() === name.toLowerCase())) {
                        await showAlertDialog(`'${name}'` + t.alert_item_exists); return;
                    }

                    state[category] = state[category].map(item =>
                        item.id === editingItemId ? { ...item, name, amount } : item
                    );
                    
                    setSectionEditMode(false); // Reset inputs after updating
                    fullUpdate(); // Re-render lists and charts
                });

                // Cancel update handler
                cancelButton.addEventListener('click', () => {
                    setSectionEditMode(false); // Reset inputs
                });
            });
            
            // Handles deletion and editing of items from any list (taxes, preTax, postTax, expenses).
            document.body.addEventListener('click', async (e) => {
                if (e.target.classList.contains('item-delete-btn')) {
                    const { id, category } = e.target.dataset;
                    // Confirm deletion for any categorized item
                    if (await showConfirmDialog(translations[state.language].confirm_delete_item)) {
                        state[category] = state[category].filter(item => item.id !== id);
                        fullUpdate();
                    } 
                } else if (e.target.classList.contains('item-edit-btn')) {
                    const { id, category } = e.target.dataset;
                    const itemToEdit = state[category].find(item => item.id === id);

                    if (itemToEdit) {
                        // Determine which section's inputs to populate
                        if (category === 'expenses') {
                            // For expenses, handle separately due to different input structure
                            expenseCategorySelect.value = itemToEdit.category;
                            expenseNameInput.value = itemToEdit.name;
                            expenseAmountInput.value = itemToEdit.amount;

                            addExpenseBtn.classList.add('hidden');
                            // Create update/cancel buttons if they don't exist
                            if (!updateExpenseBtn) { 
                                const expenseButtonContainer = addExpenseBtn.parentNode;
                                updateExpenseBtn = document.createElement('button');
                                updateExpenseBtn.id = 'update-expense-button';
                                updateExpenseBtn.textContent = translations[state.language]['update-expense-button'];
                                updateExpenseBtn.style.width = '100%';
                                updateExpenseBtn.style.marginTop = '1rem';
                                expenseButtonContainer.insertBefore(updateExpenseBtn, addExpenseBtn);

                                cancelExpenseBtn = document.createElement('button');
                                cancelExpenseBtn.id = 'cancel-expense-button';
                                cancelExpenseBtn.textContent = translations[state.language]['cancel-expense-button'];
                                cancelExpenseBtn.className = 'utility-btn';
                                cancelExpenseBtn.style.width = '100%';
                                cancelExpenseBtn.style.marginTop = '1rem';
                                cancelExpenseBtn.style.backgroundColor = '#6c757d';
                                expenseButtonContainer.insertBefore(cancelExpenseBtn, addExpenseBtn);

                                // Attach event listeners for expense update/cancel buttons
                                updateExpenseBtn.addEventListener('click', async () => {
                                    const t = translations[state.language];
                                    const categoryVal = expenseCategorySelect.value;
                                    const name = expenseNameInput.value.trim();
                                    const amount = parseFloat(expenseAmountInput.value);

                                    if (!categoryVal || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }

                                    state.expenses = state.expenses.map(exp =>
                                        exp.id === editingItemIdForExpenses ? { ...exp, category: categoryVal, name, amount } : exp
                                    );
                                    resetExpenseForm();
                                    fullUpdate();
                                });

                                cancelExpenseBtn.addEventListener('click', () => {
                                    resetExpenseForm();
                                });
                            }
                            updateExpenseBtn.classList.remove('hidden');
                            cancelExpenseBtn.classList.remove('hidden');
                            editingItemIdForExpenses = id; // Set editing ID for expenses
                        } else {
                            // For tax, preTax, postTax sections
                            const section = document.querySelector(`.card[data-category="${category}"]`);
                            // Call the setEditMode function attached to the specific section
                            if (section && section.setEditMode) {
                                section.setEditMode(true, itemToEdit); // Pass the item to populate inputs
                            }
                        }
                    }
                }
            });

            // Helper function to reset expense form and buttons
            const resetExpenseForm = () => {
                expenseCategorySelect.value = state.expenseCategories[0]; // Reset to first category
                expenseNameInput.value = '';
                expenseAmountInput.value = '';
                addExpenseBtn.classList.remove('hidden');
                if (updateExpenseBtn) updateExpenseBtn.classList.add('hidden');
                if (cancelExpenseBtn) cancelExpenseBtn.classList.add('hidden');
                editingItemIdForExpenses = null;
            };
            let editingItemIdForExpenses = null; // New state variable for expense editing

            // Adds a new expense category.
            addCategoryBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const newCategory = newCategoryInput.value.trim();
                if (newCategory && !state.expenseCategories.includes(newCategory)) {
                    state.expenseCategories.push(newCategory);
                    newCategoryInput.value = '';
                    renderExpenseCategories();
                } else if (state.expenseCategories.includes(newCategory)) {
                    await showAlertDialog(t.alert_category_exists);
                }
            });
            
            // Adds a new expense item.
            addExpenseBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const category = expenseCategorySelect.value;
                const name = expenseNameInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);

                if (!category || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }
                
                state.expenses.push({ id: generateId(), category, name, amount });
                resetExpenseForm(); // Reset form after adding
                fullUpdate();
            });
            
            // Changes the application language.
            langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

            // Saves current state to local storage.
            document.getElementById('save-button').addEventListener('click', async () => {
                const t = translations[state.language];
                try {
                    localStorage.setItem('budgetAppData', JSON.stringify(state));
                    await showAlertDialog(t.alert_data_saved);
                } <<<<<<< HEAD
                } catch (error) {
                    console.error('Failed to save data:', error);
                    await showAlertDialog(t.alert_save_failed);
                }
            });

            // Loads state from local storage.
            document.getElementById('load-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const savedData = localStorage.getItem('budgetAppData');
                if (savedData) {
                    try {
                        const loadedState = JSON.parse(savedData);
                        // Robustly initialize arrays if they are missing or null in loaded state
                        state.income = loadedState.income || 0;
                        state.taxes = Array.isArray(loadedState.taxes) ? loadedState.taxes : [];
                        state.preTax = Array.isArray(loadedState.preTax) ? loadedState.preTax : [];
                        state.postTax = Array.isArray(loadedState.postTax) ? loadedState.postTax : [];
                        state.expenses = Array.isArray(loadedState.expenses) ? loadedState.expenses : [];
                        state.expenseCategories = Array.isArray(loadedState.expenseCategories) ? loadedState.expenseCategories : ['주거', '교통', '식비', '생활', '오락', '기타'];
                        
                        langSelect.value = loadedState.language || 'ko';
                        setLanguage(langSelect.value); // Re-set language to update all UI elements
                        await showAlertDialog(t.alert_data_loaded);
                    } catch(error) {
                        console.error('Failed to parse saved data:', error);
                        await showAlertDialog(t.alert_load_failed);
                    }
                } else {
                    await showAlertDialog(t.alert_no_data);
                }
            });
            
            // Resets all data in the application.
            document.getElementById('reset-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const confirmed = await showConfirmDialog(t.confirm_reset);
                if (confirmed) {
                    localStorage.removeItem('budgetAppData');
                    // Reset to initial state, ensuring all arrays are empty.
                    state = { 
                        language: state.language, 
                        income: 0, 
                        taxes: [], 
                        preTax: [], 
                        postTax: [], 
                        expenses: [], 
                        expenseCategories: ['주거', '교통', '식비', '생활', '오락', '기타'], 
                    };
                    incomeInput.value = '';
                    setLanguage(state.language); // Re-set language to update all UI elements
                    await showAlertDialog(t.alert_data_reset);
                }
            });
            
            // --- INITIALIZATION ---
            // Loads saved language preference or defaults to Korean.
            const savedLang = localStorage.getItem('budgetAppLang') || 'ko';
            langSelect.value = savedLang;
            setLanguage(savedLang); // Initial UI setup with saved language
        });
    </script>
</body>
</html>
