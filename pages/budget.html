<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가계 재무 플래너</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --text-color: #2c3e50;
            --light-gray: #f9f9f9;
            --medium-gray: #7f8c8d;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        h1, h2 {
            color: var(--text-color);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input, select, button {
            padding: 12px;
            margin: 8px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .card label:not(.sr-only) {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        select {
            height: 46px;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }
        .delete-btn {
            background: var(--danger);
            padding: 8px 12px;
            width: auto;
        }
        .edit-btn, .save-edit-btn {
            background: var(--warning);
            padding: 8px 12px;
            width: auto;
            margin-right: 5px;
        }
        .save-edit-btn {
            background: var(--success);
        }
        .cancel-edit-btn {
            background: var(--medium-gray);
            padding: 8px 12px;
            width: auto;
            margin-right: 5px;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .flex > div {
            flex: 1;
        }
        .flex input, .flex select {
            margin: 0;
        }

        .item-list {
            margin-top: 20px;
        }
        .expense-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .expense-item-content {
            flex: 1;
            min-width: 150px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .expense-item-amount {
            min-width: 100px;
            text-align: right;
            padding-right: 10px;
        }
        .expense-item-actions {
            display: flex;
            flex-shrink: 0;
        }
        .expense-item input[type="text"],
        .expense-item input[type="number"] {
            width: auto;
            flex: 1;
            margin: 0;
            padding: 8px;
        }
        .badge {
            background: #eee;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .income-flow {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .flow-item.highlighted {
            border-left: 4px solid var(--danger);
        }
        .flow-item.result {
            border-left: 4px solid var(--success);
            font-weight: bold;
        }
        .flow-item.info { /* For total deductions/taxes */
            border-left: 4px solid var(--warning);
            font-weight: bold;
        }
        .flow-arrow {
            text-align: center;
            color: var(--medium-gray);
            margin: 2px 0;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card.accent {
            border-top: 4px solid var(--primary);
        }
        .card-label {
            font-size: 1em;
            color: var(--medium-gray);
            margin-bottom: 5px;
        }
        .card-amount {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        .card-amount.positive {
            color: var(--success);
        }
        .card-amount.negative {
            color: var(--danger);
        }
        .card-sub {
            font-size: 0.7em;
            color: #bdc3c7;
        }
        .card-percentage {
            font-size: 0.8em;
            color: var(--medium-gray);
            margin-top: 5px;
            font-weight: bold;
        }
        .card-percentage .highlighted-percentage {
            color: var(--primary); /* Highlight color for percentages */
            font-weight: bold;
        }
        .utility-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .utility-btn {
            background: #95a5a6;
            padding: 10px 15px;
            width: auto;
        }
        .utility-btn.print {
            background: #9b59b6;
        }
        .category-input-container {
            display: none;
            margin-top: 8px;
        }
        #tax-custom-container .flex,
        #pre-tax-custom-container .flex,
        #post-tax-custom-container .flex,
        #category-input-container.flex {
            align-items: center;
        }
        #tax-custom-container input,
        #pre-tax-custom-container input,
        #post-tax-custom-container input,
        #category-input-container input {
            margin-right: 10px;
        }
        #tax-custom-container button,
        #pre-tax-custom-container button,
        #post-tax-custom-container button,
        #category-input-container button {
            flex-shrink: 0;
            width: auto;
        }

        .total-summary {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .total-summary .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .total-summary .summary-label {
            color: var(--medium-gray);
        }
        .total-summary .summary-value {
            font-weight: bold;
        }
        .total-summary .percentage {
            color: var(--primary);
            font-size: 0.8em;
            margin-left: 5px;
            font-weight: bold;
        }
        .flow-amount .percentage {
            color: var(--primary); /* Highlighted percentage */
            font-size: 0.8em;
            font-style: normal;
            margin-left: 3px;
            font-weight: bold;
        }
        .flow-item.result .percentage {
            color: var(--success); /* Green for positive results */
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* Chart specific styles */
        .chart-container {
            margin-top: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- 차트 높이 문제 해결 및 렌더링 개선을 위한 코드 --- */
        .charts-grid > div {
            position: relative;
            height: 350px; /* 차트 컨테이너의 고정 높이 */
            display: flex; /* flexbox를 사용하여 canvas를 중앙에 배치하거나 크기 조절 */
            justify-content: center;
            align-items: center;
        }

        .charts-grid canvas {
            max-width: 100%; /* 부모 너비에 맞추고 */
            max-height: 100%; /* 부모 높이에 맞추되 */
            height: 100% !important; /* 항상 100%를 유지하도록 강제 */
            width: 100% !important; /* 항상 100%를 유지하도록 강제 */
        }
        /* ------------------------------------------------ */


        @media (max-width: 600px) {
            .flex {
                flex-direction: column;
                align-items: stretch;
            }
            .flex > div {
                flex: auto;
            }
            .utility-buttons {
                flex-wrap: wrap;
            }
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .expense-item-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            #tax-custom-container .flex,
            #pre-tax-custom-container .flex,
            #post-tax-custom-container .flex,
            #category-input-container.flex {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
            }
            #tax-custom-container input,
            #pre-tax-custom-container input,
            #post-tax-custom-container input,
            #category-input-container input {
                flex: 1;
                min-width: 120px;
            }
            #tax-custom-container button,
            #pre-tax-custom-container button,
            #post-tax-custom-container button,
            #category-input-container button {
                width: auto;
                flex-shrink: 0;
            }
            .charts-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            /* 작은 화면에서도 차트 높이 유지 */
            .charts-grid > div {
                height: 300px; /* 모바일 등 작은 화면에서 차트 컨테이너 높이 조정 */
            }
        }
        @media print {
            body {
                padding: 0;
                background: white;
            }
            .card, .chart-container {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            button, .utility-buttons, .category-input-container {
                display: none;
            }
            input, select {
                border: none;
                padding: 0;
            }
            .expense-item-actions {
                display: none;
            }
            canvas { /* Ensure charts are visible in print */
                max-width: 100%;
                height: auto !important;
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>📊 가계 재무 플래너</h1>

    <div class="card">
        <h2>💰 수입 및 지출 기록</h2>
        <div class="flex">
            <div>
                <label for="item-name">항목</label>
                <input type="text" id="item-name" placeholder="항목명 (예: 급여, 식비)" required>
            </div>
            <div>
                <label for="item-amount">금액</label>
                <input type="number" id="item-amount" placeholder="금액 (숫자만)" required min="0">
            </div>
            <div>
                <label for="item-type">유형</label>
                <select id="item-type">
                    <option value="income">수입</option>
                    <option value="expense">지출</option>
                </select>
            </div>
            <div>
                <label for="item-category">카테고리</label>
                <select id="item-category">
                    </select>
            </div>
            <div>
                <button id="add-item-btn">추가</button>
            </div>
        </div>
        <div id="category-input-container" class="flex">
            <div>
                <label for="new-category-name" class="sr-only">새 카테고리명</label>
                <input type="text" id="new-category-name" placeholder="새 카테고리명">
            </div>
            <div>
                <label for="new-category-type" class="sr-only">유형</label>
                <select id="new-category-type">
                    <option value="income">수입</option>
                    <option value="expense">지출</option>
                </select>
            </div>
            <div>
                <button id="add-category-btn" class="save-edit-btn">카테고리 추가</button>
            </div>
            <div>
                <button id="cancel-add-category-btn" class="cancel-edit-btn">취소</button>
            </div>
        </div>
        <button id="toggle-category-input-btn" class="utility-btn">사용자 정의 카테고리</button>
    </div>

    <div class="card item-list">
        <h2>📊 거래 내역</h2>
        <div id="transaction-list">
            </div>
    </div>

    <div class="card">
        <h2>📈 재무 분석 차트</h2>
        <div class="charts-grid">
            <div>
                <h3>자금 흐름 배분 (총 수입 대비)</h3>
                <canvas id="incomeFlowChart"></canvas>
            </div>
            <div>
                <h3>지출 카테고리별 비중 (총 지출 대비)</h3>
                <canvas id="expenseCategoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card income-flow">
        <h2>💰 순이익 및 자금 흐름</h2>
        <div id="income-flow-details">
            </div>
        <div class="total-summary">
            <div class="summary-row">
                <span class="summary-label">총 수입</span>
                <span class="summary-value" id="total-income">0원</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">총 지출</span>
                <span class="summary-value" id="total-expense">0원</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">순이익</span>
                <span class="summary-value" id="net-profit">0원</span>
            </div>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card accent">
            <div class="card-label">총 자산</div>
            <div class="card-amount positive" id="total-assets-display">0원</div>
            <div class="card-sub">현재 가용 자산</div>
        </div>
        <div class="summary-card">
            <div class="card-label">소비율</div>
            <div class="card-amount" id="spending-ratio-display">0%</div>
            <div class="card-sub">수입 대비 지출</div>
        </div>
        <div class="summary-card">
            <div class="card-label">저축률</div>
            <div class="card-amount" id="savings-ratio-display">0%</div>
            <div class="card-sub">수입 대비 저축</div>
        </div>
    </div>

    <div class="card utility-buttons">
        <button id="clear-all-data-btn" class="utility-btn danger">모든 데이터 삭제</button>
        <button id="print-report-btn" class="utility-btn print">보고서 인쇄</button>
    </div>

    <script>
        // 초기 데이터 로드 및 전역 변수
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || { income: [], expense: [] };
        let incomeFlowItems = JSON.parse(localStorage.getItem('incomeFlowItems')) || [];

        const defaultExpenseCategories = ['식비', '주거', '교통', '통신', '의료', '교육', '문화생활', '의류미용', '경조사', '기타 지출'];
        const defaultIncomeCategories = ['급여', '부수입', '투자수입', '용돈', '기타 수입'];

        let incomeFlowChartInstance;
        let expenseCategoryChartInstance;

        // HTML 요소 참조
        const itemForm = document.getElementById('add-item-btn');
        const itemNameInput = document.getElementById('item-name');
        const itemAmountInput = document.getElementById('item-amount');
        const itemTypeSelect = document.getElementById('item-type');
        const itemCategorySelect = document.getElementById('item-category');
        const transactionListDiv = document.getElementById('transaction-list');
        const totalIncomeDisplay = document.getElementById('total-income');
        const totalExpenseDisplay = document.getElementById('total-expense');
        const netProfitDisplay = document.getElementById('net-profit');
        const totalAssetsDisplay = document.getElementById('total-assets-display');
        const spendingRatioDisplay = document.getElementById('spending-ratio-display');
        const savingsRatioDisplay = document.getElementById('savings-ratio-display');
        const incomeFlowDetailsDiv = document.getElementById('income-flow-details');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        const printReportBtn = document.getElementById('print-report-btn');

        const toggleCategoryInputBtn = document.getElementById('toggle-category-input-btn');
        const categoryInputContainer = document.getElementById('category-input-container');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const newCategoryTypeSelect = document.getElementById('new-category-type');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');

        // 사용자 정의 소득 흐름 항목을 위한 요소들
        const preTaxCustomContainer = document.createElement('div');
        preTaxCustomContainer.id = 'pre-tax-custom-container';
        preTaxCustomContainer.innerHTML = `
            <div class="flex">
                <div>
                    <label for="pre-tax-custom-name">세전 공제 항목명</label>
                    <input type="text" id="pre-tax-custom-name" placeholder="국민연금, 건강보험 등">
                </div>
                <div>
                    <label for="pre-tax-custom-amount">금액 (원)</label>
                    <input type="number" id="pre-tax-custom-amount" placeholder="금액" min="0">
                </div>
                <div>
                    <button id="add-pre-tax-custom" class="save-edit-btn">추가</button>
                </div>
                <div>
                    <button id="cancel-pre-tax-custom" class="cancel-edit-btn">취소</button>
                </div>
            </div>
        `;
        preTaxCustomContainer.style.display = 'none';

        const postTaxCustomContainer = document.createElement('div');
        postTaxCustomContainer.id = 'post-tax-custom-container';
        postTaxCustomContainer.innerHTML = `
            <div class="flex">
                <div>
                    <label for="post-tax-custom-name">세후 공제 항목명</label>
                    <input type="text" id="post-tax-custom-name" placeholder="대출 상환, 보험료 등">
                </div>
                <div>
                    <label for="post-tax-custom-amount">금액 (원)</label>
                    <input type="number" id="post-tax-custom-amount" placeholder="금액" min="0">
                </div>
                <div>
                    <button id="add-post-tax-custom" class="save-edit-btn">추가</button>
                </div>
                <div>
                    <button id="cancel-post-tax-custom" class="cancel-edit-btn">취소</button>
                </div>
            </div>
        `;
        postTaxCustomContainer.style.display = 'none';

        document.querySelector('.income-flow').prepend(postTaxCustomContainer);
        document.querySelector('.income-flow').prepend(preTaxCustomContainer);

        // 숫자 포맷팅 함수
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        };

        // 데이터 저장
        const saveData = () => {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            localStorage.setItem('incomeFlowItems', JSON.stringify(incomeFlowItems));
            updateUI();
        };

        // 카테고리 옵션 업데이트
        const updateCategoryOptions = () => {
            itemCategorySelect.innerHTML = ''; // Clear existing options

            const currentType = itemTypeSelect.value;
            let categoriesToDisplay = [];

            if (currentType === 'income') {
                categoriesToDisplay = [...defaultIncomeCategories, ...(customCategories.income || [])];
            } else { // expense
                categoriesToDisplay = [...defaultExpenseCategories, ...(customCategories.expense || [])];
            }

            categoriesToDisplay.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                itemCategorySelect.appendChild(option);
            });

            // If no category is selected, select the first one if available
            if (itemCategorySelect.options.length > 0 && !itemCategorySelect.value) {
                itemCategorySelect.value = itemCategorySelect.options[0].value;
            }
        };

        // 초기 카테고리 옵션 로드
        updateCategoryOptions();

        // 거래 내역 추가
        itemForm.addEventListener('click', (e) => {
            if (e.target.id === 'add-item-btn') {
                const name = itemNameInput.value.trim();
                const amount = parseFloat(itemAmountInput.value);
                const type = itemTypeSelect.value;
                const category = itemCategorySelect.value;
                const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                if (name && !isNaN(amount) && amount > 0) {
                    transactions.push({ id: Date.now(), name, amount, type, category, date });
                    itemNameInput.value = '';
                    itemAmountInput.value = '';
                    itemCategorySelect.value = itemCategorySelect.options[0] ? itemCategorySelect.options[0].value : ''; // Reset to first category
                    saveData();
                } else {
                    alert('항목명과 유효한 금액을 입력해주세요.');
                }
            }
        });

        // 거래 내역 렌더링
        const renderTransactions = () => {
            transactionListDiv.innerHTML = '';
            transactions.forEach(transaction => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'expense-item';
                itemDiv.dataset.id = transaction.id;

                const amountClass = transaction.type === 'income' ? 'positive' : 'negative';
                const sign = transaction.type === 'income' ? '+' : '-';

                itemDiv.innerHTML = `
                    <div class="expense-item-content">
                        <span class="badge">${transaction.category}</span>
                        <span class="item-name">${transaction.name}</span>
                        <span class="item-date">(${transaction.date})</span>
                    </div>
                    <div class="expense-item-amount ${amountClass}">
                        ${sign}${formatMoney(transaction.amount)}
                    </div>
                    <div class="expense-item-actions">
                        <button class="edit-btn">수정</button>
                        <button class="delete-btn">삭제</button>
                    </div>
                `;
                transactionListDiv.appendChild(itemDiv);
            });
        };

        // 거래 내역 수정/삭제
        transactionListDiv.addEventListener('click', (e) => {
            const id = parseInt(e.target.closest('.expense-item').dataset.id);
            const index = transactions.findIndex(t => t.id === id);

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('정말로 이 항목을 삭제하시겠습니까?')) {
                    transactions.splice(index, 1);
                    saveData();
                }
            } else if (e.target.classList.contains('edit-btn')) {
                const itemDiv = e.target.closest('.expense-item');
                const transaction = transactions[index];

                itemDiv.innerHTML = `
                    <div class="expense-item-content">
                        <input type="text" class="edit-name" value="${transaction.name}">
                        <input type="number" class="edit-amount" value="${transaction.amount}" min="0">
                    </div>
                    <div class="expense-item-actions">
                        <button class="save-edit-btn">저장</button>
                        <button class="cancel-edit-btn">취소</button>
                    </div>
                `;
            } else if (e.target.classList.contains('save-edit-btn')) {
                const itemDiv = e.target.closest('.expense-item');
                const newName = itemDiv.querySelector('.edit-name').value.trim();
                const newAmount = parseFloat(itemDiv.querySelector('.edit-amount').value);

                if (newName && !isNaN(newAmount) && newAmount > 0) {
                    transactions[index].name = newName;
                    transactions[index].amount = newAmount;
                    saveData();
                } else {
                    alert('유효한 항목명과 금액을 입력해주세요.');
                }
            } else if (e.target.classList.contains('cancel-edit-btn')) {
                saveData(); // Simply re-render to revert
            }
        });

        // 요약 정보 및 차트 업데이트
        const updateUI = () => {
            renderTransactions();
            updateSummaries();
            updateCharts();
            renderIncomeFlowDetails();
        };

        // 요약 정보 업데이트
        const updateSummaries = () => {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalIncome - totalExpense;

            const totalAssets = totalIncome - totalExpense; // 예시: 단순 총 수입 - 총 지출로 자산 계산 (현금성 자산)
            const spendingRatio = totalIncome > 0 ? ((totalExpense / totalIncome) * 100).toFixed(1) : 0;
            const savingsRatio = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;

            totalIncomeDisplay.textContent = formatMoney(totalIncome);
            totalExpenseDisplay.textContent = formatMoney(totalExpense);
            netProfitDisplay.textContent = formatMoney(netProfit);

            totalAssetsDisplay.textContent = formatMoney(totalAssets);
            totalAssetsDisplay.className = `card-amount ${totalAssets >= 0 ? 'positive' : 'negative'}`;

            spendingRatioDisplay.textContent = `${spendingRatio}%`;
            savingsRatioDisplay.textContent = `${savingsRatio}%`;

            if (spendingRatioDisplay.nextElementSibling && spendingRatioDisplay.nextElementSibling.classList.contains('card-sub')) {
                const spendingRatioCard = spendingRatioDisplay.closest('.summary-card');
                if (spendingRatioCard) {
                    const percentageDiv = document.createElement('div');
                    percentageDiv.className = 'card-percentage';
                    percentageDiv.innerHTML = `소비율: <span class="highlighted-percentage">${spendingRatio}%</span>`;
                    // Check if already exists to prevent duplicates
                    if (!spendingRatioCard.querySelector('.card-percentage')) {
                         // Spending ratio card usually doesn't have its own percentage area
                         // This is just to demonstrate where it might go if needed, but current design has it in card-amount
                    }
                }
            }
        };

        // 차트 업데이트
        const updateCharts = () => {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            // 소득 흐름 배분 (파이 차트)
            const preTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            const postTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .reduce((sum, item) => sum + item.amount, 0);

            let availableIncome = totalIncome;
            let taxAmount = 0; // 세금 계산 로직 추가 필요

            // 세금 계산 (예시: 소득의 10%를 세금으로 가정)
            // 이 부분은 실제 세율 및 공제 항목에 따라 복잡하게 계산되어야 함
            if (totalIncome > 0) {
                taxAmount = totalIncome * 0.1; // 간단한 예시 세금
                availableIncome = totalIncome - preTaxDeductions - taxAmount;
            } else {
                availableIncome = 0;
            }

            const remainingBalance = availableIncome - postTaxDeductions - totalExpense;

            const incomeFlowData = {
                labels: ['세전 공제', '세금', '세후 공제', '총 지출', '남은 잔액'],
                datasets: [{
                    data: [
                        preTaxDeductions,
                        taxAmount,
                        postTaxDeductions,
                        totalExpense,
                        Math.max(0, remainingBalance) // 잔액이 마이너스면 0으로 표시
                    ],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }]
            };

            if (incomeFlowChartInstance) {
                incomeFlowChartInstance.data = incomeFlowData;
                incomeFlowChartInstance.update();
            } else {
                const ctx = document.getElementById('incomeFlowChart').getContext('2d');
                incomeFlowChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: incomeFlowData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // 컨테이너 높이를 따름
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${formatMoney(value)} (${percentage}%)`; // 여기를 수정했습니다.
                                    }
                                }
                            },
                            legend: {
                                position: 'right', // 범례 위치
                            }
                            // datalabels: { // Chart.js Datalabels Plugin 사용 시
                            //     formatter: (value, ctx) => {
                            //         const total = ctx.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                            //         const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            //         return percentage;
                            //     },
                            //     color: '#fff',
                            //     font: {
                            //         weight: 'bold'
                            //     }
                            // }
                        }
                    }
                });
            }

            // 지출 카테고리별 비중 (도넛 차트)
            const expenseCategoryMap = transactions
                .filter(t => t.type === 'expense')
                .reduce((map, t) => {
                    map[t.category] = (map[t.category] || 0) + t.amount;
                    return map;
                }, {});

            const expenseCategories = Object.keys(expenseCategoryMap);
            const expenseAmounts = Object.values(expenseCategoryMap);
            const expenseColors = expenseCategories.map((_, i) => `hsl(${i * 60}, 70%, 60%)`); // 동적 색상

            const expenseCategoryData = {
                labels: expenseCategories,
                datasets: [{
                    data: expenseAmounts,
                    backgroundColor: expenseColors,
                    hoverBackgroundColor: expenseColors
                }]
            };

            if (expenseCategoryChartInstance) {
                expenseCategoryChartInstance.data = expenseCategoryData;
                expenseCategoryChartInstance.update();
            } else {
                const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
                expenseCategoryChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: expenseCategoryData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // 컨테이너 높이를 따름
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${formatMoney(value)} (${percentage}%)`; // 여기를 수정했습니다.
                                    }
                                }
                            },
                            legend: {
                                position: 'right', // 범례 위치
                            }
                            // datalabels: { // Chart.js Datalabels Plugin 사용 시
                            //     formatter: (value, ctx) => {
                            //         const total = ctx.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                            //         const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            //         return percentage;
                            //     },
                            //     color: '#fff',
                            //     font: {
                            //         weight: 'bold'
                            //     }
                            // }
                        }
                    }
                });
            }
        };

        // 순이익 및 자금 흐름 상세 내역 렌더링
        const renderIncomeFlowDetails = () => {
            incomeFlowDetailsDiv.innerHTML = '';
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            let currentBalance = totalIncome;

            const addFlowItem = (label, amount, className = '') => {
                const percentage = totalIncome > 0 ? ((amount / totalIncome) * 100).toFixed(1) : 0;
                const sign = amount >= 0 ? '+' : '-'; // Make sure sign is correct for deductions too
                const flowItem = document.createElement('div');
                flowItem.className = `flow-item ${className}`;
                flowItem.innerHTML = `
                    <span>${label}</span>
                    <span class="flow-amount ${amount < 0 ? 'negative' : ''}">${sign}${formatMoney(Math.abs(amount))}
                        <span class="percentage">(${percentage}%)</span>
                    </span>
                `;
                incomeFlowDetailsDiv.appendChild(flowItem);
            };

            const addArrow = () => {
                const arrow = document.createElement('div');
                arrow.className = 'flow-arrow';
                arrow.innerHTML = '&#x2193;'; // Down arrow
                incomeFlowDetailsDiv.appendChild(arrow);
            };

            addFlowItem('총 수입', totalIncome, 'result');
            addArrow();

            // 세전 공제
            const preTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            if (preTaxDeductions > 0) {
                addFlowItem('세전 공제 총계', -preTaxDeductions, 'highlighted info');
                currentBalance -= preTaxDeductions;
                addArrow();
            }
            incomeFlowItems
                .filter(item => item.type === 'pre-tax')
                .forEach(item => {
                    const percentage = totalIncome > 0 ? ((item.amount / totalIncome) * 100).toFixed(1) : 0;
                    incomeFlowDetailsDiv.innerHTML += `
                        <div class="flow-item sub-item">
                            <span>${item.name}</span>
                            <span class="flow-amount negative">-${formatMoney(item.amount)} <span class="percentage">(${percentage}%)</span></span>
                            <button class="delete-flow-item-btn delete-btn" data-id="${item.id}" data-type="${item.type}">삭제</button>
                        </div>
                    `;
                });

            // 세금 (임시 계산)
            let taxAmount = 0;
            if (totalIncome > 0) {
                taxAmount = totalIncome * 0.1; // 10%
                currentBalance -= taxAmount;
                addFlowItem('예상 세금', -taxAmount, 'highlighted info');
                addArrow();
            }

            // 세후 공제
            const postTaxDeductions = incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .reduce((sum, item) => sum + item.amount, 0);
            if (postTaxDeductions > 0) {
                addFlowItem('세후 공제 총계', -postTaxDeductions, 'highlighted info');
                currentBalance -= postTaxDeductions;
                addArrow();
            }
            incomeFlowItems
                .filter(item => item.type === 'post-tax')
                .forEach(item => {
                    const percentage = totalIncome > 0 ? ((item.amount / totalIncome) * 100).toFixed(1) : 0;
                    incomeFlowDetailsDiv.innerHTML += `
                        <div class="flow-item sub-item">
                            <span>${item.name}</span>
                            <span class="flow-amount negative">-${formatMoney(item.amount)} <span class="percentage">(${percentage}%)</span></span>
                            <button class="delete-flow-item-btn delete-btn" data-id="${item.id}" data-type="${item.type}">삭제</button>
                        </div>
                    `;
                });

            // 총 지출
            if (totalExpense > 0) {
                addFlowItem('총 지출', -totalExpense, 'highlighted');
                currentBalance -= totalExpense;
                addArrow();
            }

            addFlowItem('최종 잔액', currentBalance, 'result');

            // 동적으로 생성된 버튼에 이벤트 리스너 추가 (삭제 버튼)
            incomeFlowDetailsDiv.querySelectorAll('.delete-flow-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToDelete = parseInt(e.target.dataset.id);
                    incomeFlowItems = incomeFlowItems.filter(item => item.id !== idToDelete);
                    saveData();
                });
            });
        };

        // 사용자 정의 카테고리 추가/취소 버튼 토글
        toggleCategoryInputBtn.addEventListener('click', () => {
            categoryInputContainer.style.display = categoryInputContainer.style.display === 'flex' ? 'none' : 'flex';
            newCategoryNameInput.value = ''; // Clear input on toggle
        });

        cancelAddCategoryBtn.addEventListener('click', () => {
            categoryInputContainer.style.display = 'none';
            newCategoryNameInput.value = '';
        });

        addCategoryBtn.addEventListener('click', () => {
            const newCategoryName = newCategoryNameInput.value.trim();
            const newCategoryType = newCategoryTypeSelect.value;
            if (newCategoryName) {
                if (!customCategories[newCategoryType].includes(newCategoryName)) {
                    customCategories[newCategoryType].push(newCategoryName);
                    saveData();
                    updateCategoryOptions(); // Update select options
                    alert(`'${newCategoryName}' (${newCategoryType === 'income' ? '수입' : '지출'}) 카테고리가 추가되었습니다.`);
                    newCategoryNameInput.value = ''; // Clear input
                    categoryInputContainer.style.display = 'none'; // Hide input area
                } else {
                    alert('이미 존재하는 카테고리입니다.');
                }
            } else {
                alert('새 카테고리명을 입력해주세요.');
            }
        });

        // 수입/지출 선택 변경 시 카테고리 옵션 업데이트
        itemTypeSelect.addEventListener('change', updateCategoryOptions);


        // 소득 흐름 항목 추가 토글 및 로직
        document.querySelector('.income-flow h2').addEventListener('click', () => {
            // 헤더 클릭 시 상세 항목 추가 UI 토글
            const isPreTaxVisible = preTaxCustomContainer.style.display === 'flex';
            const isPostTaxVisible = postTaxCustomContainer.style.display === 'flex';

            if (!isPreTaxVisible && !isPostTaxVisible) {
                preTaxCustomContainer.style.display = 'flex';
                postTaxCustomContainer.style.display = 'flex';
            } else {
                preTaxCustomContainer.style.display = 'none';
                postTaxCustomContainer.style.display = 'none';
            }
        });

        // 세전 공제 항목 추가
        document.getElementById('add-pre-tax-custom').addEventListener('click', () => {
            const name = document.getElementById('pre-tax-custom-name').value.trim();
            const amount = parseFloat(document.getElementById('pre-tax-custom-amount').value);
            if (name && !isNaN(amount) && amount > 0) {
                incomeFlowItems.push({ id: Date.now(), name, amount, type: 'pre-tax' });
                document.getElementById('pre-tax-custom-name').value = '';
                document.getElementById('pre-tax-custom-amount').value = '';
                saveData();
            } else {
                alert('항목명과 유효한 금액을 입력해주세요.');
            }
        });

        // 세전 공제 항목 추가 취소
        document.getElementById('cancel-pre-tax-custom').addEventListener('click', () => {
            document.getElementById('pre-tax-custom-name').value = '';
            document.getElementById('pre-tax-custom-amount').value = '';
            preTaxCustomContainer.style.display = 'none';
        });

        // 세후 공제 항목 추가
        document.getElementById('add-post-tax-custom').addEventListener('click', () => {
            const name = document.getElementById('post-tax-custom-name').value.trim();
            const amount = parseFloat(document.getElementById('post-tax-custom-amount').value);
            if (name && !isNaN(amount) && amount > 0) {
                incomeFlowItems.push({ id: Date.now(), name, amount, type: 'post-tax' });
                document.getElementById('post-tax-custom-name').value = '';
                document.getElementById('post-tax-custom-amount').value = '';
                saveData();
            } else {
                alert('항목명과 유효한 금액을 입력해주세요.');
            }
        });

        // 세후 공제 항목 추가 취소
        document.getElementById('cancel-post-tax-custom').addEventListener('click', () => {
            document.getElementById('post-tax-custom-name').value = '';
            document.getElementById('post-tax-custom-amount').value = '';
            postTaxCustomContainer.style.display = 'none';
        });

        // 모든 데이터 삭제
        clearAllDataBtn.addEventListener('click', () => {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                transactions = [];
                customCategories = { income: [], expense: [] };
                incomeFlowItems = [];
                saveData();
                updateCategoryOptions(); // Reset categories
                alert('모든 데이터가 삭제되었습니다.');
            }
        });

        // 보고서 인쇄
        printReportBtn.addEventListener('click', () => {
            window.print();
        });

        // 페이지 로드 시 UI 업데이트
        updateUI();

        // Chart.js DataLabels Plugin 등록 (선택 사항: 주석 해제 시 사용)
        // Chart.register(ChartDataLabels);
    </script>
</body>
</html>
