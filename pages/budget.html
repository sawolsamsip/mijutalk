<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title-head">Kuatia√±e'·∫Ω Rerekuaha Mba'ehetave rehegua (USD)</title>

    <!-- Chart.js oƒ©va'ekue (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- chartjs-plugin-datalabels tembipuru (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- CSS o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua -->
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #F44336;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --card-bg: #fff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .app-header {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Tembipuru ojejapo hagÃÉua pantalla michƒ©v√©vape */
        }

        .app-header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
            flex-grow: 1; /* Tembipuru r√©ra oheja hagÃÉua o√±emoguyrukuere */
        }

        .language-selector-wrapper {
            margin-left: 20px; /* Tembipuru r√©ra rendaha */
        }

        #language-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            font-size: 1rem;
            cursor: pointer;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .card label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Ojoaju hagÃÉua o√±emonguatia'·ªπvape */
            color: var(--text-color);
        }

        .card input[type="number"],
        .card input[type="text"],
        .card select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box; /* O√±emoƒ©ve hagÃÉua padding width-pe */
            color: var(--text-color);
            background-color: var(--light-bg);
        }

        .card input[type="number"]:focus,
        .card input[type="text"]:focus,
        .card select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .flex {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Tembipuru ojejapo hagÃÉua */
        }

        .flex > div {
            flex: 1; /* O√±emom√Ωi hagÃÉua hekopete */
            min-width: 120px; /* Ancho m√≠nimo para elementos flexibles */
        }

        .category-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .category-input-container input[type="text"],
        .category-input-container input[type="number"] {
            flex: 1;
            min-width: 100px; /* O√±emonguatia'·ªπva nomichƒ©ri hagÃÉua hetave */
        }

        .category-input-container button {
            flex-shrink: 0; /* √ëanduti nome'·∫Ωi hagÃÉua */
            width: auto;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-input-container button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .category-input-container button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* √ëanduti apa√±u√°i voreku√©rape gÃÉuar√£ */
        .add-item-btn,
        .update-item-btn,
        .cancel-item-btn {
            flex-grow: 1;
            max-width: 120px; /* √ëanduti anchura ypyku√©rape gÃÉuar√£ */
        }

        .update-item-btn {
            background-color: var(--secondary-color) !important; /* √ëanduti apa√±u√°i */
        }
        .update-item-btn:hover {
            background-color: #1976d2 !important;
        }

        .cancel-item-btn {
            background-color: #6c757d !important; /* √ëanduti apa√±u√°i */
        }
        .cancel-item-btn:hover {
            background-color: #5a6268 !important;
        }

        .hidden {
            display: none !important; /* √ëanduti o√±embotapykueva'er√£ */
        }

        .item-list {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: bold;
            flex-grow: 1;
            margin-right: 10px;
        }

        .item-amount {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap; /* Nomichƒ©ri hagÃÉua mba'ehetave */
        }

        .item-edit-btn,
        .item-delete-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .item-edit-btn {
            color: var(--secondary-color);
        }
        .item-edit-btn:hover {
            background-color: rgba(33, 150, 243, 0.1);
        }

        .item-delete-btn {
            color: var(--danger-color);
        }
        .item-delete-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        /* Mba'ehetave */
        .income-flow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
        }

        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 8px;
            background-color: var(--light-bg);
            align-items: center;
        }

        .flow-item.highlighted {
            background-color: #fce8d2; /* √ëanduti jepy'apy */
        }

        .flow-item.info {
            background-color: #e3f2fd; /* √ëanduti marandu */
            border-left: 4px solid var(--secondary-color);
        }

        .flow-item.result {
            background-color: #d4edda; /* √ëanduti mba'ehetave */
            border-left: 4px solid var(--primary-color);
            font-size: 1.1em;
            font-weight: bold;
        }

        .flow-arrow {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
        }

        .flow-label {
            font-weight: bold;
        }

        .flow-amount {
            white-space: nowrap;
        }

        .percentage {
            font-size: 0.9em;
            color: #666;
            margin-left: 5px;
        }

        .highlighted-percentage {
            color: var(--danger-color); /* √ëanduti jepy'apy */
        }
        .flow-item.result .highlighted-percentage {
            color: var(--primary-color); /* √ëanduti mba'ehetave */
        }


        /* √ëanduti voreku√©ra */
        .summary-cards {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 5px solid var(--primary-color); /* √ëanduti */
        }

        .summary-card.accent {
            border-color: var(--accent-color);
        }

        .card-label {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        .card-amount {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .card-amount.negative {
            color: var(--danger-color);
        }

        .card-sub {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .card-percentage {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: bold;
        }

        /* Ta'anga */
        .chart-container {
            padding-bottom: 40px; /* Ta'anga jeroviaha */
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr; /* Ta'anga michƒ©va */
            gap: 30px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr; /* Ta'anga tuich√°va */
            }
        }

        .charts-grid > div {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .charts-grid h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* √ëanduti rembiapo */
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .utility-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .utility-btn:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
        }

        .utility-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .utility-btn.print {
            background-color: #607d8b;
        }
        .utility-btn.print:hover {
            background-color: #455a64;
        }

        .utility-btn[style*="background-color: var(--danger-color);"] {
            background-color: var(--danger-color);
        }
        .utility-btn[style*="background-color: var(--danger-color);"]:hover {
            background-color: #d32f2f;
        }


        /* Modal apa√±u√°i */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            max-width: 400px;
            width: 90%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: scaleIn 0.3s ease-out forwards;
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--text-color);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-button.alert-ok {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-button.alert-ok:hover {
            background-color: #45a049;
        }

        .modal-button.confirm-yes {
            background-color: var(--danger-color);
            color: white;
        }
        .modal-button.confirm-yes:hover {
            background-color: #d32f2f;
        }

        .modal-button.confirm-no {
            background-color: #6c757d;
            color: white;
        }
        .modal-button.confirm-no:hover {
            background-color: #5a6268;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Accessibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Mba'ehetave rerekuaha */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .language-selector-wrapper {
                margin-left: 0;
                width: 100%;
            }
            
            #language-select {
                width: 100%;
            }

            .flex,
            .category-input-container,
            .summary-cards,
            .utility-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .flex > div,
            .category-input-container input,
            .category-input-container button,
            .summary-card,
            .utility-btn {
                width: 100%;
                min-width: unset;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 id="app-title">üí∞ Kuatia√±e'·∫Ω Rerekuaha Mba'ehetave (USD)</h1>
        <div class="language-selector-wrapper">
            <label for="language-select" class="sr-only" id="language-label">√ëe'·∫Ω Jeporu</label>
            <select id="language-select">
                <option value="ko">üá∞üá∑ Koreano</option>
                <option value="en">üá∫üá∏ Ingl√©s</option>
                <option value="zh">üá®üá≥ Chino Sencillo</option>
            </select>
        </div>
    </header>

    <main>
        <div class="card">
            <h2 id="income-title">Sueldo Jasykue</h2>
            <label for="income" id="income-label">Sueldo Jasykue (USD)</label>
            <input type="number" id="income" placeholder="0">
        </div>

        <!-- Tembipuru Vore -->
        <div class="card" data-category="taxes">
            <h2 id="tax-title">Impuesto</h2>
            <label for="taxes-type" id="tax-type-label">Impuesto Renda</label>
            <select id="taxes-type" class="category-select">
                <option value="" disabled selected id="tax-select-placeholder">Eiporavo Impuesto Renda</option>
                <option value="federal_withholding">Federal Withholding</option>
                <option value="state_tax_ca">Estado Impuesto (CA)</option>
                <option value="oasdi_social_security">OASDI (Seguridad Social)</option>
                <option value="medicare">Medicare</option>
                <option value="ca_sdi">CA SDI</option>
                <option value="custom" id="tax-option-custom">Eiporavo √ëandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Impuesto Renda" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="tax-add-button">Toa√±ad√≠</button>
            </div>
            <div class="item-list" id="taxes-list"></div>
        </div>

        <!-- Tembipuru √ëanduti Vore -->
        <div class="card" data-category="preTax">
            <h2 id="pre-tax-title">Impuesto √ëanduti</h2>
            <label for="preTax-type" id="pre-tax-type-label">Tembipuru √ëanduti</label>
            <select id="preTax-type" class="category-select">
                <option value="" disabled selected id="pre-tax-select-placeholder">Eiporavo Tembipuru √ëanduti</option>
                <option value="four_01k_traditional">401k Tradicional</option>
                <option value="medical_premium">M√©dico Seguro</option>
                <option value="dental_premium">Dental Seguro</option>
                <option value="vision_premium">Visi√≥n Seguro</option>
                <option value="mseap">MSEAP</option>
                <option value="custom" id="pre-tax-option-custom">Eiporavo √ëandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Tembipuru √ëanduti" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="pre-tax-add-button">Toa√±ad√≠</button>
            </div>
            <div class="item-list" id="preTax-list"></div>
        </div>

        <!-- Tembipuru Arakatupy Vore -->
        <div class="card" data-category="postTax">
            <h2 id="post-tax-title">Impuesto Arakatupy</h2>
            <label for="postTax-type" id="post-tax-type-label">Tembipuru Arakatupy</label>
            <select id="postTax-type" class="category-select">
                <option value="" disabled selected id="post-tax-select-placeholder">Eiporavo Tembipuru Arakatupy</option>
                <option value="four_01k_roth">401k Roth</option>
                <option value="legal_services">Servicios Legales</option>
                <option value="ltd">LTD</option>
                <option value="stock_purchase_plan">Pl√°n Opa √ëemur√£</option>
                <option value="ad_and_d">AD&D</option>
                <option value="critical_illness">√ëembyasy Tuichav√©va</option>
                <option value="accident_insurance">Aseguro √ëembyasy rehegua</option>
                <option value="custom" id="post-tax-option-custom">Eiporavo √ëandejara</option>
            </select>
            <div class="category-input-container" style="display: none;">
                <input type="text" class="custom-name-input" placeholder="Eiporavo Tembipuru Arakatupy" style="display: none;">
                <input type="number" class="amount-input" placeholder="Mba'ehetave ($)">
                <button class="add-item-btn" id="post-tax-add-button">Toa√±ad√≠</button>
            </div>
            <div class="item-list" id="postTax-list"></div>
        </div>

        <!-- Tembipuru Rerekuaha Vore -->
        <div class="card">
            <h2 id="expense-management-title">Mba'ehetave Rerekuaha</h2>
            <div class="flex">
                <div style="flex: 1;">
                    <label for="category" id="category-label">Vore</label>
                    <select id="category"></select>
                </div>
                <div style="flex: 2;">
                    <label for="expense-name" id="expense-name-label">H√©ra</label>
                    <input type="text" id="expense-name" placeholder="Techapyr√£: Alquiler">
                </div>
                <div style="flex: 1;">
                    <label for="expense-amount" id="expense-amount-label">Mba'ehetave</label>
                    <input type="number" id="expense-amount" placeholder="$">
                </div>
            </div>
            <div class="category-input-container">
                <label for="new-category" class="sr-only" id="new-category-label">Vore Pyahu H√©ra</label>
                <input type="text" id="new-category" placeholder="Eiporavo Vore Pyahu H√©ra" style="flex: 1;">
                <button id="add-category-button" style="flex-shrink: 0; width: auto;">Toa√±ad√≠ Vore</button>
            </div>
            <button id="add-expense-button" style="width: 100%; margin-top: 1rem;">Toa√±ad√≠ Mba'ehetave</button>
            <div class="item-list" id="expenses-list"></div>
        </div>

        <!-- Mba'ehetave Jasykue Vore -->
        <div class="card">
            <h2 id="monthly-financial-status-title">üìä Mba'ehetave Jasykue</h2>
            <div class="income-flow">
                <!-- Mba'ehetave o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua JS rupi -->
            </div>
            <div class="summary-cards">
                <!-- Mba'ehetave o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua JS rupi -->
            </div>
        </div>

        <!-- Mba'ehetave √ëanduti Vore -->
        <div class="card chart-container">
            <h2 id="financial-analysis-chart-title">üìà Mba'ehetave √ëanduti</h2>
            <div class="charts-grid">
                <div>
                    <h3 id="income-flow-chart-title">Mba'ehetave Jasykue (Mba'ehetave √ëanduti)</h3>
                    <canvas id="incomeFlowChart"></canvas>
                </div>
                <div>
                    <h3 id="expense-category-chart-title">Mba'ehetave Voreku√©ra (Mba'ehetave √ëanduti)</h3>
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- √ëanduti Rembiapo Vore -->
        <div class="utility-buttons">
            <button class="utility-btn" id="save-button">üíæ √ëongatu</button>
            <button class="utility-btn" id="load-button">üìÇ Karga</button>
            <button class="utility-btn print" onclick="window.print()">üñ®Ô∏è √ëongatu</button>
            <button class="utility-btn" id="reset-button" style="background-color: var(--danger-color);">üîÑ √ëembopyahu</button>
        </div>
    </main>

    <!-- Modal Apapaha -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message" class="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <!-- JavaScript o√±emonguatia'·ªπva -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- √ëanduti √±embopyahu ---
            // K√≥va o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua √±anduti.
            // Chart.js ha ChartDataLabels o√±emboguatava'er√£ HTML-gui.
            Chart.register(ChartDataLabels);

            // --- ESTADO REREKUAHAR√É ---
            let state = {
                language: 'ko',
                income: 0,
                taxes: [], // { id, h√©ra, mba'ehetave }
                preTax: [],
                postTax: [],
                expenses: [], // { id, vore, h√©ra, mba'ehetave }
                expenseCategories: ['√ìga', 'Tape', 'Tembi'u', 'Tekove', 'Vy'a', 'Ambue'],
            };

            // --- √ëe'·∫Ω JEPORUPY (i18n) ---
            const translations = {
                ko: {
                    'app-title': 'üí∞ Kuatia√±e\'·∫Ω Rerekuaha Mba\'ehetave (USD)', 'income-title': 'Sueldo Jasykue', 'income-label': 'Sueldo Jasykue (USD)', 
                    'tax-title': 'Impuesto', 'tax-type-label': 'Impuesto Renda', 'tax-select-placeholder': 'Eiporavo Impuesto Renda', 'tax-option-custom': 'Eiporavo √ëandejara', 'tax_custom_name_placeholder': 'Eiporavo Impuesto Renda', 'tax-amount-placeholder': 'Mba\'ehetave ($)', 'tax-add-button': 'Toa√±ad√≠', 'tax-update-button': '√ëembopyahu', 'tax-cancel-button': '√ëembopyahu', 
                    'pre-tax-title': 'Impuesto √ëanduti', 'pre-tax-type-label': 'Tembipuru √ëanduti', 'pre-tax-select-placeholder': 'Eiporavo Tembipuru √ëanduti', 'pre-tax-option-custom': 'Eiporavo √ëandejara', 'pre_tax_custom_name_placeholder': 'Eiporavo Tembipuru √ëanduti', 'pre-tax-amount-placeholder': 'Mba\'ehetave ($)', 'pre-tax-add-button': 'Toa√±ad√≠', 'pre-tax-update-button': '√ëembopyahu', 'pre-tax-cancel-button': '√ëembopyahu', 
                    'post-tax-title': 'Impuesto Arakatupy', 'post-tax-type-label': 'Tembipuru Arakatupy', 'post-tax-select-placeholder': 'Eiporavo Tembipuru Arakatupy', 'post-tax-option-custom': 'Eiporavo √ëandejara', 'post_tax_custom_name_placeholder': 'Eiporavo Tembipuru Arakatupy', 'post-tax-amount-placeholder': 'Mba\'ehetave ($)', 'post-tax-add-button': 'Toa√±ad√≠', 'post-tax-update-button': '√ëembopyahu', 'post-tax-cancel-button': '√ëembopyahu',
                    'expense-management-title': 'Mba\'ehetave Rerekuaha', 'category-label': 'Vore', 'expense-name-label': 'H√©ra', 'expense-name-placeholder': 'Techapyr√£: Alquiler', 'expense-amount-label': 'Mba\'ehetave', 
                    'new-category-placeholder': 'Eiporavo Vore Pyahu H√©ra', 'add-category-button': 'Toa√±ad√≠ Vore', 'add-expense-button': 'Toa√±ad√≠ Mba\'ehetave', 'update-expense-button': '√ëembopyahu Mba\'ehetave', 'cancel-expense-button': '√ëembopyahu',
                    'monthly-financial-status-title': 'üìä Mba\'ehetave Jasykue', 'financial-analysis-chart-title': 'üìà Mba\'ehetave √ëanduti', 'income-flow-chart-title': 'Mba\'ehetave Jasykue (Mba\'ehetave √ëanduti)', 'expense-category-chart-title': 'Mba\'ehetave Voreku√©ra (Mba\'ehetave √ëanduti)', 
                    'save-button': 'üíæ √ëongatu', 'load-button': 'üìÇ Karga', 'print-button': 'üñ®Ô∏è √ëongatu', 'reset-button': 'üîÑ √ëembopyahu',
                    gross_income_label: "Sueldo √ëanduti (Mba'ehetave √ëanduti)", pre_tax_deductions_label: "√ëanduti Tembipuru", taxable_income_label: "Mba'ehetave √ëanduti", tax_total_label: "Impuesto", post_tax_deductions_label: "Impuesto Arakatupy", total_deductions_taxes_label: "Mba'ehetave √ëanduti ha Impuesto", net_income_label: "Mba'ehetave Jasykue", 
                    total_expenses_card_label: "Mba'ehetave √ëanduti", total_expenses_card_sub: "(Mba'ehetave Jasykue guive)", remaining_balance_card_label: "Mba'ehetave Opytava'er√£", remaining_balance_card_sub: "(√ëongatu/Mba'ehetave √ëanduti)", expenses_percentage_text: "Mba'ehetave √ëanduti", remaining_percentage_text: "Mba'ehetave √ëanduti",
                    alert_valid_amount: "Eiporavo mba'ehetave hekopete.", alert_custom_name: "Eiporavo mba'ehetave h√©ra.", alert_item_exists: "' ko vorepe oƒ©ma.", alert_fill_all_fields: "Emyanyh·∫Ω opa mba'ehetave rendaha hekopete.", alert_category_exists: "Vore oƒ©ma.",
                    confirm_reset: "¬øNde rehen√≥i mba'ehetave rembopyahu hagÃÉua? Ko mba'e nombyai hagÃÉua.", alert_data_saved: "Mba'ehetave o√±ongatu hekopete!", alert_save_failed: "Mba'ehetave o√±ongatu'·ªπva.", alert_data_loaded: "Mba'ehetave okarga hekopete!", alert_load_failed: "Mba'ehetave okarga'·ªπva. Ikatu o√±embyai.", alert_no_data: "Mba'ehetave o√±ongatu'·ªπva.", alert_data_reset: "Mba'ehetave o√±embopyahu.",
                    confirm_delete_item: "¬øNde rehen√≥i mba'ehetave rembopyahu hagÃÉua?" 
                },
                en: {
                    'app-title': 'üí∞ Budget Management System (USD)', 'income-title': 'Salary', 'income-label': 'Gross Monthly Salary ($)', 
                    'tax-title': 'Taxes', 'tax-type-label': 'Tax Type', 'tax-select-placeholder': 'Select tax type', 'tax-option-custom': 'Custom', 'tax_custom_name_placeholder': 'Enter tax name', 'tax-amount-placeholder': 'Amount ($)', 'tax-add-button': 'Add', 'tax-update-button': 'Update', 'tax-cancel-button': 'Cancel', 
                    'pre-tax-title': 'Pre-Tax Deductions', 'pre-tax-type-label': 'Deduction Item', 'pre-tax-select-placeholder': 'Select deduction', 'pre-tax-option-custom': 'Custom', 'pre_tax_custom_name_placeholder': 'Enter deduction name', 'pre-tax-amount-placeholder': 'Amount ($)', 'pre-tax-add-button': 'Add', 'pre-tax-update-button': 'Update', 'pre-tax-cancel-button': 'Cancel', 
                    'post-tax-title': 'Post-Tax Deductions', 'post-tax-type-label': 'Deduction Item', 'post-tax-select-placeholder': 'Select deduction', 'post-tax-option-custom': 'Custom', 'post_tax_custom_name_placeholder': 'Enter deduction name', 'post-tax-amount-placeholder': 'Amount ($)', 'post-tax-add-button': 'Add', 'post-tax-update-button': 'Update', 'post-tax-cancel-button': 'Cancel',
                    'expense-management-title': 'Expense Management', 'category-label': 'Category', 'expense-name-label': 'Item Name', 'expense-name-placeholder': 'e.g., Rent', 'expense-amount-label': 'Amount', 
                    'new-category-placeholder': 'Enter new category name', 'add-category-button': 'Add Category', 'add-expense-button': 'Add Expense', 'update-expense-button': 'Update Expense', 'cancel-expense-button': 'Cancel', 
                    'monthly-financial-status-title': 'üìä Monthly Financial Status', 'financial-analysis-chart-title': 'üìà Financial Analysis Charts', 'income-flow-chart-title': 'Fund Flow Distribution (vs. Gross Income)', 'expense-category-chart-title': 'Expense Breakdown by Category (vs. Total Expenses)', 
                    'save-button': 'üíæ Save', 'load-button': 'üìÇ Load', 'print-button': 'üñ®Ô∏è Print', 'reset-button': 'üîÑ Reset',
                    gross_income_label: "Gross Salary (Total Income)", pre_tax_deductions_label: "Pre-Tax Deductions", taxable_income_label: "Taxable Income", tax_total_label: "Taxes", post_tax_deductions_label: "Post-Tax Deductions", total_deductions_taxes_label: "Total Deductions & Taxes", net_income_label: "Net Income (Take-Home Pay)", 
                    total_expenses_card_label: "Total Expenses", total_expenses_card_sub: "(spent from Net Income)", remaining_balance_card_label: "Remaining Balance", remaining_balance_card_sub: "(for Savings/Investments)", expenses_percentage_text: "of Gross Income", remaining_percentage_text: "of Gross Income",
                    alert_valid_amount: "Please enter a valid amount.", alert_custom_name: "Please enter a name for the custom item.", alert_item_exists: "' already exists in this category.", alert_fill_all_fields: "Please fill all expense fields with valid data.", alert_category_exists: "Category already exists.",
                    confirm_reset: "Are you sure you want to reset all data? This cannot be undone.", alert_data_saved: "Data saved successfully!", alert_save_failed: "Failed to save data.", alert_data_loaded: "Data loaded successfully!", alert_load_failed: "Failed to load data. It might be corrupted.", alert_no_data: "No saved data found.", alert_data_reset: "Data has been reset.",
                    confirm_delete_item: "Are you sure you want to delete this item?"
                },
                zh: {
                    'app-title': 'üí∞ È¢ÑÁÆóÁÆ°ÁêÜÁ≥ªÁªü (USD)', 'income-title': 'Ëñ™Ê∞¥', 'income-label': 'ÏÑ∏Ï†Ñ ÏõîÍ∏âÏï° ($)', 
                    'tax-title': 'ÏÑ∏Í∏à', 'tax-type-label': 'ÏÑ∏Ï¢Ö', 'tax-select-placeholder': 'ÏÑ†ÌÉù ÏÑ∏Ï¢Ö', 'tax-option-custom': 'Ëá™ÂÆö‰πâ', 'tax_custom_name_placeholder': 'ËæìÂÖ•Á®éÈ°πÂêçÁß∞', 'tax-amount-placeholder': 'ÈáëÈ°ç ($)', 'tax-add-button': 'Ê∑ªÂä†', 'tax-update-button': 'Êõ¥Êñ∞', 'tax-cancel-button': 'ÂèñÊ∂à', 
                    'pre-tax-title': 'ÏÑ∏Ï†Ñ Í≥µÏ†ú', 'pre-tax-type-label': 'Í≥µÏ†ú Ìï≠Î™©', 'pre-tax-select-placeholder': 'ÏÑ†ÌÉù Í≥µÏ†ú Ìï≠Î™©', 'pre-tax-option-custom': 'Ëá™ÂÆö‰πâ', 'pre_tax_custom_name_placeholder': 'ËæìÂÖ•Êâ£Èô§ÂêçÁß∞', 'pre-tax-amount-placeholder': 'ÈáëÈ°ç ($)', 'pre-tax-add-button': 'Ê∑ªÂä†', 'pre-tax-update-button': 'Êõ¥Êñ∞', 'tax-cancel-button': 'ÂèñÊ∂à', 
                    'post-tax-title': 'ÏÑ∏ÌõÑ Í≥µÏ†ú', 'post-tax-type-label': 'Í≥µÏ†ú Ìï≠Î™©', 'post-tax-select-placeholder': 'ÏÑ†ÌÉù Í≥µÏ†ú Ìï≠Î™©', 'post-tax-option-custom': 'Ëá™ÂÆö‰πâ', 'post_tax_custom_name_placeholder': 'ËæìÂÖ•Êâ£Èô§ÂêçÁß∞', 'post-tax-amount-placeholder': 'ÈáëÈ°ç ($)', 'post-tax-add-button': 'Ê∑ªÂä†', 'post-tax-update-button': 'Êõ¥Êñ∞', 'post-tax-cancel-button': 'ÂèñÊ∂à',
                    'expense-management-title': 'ÏßÄÏ∂ú Í¥ÄÎ¶¨', 'category-label': 'Á±ªÂà´', 'expense-name-label': 'Ìï≠Î™©Î™Ö', 'expense-name-placeholder': 'Ïòà: ÏõîÏÑ∏', 'expense-amount-label': 'ÈáëÈ°ç', 
                    'new-category-placeholder': 'ËæìÂÖ•Êñ∞Á±ªÂà´ÂêçÁß∞', 'add-category-button': 'Ê∑ªÂä†Á±ªÂà´', 'add-expense-button': 'Ê∑ªÂä†ÊîØÂá∫', 'update-expense-button': 'Êõ¥Êñ∞ÊîØÂá∫', 'cancel-expense-button': 'ÂèñÊ∂à', 
                    'monthly-financial-status-title': 'üìä ÊØèÏõî Ïû¨Î¨¥ ÌòÑÌô©', 'financial-analysis-chart-title': 'üìà Ïû¨Î¨¥ Î∂ÑÏÑù Ï∞®Ìä∏', 'income-flow-chart-title': 'Ë≥áÈáëÊµÅÂàÜÈÖç (ËàáÁ∏ΩÊî∂ÂÖ•Áõ∏ÊØî)', 'expense-category-chart-title': 'ÊåâÁ±ªÂà´ÂàíÂàÜÁöÑÊîØÂá∫ÊòéÁªÜ (ËàáÁ∏ΩÊîØÂá∫Áõ∏ÊØî)', 
                    'save-button': 'üíæ ‰øùÂ≠ò', 'load-button': 'üìÇ Âä†ËΩΩ', 'print-button': 'üñ®Ô∏è Ïù∏ÏáÑÌïòÍ∏∞', 'reset-button': 'üîÑ Ï¥àÍ∏∞Ìôî',
                    gross_income_label: "Ï¥ùËñ™Ïàò (Ï¥ùÊî∂ÂÖ•)", pre_tax_deductions_label: "ÏÑ∏Ï†Ñ Í≥µÏ†ú", taxable_income_label: "Â∫îÁ®éÊî∂ÂÖ•", tax_total_label: "ÏÑ∏Í∏à", post_tax_deductions_label: "ÏÑ∏ÌõÑ Í≥µÏ†ú", total_deductions_taxes_label: "ÊÄª Í≥µÏ†ú Î∞è ÏÑ∏Í∏à", net_income_label: "ÂáÄÊî∂ÂÖ• (ÂÆûÂæóÂ∑•ËµÑ)", 
                    total_expenses_card_label: "ÊÄªÊîØÂá∫", total_expenses_card_sub: "(‰ªéÂáÄÊî∂ÂÖ•‰∏≠ÊîØÂá∫)", remaining_balance_card_label: "Ââ©‰Ωô‰ΩôÈ¢ù", remaining_balance_card_sub: "(Áî®ÊñºÂÇ®ËìÑ/ÊäïËµÑ)", expenses_percentage_text: "Ï¥ùÊî∂ÂÖ•Ïùò", remaining_percentage_text: "Ï¥ùÊî∂ÂÖ•Ïùò",
                    alert_valid_amount: "ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ°ç„ÄÇ", alert_custom_name: "ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÈ°πÁõÆÁöÑÂêçÁß∞„ÄÇ", alert_item_exists: "' Â∑≤Â≠òÂú®‰∫éÊ≠§Á±ªÂà´‰∏≠„ÄÇ", alert_fill_all_fields: "ËØ∑Áî®ÊúâÊïàÊï∞ÊçÆÂ°´ÂÜôÊâÄÊúâË¥πÁî®Â≠óÊÆµ„ÄÇ", alert_category_exists: "Á±ªÂà´Â∑≤Â≠òÂú®„ÄÇ",
                    confirm_reset: "ÊÇ®Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ", alert_data_saved: "Êï∞ÊçÆ‰øùÂ≠òÊàêÂäüÔºÅ", alert_save_failed: "Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•„ÄÇ", alert_data_loaded: "Êï∞ÊçÆÂä†ËΩΩÊàêÂäüÔºÅ", alert_load_failed: "Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•„ÄÇÊï∞ÊçÆÂèØËÉΩÂ∑≤ÊçüÂùè„ÄÇ", alert_no_data: "Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÊï∞ÊçÆ„ÄÇ", alert_data_reset: "Êï∞ÊçÆÂ∑≤ÈáçÁΩÆ„ÄÇ",
                    confirm_delete_item: "ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È°πÁõÆÂêóÔºü"
                },
            };

            // --- DOM REREKUAHAR√É ---
            const incomeInput = document.getElementById('income');
            const langSelect = document.getElementById('language-select');
            const categorySections = document.querySelectorAll('.card[data-category]');
            const addCategoryBtn = document.getElementById('add-category-button');
            const newCategoryInput = document.getElementById('new-category');
            const expenseCategorySelect = document.getElementById('category');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expensesListContainer = document.getElementById('expenses-list');
            const addExpenseBtn = document.getElementById('add-expense-button'); // √ëanduti ojejapova'ekue "Toa√±ad√≠ Mba'ehetave"
            let updateExpenseBtn = null; // Pyahu "√ëembopyahu Mba'ehetave"
            let cancelExpenseBtn = null; // Pyahu "√ëembopyahu Mba'ehetave"

            // Modal tembipuru
            const customModalOverlay = document.getElementById('custom-modal-overlay');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            // --- MODAL REMBIAPO ---
            // Ohechauka apa√±u√°i modal-pe peteƒ© marandu ha "OK" √±anduti.
            const showAlertDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `<button class="modal-button alert-ok">OK</button>`;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.alert-ok').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve();
                    };
                });
            };

            // Ohechauka √±embopyahu modal-pe peteƒ© marandu ha "S√≠/No" √±anduti.
            const showConfirmDialog = (message) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `
                        <button class="modal-button confirm-yes">H√©·∫Ω</button>
                        <button class="modal-button confirm-no">Nah√°niri</button>
                    `;
                    customModalOverlay.classList.add('active');

                    modalButtons.querySelector('.confirm-yes').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(true);
                    };
                    modalButtons.querySelector('.confirm-no').onclick = () => {
                        customModalOverlay.classList.remove('active');
                        resolve(false);
                    };
                });
            };

            // --- REMBIAPO POR√É ---
            // O√±emboheko mba'ehetave ojeguerojerovia hagÃÉua mok√µi decimal ha coma-re.
            const formatCurrency = (amount) => (amount ? amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : '0.00');
            // Ojejapo ID pyahu tembipuru reraha hagÃÉua.
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // --- √ëE'·∫º JEPORUPY ---
            // O√±emboheko √±e'·∫Ω ha o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua opa mba'e.
            const setLanguage = (lang) => {
                state.language = lang;
                localStorage.setItem('budgetAppLang', lang); // √ëongatu √±e'·∫Ω oƒ©va'ekue
                const t = translations[lang];

                // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua opa mba'e oƒ©va'ekue ID-pe
                document.querySelectorAll('[id]').forEach(el => {
                    const keyWithSuffix = el.id.replace(/-/g, '_'); // √ëe'·∫Ω JEPORUPY ID-pe
                    const key = el.id.replace(/-label|-title|-button|-placeholder|-text|-sub|-card/g, ''); // √ëe'·∫Ω JEPORUPY ID-pe

                    if (t[keyWithSuffix]) {
                        el.innerHTML = t[keyWithSuffix];
                    } else if (t[key]) {
                        // √ëanduti: o√±emonguatia'·ªπva, o√±emonguatia'·ªπva
                        if (el.placeholder !== undefined) el.placeholder = t[key];
                        else el.innerHTML = t[key];
                    }
                });
                
                // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua opa mba'e oƒ©va'ekue ID-pe
                document.querySelector('[data-category="taxes"] .custom-name-input').placeholder = t.tax_custom_name_placeholder;
                document.querySelector('[data-category="taxes"] .amount-input').placeholder = t['tax-amount-placeholder'];
                // Toa√±ad√≠-mba'e-btn o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
                if (document.querySelector('[data-category="taxes"] .add-item-btn')) {
                    document.querySelector('[data-category="taxes"] .add-item-btn').textContent = t['tax-add-button'];
                }
                
                document.querySelector('[data-category="preTax"] .custom-name-input').placeholder = t.pre_tax_custom_name_placeholder;
                document.querySelector('[data-category="preTax"] .amount-input').placeholder = t['pre-tax-amount-placeholder'];
                if (document.querySelector('[data-category="preTax"] .add-item-btn')) {
                    document.querySelector('[data-category="preTax"] .add-item-btn').textContent = t['pre-tax-add-button'];
                }

                document.querySelector('[data-category="postTax"] .custom-name-input').placeholder = t.post_tax_custom_name_placeholder;
                document.querySelector('[data-category="postTax"] .amount-input').placeholder = t['post-tax-amount-placeholder'];
                if (document.querySelector('[data-category="postTax"] .add-item-btn')) {
                    document.querySelector('[data-category="postTax"] .add-item-btn').textContent = t['post-tax-add-button'];
                }


                document.getElementById('expense-name').placeholder = t['expense-name-placeholder'];
                document.getElementById('expense-amount').placeholder = t['expense-amount-label']; 
                document.getElementById('new-category').placeholder = t['new-category-placeholder'];
                document.getElementById('add-expense-button').textContent = t['add-expense-button']; 

                // √ëanduti: √ëembopyahu/√ëembopyahu
                if (updateExpenseBtn) updateExpenseBtn.textContent = t['update-expense-button'];
                if (cancelExpenseBtn) cancelExpenseBtn.textContent = t['cancel-expense-button'];

                // √ëanduti √±embopyahu/√±embopyahu
                categorySections.forEach(section => {
                    const category = section.dataset.category;
                    const updateBtn = section.querySelector('.update-item-btn');
                    const cancelBtn = section.querySelector('.cancel-item-btn');
                    const addBtn = section.querySelector('.add-item-btn'); // Toa√±ad√≠ mba'e

                    if (updateBtn) updateBtn.textContent = t[`${category}-update-button`];
                    if (cancelBtn) cancelBtn.textContent = t[`${category}-cancel-button`];
                    if (addBtn) addBtn.textContent = t[`${category}-add-button`]; // Toa√±ad√≠ mba'e
                });

                document.documentElement.lang = lang.split('-')[0]; // √ëanduti √±embopyahu
                fullUpdate(); // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            };
            
            // --- √ëANDUTI REMBIAPO ---
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua Impuesto renda, Impuesto √ëanduti, Impuesto Arakatupy.
            const renderCategorizedList = (category) => {
                const listContainer = document.getElementById(`${category}-list`);
                listContainer.innerHTML = '';
                state[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(item.amount)}</span>
                            <button class="item-edit-btn" data-id="${item.id}" data-category="${category}">√ëembopyahu</button>
                            <button class="item-delete-btn" data-id="${item.id}" data-category="${category}">X</button>
                        </div>
                    `;
                    listContainer.appendChild(itemDiv);
                });
            };

            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua Mba'ehetave vore.
            const renderExpenseCategories = () => {
                expenseCategorySelect.innerHTML = '';
                state.expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    expenseCategorySelect.appendChild(option);
                });
            };

            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua Mba'ehetave.
            const renderExpensesList = () => {
                expensesListContainer.innerHTML = '';
                state.expenses.forEach(exp => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span class="item-name">${exp.category}: ${exp.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="item-amount">-$${formatCurrency(exp.amount)}</span>
                            <button class="item-edit-btn" data-id="${exp.id}" data-category="expenses">√ëembopyahu</button>
                            <button class="item-delete-btn" data-id="${exp.id}" data-category="expenses">X</button>
                        </div>
                    `;
                    expensesListContainer.appendChild(itemDiv);
                });
            };

            // --- √ëanduti √±embopyahu ---
            // O√±emboheko opa mba'ehetave √±anduti ha o√±emonguatia'·ªπva.
            const calculateAndUpdateAll = () => {
                const t = translations[state.language];
                const income = state.income || 0;

                const preTaxDeductions = state.preTax.reduce((sum, item) => sum + item.amount, 0);
                const taxableIncome = Math.max(0, income - preTaxDeductions);
                const taxTotal = state.taxes.reduce((sum, item) => sum + item.amount, 0);
                const postTaxDeductions = state.postTax.reduce((sum, item) => sum + item.amount, 0);
                const totalDeductionsAndTaxes = preTaxDeductions + taxTotal + postTaxDeductions;
                const netIncome = Math.max(0, income - totalDeductionsAndTaxes);
                const expensesTotal = state.expenses.reduce((sum, item) => sum + item.amount, 0);
                const remainingBalance = netIncome - expensesTotal;

                const incomeFlowContainer = document.querySelector('.income-flow');
                incomeFlowContainer.innerHTML = `
                    <div class="flow-item"><span class="flow-label">${t.gross_income_label}</span> <span class="flow-amount">$${formatCurrency(income)} <em class="percentage highlighted-percentage">(100.0%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.pre_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(preTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? preTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item"><span class="flow-label"><strong>${t.taxable_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(taxableIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxableIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.tax_total_label}</span> <span class="flow-amount">-$${formatCurrency(taxTotal)} <em class="percentage highlighted-percentage">(${(income > 0 ? taxTotal / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item highlighted"><span class="flow-label">${t.post_tax_deductions_label}</span> <span class="flow-amount">-$${formatCurrency(postTaxDeductions)} <em class="percentage highlighted-percentage">(${(income > 0 ? postTaxDeductions / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item info"><span class="flow-label"><strong>${t.total_deductions_taxes_label}</strong></span> <span class="flow-amount">-$${formatCurrency(totalDeductionsAndTaxes)} <em class="percentage highlighted-percentage">(${(income > 0 ? totalDeductionsAndTaxes / income * 100 : 0).toFixed(1)}%)</em></span></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item result"><span class="flow-label"><strong>${t.net_income_label}</strong></span> <span class="flow-amount">$${formatCurrency(netIncome)} <em class="percentage highlighted-percentage">(${(income > 0 ? netIncome / income * 100 : 0).toFixed(1)}%)</em></span></div>
                `;

                const summaryCardsContainer = document.querySelector('.summary-cards');
                summaryCardsContainer.innerHTML = `
                    <div class="summary-card">
                        <div class="card-label">${t.total_expenses_card_label}</div>
                        <div class="card-amount negative">$${formatCurrency(expensesTotal)}</div>
                        <div class="card-sub">${t.total_expenses_card_sub}</div>
                        <div class="card-percentage">${t.expenses_percentage_text} <span class="highlighted-percentage">${(income > 0 ? expensesTotal / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                    <div class="summary-card accent">
                        <div class="card-label">${t.remaining_balance_card_label}</div>
                        <div class="card-amount ${remainingBalance < 0 ? 'negative' : ''}">$${formatCurrency(remainingBalance)}</div>
                        <div class="card-sub">${t.remaining_balance_card_sub}</div>
                        <div class="card-percentage">${t.remaining_percentage_text} <span class="highlighted-percentage">${(income > 0 ? remainingBalance / income * 100 : 0).toFixed(1)}%</span></div>
                    </div>
                `;

                updateCharts({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions });
            };

            // --- TA'ANGA √ëANDUTI ---
            let incomeFlowChart, expenseCategoryChart;
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua ta'anga.
            const updateCharts = ({ netIncome, taxTotal, preTaxDeductions, postTaxDeductions }) => {
                const incomeFlowCtx = document.getElementById('incomeFlowChart')?.getContext('2d');
                const expenseCategoryCtx = document.getElementById('expenseCategoryChart')?.getContext('2d');

                if (!incomeFlowCtx || !expenseCategoryCtx) return;

                // Ta'anga o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
                incomeFlowCtx.canvas.parentNode.style.height = '350px';
                incomeFlowCtx.canvas.parentNode.style.position = 'relative';
                expenseCategoryCtx.canvas.parentNode.style.height = '350px';
                expenseCategoryCtx.canvas.parentNode.style.position = 'relative';

                if (incomeFlowChart) incomeFlowChart.destroy();
                incomeFlowChart = new Chart(incomeFlowCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mba\'ehetave Jasykue', 'Impuesto', '√ëanduti Tembipuru', 'Impuesto Arakatupy'],
                        datasets: [{
                            data: [Math.max(0, netIncome), taxTotal, preTaxDeductions, postTaxDeductions],
                            backgroundColor: ['#7ed321', '#d0021b', '#f5a623', '#4a90e2'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
                
                const expenseData = state.expenseCategories.map(cat => state.expenses.filter(exp => exp.category === cat).reduce((sum, exp) => sum + exp.amount, 0));

                if (expenseCategoryChart) expenseCategoryChart.destroy();
                expenseCategoryChart = new Chart(expenseCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: state.expenseCategories,
                        datasets: [{
                            data: expenseData,
                            backgroundColor: ['#4a90e2', '#50e3c2', '#f5a623', '#bd10e0', '#b8e986', '#7ed321', '#4a4a4a', '#9013fe', '#f8e71c', '#d0021b']
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return value > 0 ? percentage : '';
                                }, color: '#fff',
                            }
                        }
                    },
                });
            };
            
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            const fullUpdate = () => {
                renderExpenseCategories();
                renderExpensesList();
                renderCategorizedList('taxes');
                renderCategorizedList('preTax');
                renderCategorizedList('postTax');
                calculateAndUpdateAll();
            };

            // --- √ëANDUTI REMBIAPO ---
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            incomeInput.addEventListener('input', (e) => {
                state.income = parseFloat(e.target.value) || 0;
                calculateAndUpdateAll();
            });

            // √ëanduti √±embopyahu/√±embopyahu
            categorySections.forEach(section => {
                const category = section.dataset.category;
                const select = section.querySelector('.category-select');
                const inputContainer = section.querySelector('.category-input-container');
                const customNameInput = section.querySelector('.custom-name-input');
                const amountInput = section.querySelector('.amount-input');
                const addButton = section.querySelector('.add-item-btn');
                
                // Pyahu √±anduti.
                // √ëanduti o√±embotapykueva'er√£.
                let updateButton = section.querySelector('.update-item-btn');
                let cancelButton = section.querySelector('.cancel-item-btn');

                if (!updateButton) {
                    updateButton = document.createElement('button');
                    updateButton.className = 'update-item-btn hidden'; // √ëanduti o√±embotapykueva'er√£
                    inputContainer.appendChild(updateButton);
                }
                if (!cancelButton) {
                    cancelButton = document.createElement('button');
                    cancelButton.className = 'cancel-item-btn hidden utility-btn'; // √ëanduti o√±embotapykueva'er√£
                    cancelButton.style.backgroundColor = '#6c757d'; 
                    inputContainer.appendChild(cancelButton);
                }

                // Estado o√±emonguatia'·ªπva
                let editingItemId = null;

                /**
                 * O√±emboheko edit mode vorepe.
                 * O√±emboheko √±anduti ha o√±emonguatia'·ªπva.
                 * @param {boolean} isEditing - True o√±emonguatia'·ªπva, False o√±emonguatia'·ªπva.
                 * @param {object | null} item - Tembipuru o√±emonguatia'·ªπva (o√±emonguatia'·ªπva).
                 */
                const setSectionEditMode = (isEditing, item = null) => {
                    const t = translations[state.language]; 
                    if (isEditing) {
                        // √ëanduti o√±embotapykueva'er√£.
                        addButton.classList.add('hidden');
                        updateButton.classList.remove('hidden');
                        cancelButton.classList.remove('hidden');
                        // √ëanduti o√±emonguatia'·ªπva
                        updateButton.textContent = t[`${category}-update-button`];
                        cancelButton.textContent = t[`${category}-cancel-button`];

                        if (item) {
                            editingItemId = item.id;
                            // √ëanduti: item.h√©ra oƒ©ma.
                            const optionExists = Array.from(select.options).some(option => option.value === item.name);
                            if (optionExists && select.querySelector(`option[value="${item.name}"]`)) { 
                                select.value = item.name;
                                customNameInput.style.display = 'none';
                            } else {
                                select.value = 'custom';
                                customNameInput.value = item.name;
                                customNameInput.style.display = 'block';
                            }
                            amountInput.value = item.amount;
                            inputContainer.style.display = 'flex'; // √ëanduti o√±emonguatia'·ªπva
                            amountInput.focus(); // √ëanduti o√±emonguatia'·ªπva
                        }
                    } else {
                        // √ëanduti √±embopyahu, o√±emonguatia'·ªπva.
                        addButton.classList.remove('hidden');
                        updateButton.classList.add('hidden');
                        cancelButton.classList.add('hidden');
                        addButton.textContent = t[`${category}-add-button`]; // √ëanduti o√±emonguatia'·ªπva
                        editingItemId = null; // Estado o√±emonguatia'·ªπva
                        
                        // √ëanduti: select.value o√±embopyahu'·ªπva.
                        customNameInput.value = '';
                        amountInput.value = '';
                        customNameInput.style.display = 'none'; // √ëanduti o√±embotapykueva'er√£
                        
                        // √ëanduti: inputContainer o√±embotapykueva'er√£.
                        if (!select.value) { // K√≥va o√±emonguatia'·ªπva
                            inputContainer.style.display = 'none'; 
                        }
                    }
                };

                // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
                section.setEditMode = setSectionEditMode;

                // √ëanduti o√±emonguatia'·ªπva.
                select.addEventListener('change', () => {
                    // √ëanduti o√±emonguatia'·ªπva
                    // √ëanduti o√±emonguatia'·ªπva
                    // √ëanduti o√±emonguatia'·ªπva
                    // √ëanduti o√±emonguatia'·ªπva
                    setSectionEditMode(false); 

                    // √ëanduti o√±emonguatia'·ªπva
                    if (select.value) { // √ëanduti o√±emonguatia'·ªπva
                        inputContainer.style.display = 'flex'; // √ëanduti o√±emonguatia'·ªπva
                        amountInput.value = ''; // √ëanduti o√±emonguatia'·ªπva
                        
                        if (select.value === 'custom') {
                            customNameInput.style.display = 'block';
                            customNameInput.value = ''; // √ëanduti o√±emonguatia'·ªπva
                            customNameInput.focus();
                        } else {
                            customNameInput.style.display = 'none';
                            customNameInput.value = ''; // √ëanduti o√±emonguatia'·ªπva
                            amountInput.focus();
                        }
                    } else {
                        // √ëanduti o√±emonguatia'·ªπva
                        inputContainer.style.display = 'none';
                        customNameInput.style.display = 'none';
                        amountInput.value = '';
                        customNameInput.value = ''; // √ëanduti o√±emonguatia'·ªπva
                    }
                });
                
                // Toa√±ad√≠ mba'e (√±anduti ojejapova'ekue "Apply" √±anduti)
                addButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }
                    
                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }
                    
                    // √ëanduti o√±emonguatia'·ªπva
                    if(state[category].some(item => item.name.toLowerCase() === name.toLowerCase())) { await showAlertDialog(`'${name}'` + t.alert_item_exists); return; }

                    state[category].push({ id: generateId(), name, amount });
                    
                    setSectionEditMode(false); // √ëanduti o√±emonguatia'·ªπva
                    fullUpdate(); // √ëanduti o√±emonguatia'·ªπva
                });

                // √ëanduti √±embopyahu
                updateButton.addEventListener('click', async () => {
                    const t = translations[state.language];
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_valid_amount); return; }

                    let name = select.value === 'custom' ? customNameInput.value.trim() : select.options[select.selectedIndex].text;
                    if (select.value === 'custom' && !name) { await showAlertDialog(t.alert_custom_name); return; }

                    // √ëanduti o√±emonguatia'·ªπva
                    if(state[category].some(item => item.id !== editingItemId && item.name.toLowerCase() === name.toLowerCase())) {
                        await showAlertDialog(`'${name}'` + t.alert_item_exists); return;
                    }

                    state[category] = state[category].map(item =>
                        item.id === editingItemId ? { ...item, name, amount } : item
                    );
                    
                    setSectionEditMode(false); // √ëanduti o√±emonguatia'·ªπva
                    fullUpdate(); // √ëanduti o√±emonguatia'·ªπva
                });

                // √ëanduti √±embopyahu
                cancelButton.addEventListener('click', () => {
                    setSectionEditMode(false); // √ëanduti o√±emonguatia'·ªπva
                });
            });
            
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            document.body.addEventListener('click', async (e) => {
                if (e.target.classList.contains('item-delete-btn')) {
                    const { id, category } = e.target.dataset;
                    // √ëanduti o√±emonguatia'·ªπva
                    if (await showConfirmDialog(translations[state.language].confirm_delete_item)) {
                        state[category] = state[category].filter(item => item.id !== id);
                        fullUpdate();
                    } 
                } else if (e.target.classList.contains('item-edit-btn')) {
                    const { id, category } = e.target.dataset;
                    const itemToEdit = state[category].find(item => item.id === id);

                    if (itemToEdit) {
                        // √ëanduti o√±emonguatia'·ªπva
                        if (category === 'expenses') {
                            // √ëanduti o√±emonguatia'·ªπva
                            expenseCategorySelect.value = itemToEdit.category;
                            expenseNameInput.value = itemToEdit.name;
                            expenseAmountInput.value = itemToEdit.amount;

                            addExpenseBtn.classList.add('hidden');
                            // √ëanduti o√±emonguatia'·ªπva
                            if (!updateExpenseBtn) { 
                                const expenseButtonContainer = addExpenseBtn.parentNode;
                                updateExpenseBtn = document.createElement('button');
                                updateExpenseBtn.id = 'update-expense-button';
                                updateExpenseBtn.textContent = translations[state.language]['update-expense-button'];
                                updateExpenseBtn.style.width = '100%';
                                updateExpenseBtn.style.marginTop = '1rem';
                                expenseButtonContainer.insertBefore(updateExpenseBtn, addExpenseBtn);

                                cancelExpenseBtn = document.createElement('button');
                                cancelExpenseBtn.id = 'cancel-expense-button';
                                cancelExpenseBtn.textContent = translations[state.language]['cancel-expense-button'];
                                cancelExpenseBtn.className = 'utility-btn';
                                cancelExpenseBtn.style.width = '100%';
                                cancelExpenseBtn.style.marginTop = '1rem';
                                cancelExpenseBtn.style.backgroundColor = '#6c757d';
                                expenseButtonContainer.insertBefore(cancelExpenseBtn, addExpenseBtn);

                                // √ëanduti o√±emonguatia'·ªπva
                                updateExpenseBtn.addEventListener('click', async () => {
                                    const t = translations[state.language];
                                    const categoryVal = expenseCategorySelect.value;
                                    const name = expenseNameInput.value.trim();
                                    const amount = parseFloat(expenseAmountInput.value);

                                    if (!categoryVal || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }

                                    state.expenses = state.expenses.map(exp =>
                                        exp.id === editingItemIdForExpenses ? { ...exp, category: categoryVal, name, amount } : exp
                                    );
                                    resetExpenseForm();
                                    fullUpdate();
                                });

                                cancelExpenseBtn.addEventListener('click', () => {
                                    resetExpenseForm();
                                });
                            }
                            updateExpenseBtn.classList.remove('hidden');
                            cancelExpenseBtn.classList.remove('hidden');
                            editingItemIdForExpenses = id; // √ëanduti o√±emonguatia'·ªπva
                        } else {
                            // √ëanduti o√±emonguatia'·ªπva
                            const section = document.querySelector(`.card[data-category="${category}"]`);
                            // √ëanduti o√±emonguatia'·ªπva
                            if (section && section.setEditMode) {
                                section.setEditMode(true, itemToEdit); // √ëanduti o√±emonguatia'·ªπva
                            }
                        }
                    }
                }
            });

            // √ëanduti o√±emonguatia'·ªπva
            const resetExpenseForm = () => {
                expenseCategorySelect.value = state.expenseCategories[0]; // √ëanduti o√±emonguatia'·ªπva
                expenseNameInput.value = '';
                expenseAmountInput.value = '';
                addExpenseBtn.classList.remove('hidden');
                if (updateExpenseBtn) updateExpenseBtn.classList.add('hidden');
                if (cancelExpenseBtn) cancelExpenseBtn.classList.add('hidden');
                editingItemIdForExpenses = null;
            };
            let editingItemIdForExpenses = null; // √ëanduti o√±emonguatia'·ªπva

            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            addCategoryBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const newCategory = newCategoryInput.value.trim();
                if (newCategory && !state.expenseCategories.includes(newCategory)) {
                    state.expenseCategories.push(newCategory);
                    newCategoryInput.value = '';
                    renderExpenseCategories();
                } else if (state.expenseCategories.includes(newCategory)) {
                    await showAlertDialog(t.alert_category_exists);
                }
            });
            
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            addExpenseBtn.addEventListener('click', async () => {
                const t = translations[state.language];
                const category = expenseCategorySelect.value;
                const name = expenseNameInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);

                if (!category || !name || isNaN(amount) || amount <= 0) { await showAlertDialog(t.alert_fill_all_fields); return; }
                
                state.expenses.push({ id: generateId(), category, name, amount });
                resetExpenseForm(); // √ëanduti o√±emonguatia'·ªπva
                fullUpdate();
            });
            
            // √ëe'·∫Ω jeporu.
            langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

            // √ëongatu √±anduti oƒ©va'ekue local storage-pe.
            document.getElementById('save-button').addEventListener('click', async () => {
                const t = translations[state.language];
                try {
                    localStorage.setItem('budgetAppData', JSON.stringify(state));
                    await showAlertDialog(t.alert_data_saved);
                } catch (error) {
                    console.error('Mba\'ehetave o√±ongatu\'·ªπva:', error);
                    await showAlertDialog(t.alert_save_failed);
                }
            });

            // Karga √±anduti oƒ©va'ekue local storage-pe.
            document.getElementById('load-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const savedData = localStorage.getItem('budgetAppData');
                if (savedData) {
                    try {
                        const loadedState = JSON.parse(savedData);
                        // Mba'ehetave o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
                        state.income = loadedState.income || 0;
                        state.taxes = Array.isArray(loadedState.taxes) ? loadedState.taxes : [];
                        state.preTax = Array.isArray(loadedState.preTax) ? loadedState.preTax : [];
                        state.postTax = Array.isArray(loadedState.postTax) ? loadedState.postTax : [];
                        state.expenses = Array.isArray(loadedState.expenses) ? loadedState.expenses : [];
                        state.expenseCategories = Array.isArray(loadedState.expenseCategories) ? loadedState.expenseCategories : ['√ìga', 'Tape', 'Tembi\'u', 'Tekove', 'Vy\'a', 'Ambue'];
                        
                        langSelect.value = loadedState.language || 'ko';
                        setLanguage(langSelect.value); // √ëanduti √±embopyahu
                        await showAlertDialog(t.alert_data_loaded);
                    } catch(error) {
                        console.error('Mba\'ehetave okarga\'·ªπva:', error);
                        await showAlertDialog(t.alert_load_failed);
                    }
                } else {
                    await showAlertDialog(t.alert_no_data);
                }
            });
            
            // O√±embopyahu opa mba'ehetave.
            document.getElementById('reset-button').addEventListener('click', async () => {
                const t = translations[state.language];
                const confirmed = await showConfirmDialog(t.confirm_reset);
                if (confirmed) {
                    localStorage.removeItem('budgetAppData');
                    // Mba'ehetave o√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
                    state = { 
                        language: state.language, 
                        income: 0, 
                        taxes: [], 
                        preTax: [], 
                        postTax: [], 
                        expenses: [], 
                        expenseCategories: ['√ìga', 'Tape', 'Tembi\'u', 'Tekove', 'Vy\'a', 'Ambue'], 
                    };
                    incomeInput.value = '';
                    setLanguage(state.language); // √ëanduti √±embopyahu
                    await showAlertDialog(t.alert_data_reset);
                }
            });
            
            // --- √ëANDUTI REMBIAPO ---
            // O√±emonguatia'·ªπva ojeguerojerovia hagÃÉua
            const savedLang = localStorage.getItem('budgetAppLang') || 'ko';
            langSelect.value = savedLang;
            setLanguage(savedLang); // √ëanduti √±embopyahu
        });
    </script>
</body>
</html>
