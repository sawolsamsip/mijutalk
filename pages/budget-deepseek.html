<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다국어 예산 관리 시스템</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #7209b7;
            --text-color: #24243e;
            --light-gray: #f7faff;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --white: #ffffff;
            --shadow: 0 4px 24px rgba(67,97,238,0.10);
            --border-radius: 16px;
        }
        html { background: var(--light-gray); }
        body {
            font-family: 'Inter', 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: var(--text-color);
            background: var(--light-gray);
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 48px auto 48px auto;
            padding: 28px 20px 40px 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }
        .language-switcher {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
            z-index: 10;
        }
        .language-btn {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            border-radius: 18px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.15s;
            box-shadow: 0 2px 10px rgba(67,97,238,0.08);
        }
        .language-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 16px rgba(67,97,238,0.16);
            transform: translateY(-2px) scale(1.04);
        }
        header {
            text-align: center;
            margin-bottom: 36px;
        }
        h1 { color: var(--primary); font-size: 2.3rem; margin-bottom: 13px; font-weight: 700; }
        h2 { color: var(--primary); font-size: 1.25rem; margin-bottom: 17px; font-weight: 700; }
        .card {
            background: var(--white);
            padding: 25px 22px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1.5px solid #e6e8ec;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }
        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        input, select {
            width: 100%;
            padding: 11px 12px;
            border: 1.5px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #f7faff;
        }
        select { cursor: pointer; }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.13);
        }
        button {
            background: linear-gradient(90deg, #4361ee, #4895ef);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.16s, box-shadow 0.18s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(67,97,238,0.09);
        }
        button:hover { background: linear-gradient(90deg, #4895ef, #4361ee); transform: translateY(-2px) scale(1.04);}
        .btn-danger { background: linear-gradient(90deg, #f72585, #d6336c);}
        .btn-danger:hover { background: linear-gradient(90deg, #d6336c, #f72585);}
        .btn-warning { background: linear-gradient(90deg, #f8961e, #e67700);}
        .btn-warning:hover { background: linear-gradient(90deg, #e67700, #f8961e);}
        .btn-success { background: linear-gradient(90deg, #4cc9f0, #4361ee); color: var(--text-color);}
        .btn-success:hover { background: linear-gradient(90deg, #4361ee, #4cc9f0); color: #fff;}
        .btn-info { background: linear-gradient(90deg, #7209b7, #4895ef);}
        .btn-info:hover { background: linear-gradient(90deg, #4895ef, #7209b7);}
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.92rem;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
            margin-right: 4px;
        }
        .item-list { margin-top: 12px; }
        .list-item {
            background: var(--white);
            padding: 13px 10px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 5px rgba(67,97,238,0.07);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            border: 1px solid #f3f3f7;
        }
        .list-item:hover {
            transform: translateX(4px) scale(1.01);
            box-shadow: 0 6px 18px rgba(67,97,238,0.10);
        }
        .list-item-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            width: 70%;
        }
        .expense-name { flex: 2; min-width: 80px; }
        .expense-amount { min-width: 80px; text-align: right; font-weight: bold; }
        .list-item-actions { display: flex; gap: 7px; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 23px;
        }
        .summary-card {
            background: var(--white);
            padding: 18px 0 16px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        .card-label { font-size: 0.96rem; color: var(--medium-gray); margin-bottom: 2px; }
        .card-amount { font-size: 1.7rem; font-weight: 700; margin: 9px 0; }
        .positive { color: var(--success);}
        .negative { color: var(--danger);}
        .flex { display: flex; gap: 12px; align-items: flex-end;}
        .flex > div { flex: 1;}
        .chart-container {
            background: var(--white);
            padding: 18px 12px 24px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            margin-top: 5px;
            height: 430px;
            position: relative;
            border: 1.5px solid #e6e8ec;
        }
        .chart-wrapper {
            width: 100%;
            height: 340px;
            position: relative;
        }
        .chart-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 700;
        }
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 28px 0 8px 0;
            flex-wrap: wrap;
        }
        .hidden { display: none;}
        @media (max-width: 900px) {
            .container { margin: 18px 3px;}
            .chart-container { height: 320px;}
            .chart-wrapper { height: 220px;}
            .list-item-content { width: 100%; }
        }
        @media (max-width: 600px) {
            .container { padding: 8px 2px;}
            .summary-cards { grid-template-columns: 1fr;}
            .chart-container { height: 260px;}
            .chart-wrapper { height: 140px;}
            .language-switcher { justify-content: center;}
            .list-item-content { flex-direction: column; gap: 4px; align-items: flex-start; width: 100%; }
            .expense-amount { text-align: left; }
        }
        @media print {
            body { padding: 0; background: white;}
            button, .utility-buttons, .language-switcher { display: none;}
            .card, .chart-container { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid;}
            .chart-container { height: auto;}
        }
        /* 월별 재무현황(흐름) 개선 */
        .income-flow {
            margin: 0 0 20px 0;
            padding: 0;
        }
        .flow-step {
            display: flex;
            justify-content: space-between;
            background: #f7faff;
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 10px 16px;
            font-size: 1.13rem;
            border-left: 6px solid #4895ef;
            align-items: center;
        }
        .flow-step.negative { border-left-color: #f72585; background: #fff2f7;}
        .flow-step.positive { border-left-color: #4cc9f0; background: #f2fcff;}
        .flow-label { font-weight: 600; }
        .flow-values { font-family: 'Inter', monospace;}
        .flow-arrow {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="language-switcher">
        <button id="lang-ko" class="language-btn active">한국어</button>
        <button id="lang-en" class="language-btn">English</button>
    </div>
    <header>
        <h1 data-lang="ko">💰 고급 예산 관리 시스템</h1>
        <h1 data-lang="en" class="hidden">💰 Advanced Budget Management System</h1>
        <p data-lang="ko">한 곳에서 수입, 세금, 공제 및 지출을 관리하세요</p>
        <p data-lang="en" class="hidden">Manage your income, taxes, deductions, and expenses in one place</p>
    </header>
    <!-- 1. 수입 -->
    <div class="card">
        <h2 data-lang="ko">1. 수입</h2>
        <h2 data-lang="en" class="hidden">1. Earnings</h2>
        <div class="form-group">
            <label data-lang="ko">1회 지급액</label>
            <label class="hidden" data-lang="en">Amount per paycheck</label>
            <input type="number" id="income-per-paycheck" placeholder="회당 수입">
            <select id="income-period">
                <option value="monthly" selected data-lang="ko">월 1회</option>
                <option value="biweekly" data-lang="ko">2주 1회</option>
                <option value="weekly" data-lang="ko">매주</option>
                <option value="monthly" class="hidden" data-lang="en">Monthly</option>
                <option value="biweekly" class="hidden" data-lang="en">Biweekly</option>
                <option value="weekly" class="hidden" data-lang="en">Weekly</option>
            </select>
            <div id="income-summary" style="color:var(--medium-gray);margin-top:5px"></div>
        </div>
    </div>
    <!-- 2. 세금 -->
    <div class="card">
        <h2 data-lang="ko">2. 직원 세금</h2>
        <h2 data-lang="en" class="hidden">2. Employee Taxes</h2>
        <div class="form-group">
            <label data-lang="ko">세금 유형</label>
            <label class="hidden" data-lang="en">Tax Type</label>
            <select id="tax-type-select"></select>
            <input type="number" id="tax-amount-input" placeholder="회당 세금">
            <input type="text" id="tax-custom-name-input" class="hidden" placeholder="세금 이름">
            <button onclick="addCategorizedItem('taxes')" class="btn-success" style="margin-top:7px;" id="tax-add-btn" data-lang="ko">세금 추가</button>
            <button onclick="addCategorizedItem('taxes')" class="btn-success hidden" style="margin-top:7px;" data-lang="en">Add Tax</button>
        </div>
        <div class="item-list" id="tax-list"></div>
    </div>
    <!-- 3. 세전 공제 -->
    <div class="card">
        <h2 data-lang="ko">3. 세전 공제</h2>
        <h2 data-lang="en" class="hidden">3. Pre-Tax Deductions</h2>
        <div class="form-group">
            <label data-lang="ko">공제 유형</label>
            <label class="hidden" data-lang="en">Deduction Type</label>
            <select id="pre-tax-type-select"></select>
            <input type="number" id="pre-tax-amount-input" placeholder="회당 공제">
            <input type="text" id="pre-tax-custom-name-input" class="hidden" placeholder="공제 이름">
            <button onclick="addCategorizedItem('preTax')" class="btn-success" style="margin-top:7px;" data-lang="ko">공제 추가</button>
            <button onclick="addCategorizedItem('preTax')" class="btn-success hidden" style="margin-top:7px;" data-lang="en">Add Deduction</button>
        </div>
        <div class="item-list" id="pre-tax-list"></div>
    </div>
    <!-- 4. 세후 공제 -->
    <div class="card">
        <h2 data-lang="ko">4. 세후 공제</h2>
        <h2 data-lang="en" class="hidden">4. Post-Tax Deductions</h2>
        <div class="form-group">
            <label data-lang="ko">공제 유형</label>
            <label class="hidden" data-lang="en">Deduction Type</label>
            <select id="post-tax-type-select"></select>
            <input type="number" id="post-tax-amount-input" placeholder="회당 공제">
            <input type="text" id="post-tax-custom-name-input" class="hidden" placeholder="공제 이름">
            <button onclick="addCategorizedItem('postTax')" class="btn-success" style="margin-top:7px;" data-lang="ko">공제 추가</button>
            <button onclick="addCategorizedItem('postTax')" class="btn-success hidden" style="margin-top:7px;" data-lang="en">Add Deduction</button>
        </div>
        <div class="item-list" id="post-tax-list"></div>
    </div>
    <!-- 5. 지출 관리 -->
    <div class="card">
        <h2 data-lang="ko">5. 지출 관리</h2>
        <h2 data-lang="en" class="hidden">5. Expense Management</h2>
        <div class="grid">
            <div class="form-group">
                <label data-lang="ko">카테고리</label>
                <label class="hidden" data-lang="en">Category</label>
                <select id="category-select"></select>
            </div>
            <div class="form-group">
                <label data-lang="ko">지출 항목</label>
                <label class="hidden" data-lang="en">Expense Name</label>
                <input type="text" id="expense-name-input" placeholder="예: 월세">
            </div>
            <div class="form-group">
                <label data-lang="ko">금액 ($)</label>
                <label class="hidden" data-lang="en">Amount ($)</label>
                <input type="number" id="expense-amount-input-main" placeholder="금액 입력">
            </div>
        </div>
        <div id="category-input-container" class="form-group hidden">
            <div class="flex">
                <div>
                    <label data-lang="ko">새 카테고리 이름</label>
                    <label class="hidden" data-lang="en">New Category Name</label>
                    <input type="text" id="new-category-input" placeholder="새 카테고리 입력">
                </div>
                <div>
                    <button onclick="addCategory()" class="btn-info" data-lang="ko">카테고리 추가</button>
                    <button onclick="addCategory()" class="btn-info hidden" data-lang="en">Add Category</button>
                </div>
            </div>
        </div>
        <button onclick="addExpense()" class="btn-success" style="width: 100%; margin-top: 10px;" data-lang="ko" id="expense-add-btn">지출 추가</button>
        <button onclick="addExpense()" class="btn-success hidden" style="width: 100%; margin-top: 10px;" data-lang="en">Add Expense</button>
        <div class="item-list" id="expenses-list"></div>
    </div>
    <!-- 6. 월별 재무 현황 -->
    <div class="card">
        <h2 data-lang="ko">6. 월별 재무 현황</h2>
        <h2 data-lang="en" class="hidden">6. Monthly Financial Status</h2>
        <div class="income-flow" id="income-flow-view"></div>
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-label" data-lang="ko">총 지출</div>
                <div class="card-label hidden" data-lang="en">Total Expenses</div>
                <div class="card-amount negative">$<span id="expenses-total-card">0.00</span></div>
                <div class="card-label" data-lang="ko">(순수입에서 사용된 금액)</div>
                <div class="card-label hidden" data-lang="en">(Amount used from net income)</div>
                <div class="card-label"><span id="expenses-percentage-card">0.0%</span> <span data-lang="ko">of 총 수입</span><span data-lang="en" class="hidden">of gross income</span></div>
            </div>
            <div class="summary-card">
                <div class="card-label" data-lang="ko">남은 잔액</div>
                <div class="card-label hidden" data-lang="en">Remaining Balance</div>
                <div class="card-amount positive">$<span id="remaining-balance">0.00</span></div>
                <div class="card-label" data-lang="ko">(순수입 - 총 지출 = 저축)</div>
                <div class="card-label hidden" data-lang="en">(Net Income - Expenses = Savings)</div>
                <div class="card-label"><span id="remaining-percentage-card">0.0%</span> <span data-lang="ko">of 총 수입</span><span data-lang="en" class="hidden">of gross income</span></div>
            </div>
        </div>
    </div>
    <!-- 7. 차트 -->
    <div class="chart-container">
        <h2 data-lang="ko">7. 재무 분석 차트</h2>
        <h2 data-lang="en" class="hidden">7. Financial Analysis Charts</h2>
        <div class="grid">
            <div>
                <div class="chart-title" data-lang="ko">수입 분배 (총 수입 대비 비율)</div>
                <div class="chart-title hidden" data-lang="en">Income Distribution (Percentage of Gross Income)</div>
                <div class="chart-wrapper">
                    <canvas id="incomeFlowChart"></canvas>
                </div>
            </div>
            <div>
                <div class="chart-title" data-lang="ko">지출 카테고리 (총 지출 대비 비율)</div>
                <div class="chart-title hidden" data-lang="en">Expense Categories (Percentage of Total Expenses)</div>
                <div class="chart-wrapper">
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="utility-buttons">
        <button onclick="saveData()" class="btn-info" data-lang="ko">💾 데이터 저장</button>
        <button onclick="saveData()" class="btn-info hidden" data-lang="en">💾 Save Data</button>
        <button onclick="loadData()" class="btn-info" data-lang="ko">📂 데이터 불러오기</button>
        <button onclick="loadData()" class="btn-info hidden" data-lang="en">📂 Load Data</button>
        <button onclick="window.print()" class="btn-warning" data-lang="ko">🖨️ 리포트 인쇄</button>
        <button onclick="window.print()" class="btn-warning hidden" data-lang="en">🖨️ Print Report</button>
        <button onclick="resetData()" class="btn-danger" data-lang="ko">🔄 데이터 초기화</button>
        <button onclick="resetData()" class="btn-danger hidden" data-lang="en">🔄 Reset Data</button>
    </div>
</div>
<script>
/* --- 상수 및 데이터 구조 --- */
const DEFAULT_DEDUCTIONS = {
    taxes: [
        { name: "Federal Withholding" },
        { name: "State Tax (CA)" },
        { name: "OASDI (Social Security)" },
        { name: "Medicare" },
        { name: "CA SDI" }
    ],
    preTax: [
        { name: "401k Traditional" },
        { name: "Medical Premium" },
        { name: "Dental Premium" },
        { name: "Vision Premium" },
        { name: "MSEAP" }
    ],
    postTax: [
        { name: "401k Roth" },
        { name: "Stock Purchase Plan" },
        { name: "Legal Services" },
        { name: "LTD" },
        { name: "AD&D" },
        { name: "Accident Insurance" },
        { name: "Critical Illness" }
    ]
};
const budgetData = {
    incomePerPay: 0,
    incomePeriod: 'monthly',
    taxes: [],
    preTax: [],
    postTax: [],
    expenses: [],
    categories: [
        { id: 'housing', name: '🏠 주거', nameEn: '🏠 Housing' },
        { id: 'food', name: '🍔 식비', nameEn: '🍔 Food' },
        { id: 'transportation', name: '🚗 교통', nameEn: '🚗 Transportation' },
        { id: 'health', name: '🏥 건강', nameEn: '🏥 Health' },
        { id: 'family', name: '👪 가족', nameEn: '👪 Family' },
        { id: 'shopping', name: '🛍️ 쇼핑', nameEn: '🛍️ Shopping' },
        { id: 'finance', name: '💳 금융', nameEn: '💳 Finance' },
        { id: 'travel', name: '✈️ 여행', nameEn: '✈️ Travel' },
        { id: 'saving', name: '💰 저축', nameEn: '💰 Saving' },
        { id: 'business', name: '💼 업무', nameEn: '💼 Business' }
    ],
    currentLanguage: 'ko'
};
let incomeFlowChartInstance = null;
let expenseCategoryChartInstance = null;
let editingItem = null;
let editingExpense = null;

/* --- 유틸리티 --- */
function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}
function formatMoney(amount) {
    if (Number.isNaN(amount) || amount == null) return "0.00";
    return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function getPayPeriodsPerMonth(period) {
    if (period === 'monthly') return 1;
    if (period === 'biweekly') return 26 / 12;
    if (period === 'weekly') return 52 / 12;
    return 1;
}
function getMonthlyValue(perPay, period) {
    return perPay * getPayPeriodsPerMonth(period);
}
function calculatePercentage(value, total) {
    if (total === 0) return "0.0%";
    return ((value / total) * 100).toFixed(1) + '%';
}

/* --- 언어 전환 --- */
function switchLanguage(lang) {
    budgetData.currentLanguage = lang;
    document.querySelectorAll('[data-lang]').forEach(e => {
        if (e.getAttribute('data-lang') === lang) e.classList.remove('hidden');
        else e.classList.add('hidden');
    });
    document.getElementById('lang-ko').classList.toggle('active', lang === 'ko');
    document.getElementById('lang-en').classList.toggle('active', lang === 'en');
    populateCategorySelect();
    populateDeductionSelects();
    updateIncomeSummary();
    updateUI();
}
document.getElementById('lang-ko').onclick = () => switchLanguage('ko');
document.getElementById('lang-en').onclick = () => switchLanguage('en');

/* --- 수입/세금/공제 입력 및 월환산 --- */
function updateIncomeSummary() {
    const perPay = parseFloat(document.getElementById('income-per-paycheck').value) || 0;
    const period = document.getElementById('income-period').value;
    budgetData.incomePerPay = perPay;
    budgetData.incomePeriod = period;
    const monthly = getMonthlyValue(perPay, period);
    document.getElementById('income-summary').innerText =
        (budgetData.currentLanguage === 'ko')
        ? `1회 지급: $${formatMoney(perPay)} / 월 환산: $${formatMoney(monthly)}`
        : `Per pay: $${formatMoney(perPay)} / Monthly: $${formatMoney(monthly)}`;
    updateUI();
}
document.getElementById('income-per-paycheck').oninput = updateIncomeSummary;
document.getElementById('income-period').onchange = () => {
    updateIncomeSummary();
    switchLanguage(budgetData.currentLanguage); // 옵션 언어 재동기화
};

/* --- 카테고리/세금/공제 셀렉트 채우기 --- */
function populateCategorySelect() {
    const select = document.getElementById('category-select');
    const prev = select.value;
    select.innerHTML = '';
    budgetData.categories.forEach(cat => {
        const o = document.createElement('option');
        o.value = cat.id;
        o.textContent = budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn || cat.name;
        select.appendChild(o);
    });
    const c = document.createElement('option');
    c.value = 'custom';
    c.textContent = budgetData.currentLanguage === 'ko' ? '✏️ 직접 입력' : '✏️ Custom Category';
    select.appendChild(c);
    if (budgetData.categories.some(cat => cat.id === prev) || prev === 'custom') select.value = prev;
    else select.value = budgetData.categories[0] ? budgetData.categories[0].id : '';
    select.onchange = function() {
        document.getElementById('category-input-container').classList.toggle('hidden', this.value !== 'custom');
    };
    if (select.value === 'custom') document.getElementById('category-input-container').classList.remove('hidden');
    else document.getElementById('category-input-container').classList.add('hidden');
}
function populateDeductionSelects() {
    [
        {type:'taxes', selectId:'tax-type-select', customId:'tax-custom-name-input'},
        {type:'preTax', selectId:'pre-tax-type-select', customId:'pre-tax-custom-name-input'},
        {type:'postTax', selectId:'post-tax-type-select', customId:'post-tax-custom-name-input'}
    ].forEach(({type, selectId, customId})=>{
        const select = document.getElementById(selectId);
        const prev = select.value;
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = budgetData.currentLanguage === 'ko' ? '유형 선택' : 'Select type';
        select.appendChild(defaultOption);
        DEFAULT_DEDUCTIONS[type].forEach(deduction => {
            const o = document.createElement('option');
            o.value = deduction.name;
            o.textContent = deduction.name;
            select.appendChild(o);
        });
        const c = document.createElement('option');
        c.value = 'custom';
        c.textContent = budgetData.currentLanguage === 'ko' ? '✏️ 사용자 정의' : '✏️ Custom';
        select.appendChild(c);
        select.value = (Array.from(select.options).some(opt=>opt.value===prev)) ? prev : '';
        select.onchange = function() {
            document.getElementById(customId).classList.toggle('hidden', this.value !== 'custom');
        };
        document.getElementById(customId).classList.toggle('hidden', select.value !== 'custom');
    });
}

/* --- 세금/공제 항목 추가, 수정, 삭제 --- */
function addCategorizedItem(type) {
    let select, customNameInput, amountInput;
    if (type === 'taxes') {
        select = document.getElementById('tax-type-select');
        customNameInput = document.getElementById('tax-custom-name-input');
        amountInput = document.getElementById('tax-amount-input');
    } else if (type === 'preTax') {
        select = document.getElementById('pre-tax-type-select');
        customNameInput = document.getElementById('pre-tax-custom-name-input');
        amountInput = document.getElementById('pre-tax-amount-input');
    } else if (type === 'postTax') {
        select = document.getElementById('post-tax-type-select');
        customNameInput = document.getElementById('post-tax-custom-name-input');
        amountInput = document.getElementById('post-tax-amount-input');
    } else return;
    let name = select.value;
    const amount = parseFloat(amountInput.value) || 0;
    if (name === 'custom') {
        name = customNameInput.value.trim();
        if (!name) {
            alert(budgetData.currentLanguage === 'ko' ? '이름을 입력하세요.' : 'Please enter a name.');
            return;
        }
    }
    if (!name || amount <= 0) {
        alert(budgetData.currentLanguage === 'ko' ? '유효한 이름과 금액을 입력하세요.' : 'Enter a valid name and amount.');
        return;
    }
    if (editingItem && editingItem.type === type) {
        const idx = budgetData[type].findIndex(x => x.id === editingItem.id);
        if (idx !== -1) {
            budgetData[type][idx].name = name;
            budgetData[type][idx].amountPerPay = amount;
        }
        editingItem = null;
    } else {
        budgetData[type].push({ id: generateUniqueId(), name, amountPerPay: amount });
    }
    select.value = '';
    customNameInput.value = '';
    amountInput.value = '';
    document.getElementById(customNameInput.id).classList.add('hidden');
    updateUI();
}
function renderCategorizedList(type, items, listId) {
    const period = budgetData.incomePeriod;
    const list = document.getElementById(listId);
    list.innerHTML = '';
    items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
            <div class="list-item-content">
                <span>${item.name}</span>
                <span class="expense-amount">
                  ${budgetData.currentLanguage==='ko'?'회당':'Per'} $${formatMoney(item.amountPerPay)}<br>
                  <small style="color:var(--medium-gray)">
                  ${budgetData.currentLanguage==='ko'?'월':'Month'} $${formatMoney(getMonthlyValue(item.amountPerPay, period))}
                  </small>
                </span>
            </div>
            <div class="list-item-actions">
                <button class="btn-warning btn-edit" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '수정' : 'Edit'}</button>
                <button class="btn-danger btn-delete" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '삭제' : 'Delete'}</button>
            </div>
        `;
        list.appendChild(el);
    });
    list.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            const item = budgetData[type].find(x => x.id === id);
            if (!item) return;
            let select, customNameInput, amountInput;
            if (type === 'taxes') {
                select = document.getElementById('tax-type-select');
                customNameInput = document.getElementById('tax-custom-name-input');
                amountInput = document.getElementById('tax-amount-input');
            } else if (type === 'preTax') {
                select = document.getElementById('pre-tax-type-select');
                customNameInput = document.getElementById('pre-tax-custom-name-input');
                amountInput = document.getElementById('pre-tax-amount-input');
            } else if (type === 'postTax') {
                select = document.getElementById('post-tax-type-select');
                customNameInput = document.getElementById('post-tax-custom-name-input');
                amountInput = document.getElementById('post-tax-amount-input');
            }
            if (DEFAULT_DEDUCTIONS[type].some(x => x.name === item.name)) {
                select.value = item.name;
                customNameInput.classList.add('hidden');
            } else {
                select.value = 'custom';
                customNameInput.value = item.name;
                customNameInput.classList.remove('hidden');
            }
            amountInput.value = item.amountPerPay;
            editingItem = { id: item.id, type };
        };
    });
    list.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            budgetData[type] = budgetData[type].filter(x => x.id !== id);
            updateUI();
        };
    });
}

/* --- 지출 항목 추가, 수정, 삭제 --- */
function addExpense() {
    const categorySelect = document.getElementById('category-select');
    let category = categorySelect.value;
    let expenseName = document.getElementById('expense-name-input').value.trim();
    let amount = parseFloat(document.getElementById('expense-amount-input-main').value);
    if (category === 'custom') {
        const newCat = document.getElementById('new-category-input').value.trim();
        if (!newCat) {
            alert(budgetData.currentLanguage === 'ko' ? '카테고리 이름을 입력하세요.' : 'Enter category name.');
            return;
        }
        const newId = generateUniqueId();
        budgetData.categories.push({ id: newId, name: newCat, nameEn: newCat });
        category = newId;
        populateCategorySelect();
    }
    if (!expenseName || isNaN(amount) || amount <= 0) {
        alert(budgetData.currentLanguage === 'ko' ? '지출 이름과 금액을 올바르게 입력하세요.' : 'Enter valid expense name and amount.');
        return;
    }
    if (editingExpense) {
        const idx = budgetData.expenses.findIndex(x => x.id === editingExpense.id);
        if (idx !== -1) {
            budgetData.expenses[idx].category = category;
            budgetData.expenses[idx].name = expenseName;
            budgetData.expenses[idx].amount = amount;
        }
        editingExpense = null;
    } else {
        budgetData.expenses.push({
            id: generateUniqueId(), category, name: expenseName, amount
        });
    }
    document.getElementById('expense-name-input').value = '';
    document.getElementById('expense-amount-input-main').value = '';
    document.getElementById('category-select').value = budgetData.categories[0].id || '';
    document.getElementById('new-category-input').value = '';
    document.getElementById('category-input-container').classList.add('hidden');
    updateUI();
}
function renderExpensesList() {
    const list = document.getElementById('expenses-list');
    list.innerHTML = '';
    budgetData.expenses.forEach(item => {
        const cat = budgetData.categories.find(cat => cat.id === item.category);
        const catName = cat ? (budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn) : item.category;
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
            <div class="list-item-content">
                <span class="badge">${catName}</span>
                <span class="expense-name">${item.name}</span>
                <span class="expense-amount">$${formatMoney(item.amount)}</span>
            </div>
            <div class="list-item-actions">
                <button class="btn-warning btn-edit" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '수정' : 'Edit'}</button>
                <button class="btn-danger btn-delete" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '삭제' : 'Delete'}</button>
            </div>
        `;
        list.appendChild(el);
    });
    list.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            const item = budgetData.expenses.find(x => x.id === id);
            if (!item) return;
            document.getElementById('category-select').value = item.category;
            document.getElementById('expense-name-input').value = item.name;
            document.getElementById('expense-amount-input-main').value = item.amount;
            editingExpense = { id: item.id };
        };
    });
    list.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            budgetData.expenses = budgetData.expenses.filter(x => x.id !== id);
            updateUI();
        };
    });
}
function addCategory() {
    const newCat = document.getElementById('new-category-input').value.trim();
    if (!newCat) {
        alert(budgetData.currentLanguage === 'ko' ? '카테고리 이름을 입력하세요.' : 'Enter category name.');
        return;
    }
    const newId = generateUniqueId();
    budgetData.categories.push({ id: newId, name: newCat, nameEn: newCat });
    populateCategorySelect();
    document.getElementById('category-select').value = newId;
    document.getElementById('category-input-container').classList.add('hidden');
    document.getElementById('new-category-input').value = '';
}

/* --- 월별 재무 현황 --- */
function renderIncomeFlowView() {
    const period = budgetData.incomePeriod;
    const perPay = budgetData.incomePerPay;
    const monthly = getMonthlyValue(perPay, period);
    const preTaxPerPays = budgetData.preTax.reduce((s, i)=>s+i.amountPerPay,0);
    const preTaxMonthly = getMonthlyValue(preTaxPerPays, period);
    const taxablePerPay = perPay - preTaxPerPays;
    const taxableMonthly = monthly - preTaxMonthly;
    const taxPerPays = budgetData.taxes.reduce((s, i)=>s+i.amountPerPay,0);
    const taxMonthly = getMonthlyValue(taxPerPays, period);
    const postTaxPerPays = budgetData.postTax.reduce((s, i)=>s+i.amountPerPay,0);
    const postTaxMonthly = getMonthlyValue(postTaxPerPays, period);
    const totalDeductPerPay = preTaxPerPays + taxPerPays + postTaxPerPays;
    const totalDeductMonthly = preTaxMonthly + taxMonthly + postTaxMonthly;
    const netIncomePerPay = perPay - totalDeductPerPay;
    const netIncomeMonthly = monthly - totalDeductMonthly;
    const expensesMonthly = budgetData.expenses.reduce((s, i)=>s+i.amount,0);
    const remaining = netIncomeMonthly - expensesMonthly;
    const flow = [
        { labelKo:'총수입', labelEn:'Gross Income', perPay, monthly, color:'positive' },
        { labelKo:'세전 공제', labelEn:'Pre-Tax Deductions', perPay:preTaxPerPays, monthly:preTaxMonthly, color:'negative' },
        { labelKo:'과세 소득', labelEn:'Taxable Income', perPay:taxablePerPay, monthly:taxableMonthly },
        { labelKo:'세금', labelEn:'Taxes', perPay:taxPerPays, monthly:taxMonthly, color:'negative' },
        { labelKo:'세후 공제', labelEn:'Post-Tax Deductions', perPay:postTaxPerPays, monthly:postTaxMonthly, color:'negative' },
        { labelKo:'총 공제/세금 합', labelEn:'Total Deductions & Taxes', perPay:totalDeductPerPay, monthly:totalDeductMonthly, color:'negative' },
        { labelKo:'순수입(실수령액)', labelEn:'Net Income', perPay:netIncomePerPay, monthly:netIncomeMonthly, color:'positive' }
    ];
    let html = '';
    flow.forEach((f,i)=>{
        html += `<div class="flow-step ${f.color||''}">
            <span class="flow-label">${budgetData.currentLanguage==='ko'?f.labelKo:f.labelEn}</span>
            <span class="flow-values">${budgetData.currentLanguage==='ko'?'회당':'Per'} $${formatMoney(f.perPay)} / ${budgetData.currentLanguage==='ko'?'월':'Month'} $${formatMoney(f.monthly)}</span>
        </div>`;
        if (i<flow.length-1) html += `<div class="flow-arrow">↓</div>`;
    });
    document.getElementById('income-flow-view').innerHTML = html;
}
/* --- 차트(동일, 생략 가능) --- */
function updateCharts() {
    const period = budgetData.incomePeriod;
    const perPay = budgetData.incomePerPay;
    const monthly = getMonthlyValue(perPay, period);
    const preTaxSum = budgetData.preTax.reduce((s, i)=>s+i.amountPerPay,0);
    const taxSum = budgetData.taxes.reduce((s, i)=>s+i.amountPerPay,0);
    const postTaxSum = budgetData.postTax.reduce((s, i)=>s+i.amountPerPay,0);
    const expensesTotal = budgetData.expenses.reduce((s, i)=>s+i.amount,0);
    const preTaxMonthly = getMonthlyValue(preTaxSum, period);
    const taxMonthly = getMonthlyValue(taxSum, period);
    const postTaxMonthly = getMonthlyValue(postTaxSum, period);
    const totalDeductMonthly = preTaxMonthly + taxMonthly + postTaxMonthly;
    const netIncomeMonthly = monthly - totalDeductMonthly;
    const remaining = netIncomeMonthly - expensesTotal;
    if (incomeFlowChartInstance) incomeFlowChartInstance.destroy();
    if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();
    const incomeLabels = [];
    const incomeData = [];
    const incomeColors = [];
    incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 수입' : 'Gross Income');
    incomeData.push(monthly);
    incomeColors.push('#4361ee');
    if (preTaxMonthly > 0) { incomeLabels.push(budgetData.currentLanguage === 'ko' ? '세전 공제' : 'Pre-Tax Deductions'); incomeData.push(preTaxMonthly); incomeColors.push('#f8961e'); }
    if (taxMonthly > 0) { incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 세금' : 'Total Taxes'); incomeData.push(taxMonthly); incomeColors.push('#f72585'); }
    if (postTaxMonthly > 0) { incomeLabels.push(budgetData.currentLanguage === 'ko' ? '세후 공제' : 'Post-Tax Deductions'); incomeData.push(postTaxMonthly); incomeColors.push('#7209b7'); }
    if (remaining > 0) { incomeLabels.push(budgetData.currentLanguage === 'ko' ? '저축/남은 잔액' : 'Savings/Remaining'); incomeData.push(remaining); incomeColors.push('#4cc9f0'); }
    if (expensesTotal > 0) { incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 지출' : 'Total Expenses'); incomeData.push(expensesTotal); incomeColors.push('#2b2d42'); }
    incomeFlowChartInstance = new Chart(document.getElementById('incomeFlowChart').getContext('2d'), {
        type: 'doughnut',
        data: { labels: incomeLabels, datasets: [{ data: incomeData, backgroundColor: incomeColors, hoverOffset: 10 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 14 }, boxWidth: 20 } },
            tooltip: { callbacks: { label: function(context) {
                const label = context.label || ''; const value = context.raw;
                const percentage = monthly ? ((value / monthly) * 100).toFixed(1) : '0.0';
                return `${label}: $${formatMoney(value)} (${percentage}%)`;
            }}}}}});
    // 지출 카테고리 차트
    const expenseCategoryData = {};
    budgetData.expenses.forEach(exp => {
        const cat = budgetData.categories.find(cat => cat.id === exp.category);
        const displayCategory = cat ? (budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn) : exp.category;
        if (expenseCategoryData[displayCategory]) expenseCategoryData[displayCategory] += exp.amount;
        else expenseCategoryData[displayCategory] = exp.amount;
    });
    const expenseLabels = Object.keys(expenseCategoryData);
    const expenseAmounts = Object.values(expenseCategoryData);
    const defaultChartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED'];
    const dynamicColors = expenseLabels.map((_, i) => defaultChartColors[i % defaultChartColors.length]);
    expenseCategoryChartInstance = new Chart(document.getElementById('expenseCategoryChart').getContext('2d'), {
        type: 'pie',
        data: { labels: expenseLabels, datasets: [{ data: expenseAmounts, backgroundColor: dynamicColors, hoverOffset: 10 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 14 }, boxWidth: 20 } },
            tooltip: { callbacks: { label: function(context) {
                const label = context.label || ''; const value = context.raw;
                const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                return `${label}: $${formatMoney(value)} (${percentage}%)`;
            }}}}}});
}

/* --- 데이터 계산 및 UI 업데이트 --- */
function updateUI() {
    const period = budgetData.incomePeriod;
    const perPay = budgetData.incomePerPay;
    const monthly = getMonthlyValue(perPay, period);
    const preTax = budgetData.preTax.reduce((sum, item) => sum + item.amountPerPay, 0);
    const preTaxMonthly = getMonthlyValue(preTax, period);
    const taxableIncome = perPay - preTax;
    const taxableIncomeMonthly = monthly - preTaxMonthly;
    const tax = budgetData.taxes.reduce((sum, item) => sum + item.amountPerPay, 0);
    const taxMonthly = getMonthlyValue(tax, period);
    const postTax = budgetData.postTax.reduce((sum, item) => sum + item.amountPerPay, 0);
    const postTaxMonthly = getMonthlyValue(postTax, period);
    const totalDeductionsTaxes = preTax + tax + postTax;
    const totalDeductionsTaxesMonthly = preTaxMonthly + taxMonthly + postTaxMonthly;
    const netIncome = perPay - totalDeductionsTaxes;
    const netIncomeMonthly = monthly - totalDeductionsTaxesMonthly;
    const expensesTotal = budgetData.expenses.reduce((sum, item) => sum + item.amount, 0);
    const remainingBalance = netIncomeMonthly - expensesTotal;
    document.getElementById('expenses-total-card').textContent = formatMoney(expensesTotal);
    document.getElementById('expenses-percentage-card').textContent = calculatePercentage(expensesTotal, monthly);
    document.getElementById('remaining-balance').textContent = formatMoney(remainingBalance);
    document.getElementById('remaining-balance').classList.toggle('positive', remainingBalance >= 0);
    document.getElementById('remaining-balance').classList.toggle('negative', remainingBalance < 0);
    document.getElementById('remaining-percentage-card').textContent = calculatePercentage(remainingBalance, monthly);
    renderCategorizedList('taxes', budgetData.taxes, 'tax-list');
    renderCategorizedList('preTax', budgetData.preTax, 'pre-tax-list');
    renderCategorizedList('postTax', budgetData.postTax, 'post-tax-list');
    renderExpensesList();
    renderIncomeFlowView();
    updateCharts();
}

/* --- 데이터 저장/불러오기/초기화 --- */
function saveData() {
    localStorage.setItem('budgetData', JSON.stringify(budgetData));
    alert(budgetData.currentLanguage === 'ko' ? '저장되었습니다.' : 'Saved!');
}
function loadData() {
    const data = localStorage.getItem('budgetData');
    if (data) {
        const parsed = JSON.parse(data);
        Object.assign(budgetData, parsed);
        populateCategorySelect();
        populateDeductionSelects();
        updateIncomeSummary();
        updateUI();
        alert(budgetData.currentLanguage === 'ko' ? '불러오기 완료!' : 'Loaded!');
    }
}
function resetData() {
    if (!confirm(budgetData.currentLanguage === 'ko' ? '정말 초기화할까요?' : 'Reset all data?')) return;
    budgetData.incomePerPay = 0;
    budgetData.incomePeriod = 'monthly';
    budgetData.taxes = [];
    budgetData.preTax = [];
    budgetData.postTax = [];
    budgetData.expenses = [];
    budgetData.categories = [
        { id: 'housing', name: '🏠 주거', nameEn: '🏠 Housing' },
        { id: 'food', name: '🍔 식비', nameEn: '🍔 Food' },
        { id: 'transportation', name: '🚗 교통', nameEn: '🚗 Transportation' },
        { id: 'health', name: '🏥 건강', nameEn: '🏥 Health' },
        { id: 'family', name: '👪 가족', nameEn: '👪 Family' },
        { id: 'shopping', name: '🛍️ 쇼핑', nameEn: '🛍️ Shopping' },
        { id: 'finance', name: '💳 금융', nameEn: '💳 Finance' },
        { id: 'travel', name: '✈️ 여행', nameEn: '✈️ Travel' },
        { id: 'saving', name: '💰 저축', nameEn: '💰 Saving' },
        { id: 'business', name: '💼 업무', nameEn: '💼 Business' }
    ];
    document.getElementById('income-per-paycheck').value = '';
    document.getElementById('income-period').value = 'monthly';
    populateCategorySelect();
    populateDeductionSelects();
    updateIncomeSummary();
    updateUI();
}

/* --- 초기 셋업 --- */
window.onload = function() {
    populateCategorySelect();
    populateDeductionSelects();
    updateIncomeSummary();
    updateUI();
};
</script>
</body>
</html>
