<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data:;
                   font-src 'self';
                   connect-src 'self';">

    <title>ë‹¤êµ­ì–´ ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ê¸°ì¡´ CSSëŠ” ë§¤ìš° ì˜ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í° ìˆ˜ì • ì—†ì´ ìœ ì§€í•©ë‹ˆë‹¤. */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #7209b7;
            --text-color: #2b2d42;
            --light-gray: #f8f9fa;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --white: #ffffff;
            --shadow: 0 4px 16px rgba(67,97,238,0.08);
            --border-radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: var(--text-color);
            background: var(--light-gray);
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto 40px auto;
            padding: 24px 18px 36px 18px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }
        .language-switcher {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
        }
        .language-btn {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            border-radius: 18px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(67,97,238,0.06);
        }
        .language-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(67,97,238,0.14);
        }
        header {
            text-align: center;
            margin-bottom: 32px;
        }
        h1 { color: var(--primary); font-size: 2.2rem; margin-bottom: 12px; }
        h2 { color: var(--primary); font-size: 1.3rem; margin-bottom: 14px; }
        .card {
            background: var(--white);
            padding: 22px 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }
        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        input, select {
            width: 100%;
            padding: 11px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #f7faff;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.12);
        }
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.18s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(67,97,238,0.07);
        }
        button:hover { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #d6336c; }
        .btn-warning { background-color: var(--warning); }
        .btn-warning:hover { background-color: #e67700; }
        .btn-success { background-color: var(--success); color: var(--text-color);}
        .btn-success:hover { background-color: #339af0; color: #fff;}
        .btn-info { background-color: var(--info);}
        .btn-info:hover { background-color: #5f3dc4;}
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.92rem;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
            margin-right: 4px;
        }
        .item-list { margin-top: 12px; }
        .list-item {
            background: var(--white);
            padding: 13px 10px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.07);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .list-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .list-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .list-item-amount { font-weight: 600; min-width: 82px; text-align: right; }
        .list-item-actions { display: flex; gap: 5px; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 23px;
        }
        .summary-card {
            background: var(--white);
            padding: 18px 0 16px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        .card-label { font-size: 0.96rem; color: var(--medium-gray); margin-bottom: 2px; }
        .card-amount { font-size: 1.7rem; font-weight: 700; margin: 9px 0; }
        .positive { color: var(--success);}
        .negative { color: var(--danger);}
        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 13px 10px;
            margin: 7px 0;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px rgba(0,0,0,0.07);
            font-size: 1.05rem;
        }
        .flow-item.highlighted { border-left: 4px solid var(--danger);}
        .flow-item.result { border-left: 4px solid var(--success); font-weight: bold;}
        .flow-item.info { border-left: 4px solid var(--warning); font-weight: bold;}
        .flow-arrow {
            text-align: center;
            color: var(--medium-gray);
            margin: 5px 0;
            font-size: 1.18rem;
        }
        .chart-container {
            background: var(--white);
            padding: 18px 12px 24px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            margin-top: 5px;
            height: 420px;
            position: relative;
        }
        .chart-wrapper {
            width: 100%;
            height: 340px;
            position: relative;
        }
        .chart-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 700;
        }
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 28px 0 8px 0;
            flex-wrap: wrap;
        }
        .hidden { display: none;}
        .flex { display: flex; gap: 12px; align-items: flex-end;}
        .flex > div { flex: 1;}
        @media (max-width: 900px) {
            .container { margin: 18px 3px;}
            .chart-container { height: 320px;}
            .chart-wrapper { height: 220px;}
        }
        @media (max-width: 600px) {
            .container { padding: 8px 2px;}
            .summary-cards { grid-template-columns: 1fr;}
            .chart-container { height: 260px;}
            .chart-wrapper { height: 140px;}
            .language-switcher { justify-content: center;}
        }
        @media print {
            body { padding: 0; background: white;}
            button, .utility-buttons, .language-switcher { display: none;}
            .card, .chart-container { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid;}
            .chart-container { height: auto;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button id="lang-ko" class="language-btn active">í•œêµ­ì–´</button>
            <button id="lang-en" class="language-btn">English</button>
        </div>
        <header>
            <h1 data-lang="ko">ğŸ’° ê³ ê¸‰ ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <h1 data-lang="en" class="hidden">ğŸ’° Advanced Budget Management System</h1>
            <p data-lang="ko">í•œ ê³³ì—ì„œ ìˆ˜ì…, ì„¸ê¸ˆ, ê³µì œ ë° ì§€ì¶œì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            <p data-lang="en" class="hidden">Manage your income, taxes, deductions, and expenses in one place</p>
        </header>

        <div class="card">
            <h2 data-lang="ko">1. ìˆ˜ì…</h2>
            <h2 data-lang="en" class="hidden">1. Earnings</h2>
            <div class="form-group">
                <label for="income-input" data-lang="ko">ì›” ì´ ìˆ˜ì… ($)</label>
                <label for="income-input" data-lang="en" class="hidden">Gross Monthly Income ($)</label>
                <input type="number" id="income-input" data-lang-ko-placeholder="ì›” ì´ ìˆ˜ì…ì„ ì…ë ¥í•˜ì„¸ìš”" data-lang-en-placeholder="Enter your gross income" placeholder="0">
            </div>
        </div>

        <div class="card">
            <h2 data-lang="ko">2. ì§ì› ì„¸ê¸ˆ</h2>
            <h2 data-lang="en" class="hidden">2. Employee Taxes</h2>
            <div class="form-group">
                <label for="tax-type-select" data-lang="ko">ì„¸ê¸ˆ ìœ í˜•</label>
                <label for="tax-type-select" data-lang="en" class="hidden">Tax Type</label>
                <select id="tax-type-select">
                    <option value="" disabled selected data-lang="ko">ì„¸ê¸ˆ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select tax type</option>
                    <option value="Federal Withholding">Federal Withholding</option>
                    <option value="State Tax (CA)">State Tax (CA)</option>
                    <option value="OASDI (Social Security)">OASDI (Social Security)</option>
                    <option value="Medicare">Medicare</option>
                    <option value="CA SDI">CA SDI</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ì„¸ê¸ˆ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Tax</option>
                </select>
            </div>
            <div id="tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="tax-custom-name-input" data-lang="ko">ì„¸ê¸ˆ ì´ë¦„</label>
                        <label for="tax-custom-name-input" data-lang="en" class="hidden">Tax Name</label>
                        <input type="text" id="tax-custom-name-input" data-lang-ko-placeholder="ì„¸ê¸ˆ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter tax name">
                    </div>
                    <div>
                        <label for="tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success" data-lang="ko">ì„¸ê¸ˆ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success hidden" data-lang="en">Add Tax</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">3. ì„¸ì „ ê³µì œ</h2>
            <h2 data-lang="en" class="hidden">3. Pre-Tax Deductions</h2>
            <div class="form-group">
                <label for="pre-tax-type-select" data-lang="ko">ê³µì œ ìœ í˜•</label>
                <label for="pre-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="pre-tax-type-select">
                    <option value="" disabled selected data-lang="ko">ê³µì œ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select deduction type</option>
                    <option value="401k Traditional">401k Traditional</option>
                    <option value="Medical Premium">Medical Premium</option>
                    <option value="Dental Premium">Dental Premium</option>
                    <option value="Vision Premium">Vision Premium</option>
                    <option value="MSEAP">MSEAP</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ê³µì œ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Deduction</option>
                </select>
            </div>
            <div id="pre-tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="pre-tax-custom-name-input" data-lang="ko">ê³µì œ ì´ë¦„</label>
                        <label for="pre-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="pre-tax-custom-name-input" data-lang-ko-placeholder="ê³µì œ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div>
                        <label for="pre-tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="pre-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="pre-tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success" data-lang="ko">ê³µì œ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="pre-tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">4. ì„¸í›„ ê³µì œ</h2>
            <h2 data-lang="en" class="hidden">4. Post-Tax Deductions</h2>
            <div class="form-group">
                <label for="post-tax-type-select" data-lang="ko">ê³µì œ ìœ í˜•</label>
                <label for="post-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="post-tax-type-select">
                    <option value="" disabled selected data-lang="ko">ê³µì œ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select deduction type</option>
                    <option value="401k Roth">401k Roth</option>
                    <option value="Stock Purchase Plan">Stock Purchase Plan</option>
                    <option value="Legal Services">Legal Services</option>
                    <option value="LTD">LTD</option>
                    <option value="AD&D">AD&D</option>
                    <option value="Accident Insurance">Accident Insurance</option>
                    <option value="Critical Illness">Critical Illness</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ê³µì œ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Deduction</option>
                </select>
            </div>
            <div id="post-tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="post-tax-custom-name-input" data-lang="ko">ê³µì œ ì´ë¦„</label>
                        <label for="post-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="post-tax-custom-name-input" data-lang-ko-placeholder="ê³µì œ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div>
                        <label for="post-tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="post-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="post-tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success" data-lang="ko">ê³µì œ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="post-tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">5. ì§€ì¶œ ê´€ë¦¬</h2>
            <h2 data-lang="en" class="hidden">5. Expense Management</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="category-select" data-lang="ko">ì¹´í…Œê³ ë¦¬</label>
                    <label for="category-select" data-lang="en" class="hidden">Category</label>
                    <select id="category-select"></select>
                </div>
                <div class="form-group">
                    <label for="expense-name-input" data-lang="ko">ì§€ì¶œ í•­ëª©</label>
                    <label for="expense-name-input" data-lang="en" class="hidden">Expense Name</label>
                    <input type="text" id="expense-name-input" data-lang-ko-placeholder="ì˜ˆ: ì›”ì„¸" data-lang-en-placeholder="e.g. Rent">
                </div>
                <div class="form-group">
                    <label for="expense-amount-input-main" data-lang="ko">ê¸ˆì•¡ ($)</label>
                    <label for="expense-amount-input-main" data-lang="en" class="hidden">Amount ($)</label>
                    <input type="number" id="expense-amount-input-main" placeholder="ê¸ˆì•¡ ì…ë ¥">
                </div>
            </div>
            <div id="category-input-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="new-category-input" data-lang="ko">ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„</label>
                        <label for="new-category-input" data-lang="en" class="hidden">New Category Name</label>
                        <input type="text" id="new-category-input" data-lang-ko-placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì…ë ¥" data-lang-en-placeholder="Enter new category">
                    </div>
                    <div>
                        <button onclick="addCategory()" class="btn-info" data-lang="ko">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
                        <button onclick="addCategory()" class="btn-info hidden" data-lang="en">Add Category</button>
                    </div>
                </div>
            </div>
            <button onclick="addExpense()" class="btn-success" style="width: 100%; margin-top: 10px;" data-lang="ko">ì§€ì¶œ ì¶”ê°€</button>
            <button onclick="addExpense()" class="btn-success hidden" style="width: 100%; margin-top: 10px;" data-lang="en">Add Expense</button>
            <div class="item-list" id="expenses-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">6. ì›”ë³„ ì¬ë¬´ í˜„í™©</h2>
            <h2 data-lang="en" class="hidden">6. Monthly Financial Status</h2>
            <div class="income-flow">
                <div class="flow-item">
                    <span data-lang="ko">ì›” ì´ ìˆ˜ì… (ì´ ìˆ˜ìµ)</span>
                    <span data-lang="en" class="hidden">Gross Monthly Income (Total Earnings)</span>
                    <span>$<span id="gross-income">0.00</span> <em data-lang="ko">(100.0%)</em><em data-lang="en" class="hidden">(100.0%)</em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸ì „ ê³µì œ</span>
                    <span data-lang="en" class="hidden">Pre-Tax Deductions</span>
                    <span>-$<span id="pre-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item">
                    <span data-lang="ko"><strong>ê³¼ì„¸ ì†Œë“</strong></span>
                    <span data-lang="en" class="hidden"><strong>Taxable Income</strong></span>
                    <span>$<span id="taxable-income">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸ê¸ˆ</span>
                    <span data-lang="en" class="hidden">Taxes</span>
                    <span>-$<span id="tax-total">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸í›„ ê³µì œ</span>
                    <span data-lang="en" class="hidden">Post-Tax Deductions</span>
                    <span>-$<span id="post-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item info">
                    <span data-lang="ko"><strong>ì´ ê³µì œ ë° ì„¸ê¸ˆ í•©ê³„</strong></span>
                    <span data-lang="en" class="hidden"><strong>Total Deductions & Taxes</strong></span>
                    <span>-$<span id="total-deductions-taxes">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item result">
                    <span data-lang="ko"><strong>ìˆœìˆ˜ì… (ì‹¤ìˆ˜ë ¹ì•¡)</strong></span>
                    <span data-lang="en" class="hidden"><strong>Net Income (Take-Home Pay)</strong></span>
                    <span>$<span id="net-income">0.00</span> <em></em></span>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">ì´ ì§€ì¶œ</div>
                    <div class="card-label hidden" data-lang="en">Total Expenses</div>
                    <div class="card-amount negative">$<span id="expenses-total-card">0.00</span></div>
                    <div class="card-label" data-lang="ko">(ìˆœìˆ˜ì…ì—ì„œ ì‚¬ìš©ëœ ê¸ˆì•¡)</div>
                    <div class="card-label hidden" data-lang="en">(Amount used from net income)</div>
                    <div class="card-label"><span id="expenses-percentage-card">0.0%</span> <span data-lang="ko">of ì´ ìˆ˜ì…</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">ë‚¨ì€ ì”ì•¡</div>
                    <div class="card-label hidden" data-lang="en">Remaining Balance</div>
                    <div class="card-amount positive">$<span id="remaining-balance">0.00</span></div>
                    <div class="card-label" data-lang="ko">(ìˆœìˆ˜ì… - ì´ ì§€ì¶œ = ì €ì¶•)</div>
                    <div class="card-label hidden" data-lang="en">(Net Income - Expenses = Savings)</div>
                    <div class="card-label"><span id="remaining-percentage-card">0.0%</span> <span data-lang="ko">of ì´ ìˆ˜ì…</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 data-lang="ko">7. ì¬ë¬´ ë¶„ì„ ì°¨íŠ¸</h2>
            <h2 data-lang="en" class="hidden">7. Financial Analysis Charts</h2>
            <div class="grid">
                <div>
                    <div class="chart-title" data-lang="ko">ìˆ˜ì… ë¶„ë°° (ì´ ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨)</div>
                    <div class="chart-title hidden" data-lang="en">Income Distribution (Percentage of Gross Income)</div>
                    <div class="chart-wrapper">
                        <canvas id="incomeFlowChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="chart-title" data-lang="ko">ì§€ì¶œ ì¹´í…Œê³ ë¦¬ (ì´ ì§€ì¶œ ëŒ€ë¹„ ë¹„ìœ¨)</div>
                    <div class="chart-title hidden" data-lang="en">Expense Categories (Percentage of Total Expenses)</div>
                    <div class="chart-wrapper">
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="utility-buttons">
            <button onclick="saveData()" class="btn-info" data-lang="ko">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
            <button onclick="saveData()" class="btn-info hidden" data-lang="en">ğŸ’¾ Save Data</button>
            <button onclick="loadData()" class="btn-info" data-lang="ko">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="loadData()" class="btn-info hidden" data-lang="en">ğŸ“‚ Load Data</button>
            <button onclick="window.print()" class="btn-warning" data-lang="ko">ğŸ–¨ï¸ ë¦¬í¬íŠ¸ ì¸ì‡„</button>
            <button onclick="window.print()" class="btn-warning hidden" data-lang="en">ğŸ–¨ï¸ Print Report</button>
            <button onclick="resetData()" class="btn-danger" data-lang="ko">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
            <button onclick="resetData()" class="btn-danger hidden" data-lang="en">ğŸ”„ Reset Data</button>
        </div>
    </div>

    <script>
        // ì„¤ì •ê°’
        const DEFAULT_DEDUCTIONS = {
            taxes: [
                { name: "Federal Withholding", amount: 0 },
                { name: "State Tax (CA)", amount: 0 },
                { name: "OASDI (Social Security)", amount: 0 },
                { name: "Medicare", amount: 0 },
                { name: "CA SDI", amount: 0 }
            ],
            preTax: [
                { name: "401k Traditional", amount: 0 },
                { name: "Medical Premium", amount: 0 },
                { name: "Dental Premium", amount: 0 },
                { name: "Vision Premium", amount: 0 },
                { name: "MSEAP", amount: 0 }
            ],
            postTax: [
                { name: "401k Roth", amount: 0 },
                { name: "Stock Purchase Plan", amount: 0 },
                { name: "Legal Services", amount: 0 },
                { name: "LTD", amount: 0 },
                { name: "AD&D", amount: 0 },
                { name: "Accident Insurance", amount: 0 },
                { name: "Critical Illness", amount: 0 }
            ]
        };

        const budgetData = {
            income: 0,
            taxes: [],
            preTax: [],
            postTax: [],
            expenses: [],
            categories: [
                { id: 'housing', name: 'ğŸ  ì£¼ê±°', nameEn: 'ğŸ  Housing' },
                { id: 'food', name: 'ğŸ” ì‹ë¹„', nameEn: 'ğŸ” Food' },
                { id: 'transportation', name: 'ğŸš— êµí†µ', nameEn: 'ğŸš— Transportation' },
                { id: 'health', name: 'ğŸ¥ ê±´ê°•', nameEn: 'ğŸ¥ Health' },
                { id: 'family', name: 'ğŸ‘ª ê°€ì¡±', nameEn: 'ğŸ‘ª Family' },
                { id: 'shopping', name: 'ğŸ›ï¸ ì‡¼í•‘', nameEn: 'ğŸ›ï¸ Shopping' },
                { id: 'finance', name: 'ğŸ’³ ê¸ˆìœµ', nameEn: 'ğŸ’³ Finance' },
                { id: 'travel', name: 'âœˆï¸ ì—¬í–‰', nameEn: 'âœˆï¸ Travel' },
                { id: 'saving', name: 'ğŸ’° ì €ì¶•', nameEn: 'ğŸ’° Saving' },
                { id: 'business', name: 'ğŸ’¼ ì—…ë¬´', nameEn: 'ğŸ’¼ Business' }
            ],
            currentLanguage: 'ko'
        };

        let incomeFlowChartInstance = null;
        let expenseCategoryChartInstance = null;
        let editingItem = null;

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatMoney(amount) {
            if (Number.isNaN(amount) || amount === null) {
                return "0.00";
            }
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function calculatePercentage(value, total) {
            if (total === 0) {
                return "0.0%";
            }
            return ((value / total) * 100).toFixed(1) + '%';
        }

        // --- ì–¸ì–´ ì „í™˜ ---
        function switchLanguage(lang) {
            budgetData.currentLanguage = lang;
            document.querySelectorAll('[data-lang]').forEach(e => {
                if (e.getAttribute('data-lang') === lang) {
                    e.classList.remove('hidden');
                } else {
                    e.classList.add('hidden');
                }
            });

            // í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[data-lang-ko-placeholder]').forEach(el => {
                const koPlaceholder = el.getAttribute('data-lang-ko-placeholder');
                const enPlaceholder = el.getAttribute('data-lang-en-placeholder');
                el.placeholder = (lang === 'ko') ? koPlaceholder : enPlaceholder;
            });

            document.getElementById('lang-ko').classList.toggle('active', lang === 'ko');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');

            populateCategorySelect(); // ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì–¸ì–´ì— ë§ê²Œ ì—…ë°ì´íŠ¸
            populateDeductionSelects(); // ì„¸ê¸ˆ/ê³µì œ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì–¸ì–´ì— ë§ê²Œ ì—…ë°ì´íŠ¸ (ì¶”ê°€ëœ í•¨ìˆ˜)
            updateUI(); // UI ì „ì²´ ì—…ë°ì´íŠ¸
        }

        // --- ì¹´í…Œê³ ë¦¬/ì„¸ê¸ˆ/ê³µì œ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì±„ìš°ê¸° ---
        function populateCategorySelect() {
            const select = document.getElementById('category-select');
            const prev = select.value;
            select.innerHTML = '';

            budgetData.categories.forEach(cat => {
                const o = document.createElement('option');
                o.value = cat.id;
                o.textContent = budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn || cat.name;
                select.appendChild(o);
            });

            const c = document.createElement('option');
            c.value = 'custom';
            c.textContent = budgetData.currentLanguage === 'ko' ? 'âœï¸ ì§ì ‘ ì…ë ¥' : 'âœï¸ Custom Category';
            select.appendChild(c);

            if (budgetData.categories.some(cat => cat.id === prev) || prev === 'custom') {
                select.value = prev;
            } else {
                select.value = budgetData.categories[0] ? budgetData.categories[0].id : '';
            }

            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ 'ì‚¬ìš©ì ì •ì˜' ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            select.addEventListener('change', function() {
                const customContainer = document.getElementById('category-input-container');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
            });
            // ì´ˆê¸° ë¡œë“œ ì‹œ ìƒíƒœ ë°˜ì˜
            const customContainer = document.getElementById('category-input-container');
            if (select.value === 'custom') {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
        }

        function populateDeductionSelects() {
            ['taxes', 'preTax', 'postTax'].forEach(type => {
                const select = document.getElementById(`${type}-type-select`);
                const prev = select.value;
                select.innerHTML = '';

                // ê¸°ë³¸ 'ì„ íƒ' ì˜µì…˜ ì¶”ê°€
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                defaultOption.textContent = budgetData.currentLanguage === 'ko' ? 'ìœ í˜• ì„ íƒ' : 'Select type';
                select.appendChild(defaultOption);


                DEFAULT_DEDUCTIONS[type].forEach(deduction => {
                    const o = document.createElement('option');
                    o.value = deduction.name;
                    o.textContent = deduction.name; // ê³µì œ/ì„¸ê¸ˆ ì´ë¦„ì€ ì˜ë¬¸ ê³ ì •
                    select.appendChild(o);
                });

                const c = document.createElement('option');
                c.value = 'custom';
                c.textContent = budgetData.currentLanguage === 'ko' ? 'âœï¸ ì‚¬ìš©ì ì •ì˜' : 'âœï¸ Custom';
                select.appendChild(c);

                // ì´ì „ì— ì„ íƒëœ ê°’ì´ ìˆë‹¤ë©´ ìœ ì§€
                if (DEFAULT_DEDUCTIONS[type].some(item => item.name === prev) || prev === 'custom') {
                    select.value = prev;
                } else {
                    select.value = ''; // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                }

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì´ì „ì— ì—†ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€)
                select.addEventListener('change', function() {
                    const customContainer = document.getElementById(`${type}-custom-container`);
                    if (this.value === 'custom') {
                        customContainer.classList.remove('hidden');
                    } else {
                        customContainer.classList.add('hidden');
                    }
                });
                // ì´ˆê¸° ë¡œë“œ ì‹œ ìƒíƒœ ë°˜ì˜
                const customContainer = document.getElementById(`${type}-custom-container`);
                if (select.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
            });
        }


        // --- ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ---
        function updateCharts(grossIncome, preTaxTotal, taxTotal, postTaxTotal, expensesTotal, remaining) {
            if (incomeFlowChartInstance) incomeFlowChartInstance.destroy();
            if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();

            // ìˆ˜ì… ë¶„ë°° ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
            const incomeLabels = [];
            const incomeData = [];
            const incomeColors = [];

            const totalPostDeductionsTaxes = taxTotal + postTaxTotal + preTaxTotal; // ì„¸ê¸ˆ + ì„¸í›„ ê³µì œ + ì„¸ì „ ê³µì œ
            const netIncome = grossIncome - totalPostDeductionsTaxes; // ì‹¤ìˆ˜ë ¹ì•¡ (ì„¸ì „ ê³µì œë„ ë°˜ì˜)

            // Gross Income (100%)
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì´ ìˆ˜ì…' : 'Gross Income');
            incomeData.push(grossIncome);
            incomeColors.push('#4361ee'); // Primary color

            // Pre-Tax Deductions
            if (preTaxTotal > 0) {
                incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì„¸ì „ ê³µì œ' : 'Pre-Tax Deductions');
                incomeData.push(preTaxTotal);
                incomeColors.push('#f8961e'); // Warning color
            }

            // Taxes
            if (taxTotal > 0) {
                incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì´ ì„¸ê¸ˆ' : 'Total Taxes');
                incomeData.push(taxTotal);
                incomeColors.push('#f72585'); // Danger color
            }

            // Post-Tax Deductions
            if (postTaxTotal > 0) {
                incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì„¸í›„ ê³µì œ' : 'Post-Tax Deductions');
                incomeData.push(postTaxTotal);
                incomeColors.push('#7209b7'); // Info color
            }

            // Remaining Balance (Net Income - Expenses) - Savings
            if (remaining > 0) {
                incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì €ì¶•/ë‚¨ì€ ì”ì•¡' : 'Savings/Remaining');
                incomeData.push(remaining);
                incomeColors.push('#4cc9f0'); // Success color
            }

            // Expenses
            if (expensesTotal > 0) {
                incomeLabels.push(budgetData.currentLanguage === 'ko' ? 'ì´ ì§€ì¶œ' : 'Total Expenses');
                incomeData.push(expensesTotal);
                incomeColors.push('#2b2d42'); // Text color / dark-gray
            }


            const ctx1 = document.getElementById('incomeFlowChart').getContext('2d');
            incomeFlowChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: incomeLabels,
                    datasets: [{
                        data: incomeData,
                        backgroundColor: incomeColors,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right', // ë²”ë¡€ ìœ„ì¹˜ ë³€ê²½
                            labels: {
                                font: {
                                    size: 14
                                },
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                    const percentage = total > 0 ? ((value / grossIncome) * 100).toFixed(1) : '0.0'; // ì´ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨
                                    return `${label}: $${formatMoney(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸
            const expenseCategoryData = {};
            budgetData.expenses.forEach(exp => {
                const categoryName = budgetData.categories.find(cat => cat.id === exp.category)?.name || exp.category;
                const categoryNameEn = budgetData.categories.find(cat => cat.id === exp.category)?.nameEn || exp.category;
                const displayCategoryName = budgetData.currentLanguage === 'ko' ? categoryName : categoryNameEn;

                if (expenseCategoryData[displayCategoryName]) {
                    expenseCategoryData[displayCategoryName] += exp.amount;
                } else {
                    expenseCategoryData[displayCategoryName] = exp.amount;
                }
            });

            const expenseLabels = Object.keys(expenseCategoryData);
            const expenseAmounts = Object.values(expenseCategoryData);

            // Chart.js ê¸°ë³¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
            const defaultChartColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED' // ë” ë§ì€ ì¹´í…Œê³ ë¦¬ë¥¼ ìœ„í•´ ë°˜ë³µ
            ];
            const dynamicColors = expenseLabels.map((_, i) => defaultChartColors[i % defaultChartColors.length]);

            const ctx2 = document.getElementById('expenseCategoryChart').getContext('2d');
            expenseCategoryChartInstance = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: expenseLabels,
                    datasets: [{
                        data: expenseAmounts,
                        backgroundColor: dynamicColors,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right', // ë²”ë¡€ ìœ„ì¹˜ ë³€ê²½
                            labels: {
                                font: {
                                    size: 14
                                },
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${label}: $${formatMoney(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- ë°ì´í„° ê³„ì‚° ë° UI ì—…ë°ì´íŠ¸ ---
        function updateUI() {
            const income = parseFloat(document.getElementById('income-input').value) || 0;
            budgetData.income = income;

            const preTaxTotal = budgetData.preTax.reduce((sum, item) => sum + item.amount, 0);
            const taxableIncome = income - preTaxTotal;
            const taxTotal = budgetData.taxes.reduce((sum, item) => sum + item.amount, 0);
            const postTaxTotal = budgetData.postTax.reduce((sum, item) => sum + item.amount, 0);
            const totalDeductionsTaxes = preTaxTotal + taxTotal + postTaxTotal;
            const netIncome = income - totalDeductionsTaxes;
            const expensesTotal = budgetData.expenses.reduce((sum, item) => sum + item.amount, 0);
            const remainingBalance = netIncome - expensesTotal;

            // ì›”ë³„ ì¬ë¬´ í˜„í™© ì—…ë°ì´íŠ¸
            document.getElementById('gross-income').textContent = formatMoney(income);
            document.getElementById('pre-tax-deductions').textContent = formatMoney(preTaxTotal);
            document.getElementById('taxable-income').textContent = formatMoney(taxableIncome);
            document.getElementById('tax-total').textContent = formatMoney(taxTotal);
            document.getElementById('post-tax-deductions').textContent = formatMoney(postTaxTotal);
            document.getElementById('total-deductions-taxes').textContent = formatMoney(totalDeductionsTaxes);
            document.getElementById('net-income').textContent = formatMoney(netIncome);

            // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('expenses-total-card').textContent = formatMoney(expensesTotal);
            document.getElementById('expenses-percentage-card').textContent = calculatePercentage(expensesTotal, income);

            document.getElementById('remaining-balance').textContent = formatMoney(remainingBalance);
            document.getElementById('remaining-balance').classList.toggle('positive', remainingBalance >= 0);
            document.getElementById('remaining-balance').classList.toggle('negative', remainingBalance < 0);
            document.getElementById('remaining-percentage-card').textContent = calculatePercentage(remainingBalance, income);

            // ëª©ë¡ ë Œë”ë§
            renderCategorizedList('taxes', budgetData.taxes, 'tax-list');
            renderCategorizedList('preTax', budgetData.preTax, 'pre-tax-list');
            renderCategorizedList('postTax', budgetData.postTax, 'post-tax-list');
            renderExpensesList();

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateCharts(income, preTaxTotal, taxTotal, postTaxTotal, expensesTotal, remainingBalance);
        }

        // --- í•­ëª© ì¶”ê°€ í•¨ìˆ˜ ---
        function addCategorizedItem(type) {
            let nameInput, amountInput, customNameInput;
            let listElementId;
            let selectElementId;

            if (type === 'taxes') {
                selectElementId = 'tax-type-select';
                nameInput = document.getElementById('tax-type-select');
                customNameInput = document.getElementById('tax-custom-name-input');
                amountInput = document.getElementById('tax-amount-input');
                listElementId = 'tax-list';
            } else if (type === 'preTax') {
                selectElementId = 'pre-tax-type-select';
                nameInput = document.getElementById('pre-tax-type-select');
                customNameInput = document.getElementById('pre-tax-custom-name-input');
                amountInput = document.getElementById('pre-tax-amount-input');
                listElementId = 'pre-tax-list';
            } else if (type === 'postTax') {
                selectElementId = 'post-tax-type-select';
                nameInput = document.getElementById('post-tax-type-select');
                customNameInput = document.getElementById('post-tax-custom-name-input');
                amountInput = document.getElementById('post-tax-amount-input');
                listElementId = 'post-tax-list';
            } else {
                console.error("Invalid type for addCategorizedItem:", type);
                return;
            }

            let name = nameInput.value;
            const amount = parseFloat(amountInput.value) || 0;

            if (name === 'custom') {
                name = customNameInput.value.trim();
                if (!name) {
                    alert(budgetData.currentLanguage === 'ko' ? 'ì‚¬ìš©ì ì •ì˜ ì´ë¦„(ì„¸ê¸ˆ/ê³µì œ)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a custom name for the tax/deduction.');
                    return;
                }
            }

            if (!name || amount <= 0) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì´ë¦„ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a name and a valid amount.');
                return;
            }

            if (editingItem) {
                // ìˆ˜ì • ëª¨ë“œ
                const itemToUpdate = budgetData[type].find(item => item.id === editingItem.id);
                if (itemToUpdate) {
                    itemToUpdate.name = name;
                    itemToUpdate.amount = amount;
                }
                editingItem = null; // ìˆ˜ì • ëª¨ë“œ ì¢…ë£Œ
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                budgetData[type].push({
                    id: generateUniqueId(),
                    name: name,
                    amount: amount
                });
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById(selectElementId).value = ''; // ì„ íƒ ì´ˆê¸°í™”
            if (nameInput.value === 'custom') { // ì‚¬ìš©ì ì •ì˜ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
                document.getElementById(`${type}-custom-container`).classList.add('hidden');
            }
            customNameInput.value = ''; // ì‚¬ìš©ì ì •ì˜ ì´ë¦„ ì´ˆê¸°í™”
            amountInput.value = ''; // ê¸ˆì•¡ ì´ˆê¸°í™”

            updateUI();
            saveData();
        }

        function addCategory() {
            const newCategoryInput = document.getElementById('new-category-input');
            const newCategoryName = newCategoryInput.value.trim();

            if (!newCategoryName) {
                alert(budgetData.currentLanguage === 'ko' ? 'ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a new category name.');
                return;
            }

            // ì¤‘ë³µ ì¹´í…Œê³ ë¦¬ í™•ì¸
            const categoryExists = budgetData.categories.some(cat =>
                cat.name.toLowerCase() === newCategoryName.toLowerCase() ||
                cat.nameEn.toLowerCase() === newCategoryName.toLowerCase()
            );

            if (categoryExists) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.' : 'Category already exists.');
                return;
            }

            const newCategoryId = newCategoryName.toLowerCase().replace(/[^a-z0-9]/g, ''); // ê°„ë‹¨í•œ ID ìƒì„±
            budgetData.categories.push({
                id: newCategoryId,
                name: newCategoryName,
                nameEn: newCategoryName // ì¼ë‹¨ ì˜ì–´ ì´ë¦„ë„ ë™ì¼í•˜ê²Œ ì„¤ì •, í•„ìš” ì‹œ ìˆ˜ì • ê°€ëŠ¥
            });

            newCategoryInput.value = '';
            populateCategorySelect(); // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸
            document.getElementById('category-select').value = newCategoryId; // ìƒˆë¡œ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ ì„ íƒ
            document.getElementById('category-input-container').classList.add('hidden'); // ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
            updateUI();
            saveData();
        }


        function addExpense() {
            const categorySelect = document.getElementById('category-select');
            const expenseNameInput = document.getElementById('expense-name-input');
            const expenseAmountInput = document.getElementById('expense-amount-input-main');

            let category = categorySelect.value;
            const name = expenseNameInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value) || 0;

            if (category === 'custom') {
                const newCategoryNameInput = document.getElementById('new-category-input');
                const newCategoryName = newCategoryNameInput.value.trim();
                if (!newCategoryName) {
                    alert(budgetData.currentLanguage === 'ko' ? 'ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.' : 'Please add a new category name first.');
                    return;
                }
                // addCategory í•¨ìˆ˜ì—ì„œ ì´ë¯¸ ì¶”ê°€ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œ ì§ì ‘ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                // ëŒ€ì‹ , ìƒˆë¡œ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ë¡œ category ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                category = budgetData.categories.find(cat => cat.name === newCategoryName || cat.nameEn === newCategoryName)?.id || category;
            }

            if (!category || !name || amount <= 0) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì¹´í…Œê³ ë¦¬, í•­ëª©ëª…, ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a category, item name, and a valid amount.');
                return;
            }

            if (editingItem) {
                const itemToUpdate = budgetData.expenses.find(item => item.id === editingItem.id);
                if (itemToUpdate) {
                    itemToUpdate.category = category;
                    itemToUpdate.name = name;
                    itemToUpdate.amount = amount;
                }
                editingItem = null;
            } else {
                budgetData.expenses.push({
                    id: generateUniqueId(),
                    category: category,
                    name: name,
                    amount: amount
                });
            }

            expenseNameInput.value = '';
            expenseAmountInput.value = '';
            // categorySelect.value = budgetData.categories[0] ? budgetData.categories[0].id : ''; // ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ë¡œ ì´ˆê¸°í™”
            // document.getElementById('category-input-container').classList.add('hidden'); // ì‚¬ìš©ì ì •ì˜ í•„ë“œ ìˆ¨ê¸°ê¸° (í˜¹ì‹œ ìˆì„ê¹Œë´)

            updateUI();
            saveData();
        }

        // --- í•­ëª© ë Œë”ë§ í•¨ìˆ˜ ---
        function renderCategorizedList(type, items, listElementId) {
            const listElement = document.getElementById(listElementId);
            listElement.innerHTML = '';
            if (items.length === 0) {
                listElement.classList.add('hidden');
                return;
            }
            listElement.classList.remove('hidden');

            items.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('list-item');
                div.innerHTML = `
                    <div class="list-item-content">
                        <span class="badge">${item.name}</span>
                        <span class="list-item-amount">$${formatMoney(item.amount)}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-warning btn-small" onclick="editCategorizedItem('${type}', '${item.id}')">âœï¸</button>
                        <button class="btn-danger btn-small" onclick="deleteCategorizedItem('${type}', '${item.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                listElement.appendChild(div);
            });
        }

        function renderExpensesList() {
            const listElement = document.getElementById('expenses-list');
            listElement.innerHTML = '';
            if (budgetData.expenses.length === 0) {
                listElement.classList.add('hidden');
                return;
            }
            listElement.classList.remove('hidden');

            budgetData.expenses.forEach(expense => {
                const categoryName = budgetData.categories.find(cat => cat.id === expense.category);
                const displayCategory = budgetData.currentLanguage === 'ko' ? (categoryName ? categoryName.name : expense.category) : (categoryName ? categoryName.nameEn : expense.category);

                const div = document.createElement('div');
                div.classList.add('list-item');
                div.innerHTML = `
                    <div class="list-item-content">
                        <span class="badge">${displayCategory}</span>
                        <span>${expense.name}</span>
                        <span class="list-item-amount">$${formatMoney(expense.amount)}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-warning btn-small" onclick="editExpense('${expense.id}')">âœï¸</button>
                        <button class="btn-danger btn-small" onclick="deleteExpense('${expense.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                listElement.appendChild(div);
            });
        }

        // --- í•­ëª© ìˆ˜ì • ë° ì‚­ì œ í•¨ìˆ˜ ---
        function editCategorizedItem(type, id) {
            const itemToEdit = budgetData[type].find(item => item.id === id);
            if (!itemToEdit) return;

            editingItem = itemToEdit; // ìˆ˜ì • ì¤‘ì¸ í•­ëª© ì„¤ì •

            let nameInput, amountInput, customNameInput, selectElement;

            if (type === 'taxes') {
                selectElement = document.getElementById('tax-type-select');
                customNameInput = document.getElementById('tax-custom-name-input');
                amountInput = document.getElementById('tax-amount-input');
                document.getElementById('tax-custom-container').classList.add('hidden'); // ì¼ë‹¨ ìˆ¨ê¹€
            } else if (type === 'preTax') {
                selectElement = document.getElementById('pre-tax-type-select');
                customNameInput = document.getElementById('pre-tax-custom-name-input');
                amountInput = document.getElementById('pre-tax-amount-input');
                document.getElementById('pre-tax-custom-container').classList.add('hidden');
            } else if (type === 'postTax') {
                selectElement = document.getElementById('post-tax-type-select');
                customNameInput = document.getElementById('post-tax-custom-name-input');
                amountInput = document.getElementById('post-tax-amount-input');
                document.getElementById('post-tax-custom-container').classList.add('hidden');
            }

            // ë¯¸ë¦¬ ì •ì˜ëœ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
            const isPredefined = DEFAULT_DEDUCTIONS[type].some(def => def.name === itemToEdit.name);

            if (isPredefined) {
                selectElement.value = itemToEdit.name;
                customNameInput.value = ''; // ì‚¬ìš©ì ì •ì˜ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById(`${type}-custom-container`).classList.add('hidden');
            } else {
                selectElement.value = 'custom';
                customNameInput.value = itemToEdit.name;
                document.getElementById(`${type}-custom-container`).classList.remove('hidden');
            }

            amountInput.value = itemToEdit.amount;

            // ì…ë ¥ í•„ë“œë¡œ ìŠ¤í¬ë¡¤
            selectElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function deleteCategorizedItem(type, id) {
            if (!confirm(budgetData.currentLanguage === 'ko' ? 'ì •ë§ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'Are you sure you want to delete this item?')) return;
            budgetData[type] = budgetData[type].filter(item => item.id !== id);
            updateUI();
            saveData();
        }

        function editExpense(id) {
            const expenseToEdit = budgetData.expenses.find(exp => exp.id === id);
            if (!expenseToEdit) return;

            editingItem = expenseToEdit;

            const categorySelect = document.getElementById('category-select');
            const expenseNameInput = document.getElementById('expense-name-input');
            const expenseAmountInput = document.getElementById('expense-amount-input-main');
            const newCategoryInput = document.getElementById('new-category-input');

            // ì¹´í…Œê³ ë¦¬ê°€ ê¸°ì¡´ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
            const isPredefinedCategory = budgetData.categories.some(cat => cat.id === expenseToEdit.category);

            if (isPredefinedCategory) {
                categorySelect.value = expenseToEdit.category;
                newCategoryInput.value = ''; // ì‚¬ìš©ì ì •ì˜ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('category-input-container').classList.add('hidden');
            } else {
                // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° 'custom' ì„ íƒí•˜ê³  ì…ë ¥ í•„ë“œ í‘œì‹œ
                categorySelect.value = 'custom';
                newCategoryInput.value = expenseToEdit.category; // ê¸°ì¡´ ì‚¬ìš©ì ì •ì˜ ì´ë¦„ ì±„ìš°ê¸°
                document.getElementById('category-input-container').classList.remove('hidden');
            }

            expenseNameInput.value = expenseToEdit.name;
            expenseAmountInput.value = expenseToEdit.amount;

            // ì…ë ¥ í•„ë“œë¡œ ìŠ¤í¬ë¡¤
            categorySelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function deleteExpense(id) {
            if (!confirm(budgetData.currentLanguage === 'ko' ? 'ì •ë§ ì´ ì§€ì¶œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'Are you sure you want to delete this expense item?')) return;
            budgetData.expenses = budgetData.expenses.filter(exp => exp.id !== id);
            updateUI();
            saveData();
        }

        // --- ë°ì´í„° ì €ì¥ ë° ë¡œë“œ ---
        function saveData() {
            try {
                localStorage.setItem('budgetAppData', JSON.stringify(budgetData));
                console.log('Data saved successfully.');
                alert(budgetData.currentLanguage === 'ko' ? 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'Data saved successfully!');
            } catch (e) {
                console.error('Error saving data to localStorage:', e);
                alert(budgetData.currentLanguage === 'ko' ? 'ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'Error saving data.');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('budgetAppData');
                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë¡œë“œëœ ë°ì´í„°ë¥¼ ë³‘í•©í•˜ì—¬ ìƒˆë¡œìš´ ì†ì„± ì¶”ê°€ ì‹œ ì—ëŸ¬ ë°©ì§€
                    Object.assign(budgetData, loadedData);

                    // ëˆ„ë½ëœ ê¸°ë³¸ ê³µì œ í•­ëª© ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„°ì— ì—†ë˜ ìƒˆë¡œìš´ ê¸°ë³¸ í•­ëª©ì´ ì¶”ê°€ë  ê²½ìš°)
                    ['taxes', 'preTax', 'postTax'].forEach(type => {
                        DEFAULT_DEDUCTIONS[type].forEach(defaultItem => {
                            if (!budgetData[type].some(item => item.name === defaultItem.name)) {
                                budgetData[type].push({ ...defaultItem, id: generateUniqueId() });
                            }
                        });
                    });

                    // ì¹´í…Œê³ ë¦¬ë„ ë§ˆì°¬ê°€ì§€ë¡œ ìƒˆë¡œìš´ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë  ê²½ìš°
                    budgetData.categories.forEach(defaultCat => {
                         if (!budgetData.categories.some(cat => cat.id === defaultCat.id)) {
                             budgetData.categories.push(defaultCat);
                         }
                    });

                    document.getElementById('income-input').value = budgetData.income;
                    switchLanguage(budgetData.currentLanguage); // ì–¸ì–´ ì„¤ì • ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
                    console.log('Data loaded successfully.');
                    alert(budgetData.currentLanguage === 'ko' ? 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!' : 'Data loaded successfully!');
                } else {
                    console.log('No saved data found. Initializing with default values.');
                    initializeDefaultData();
                }
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
                alert(budgetData.currentLanguage === 'ko' ? 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'Error loading data.');
                initializeDefaultData(); // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            }
            updateUI();
        }

        function resetData() {
            if (!confirm(budgetData.currentLanguage === 'ko' ? 'ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'Are you sure you want to reset all data? This action cannot be undone.')) {
                return;
            }
            localStorage.removeItem('budgetAppData');
            initializeDefaultData();
            updateUI();
            alert(budgetData.currentLanguage === 'ko' ? 'ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'All data has been reset!');
        }

        function initializeDefaultData() {
            budgetData.income = 0;
            budgetData.taxes = DEFAULT_DEDUCTIONS.taxes.map(item => ({ ...item, id: generateUniqueId() }));
            budgetData.preTax = DEFAULT_DEDUCTIONS.preTax.map(item => ({ ...item, id: generateUniqueId() }));
            budgetData.postTax = DEFAULT_DEDUCTIONS.postTax.map(item => ({ ...item, id: generateUniqueId() }));
            budgetData.expenses = [];
            // categoriesëŠ” ì´ˆê¸° ìƒíƒœë¥¼ ìœ ì§€í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
            // budgetData.categories = [ ...original_default_categories ]; // í•„ìš”í•œ ê²½ìš° ì´ë ‡ê²Œ ì´ˆê¸°í™”
            document.getElementById('income-input').value = 0;
            switchLanguage('ko'); // ì´ˆê¸°í™” ì‹œ í•œêµ­ì–´ë¡œ ì„¤ì •
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            // ì–¸ì–´ ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('lang-ko').addEventListener('click', () => switchLanguage('ko'));
            document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));

            // ìˆ˜ì… ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
            document.getElementById('income-input').addEventListener('input', updateUI);

            // CSPë¡œ ì¸í•œ ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±° (onclick ëŒ€ì‹  addEventListener ì‚¬ìš© ê¶Œì¥)
            // í•˜ì§€ë§Œ í˜„ì¬ ì½”ë“œëŠ” onclickì„ ì‚¬ìš©í•˜ë¯€ë¡œ, CSPê°€ 'unsafe-inline'ì„ í—ˆìš©í•´ì•¼ í•¨.
            // ìœ„ meta íƒœê·¸ì— 'unsafe-inline'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë™ì‘í•  ê²ƒì…ë‹ˆë‹¤.

            loadData(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        });

    </script>
</body>
</html>
