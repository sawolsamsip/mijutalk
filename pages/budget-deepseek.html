<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다국어 예산 관리 시스템</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #7209b7;
            --text-color: #24243e;
            --light-gray: #f7faff;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --white: #ffffff;
            --shadow: 0 4px 24px rgba(67,97,238,0.10);
            --border-radius: 16px;
        }
        html { background: var(--light-gray); }
        body {
            font-family: 'Inter', 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: var(--text-color);
            background: var(--light-gray);
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 48px auto 48px auto;
            padding: 28px 20px 40px 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }
        .language-switcher {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
            z-index: 10;
        }
        .language-btn {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            border-radius: 18px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.15s;
            box-shadow: 0 2px 10px rgba(67,97,238,0.08);
        }
        .language-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 16px rgba(67,97,238,0.16);
            transform: translateY(-2px) scale(1.04);
        }
        header {
            text-align: center;
            margin-bottom: 36px;
        }
        h1 { color: var(--primary); font-size: 2.3rem; margin-bottom: 13px; font-weight: 700; }
        h2 { color: var(--primary); font-size: 1.25rem; margin-bottom: 17px; font-weight: 700; }
        .card {
            background: var(--white);
            padding: 25px 22px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1.5px solid #e6e8ec;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }
        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        input, select {
            width: 100%;
            padding: 11px 12px;
            border: 1.5px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #f7faff;
        }
        select {
            cursor: pointer;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.13);
        }
        button {
            background: linear-gradient(90deg, #4361ee, #4895ef);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.16s, box-shadow 0.18s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(67,97,238,0.09);
        }
        button:hover { background: linear-gradient(90deg, #4895ef, #4361ee); transform: translateY(-2px) scale(1.04);}
        .btn-danger { background: linear-gradient(90deg, #f72585, #d6336c);}
        .btn-danger:hover { background: linear-gradient(90deg, #d6336c, #f72585);}
        .btn-warning { background: linear-gradient(90deg, #f8961e, #e67700);}
        .btn-warning:hover { background: linear-gradient(90deg, #e67700, #f8961e);}
        .btn-success { background: linear-gradient(90deg, #4cc9f0, #4361ee); color: var(--text-color);}
        .btn-success:hover { background: linear-gradient(90deg, #4361ee, #4cc9f0); color: #fff;}
        .btn-info { background: linear-gradient(90deg, #7209b7, #4895ef);}
        .btn-info:hover { background: linear-gradient(90deg, #4895ef, #7209b7);}
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.92rem;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
            margin-right: 4px;
        }
        .item-list { margin-top: 12px; }
        .list-item {
            background: var(--white);
            padding: 13px 10px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 5px rgba(67,97,238,0.07);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            border: 1px solid #f3f3f7;
        }
        .list-item:hover {
            transform: translateX(4px) scale(1.01);
            box-shadow: 0 6px 18px rgba(67,97,238,0.10);
        }
        .list-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .list-item-amount { font-weight: 600; min-width: 82px; text-align: right; }
        .list-item-actions { display: flex; gap: 7px; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 23px;
        }
        .summary-card {
            background: var(--white);
            padding: 18px 0 16px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        .card-label { font-size: 0.96rem; color: var(--medium-gray); margin-bottom: 2px; }
        .card-amount { font-size: 1.7rem; font-weight: 700; margin: 9px 0; }
        .positive { color: var(--success);}
        .negative { color: var(--danger);}
        .flex { display: flex; gap: 12px; align-items: flex-end;}
        .flex > div { flex: 1;}
        .chart-container {
            background: var(--white);
            padding: 18px 12px 24px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            margin-top: 5px;
            height: 430px;
            position: relative;
            border: 1.5px solid #e6e8ec;
        }
        .chart-wrapper {
            width: 100%;
            height: 340px;
            position: relative;
        }
        .chart-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 700;
        }
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 28px 0 8px 0;
            flex-wrap: wrap;
        }
        .hidden { display: none;}
        @media (max-width: 900px) {
            .container { margin: 18px 3px;}
            .chart-container { height: 320px;}
            .chart-wrapper { height: 220px;}
        }
        @media (max-width: 600px) {
            .container { padding: 8px 2px;}
            .summary-cards { grid-template-columns: 1fr;}
            .chart-container { height: 260px;}
            .chart-wrapper { height: 140px;}
            .language-switcher { justify-content: center;}
        }
        @media print {
            body { padding: 0; background: white;}
            button, .utility-buttons, .language-switcher { display: none;}
            .card, .chart-container { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid;}
            .chart-container { height: auto;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button id="lang-ko" class="language-btn active">한국어</button>
            <button id="lang-en" class="language-btn">English</button>
        </div>
        <header>
            <h1 data-lang="ko">💰 고급 예산 관리 시스템</h1>
            <h1 data-lang="en" class="hidden">💰 Advanced Budget Management System</h1>
            <p data-lang="ko">한 곳에서 수입, 세금, 공제 및 지출을 관리하세요</p>
            <p data-lang="en" class="hidden">Manage your income, taxes, deductions, and expenses in one place</p>
        </header>
        <!-- 1. 수입 -->
        <div class="card">
            <h2 data-lang="ko">1. 수입</h2>
            <h2 data-lang="en" class="hidden">1. Earnings</h2>
            <div class="form-group">
                <label for="income-input" data-lang="ko">수입 (급여)</label>
                <label for="income-input" data-lang="en" class="hidden">Income (Salary)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="income-input" data-lang-ko-placeholder="수입을 입력하세요" data-lang-en-placeholder="Enter your income" placeholder="0">
                    <select id="income-period">
                        <option value="monthly" selected data-lang="ko">월 1회</option>
                        <option value="biweekly" data-lang="ko">2주 1회</option>
                        <option value="weekly" data-lang="ko">매주</option>
                        <option value="monthly" class="hidden" data-lang="en">Monthly</option>
                        <option value="biweekly" class="hidden" data-lang="en">Biweekly</option>
                        <option value="weekly" class="hidden" data-lang="en">Weekly</option>
                    </select>
                </div>
                <small id="income-period-desc" style="display:block; color:var(--medium-gray); margin-top:2px;"></small>
            </div>
        </div>
        <!-- 2. 세금 -->
        <div class="card">
            <h2 data-lang="ko">2. 직원 세금</h2>
            <h2 data-lang="en" class="hidden">2. Employee Taxes</h2>
            <div class="form-group">
                <label for="tax-type-select" data-lang="ko">세금 유형</label>
                <label for="tax-type-select" data-lang="en" class="hidden">Tax Type</label>
                <select id="tax-type-select"></select>
            </div>
            <div id="tax-custom-container" class="form-group hidden">
                <div class="flex" style="gap:10px;">
                    <div id="tax-custom-name-div" class="hidden">
                        <label for="tax-custom-name-input" data-lang="ko">세금 이름</label>
                        <label for="tax-custom-name-input" data-lang="en" class="hidden">Tax Name</label>
                        <input type="text" id="tax-custom-name-input" data-lang-ko-placeholder="세금 이름 입력" data-lang-en-placeholder="Enter tax name">
                    </div>
                    <div style="min-width:110px;">
                        <label for="tax-amount-input" data-lang="ko">금액 ($)</label>
                        <label for="tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="tax-amount-input" placeholder="금액 입력">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success" id="tax-add-btn" data-lang="ko">세금 추가</button>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success hidden" data-lang="en">Add Tax</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="tax-list"></div>
        </div>
        <!-- 3. 세전 공제 -->
        <div class="card">
            <h2 data-lang="ko">3. 세전 공제</h2>
            <h2 data-lang="en" class="hidden">3. Pre-Tax Deductions</h2>
            <div class="form-group">
                <label for="pre-tax-type-select" data-lang="ko">공제 유형</label>
                <label for="pre-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="pre-tax-type-select"></select>
            </div>
            <div id="pre-tax-custom-container" class="form-group hidden">
                <div class="flex" style="gap:10px;">
                    <div id="pre-tax-custom-name-div" class="hidden">
                        <label for="pre-tax-custom-name-input" data-lang="ko">공제 이름</label>
                        <label for="pre-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="pre-tax-custom-name-input" data-lang-ko-placeholder="공제 이름 입력" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div style="min-width:110px;">
                        <label for="pre-tax-amount-input" data-lang="ko">금액 ($)</label>
                        <label for="pre-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="pre-tax-amount-input" placeholder="금액 입력">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success" id="pre-tax-add-btn" data-lang="ko">공제 추가</button>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="pre-tax-list"></div>
        </div>
        <!-- 4. 세후 공제 -->
        <div class="card">
            <h2 data-lang="ko">4. 세후 공제</h2>
            <h2 data-lang="en" class="hidden">4. Post-Tax Deductions</h2>
            <div class="form-group">
                <label for="post-tax-type-select" data-lang="ko">공제 유형</label>
                <label for="post-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="post-tax-type-select"></select>
            </div>
            <div id="post-tax-custom-container" class="form-group hidden">
                <div class="flex" style="gap:10px;">
                    <div id="post-tax-custom-name-div" class="hidden">
                        <label for="post-tax-custom-name-input" data-lang="ko">공제 이름</label>
                        <label for="post-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="post-tax-custom-name-input" data-lang-ko-placeholder="공제 이름 입력" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div style="min-width:110px;">
                        <label for="post-tax-amount-input" data-lang="ko">금액 ($)</label>
                        <label for="post-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="post-tax-amount-input" placeholder="금액 입력">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success" id="post-tax-add-btn" data-lang="ko">공제 추가</button>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="post-tax-list"></div>
        </div>
        <!-- 5. 지출 관리 -->
        <div class="card">
            <h2 data-lang="ko">5. 지출 관리</h2>
            <h2 data-lang="en" class="hidden">5. Expense Management</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="category-select" data-lang="ko">카테고리</label>
                    <label for="category-select" data-lang="en" class="hidden">Category</label>
                    <select id="category-select"></select>
                </div>
                <div class="form-group">
                    <label for="expense-name-input" data-lang="ko">지출 항목</label>
                    <label for="expense-name-input" data-lang="en" class="hidden">Expense Name</label>
                    <input type="text" id="expense-name-input" data-lang-ko-placeholder="예: 월세" data-lang-en-placeholder="e.g. Rent">
                </div>
                <div class="form-group">
                    <label for="expense-amount-input-main" data-lang="ko">금액 ($)</label>
                    <label for="expense-amount-input-main" data-lang="en" class="hidden">Amount ($)</label>
                    <input type="number" id="expense-amount-input-main" placeholder="금액 입력">
                </div>
            </div>
            <div id="category-input-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="new-category-input" data-lang="ko">새 카테고리 이름</label>
                        <label for="new-category-input" data-lang="en" class="hidden">New Category Name</label>
                        <input type="text" id="new-category-input" data-lang-ko-placeholder="새 카테고리 입력" data-lang-en-placeholder="Enter new category">
                    </div>
                    <div>
                        <button onclick="addCategory()" class="btn-info" data-lang="ko">카테고리 추가</button>
                        <button onclick="addCategory()" class="btn-info hidden" data-lang="en">Add Category</button>
                    </div>
                </div>
            </div>
            <button onclick="addExpense()" class="btn-success" style="width: 100%; margin-top: 10px;" data-lang="ko" id="expense-add-btn">지출 추가</button>
            <button onclick="addExpense()" class="btn-success hidden" style="width: 100%; margin-top: 10px;" data-lang="en">Add Expense</button>
            <div class="item-list" id="expenses-list"></div>
        </div>
        <!-- 6. 월별 재무 현황 -->
        <div class="card">
            <h2 data-lang="ko">6. 월별 재무 현황</h2>
            <h2 data-lang="en" class="hidden">6. Monthly Financial Status</h2>
            <div class="income-flow">
                <div class="flow-item">
                    <span data-lang="ko">월 총 수입 (총 수익)</span>
                    <span data-lang="en" class="hidden">Gross Monthly Income (Total Earnings)</span>
                    <span>$<span id="gross-income">0.00</span> <em data-lang="ko">(100.0%)</em><em data-lang="en" class="hidden">(100.0%)</em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">세전 공제</span>
                    <span data-lang="en" class="hidden">Pre-Tax Deductions</span>
                    <span>-$<span id="pre-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item">
                    <span data-lang="ko"><strong>과세 소득</strong></span>
                    <span data-lang="en" class="hidden"><strong>Taxable Income</strong></span>
                    <span>$<span id="taxable-income">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">세금</span>
                    <span data-lang="en" class="hidden">Taxes</span>
                    <span>-$<span id="tax-total">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">세후 공제</span>
                    <span data-lang="en" class="hidden">Post-Tax Deductions</span>
                    <span>-$<span id="post-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item info">
                    <span data-lang="ko"><strong>총 공제 및 세금 합계</strong></span>
                    <span data-lang="en" class="hidden"><strong>Total Deductions & Taxes</strong></span>
                    <span>-$<span id="total-deductions-taxes">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item result">
                    <span data-lang="ko"><strong>순수입 (실수령액)</strong></span>
                    <span data-lang="en" class="hidden"><strong>Net Income (Take-Home Pay)</strong></span>
                    <span>$<span id="net-income">0.00</span> <em></em></span>
                </div>
            </div>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">총 지출</div>
                    <div class="card-label hidden" data-lang="en">Total Expenses</div>
                    <div class="card-amount negative">$<span id="expenses-total-card">0.00</span></div>
                    <div class="card-label" data-lang="ko">(순수입에서 사용된 금액)</div>
                    <div class="card-label hidden" data-lang="en">(Amount used from net income)</div>
                    <div class="card-label"><span id="expenses-percentage-card">0.0%</span> <span data-lang="ko">of 총 수입</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">남은 잔액</div>
                    <div class="card-label hidden" data-lang="en">Remaining Balance</div>
                    <div class="card-amount positive">$<span id="remaining-balance">0.00</span></div>
                    <div class="card-label" data-lang="ko">(순수입 - 총 지출 = 저축)</div>
                    <div class="card-label hidden" data-lang="en">(Net Income - Expenses = Savings)</div>
                    <div class="card-label"><span id="remaining-percentage-card">0.0%</span> <span data-lang="ko">of 총 수입</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
            </div>
        </div>
        <!-- 7. 차트 -->
        <div class="chart-container">
            <h2 data-lang="ko">7. 재무 분석 차트</h2>
            <h2 data-lang="en" class="hidden">7. Financial Analysis Charts</h2>
            <div class="grid">
                <div>
                    <div class="chart-title" data-lang="ko">수입 분배 (총 수입 대비 비율)</div>
                    <div class="chart-title hidden" data-lang="en">Income Distribution (Percentage of Gross Income)</div>
                    <div class="chart-wrapper">
                        <canvas id="incomeFlowChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="chart-title" data-lang="ko">지출 카테고리 (총 지출 대비 비율)</div>
                    <div class="chart-title hidden" data-lang="en">Expense Categories (Percentage of Total Expenses)</div>
                    <div class="chart-wrapper">
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="utility-buttons">
            <button onclick="saveData()" class="btn-info" data-lang="ko">💾 데이터 저장</button>
            <button onclick="saveData()" class="btn-info hidden" data-lang="en">💾 Save Data</button>
            <button onclick="loadData()" class="btn-info" data-lang="ko">📂 데이터 불러오기</button>
            <button onclick="loadData()" class="btn-info hidden" data-lang="en">📂 Load Data</button>
            <button onclick="window.print()" class="btn-warning" data-lang="ko">🖨️ 리포트 인쇄</button>
            <button onclick="window.print()" class="btn-warning hidden" data-lang="en">🖨️ Print Report</button>
            <button onclick="resetData()" class="btn-danger" data-lang="ko">🔄 데이터 초기화</button>
            <button onclick="resetData()" class="btn-danger hidden" data-lang="en">🔄 Reset Data</button>
        </div>
    </div>
    <script>
    // --- 데이터 구조 및 상수 ---
    const DEFAULT_DEDUCTIONS = {
        taxes: [
            { name: "Federal Withholding", amount: 0 },
            { name: "State Tax (CA)", amount: 0 },
            { name: "OASDI (Social Security)", amount: 0 },
            { name: "Medicare", amount: 0 },
            { name: "CA SDI", amount: 0 }
        ],
        preTax: [
            { name: "401k Traditional", amount: 0 },
            { name: "Medical Premium", amount: 0 },
            { name: "Dental Premium", amount: 0 },
            { name: "Vision Premium", amount: 0 },
            { name: "MSEAP", amount: 0 }
        ],
        postTax: [
            { name: "401k Roth", amount: 0 },
            { name: "Stock Purchase Plan", amount: 0 },
            { name: "Legal Services", amount: 0 },
            { name: "LTD", amount: 0 },
            { name: "AD&D", amount: 0 },
            { name: "Accident Insurance", amount: 0 },
            { name: "Critical Illness", amount: 0 }
        ]
    };
    const budgetData = {
        income: 0,
        taxes: [],
        preTax: [],
        postTax: [],
        expenses: [],
        categories: [
            { id: 'housing', name: '🏠 주거', nameEn: '🏠 Housing' },
            { id: 'food', name: '🍔 식비', nameEn: '🍔 Food' },
            { id: 'transportation', name: '🚗 교통', nameEn: '🚗 Transportation' },
            { id: 'health', name: '🏥 건강', nameEn: '🏥 Health' },
            { id: 'family', name: '👪 가족', nameEn: '👪 Family' },
            { id: 'shopping', name: '🛍️ 쇼핑', nameEn: '🛍️ Shopping' },
            { id: 'finance', name: '💳 금융', nameEn: '💳 Finance' },
            { id: 'travel', name: '✈️ 여행', nameEn: '✈️ Travel' },
            { id: 'saving', name: '💰 저축', nameEn: '💰 Saving' },
            { id: 'business', name: '💼 업무', nameEn: '💼 Business' }
        ],
        currentLanguage: 'ko'
    };
    let incomeFlowChartInstance = null;
    let expenseCategoryChartInstance = null;
    let editingItem = null; // { type, id }
    let editingExpense = null;

    // --- 유틸리티 함수 ---
    function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }
    function formatMoney(amount) {
        if (Number.isNaN(amount) || amount === null) return "0.00";
        return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function calculatePercentage(value, total) {
        if (total === 0) return "0.0%";
        return ((value / total) * 100).toFixed(1) + '%';
    }

    // --- 언어 전환 ---
    function switchLanguage(lang) {
        budgetData.currentLanguage = lang;
        document.querySelectorAll('[data-lang]').forEach(e => {
            if (e.getAttribute('data-lang') === lang) e.classList.remove('hidden');
            else e.classList.add('hidden');
        });
        document.querySelectorAll('[data-lang-ko-placeholder]').forEach(el => {
            const koPlaceholder = el.getAttribute('data-lang-ko-placeholder');
            const enPlaceholder = el.getAttribute('data-lang-en-placeholder');
            el.placeholder = (lang === 'ko') ? koPlaceholder : enPlaceholder;
        });
        document.getElementById('lang-ko').classList.toggle('active', lang === 'ko');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        populateCategorySelect();
        populateDeductionSelects();
        updateIncomePeriodDesc();
        updateUI();
    }
    document.getElementById('lang-ko').onclick = () => switchLanguage('ko');
    document.getElementById('lang-en').onclick = () => switchLanguage('en');

    // --- 수입 주기 안내 ---
    function getMonthlyIncome() {
        const val = parseFloat(document.getElementById('income-input').value) || 0;
        const period = document.getElementById('income-period').value;
        if (period === 'monthly') return val;
        if (period === 'biweekly') return val * 26 / 12;
        if (period === 'weekly') return val * 52 / 12;
        return val;
    }
    function updateIncomePeriodDesc() {
        const income = parseFloat(document.getElementById('income-input').value) || 0;
        const period = document.getElementById('income-period').value;
        let monthly = getMonthlyIncome();
        let msg = '';
        if (budgetData.currentLanguage === 'ko') {
            msg = (period === 'monthly') ? `월 ${formatMoney(monthly)}불로 계산됩니다.` :
                (period === 'biweekly') ? `2주 1회 ${formatMoney(income)}불 → 월 환산 ${formatMoney(monthly)}불` :
                (period === 'weekly') ? `주 ${formatMoney(income)}불 → 월 환산 ${formatMoney(monthly)}불` : '';
        } else {
            msg = (period === 'monthly') ? `Calculated as $${formatMoney(monthly)} per month.` :
                (period === 'biweekly') ? `$${formatMoney(income)} every 2 weeks → $${formatMoney(monthly)} per month` :
                (period === 'weekly') ? `$${formatMoney(income)} per week → $${formatMoney(monthly)} per month` : '';
        }
        document.getElementById('income-period-desc').innerText = msg;
    }
    document.getElementById('income-input').oninput = updateIncomePeriodDesc;
    document.getElementById('income-period').onchange = function() {
        updateIncomePeriodDesc();
        updateUI();
        switchLanguage(budgetData.currentLanguage); // 언어별 옵션 동기화
    };

    // --- 카테고리/세금/공제 셀렉트 채우기 ---
    function populateCategorySelect() {
        const select = document.getElementById('category-select');
        const prev = select.value;
        select.innerHTML = '';
        budgetData.categories.forEach(cat => {
            const o = document.createElement('option');
            o.value = cat.id;
            o.textContent = budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn || cat.name;
            select.appendChild(o);
        });
        const c = document.createElement('option');
        c.value = 'custom';
        c.textContent = budgetData.currentLanguage === 'ko' ? '✏️ 직접 입력' : '✏️ Custom Category';
        select.appendChild(c);
        if (budgetData.categories.some(cat => cat.id === prev) || prev === 'custom') select.value = prev;
        else select.value = budgetData.categories[0] ? budgetData.categories[0].id : '';
        select.onchange = function() {
            const cc = document.getElementById('category-input-container');
            if (this.value === 'custom') cc.classList.remove('hidden');
            else cc.classList.add('hidden');
        };
        // 최초 상태 반영
        if (select.value === 'custom') document.getElementById('category-input-container').classList.remove('hidden');
        else document.getElementById('category-input-container').classList.add('hidden');
    }
    function populateDeductionSelects() {
        ['taxes', 'preTax', 'postTax'].forEach(type => {
            const select = document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-type-select`);
            const prev = select.value;
            select.innerHTML = '';
            // 기본 '선택' 옵션
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = budgetData.currentLanguage === 'ko' ? '유형 선택' : 'Select type';
            select.appendChild(defaultOption);
            DEFAULT_DEDUCTIONS[type].forEach(deduction => {
                const o = document.createElement('option');
                o.value = deduction.name;
                o.textContent = deduction.name;
                select.appendChild(o);
            });
            const c = document.createElement('option');
            c.value = 'custom';
            c.textContent = budgetData.currentLanguage === 'ko' ? '✏️ 사용자 정의' : '✏️ Custom';
            select.appendChild(c);
            if (DEFAULT_DEDUCTIONS[type].some(item => item.name === prev) || prev === 'custom') select.value = prev;
            else select.value = '';
            select.onchange = function() {
                const container = document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-container`);
                const nameDiv = document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-name-div`);
                container.classList.remove('hidden'); // 항상 금액 입력란 보임
                if (this.value === 'custom') nameDiv.classList.remove('hidden');
                else nameDiv.classList.add('hidden');
            };
            // 최초 상태 반영
            const container = document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-container`);
            const nameDiv = document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-name-div`);
            if (select.value === 'custom') nameDiv.classList.remove('hidden');
            else nameDiv.classList.add('hidden');
            // 금액입력은 항상 보임
            container.classList.remove('hidden');
        });
    }

    // --- 세금/공제 항목 추가, 수정, 삭제 ---
    function addCategorizedItem(type) {
        let select, customNameInput, amountInput, listElementId;
        if (type === 'taxes') {
            select = document.getElementById('tax-type-select');
            customNameInput = document.getElementById('tax-custom-name-input');
            amountInput = document.getElementById('tax-amount-input');
            listElementId = 'tax-list';
        } else if (type === 'preTax') {
            select = document.getElementById('pre-tax-type-select');
            customNameInput = document.getElementById('pre-tax-custom-name-input');
            amountInput = document.getElementById('pre-tax-amount-input');
            listElementId = 'pre-tax-list';
        } else if (type === 'postTax') {
            select = document.getElementById('post-tax-type-select');
            customNameInput = document.getElementById('post-tax-custom-name-input');
            amountInput = document.getElementById('post-tax-amount-input');
            listElementId = 'post-tax-list';
        } else return;
        let name = select.value;
        const amount = parseFloat(amountInput.value) || 0;
        if (name === 'custom') {
            name = customNameInput.value.trim();
            if (!name) {
                alert(budgetData.currentLanguage === 'ko' ? '이름을 입력하세요.' : 'Please enter a name.');
                return;
            }
        }
        if (!name || amount <= 0) {
            alert(budgetData.currentLanguage === 'ko' ? '유효한 이름과 금액을 입력하세요.' : 'Enter a valid name and amount.');
            return;
        }
        if (editingItem && editingItem.type === type) {
            // 수정
            const idx = budgetData[type].findIndex(x => x.id === editingItem.id);
            if (idx !== -1) {
                budgetData[type][idx].name = name;
                budgetData[type][idx].amount = amount;
            }
            editingItem = null;
        } else {
            budgetData[type].push({ id: generateUniqueId(), name, amount });
        }
        // 입력 초기화
        select.value = '';
        customNameInput.value = '';
        amountInput.value = '';
        // 이름입력란/금액입력란 모두 숨기기
        document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-name-div`).classList.add('hidden');
        updateUI();
    }
    function renderCategorizedList(type, items, listId) {
        const list = document.getElementById(listId);
        list.innerHTML = '';
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'list-item';
            el.innerHTML = `
                <div class="list-item-content">
                    <span>${item.name}</span>
                    <span class="list-item-amount">$${formatMoney(item.amount)}</span>
                </div>
                <div class="list-item-actions">
                    <button class="btn-warning btn-edit" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '수정' : 'Edit'}</button>
                    <button class="btn-danger btn-delete" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '삭제' : 'Delete'}</button>
                </div>
            `;
            list.appendChild(el);
        });
        list.querySelectorAll('.btn-edit').forEach(btn => {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                const item = budgetData[type].find(x => x.id === id);
                if (!item) return;
                // 입력창에 값 복원
                let select, customNameInput, amountInput;
                if (type === 'taxes') {
                    select = document.getElementById('tax-type-select');
                    customNameInput = document.getElementById('tax-custom-name-input');
                    amountInput = document.getElementById('tax-amount-input');
                } else if (type === 'preTax') {
                    select = document.getElementById('pre-tax-type-select');
                    customNameInput = document.getElementById('pre-tax-custom-name-input');
                    amountInput = document.getElementById('pre-tax-amount-input');
                } else if (type === 'postTax') {
                    select = document.getElementById('post-tax-type-select');
                    customNameInput = document.getElementById('post-tax-custom-name-input');
                    amountInput = document.getElementById('post-tax-amount-input');
                }
                if (DEFAULT_DEDUCTIONS[type].some(x => x.name === item.name)) {
                    select.value = item.name;
                    document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-name-div`).classList.add('hidden');
                } else {
                    select.value = 'custom';
                    customNameInput.value = item.name;
                    document.getElementById(`${type.replace(/([A-Z])/g, '-$1').toLowerCase()}-custom-name-div`).classList.remove('hidden');
                }
                amountInput.value = item.amount;
                editingItem = { id: item.id, type };
            };
        });
        list.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                budgetData[type] = budgetData[type].filter(x => x.id !== id);
                updateUI();
            };
        });
    }

    // --- 지출 항목 추가, 수정, 삭제 ---
    function addExpense() {
        const categorySelect = document.getElementById('category-select');
        let category = categorySelect.value;
        let expenseName = document.getElementById('expense-name-input').value.trim();
        let amount = parseFloat(document.getElementById('expense-amount-input-main').value);
        // custom category
        if (category === 'custom') {
            const newCat = document.getElementById('new-category-input').value.trim();
            if (!newCat) {
                alert(budgetData.currentLanguage === 'ko' ? '카테고리 이름을 입력하세요.' : 'Enter category name.');
                return;
            }
            const newId = generateUniqueId();
            budgetData.categories.push({ id: newId, name: newCat, nameEn: newCat });
            category = newId;
            populateCategorySelect();
        }
        if (!expenseName || isNaN(amount) || amount <= 0) {
            alert(budgetData.currentLanguage === 'ko' ? '지출 이름과 금액을 올바르게 입력하세요.' : 'Enter valid expense name and amount.');
            return;
        }
        if (editingExpense) {
            const idx = budgetData.expenses.findIndex(x => x.id === editingExpense.id);
            if (idx !== -1) {
                budgetData.expenses[idx].category = category;
                budgetData.expenses[idx].name = expenseName;
                budgetData.expenses[idx].amount = amount;
            }
            editingExpense = null;
        } else {
            budgetData.expenses.push({
                id: generateUniqueId(), category, name: expenseName, amount
            });
        }
        document.getElementById('expense-name-input').value = '';
        document.getElementById('expense-amount-input-main').value = '';
        document.getElementById('category-select').value = budgetData.categories[0].id || '';
        document.getElementById('new-category-input').value = '';
        document.getElementById('category-input-container').classList.add('hidden');
        updateUI();
    }
    function renderExpensesList() {
        const list = document.getElementById('expenses-list');
        list.innerHTML = '';
        budgetData.expenses.forEach(item => {
            const cat = budgetData.categories.find(cat => cat.id === item.category);
            const catName = cat ? (budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn) : item.category;
            const el = document.createElement('div');
            el.className = 'list-item';
            el.innerHTML = `
                <div class="list-item-content">
                    <span class="badge">${catName}</span>
                    <span>${item.name}</span>
                    <span class="list-item-amount">$${formatMoney(item.amount)}</span>
                </div>
                <div class="list-item-actions">
                    <button class="btn-warning btn-edit" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '수정' : 'Edit'}</button>
                    <button class="btn-danger btn-delete" data-id="${item.id}">${budgetData.currentLanguage === 'ko' ? '삭제' : 'Delete'}</button>
                </div>
            `;
            list.appendChild(el);
        });
        list.querySelectorAll('.btn-edit').forEach(btn => {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                const item = budgetData.expenses.find(x => x.id === id);
                if (!item) return;
                document.getElementById('category-select').value = item.category;
                document.getElementById('expense-name-input').value = item.name;
                document.getElementById('expense-amount-input-main').value = item.amount;
                editingExpense = { id: item.id };
            };
        });
        list.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                budgetData.expenses = budgetData.expenses.filter(x => x.id !== id);
                updateUI();
            };
        });
    }
    function addCategory() {
        const newCat = document.getElementById('new-category-input').value.trim();
        if (!newCat) {
            alert(budgetData.currentLanguage === 'ko' ? '카테고리 이름을 입력하세요.' : 'Enter category name.');
            return;
        }
        const newId = generateUniqueId();
        budgetData.categories.push({ id: newId, name: newCat, nameEn: newCat });
        populateCategorySelect();
        document.getElementById('category-select').value = newId;
        document.getElementById('category-input-container').classList.add('hidden');
        document.getElementById('new-category-input').value = '';
    }

    // --- 차트 ---
    function updateCharts(grossIncome, preTaxTotal, taxTotal, postTaxTotal, expensesTotal, remaining) {
        if (incomeFlowChartInstance) incomeFlowChartInstance.destroy();
        if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();
        const incomeLabels = [];
        const incomeData = [];
        const incomeColors = [];
        const totalPostDeductionsTaxes = taxTotal + postTaxTotal + preTaxTotal;
        const netIncome = grossIncome - totalPostDeductionsTaxes;
        incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 수입' : 'Gross Income');
        incomeData.push(grossIncome);
        incomeColors.push('#4361ee');
        if (preTaxTotal > 0) {
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? '세전 공제' : 'Pre-Tax Deductions');
            incomeData.push(preTaxTotal);
            incomeColors.push('#f8961e');
        }
        if (taxTotal > 0) {
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 세금' : 'Total Taxes');
            incomeData.push(taxTotal);
            incomeColors.push('#f72585');
        }
        if (postTaxTotal > 0) {
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? '세후 공제' : 'Post-Tax Deductions');
            incomeData.push(postTaxTotal);
            incomeColors.push('#7209b7');
        }
        if (remaining > 0) {
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? '저축/남은 잔액' : 'Savings/Remaining');
            incomeData.push(remaining);
            incomeColors.push('#4cc9f0');
        }
        if (expensesTotal > 0) {
            incomeLabels.push(budgetData.currentLanguage === 'ko' ? '총 지출' : 'Total Expenses');
            incomeData.push(expensesTotal);
            incomeColors.push('#2b2d42');
        }
        const ctx1 = document.getElementById('incomeFlowChart').getContext('2d');
        incomeFlowChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: incomeLabels,
                datasets: [{
                    data: incomeData,
                    backgroundColor: incomeColors,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 14 }, boxWidth: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const percentage = grossIncome ? ((value / grossIncome) * 100).toFixed(1) : '0.0';
                                return `${label}: $${formatMoney(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        // 지출 차트
        const expenseCategoryData = {};
        budgetData.expenses.forEach(exp => {
            const cat = budgetData.categories.find(cat => cat.id === exp.category);
            const displayCategory = cat ? (budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn) : exp.category;
            if (expenseCategoryData[displayCategory]) expenseCategoryData[displayCategory] += exp.amount;
            else expenseCategoryData[displayCategory] = exp.amount;
        });
        const expenseLabels = Object.keys(expenseCategoryData);
        const expenseAmounts = Object.values(expenseCategoryData);
        const defaultChartColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED'
        ];
        const dynamicColors = expenseLabels.map((_, i) => defaultChartColors[i % defaultChartColors.length]);
        const ctx2 = document.getElementById('expenseCategoryChart').getContext('2d');
        expenseCategoryChartInstance = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: expenseLabels,
                datasets: [{
                    data: expenseAmounts,
                    backgroundColor: dynamicColors,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 14 }, boxWidth: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: $${formatMoney(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- 데이터 계산 및 UI 업데이트 ---
    function updateUI() {
        const income = getMonthlyIncome();
        budgetData.income = income;
        const preTaxTotal = budgetData.preTax.reduce((sum, item) => sum + item.amount, 0);
        const taxableIncome = income - preTaxTotal;
        const taxTotal = budgetData.taxes.reduce((sum, item) => sum + item.amount, 0);
        const postTaxTotal = budgetData.postTax.reduce((sum, item) => sum + item.amount, 0);
        const totalDeductionsTaxes = preTaxTotal + taxTotal + postTaxTotal;
        const netIncome = income - totalDeductionsTaxes;
        const expensesTotal = budgetData.expenses.reduce((sum, item) => sum + item.amount, 0);
        const remainingBalance = netIncome - expensesTotal;
        // 월별 재무 현황 업데이트
        document.getElementById('gross-income').textContent = formatMoney(income);
        document.getElementById('pre-tax-deductions').textContent = formatMoney(preTaxTotal);
        document.getElementById('taxable-income').textContent = formatMoney(taxableIncome);
        document.getElementById('tax-total').textContent = formatMoney(taxTotal);
        document.getElementById('post-tax-deductions').textContent = formatMoney(postTaxTotal);
        document.getElementById('total-deductions-taxes').textContent = formatMoney(totalDeductionsTaxes);
        document.getElementById('net-income').textContent = formatMoney(netIncome);
        // 요약 카드
        document.getElementById('expenses-total-card').textContent = formatMoney(expensesTotal);
        document.getElementById('expenses-percentage-card').textContent = calculatePercentage(expensesTotal, income);
        document.getElementById('remaining-balance').textContent = formatMoney(remainingBalance);
        document.getElementById('remaining-balance').classList.toggle('positive', remainingBalance >= 0);
        document.getElementById('remaining-balance').classList.toggle('negative', remainingBalance < 0);
        document.getElementById('remaining-percentage-card').textContent = calculatePercentage(remainingBalance, income);
        renderCategorizedList('taxes', budgetData.taxes, 'tax-list');
        renderCategorizedList('preTax', budgetData.preTax, 'pre-tax-list');
        renderCategorizedList('postTax', budgetData.postTax, 'post-tax-list');
        renderExpensesList();
        updateCharts(income, preTaxTotal, taxTotal, postTaxTotal, expensesTotal, remainingBalance);
    }

    // --- 데이터 저장/불러오기/초기화 ---
    function saveData() {
        localStorage.setItem('budgetData', JSON.stringify(budgetData));
        alert(budgetData.currentLanguage === 'ko' ? '저장되었습니다.' : 'Saved!');
    }
    function loadData() {
        const data = localStorage.getItem('budgetData');
        if (data) {
            const parsed = JSON.parse(data);
            Object.assign(budgetData, parsed);
            populateCategorySelect();
            populateDeductionSelects();
            updateIncomePeriodDesc();
            updateUI();
            alert(budgetData.currentLanguage === 'ko' ? '불러오기 완료!' : 'Loaded!');
        }
    }
    function resetData() {
        if (!confirm(budgetData.currentLanguage === 'ko' ? '정말 초기화할까요?' : 'Reset all data?')) return;
        budgetData.income = 0;
        budgetData.taxes = [];
        budgetData.preTax = [];
        budgetData.postTax = [];
        budgetData.expenses = [];
        budgetData.categories = [
            { id: 'housing', name: '🏠 주거', nameEn: '🏠 Housing' },
            { id: 'food', name: '🍔 식비', nameEn: '🍔 Food' },
            { id: 'transportation', name: '🚗 교통', nameEn: '🚗 Transportation' },
            { id: 'health', name: '🏥 건강', nameEn: '🏥 Health' },
            { id: 'family', name: '👪 가족', nameEn: '👪 Family' },
            { id: 'shopping', name: '🛍️ 쇼핑', nameEn: '🛍️ Shopping' },
            { id: 'finance', name: '💳 금융', nameEn: '💳 Finance' },
            { id: 'travel', name: '✈️ 여행', nameEn: '✈️ Travel' },
            { id: 'saving', name: '💰 저축', nameEn: '💰 Saving' },
            { id: 'business', name: '💼 업무', nameEn: '💼 Business' }
        ];
        document.getElementById('income-input').value = '';
        document.getElementById('income-period').value = 'monthly';
        populateCategorySelect();
        populateDeductionSelects();
        updateIncomePeriodDesc();
        updateUI();
    }

    // --- 초기 셋업 ---
    window.onload = function() {
        populateCategorySelect();
        populateDeductionSelects();
        updateIncomePeriodDesc();
        updateUI();
    };
    </script>
</body>
</html>
