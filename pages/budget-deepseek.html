<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';">
    <title>ë‹¤êµ­ì–´ ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ê¸°ì¡´ CSSëŠ” ë§¤ìš° ì˜ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í° ìˆ˜ì • ì—†ì´ ìœ ì§€í•©ë‹ˆë‹¤. */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #7209b7;
            --text-color: #2b2d42;
            --light-gray: #f8f9fa;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --white: #ffffff;
            --shadow: 0 4px 16px rgba(67,97,238,0.08);
            --border-radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: var(--text-color);
            background: var(--light-gray);
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto 40px auto;
            padding: 24px 18px 36px 18px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }
        .language-switcher {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
        }
        .language-btn {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            border-radius: 18px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(67,97,238,0.06);
        }
        .language-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(67,97,238,0.14);
        }
        header {
            text-align: center;
            margin-bottom: 32px;
        }
        h1 { color: var(--primary); font-size: 2.2rem; margin-bottom: 12px; }
        h2 { color: var(--primary); font-size: 1.3rem; margin-bottom: 14px; }
        .card {
            background: var(--white);
            padding: 22px 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }
        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        input, select {
            width: 100%;
            padding: 11px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #f7faff;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.12);
        }
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.18s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(67,97,238,0.07);
        }
        button:hover { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #d6336c; }
        .btn-warning { background-color: var(--warning); }
        .btn-warning:hover { background-color: #e67700; }
        .btn-success { background-color: var(--success); color: var(--text-color);}
        .btn-success:hover { background-color: #339af0; color: #fff;}
        .btn-info { background-color: var(--info);}
        .btn-info:hover { background-color: #5f3dc4;}
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.92rem;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
            margin-right: 4px;
        }
        .item-list { margin-top: 12px; }
        .list-item {
            background: var(--white);
            padding: 13px 10px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.07);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .list-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .list-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .list-item-amount { font-weight: 600; min-width: 82px; text-align: right; }
        .list-item-actions { display: flex; gap: 5px; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 23px;
        }
        .summary-card {
            background: var(--white);
            padding: 18px 0 16px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        .card-label { font-size: 0.96rem; color: var(--medium-gray); margin-bottom: 2px; }
        .card-amount { font-size: 1.7rem; font-weight: 700; margin: 9px 0; }
        .positive { color: var(--success);}
        .negative { color: var(--danger);}
        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 13px 10px;
            margin: 7px 0;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px rgba(0,0,0,0.07);
            font-size: 1.05rem;
        }
        .flow-item.highlighted { border-left: 4px solid var(--danger);}
        .flow-item.result { border-left: 4px solid var(--success); font-weight: bold;}
        .flow-item.info { border-left: 4px solid var(--warning); font-weight: bold;}
        .flow-arrow {
            text-align: center;
            color: var(--medium-gray);
            margin: 5px 0;
            font-size: 1.18rem;
        }
        .chart-container {
            background: var(--white);
            padding: 18px 12px 24px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            margin-top: 5px;
            height: 420px;
            position: relative;
        }
        .chart-wrapper {
            width: 100%;
            height: 340px;
            position: relative;
        }
        .chart-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 700;
        }
        .utility-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 28px 0 8px 0;
            flex-wrap: wrap;
        }
        .hidden { display: none;}
        .flex { display: flex; gap: 12px; align-items: flex-end;}
        .flex > div { flex: 1;}
        @media (max-width: 900px) {
            .container { margin: 18px 3px;}
            .chart-container { height: 320px;}
            .chart-wrapper { height: 220px;}
        }
        @media (max-width: 600px) {
            .container { padding: 8px 2px;}
            .summary-cards { grid-template-columns: 1fr;}
            .chart-container { height: 260px;}
            .chart-wrapper { height: 140px;}
            .language-switcher { justify-content: center;}
        }
        @media print {
            body { padding: 0; background: white;}
            button, .utility-buttons, .language-switcher { display: none;}
            .card, .chart-container { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid;}
            .chart-container { height: auto;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button id="lang-ko" class="language-btn active">í•œêµ­ì–´</button>
            <button id="lang-en" class="language-btn">English</button>
        </div>
        <header>
            <h1 data-lang="ko">ğŸ’° ê³ ê¸‰ ì˜ˆì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <h1 data-lang="en" class="hidden">ğŸ’° Advanced Budget Management System</h1>
            <p data-lang="ko">í•œ ê³³ì—ì„œ ìˆ˜ì…, ì„¸ê¸ˆ, ê³µì œ ë° ì§€ì¶œì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            <p data-lang="en" class="hidden">Manage your income, taxes, deductions, and expenses in one place</p>
        </header>

        <div class="card">
            <h2 data-lang="ko">1. ìˆ˜ì…</h2>
            <h2 data-lang="en" class="hidden">1. Earnings</h2>
            <div class="form-group">
                <label for="income-input" data-lang="ko">ì›” ì´ ìˆ˜ì… ($)</label>
                <label for="income-input" data-lang="en" class="hidden">Gross Monthly Income ($)</label>
                <input type="number" id="income-input" data-lang-ko-placeholder="ì›” ì´ ìˆ˜ì…ì„ ì…ë ¥í•˜ì„¸ìš”" data-lang-en-placeholder="Enter your gross income" placeholder="0">
            </div>
        </div>

        <div class="card">
            <h2 data-lang="ko">2. ì§ì› ì„¸ê¸ˆ</h2>
            <h2 data-lang="en" class="hidden">2. Employee Taxes</h2>
            <div class="form-group">
                <label for="tax-type-select" data-lang="ko">ì„¸ê¸ˆ ìœ í˜•</label>
                <label for="tax-type-select" data-lang="en" class="hidden">Tax Type</label>
                <select id="tax-type-select">
                    <option value="" disabled selected data-lang="ko">ì„¸ê¸ˆ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select tax type</option>
                    <option value="Federal Withholding">Federal Withholding</option>
                    <option value="State Tax (CA)">State Tax (CA)</option>
                    <option value="OASDI (Social Security)">OASDI (Social Security)</option>
                    <option value="Medicare">Medicare</option>
                    <option value="CA SDI">CA SDI</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ì„¸ê¸ˆ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Tax</option>
                </select>
            </div>
            <div id="tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="tax-custom-name-input" data-lang="ko">ì„¸ê¸ˆ ì´ë¦„</label>
                        <label for="tax-custom-name-input" data-lang="en" class="hidden">Tax Name</label>
                        <input type="text" id="tax-custom-name-input" data-lang-ko-placeholder="ì„¸ê¸ˆ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter tax name">
                    </div>
                    <div>
                        <label for="tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success" data-lang="ko">ì„¸ê¸ˆ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('taxes')" class="btn-success hidden" data-lang="en">Add Tax</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">3. ì„¸ì „ ê³µì œ</h2>
            <h2 data-lang="en" class="hidden">3. Pre-Tax Deductions</h2>
            <div class="form-group">
                <label for="pre-tax-type-select" data-lang="ko">ê³µì œ ìœ í˜•</label>
                <label for="pre-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="pre-tax-type-select">
                    <option value="" disabled selected data-lang="ko">ê³µì œ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select deduction type</option>
                    <option value="401k Traditional">401k Traditional</option>
                    <option value="Medical Premium">Medical Premium</option>
                    <option value="Dental Premium">Dental Premium</option>
                    <option value="Vision Premium">Vision Premium</option>
                    <option value="MSEAP">MSEAP</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ê³µì œ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Deduction</option>
                </select>
            </div>
            <div id="pre-tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="pre-tax-custom-name-input" data-lang="ko">ê³µì œ ì´ë¦„</label>
                        <label for="pre-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="pre-tax-custom-name-input" data-lang-ko-placeholder="ê³µì œ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div>
                        <label for="pre-tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="pre-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="pre-tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success" data-lang="ko">ê³µì œ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('preTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="pre-tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">4. ì„¸í›„ ê³µì œ</h2>
            <h2 data-lang="en" class="hidden">4. Post-Tax Deductions</h2>
            <div class="form-group">
                <label for="post-tax-type-select" data-lang="ko">ê³µì œ ìœ í˜•</label>
                <label for="post-tax-type-select" data-lang="en" class="hidden">Deduction Type</label>
                <select id="post-tax-type-select">
                    <option value="" disabled selected data-lang="ko">ê³µì œ ìœ í˜• ì„ íƒ</option>
                    <option value="" disabled selected data-lang="en" class="hidden">Select deduction type</option>
                    <option value="401k Roth">401k Roth</option>
                    <option value="Stock Purchase Plan">Stock Purchase Plan</option>
                    <option value="Legal Services">Legal Services</option>
                    <option value="LTD">LTD</option>
                    <option value="AD&D">AD&D</option>
                    <option value="Accident Insurance">Accident Insurance</option>
                    <option value="Critical Illness">Critical Illness</option>
                    <option value="custom" data-lang="ko">ì‚¬ìš©ì ì •ì˜ ê³µì œ</option>
                    <option value="custom" data-lang="en" class="hidden">Custom Deduction</option>
                </select>
            </div>
            <div id="post-tax-custom-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="post-tax-custom-name-input" data-lang="ko">ê³µì œ ì´ë¦„</label>
                        <label for="post-tax-custom-name-input" data-lang="en" class="hidden">Deduction Name</label>
                        <input type="text" id="post-tax-custom-name-input" data-lang-ko-placeholder="ê³µì œ ì´ë¦„ ì…ë ¥" data-lang-en-placeholder="Enter deduction name">
                    </div>
                    <div>
                        <label for="post-tax-amount-input" data-lang="ko">ê¸ˆì•¡ ($)</label>
                        <label for="post-tax-amount-input" data-lang="en" class="hidden">Amount ($)</label>
                        <input type="number" id="post-tax-amount-input" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success" data-lang="ko">ê³µì œ ì¶”ê°€</button>
                        <button onclick="addCategorizedItem('postTax')" class="btn-success hidden" data-lang="en">Add Deduction</button>
                    </div>
                </div>
            </div>
            <div class="item-list" id="post-tax-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">5. ì§€ì¶œ ê´€ë¦¬</h2>
            <h2 data-lang="en" class="hidden">5. Expense Management</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="category-select" data-lang="ko">ì¹´í…Œê³ ë¦¬</label>
                    <label for="category-select" data-lang="en" class="hidden">Category</label>
                    <select id="category-select"></select>
                </div>
                <div class="form-group">
                    <label for="expense-name-input" data-lang="ko">ì§€ì¶œ í•­ëª©</label>
                    <label for="expense-name-input" data-lang="en" class="hidden">Expense Name</label>
                    <input type="text" id="expense-name-input" data-lang-ko-placeholder="ì˜ˆ: ì›”ì„¸" data-lang-en-placeholder="e.g. Rent">
                </div>
                <div class="form-group">
                    <label for="expense-amount-input-main" data-lang="ko">ê¸ˆì•¡ ($)</label>
                    <label for="expense-amount-input-main" data-lang="en" class="hidden">Amount ($)</label>
                    <input type="number" id="expense-amount-input-main" placeholder="ê¸ˆì•¡ ì…ë ¥">
                </div>
            </div>
            <div id="category-input-container" class="form-group hidden">
                <div class="flex">
                    <div>
                        <label for="new-category-input" data-lang="ko">ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„</label>
                        <label for="new-category-input" data-lang="en" class="hidden">New Category Name</label>
                        <input type="text" id="new-category-input" data-lang-ko-placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì…ë ¥" data-lang-en-placeholder="Enter new category">
                    </div>
                    <div>
                        <button onclick="addCategory()" class="btn-info" data-lang="ko">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
                        <button onclick="addCategory()" class="btn-info hidden" data-lang="en">Add Category</button>
                    </div>
                </div>
            </div>
            <button onclick="addExpense()" class="btn-success" style="width: 100%; margin-top: 10px;" data-lang="ko">ì§€ì¶œ ì¶”ê°€</button>
            <button onclick="addExpense()" class="btn-success hidden" style="width: 100%; margin-top: 10px;" data-lang="en">Add Expense</button>
            <div class="item-list" id="expenses-list"></div>
        </div>

        <div class="card">
            <h2 data-lang="ko">6. ì›”ë³„ ì¬ë¬´ í˜„í™©</h2>
            <h2 data-lang="en" class="hidden">6. Monthly Financial Status</h2>
            <div class="income-flow">
                <div class="flow-item">
                    <span data-lang="ko">ì›” ì´ ìˆ˜ì… (ì´ ìˆ˜ìµ)</span>
                    <span data-lang="en" class="hidden">Gross Monthly Income (Total Earnings)</span>
                    <span>$<span id="gross-income">0.00</span> <em data-lang="ko">(100.0%)</em><em data-lang="en" class="hidden">(100.0%)</em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸ì „ ê³µì œ</span>
                    <span data-lang="en" class="hidden">Pre-Tax Deductions</span>
                    <span>-$<span id="pre-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item">
                    <span data-lang="ko"><strong>ê³¼ì„¸ ì†Œë“</strong></span>
                    <span data-lang="en" class="hidden"><strong>Taxable Income</strong></span>
                    <span>$<span id="taxable-income">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸ê¸ˆ</span>
                    <span data-lang="en" class="hidden">Taxes</span>
                    <span>-$<span id="tax-total">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item highlighted">
                    <span data-lang="ko">ì„¸í›„ ê³µì œ</span>
                    <span data-lang="en" class="hidden">Post-Tax Deductions</span>
                    <span>-$<span id="post-tax-deductions">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item info">
                    <span data-lang="ko"><strong>ì´ ê³µì œ ë° ì„¸ê¸ˆ í•©ê³„</strong></span>
                    <span data-lang="en" class="hidden"><strong>Total Deductions & Taxes</strong></span>
                    <span>-$<span id="total-deductions-taxes">0.00</span> <em></em></span>
                </div>
                <div class="flow-arrow">â†“</div>
                <div class="flow-item result">
                    <span data-lang="ko"><strong>ìˆœìˆ˜ì… (ì‹¤ìˆ˜ë ¹ì•¡)</strong></span>
                    <span data-lang="en" class="hidden"><strong>Net Income (Take-Home Pay)</strong></span>
                    <span>$<span id="net-income">0.00</span> <em></em></span>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">ì´ ì§€ì¶œ</div>
                    <div class="card-label hidden" data-lang="en">Total Expenses</div>
                    <div class="card-amount negative">$<span id="expenses-total-card">0.00</span></div>
                    <div class="card-label" data-lang="ko">(ìˆœìˆ˜ì…ì—ì„œ ì‚¬ìš©ëœ ê¸ˆì•¡)</div>
                    <div class="card-label hidden" data-lang="en">(Amount used from net income)</div>
                    <div class="card-label"><span id="expenses-percentage-card">0.0%</span> <span data-lang="ko">of ì´ ìˆ˜ì…</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
                <div class="summary-card">
                    <div class="card-label" data-lang="ko">ë‚¨ì€ ì”ì•¡</div>
                    <div class="card-label hidden" data-lang="en">Remaining Balance</div>
                    <div class="card-amount positive">$<span id="remaining-balance">0.00</span></div>
                    <div class="card-label" data-lang="ko">(ìˆœìˆ˜ì… - ì´ ì§€ì¶œ = ì €ì¶•)</div>
                    <div class="card-label hidden" data-lang="en">(Net Income - Expenses = Savings)</div>
                    <div class="card-label"><span id="remaining-percentage-card">0.0%</span> <span data-lang="ko">of ì´ ìˆ˜ì…</span><span data-lang="en" class="hidden">of gross income</span></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 data-lang="ko">7. ì¬ë¬´ ë¶„ì„ ì°¨íŠ¸</h2>
            <h2 data-lang="en" class="hidden">7. Financial Analysis Charts</h2>
            <div class="grid">
                <div>
                    <div class="chart-title" data-lang="ko">ìˆ˜ì… ë¶„ë°° (ì´ ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨)</div>
                    <div class="chart-title hidden" data-lang="en">Income Distribution (Percentage of Gross Income)</div>
                    <div class="chart-wrapper">
                        <canvas id="incomeFlowChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="chart-title" data-lang="ko">ì§€ì¶œ ì¹´í…Œê³ ë¦¬ (ì´ ì§€ì¶œ ëŒ€ë¹„ ë¹„ìœ¨)</div>
                    <div class="chart-title hidden" data-lang="en">Expense Categories (Percentage of Total Expenses)</div>
                    <div class="chart-wrapper">
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="utility-buttons">
            <button onclick="saveData()" class="btn-info" data-lang="ko">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
            <button onclick="saveData()" class="btn-info hidden" data-lang="en">ğŸ’¾ Save Data</button>
            <button onclick="loadData()" class="btn-info" data-lang="ko">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="loadData()" class="btn-info hidden" data-lang="en">ğŸ“‚ Load Data</button>
            <button onclick="window.print()" class="btn-warning" data-lang="ko">ğŸ–¨ï¸ ë¦¬í¬íŠ¸ ì¸ì‡„</button>
            <button onclick="window.print()" class="btn-warning hidden" data-lang="en">ğŸ–¨ï¸ Print Report</button>
            <button onclick="resetData()" class="btn-danger" data-lang="ko">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
            <button onclick="resetData()" class="btn-danger hidden" data-lang="en">ğŸ”„ Reset Data</button>
        </div>
    </div>

    <script>
        // ì„¤ì •ê°’
        const DEFAULT_DEDUCTIONS = {
            taxes: [
                { name: "Federal Withholding", amount: 0 },
                { name: "State Tax (CA)", amount: 0 },
                { name: "OASDI (Social Security)", amount: 0 },
                { name: "Medicare", amount: 0 },
                { name: "CA SDI", amount: 0 }
            ],
            preTax: [
                { name: "401k Traditional", amount: 0 },
                { name: "Medical Premium", amount: 0 },
                { name: "Dental Premium", amount: 0 },
                { name: "Vision Premium", amount: 0 },
                { name: "MSEAP", amount: 0 }
            ],
            postTax: [
                { name: "401k Roth", amount: 0 },
                { name: "Stock Purchase Plan", amount: 0 },
                { name: "Legal Services", amount: 0 },
                { name: "LTD", amount: 0 },
                { name: "AD&D", amount: 0 },
                { name: "Accident Insurance", amount: 0 },
                { name: "Critical Illness", amount: 0 }
            ]
        };

        const budgetData = {
            income: 0,
            taxes: [],
            preTax: [],
            postTax: [],
            expenses: [],
            categories: [
                { id: 'housing', name: 'ğŸ  ì£¼ê±°', nameEn: 'ğŸ  Housing' },
                { id: 'food', name: 'ğŸ” ì‹ë¹„', nameEn: 'ğŸ” Food' },
                { id: 'transportation', name: 'ğŸš— êµí†µ', nameEn: 'ğŸš— Transportation' },
                { id: 'health', name: 'ğŸ¥ ê±´ê°•', nameEn: 'ğŸ¥ Health' },
                { id: 'family', name: 'ğŸ‘ª ê°€ì¡±', nameEn: 'ğŸ‘ª Family' },
                { id: 'shopping', name: 'ğŸ›ï¸ ì‡¼í•‘', nameEn: 'ğŸ›ï¸ Shopping' },
                { id: 'finance', name: 'ğŸ’³ ê¸ˆìœµ', nameEn: 'ğŸ’³ Finance' },
                { id: 'travel', name: 'âœˆï¸ ì—¬í–‰', nameEn: 'âœˆï¸ Travel' },
                { id: 'saving', name: 'ğŸ’° ì €ì¶•', nameEn: 'ğŸ’° Saving' },
                { id: 'business', name: 'ğŸ’¼ ì—…ë¬´', nameEn: 'ğŸ’¼ Business' }
            ],
            currentLanguage: 'ko'
        };

        let incomeFlowChartInstance = null;
        let expenseCategoryChartInstance = null;
        let editingItem = null;

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatMoney(amount) {
            if (Number.isNaN(amount) || amount === null) {
                return "0.00";
            }
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function calculatePercentage(value, total) {
            if (total === 0) {
                return "0.0%";
            }
            return ((value / total) * 100).toFixed(1) + '%';
        }

        // --- ì–¸ì–´ ì „í™˜ ---
        function switchLanguage(lang) {
            budgetData.currentLanguage = lang;
            document.querySelectorAll('[data-lang]').forEach(e => {
                if (e.getAttribute('data-lang') === lang) {
                    e.classList.remove('hidden');
                } else {
                    e.classList.add('hidden');
                }
            });

            // í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[data-lang-ko-placeholder]').forEach(el => {
                const koPlaceholder = el.getAttribute('data-lang-ko-placeholder');
                const enPlaceholder = el.getAttribute('data-lang-en-placeholder');
                el.placeholder = (lang === 'ko') ? koPlaceholder : enPlaceholder;
            });

            document.getElementById('lang-ko').classList.toggle('active', lang === 'ko');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');

            populateCategorySelect(); // ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì–¸ì–´ì— ë§ê²Œ ì—…ë°ì´íŠ¸
            updateUI(); // UI ì „ì²´ ì—…ë°ì´íŠ¸
        }

        // --- ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì±„ìš°ê¸° ---
        function populateCategorySelect() {
            const select = document.getElementById('category-select');
            const prev = select.value;
            select.innerHTML = '';

            budgetData.categories.forEach(cat => {
                const o = document.createElement('option');
                o.value = cat.id;
                o.textContent = budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn || cat.name;
                select.appendChild(o);
            });

            const c = document.createElement('option');
            c.value = 'custom';
            c.textContent = budgetData.currentLanguage === 'ko' ? 'âœï¸ ì§ì ‘ ì…ë ¥' : 'âœï¸ Custom Category';
            select.appendChild(c);

            if (budgetData.categories.some(cat => cat.id === prev) || prev === 'custom') {
                select.value = prev;
            } else {
                select.value = budgetData.categories[0] ? budgetData.categories[0].id : '';
            }
        }

        // --- ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ---
        function updateCharts(grossIncome, preTaxTotal, taxTotal, postTaxTotal, expensesTotal, remaining) {
            // Chart is not defined ì˜¤ë¥˜ë¥¼ í”¼í•˜ê¸° ìœ„í•´ Chart ê°ì²´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js library not loaded. Skipping chart updates.");
                return;
            }

            if (incomeFlowChartInstance) incomeFlowChartInstance.destroy();
            if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();

            // ìˆ˜ì… ë¶„ë°° ì°¨íŠ¸
            const ctx1 = document.getElementById('incomeFlowChart').getContext('2d');
            incomeFlowChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: [
                        budgetData.currentLanguage === 'ko' ? 'ì„¸ì „ ê³µì œ' : 'Pre-Tax Deductions',
                        budgetData.currentLanguage === 'ko' ? 'ì„¸ê¸ˆ' : 'Taxes',
                        budgetData.currentLanguage === 'ko' ? 'ì„¸í›„ ê³µì œ' : 'Post-Tax Deductions',
                        budgetData.currentLanguage === 'ko' ? 'ì´ ì§€ì¶œ' : 'Total Expenses',
                        budgetData.currentLanguage === 'ko' ? 'ë‚¨ì€ ì”ì•¡' : 'Remaining Balance'
                    ],
                    datasets: [{
                        data: [preTaxTotal, taxTotal, postTaxTotal, expensesTotal, Math.max(0, remaining)],
                        backgroundColor: ['#4895ef', '#f72585', '#4cc9f0', '#f8961e', '#43aa8b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 13 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = total === 0 ? '0.0%' : ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: $${formatMoney(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            // ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸
            const ctx2 = document.getElementById('expenseCategoryChart').getContext('2d');
            const categoryTotals = {};
            budgetData.expenses.forEach(item => {
                const cat = budgetData.categories.find(c => c.id === item.category);
                const label = budgetData.currentLanguage === 'ko' ? (cat?.name || 'ê¸°íƒ€') : (cat?.nameEn || cat?.name || 'Other');
                if (!categoryTotals[label]) {
                    categoryTotals[label] = 0;
                }
                categoryTotals[label] += item.amount;
            });

            expenseCategoryChartInstance = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: ['#4895ef', '#f72585', '#4cc9f0', '#f8961e', '#7209b7', '#b5179e', '#43aa8b', '#ffd60a', '#b5ead7', '#ffdac1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 13 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = total === 0 ? '0.0%' : ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: $${formatMoney(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- UI ì „ì²´ ì—…ë°ì´íŠ¸ ---
        function updateUI() {
            localStorage.setItem('budgetData', JSON.stringify(budgetData));

            const gross = budgetData.income;
            const pretax = budgetData.preTax.reduce((s, i) => s + i.amount, 0);
            const tax = budgetData.taxes.reduce((s, i) => s + i.amount, 0);
            const posttax = budgetData.postTax.reduce((s, i) => s + i.amount, 0);

            const totalDeduct = pretax + tax + posttax;
            const taxable = gross - pretax;
            const net = taxable - tax - posttax;
            const expenses = budgetData.expenses.reduce((s, i) => s + i.amount, 0);
            const remain = net - expenses;

            document.getElementById('income-input').value = gross;

            document.getElementById('gross-income').textContent = formatMoney(gross);
            document.getElementById('pre-tax-deductions').textContent = formatMoney(pretax);
            document.getElementById('taxable-income').textContent = formatMoney(taxable);
            document.getElementById('tax-total').textContent = formatMoney(tax);
            document.getElementById('post-tax-deductions').textContent = formatMoney(posttax);
            document.getElementById('total-deductions-taxes').textContent = formatMoney(totalDeduct);
            document.getElementById('net-income').textContent = formatMoney(net);

            document.getElementById('expenses-total-card').textContent = formatMoney(expenses);
            document.getElementById('remaining-balance').textContent = formatMoney(remain);

            const remainingBalanceElement = document.getElementById('remaining-balance');
            remainingBalanceElement.className = `card-amount ${remain >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('expenses-percentage-card').textContent = calculatePercentage(expenses, gross);
            document.getElementById('remaining-percentage-card').textContent = calculatePercentage(remain, gross);

            renderList('tax-list', budgetData.taxes);
            renderList('pre-tax-list', budgetData.preTax);
            renderList('post-tax-list', budgetData.postTax);
            renderExpenses();

            populateCategorySelect();
            updateCharts(gross, pretax, tax, posttax, expenses, remain);
        }

        // --- ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ì„¸ê¸ˆ, ì„¸ì „/ì„¸í›„ ê³µì œ) ---
        function renderList(elementId, items) {
            const container = document.getElementById(elementId);
            const type = elementId.replace('-list', ''); // 'tax-list' -> 'tax', 'pre-tax-list' -> 'pre-tax'

            container.innerHTML = items.map(item => `
                <div class="list-item" data-id="${item.id}" data-type="${type}">
                    ${editingItem && editingItem.id === item.id ?
                        `<div class="list-item-content">
                            <input type="text" value="${item.name}" id="edit-name-${item.id}" placeholder="${budgetData.currentLanguage === 'ko' ? 'í•­ëª©ëª…' : 'Item name'}">
                            <input type="number" value="${item.amount}" id="edit-amount-${item.id}" placeholder="${budgetData.currentLanguage === 'ko' ? 'ê¸ˆì•¡' : 'Amount'}">
                        </div>
                        <div class="list-item-actions">
                            <button onclick="saveEdit('${type}','${item.id}')" class="btn-success">${budgetData.currentLanguage === 'ko' ? 'ì €ì¥' : 'Save'}</button>
                            <button onclick="cancelEdit()" class="btn-warning">${budgetData.currentLanguage === 'ko' ? 'ì·¨ì†Œ' : 'Cancel'}</button>
                        </div>`
                        :
                        `<div class="list-item-content">
                            <span>${item.name}: $${formatMoney(item.amount)}</span>
                        </div>
                        <div class="list-item-actions">
                            <button onclick="editItem('${type}','${item.id}')" class="btn-info">${budgetData.currentLanguage === 'ko' ? 'ìˆ˜ì •' : 'Edit'}</button>
                            <button onclick="deleteItem('${type}','${item.id}')" class="btn-danger">${budgetData.currentLanguage === 'ko' ? 'ì‚­ì œ' : 'Delete'}</button>
                        </div>`
                    }
                </div>
            `).join('');
        }

        // --- ì§€ì¶œ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderExpenses() {
            const container = document.getElementById('expenses-list');
            container.innerHTML = budgetData.expenses.map(item => {
                const category = budgetData.categories.find(cat => cat.id === item.category);
                const categoryName = budgetData.currentLanguage === 'ko' ? category?.name : category?.nameEn || category?.name || 'Other';
                return `
                    <div class="list-item" data-id="${item.id}" data-type="expenses">
                        ${editingItem && editingItem.id === item.id ?
                            `<div class="list-item-content">
                                <select id="edit-category-${item.id}" style="margin-right:7px;">
                                    ${budgetData.categories.map(cat => `
                                        <option value="${cat.id}" ${cat.id === item.category ? 'selected' : ''}>
                                            ${budgetData.currentLanguage === 'ko' ? cat.name : cat.nameEn || cat.name}
                                        </option>
                                    `).join('')}
                                </select>
                                <input type="text" value="${item.name}" id="edit-name-${item.id}" placeholder="${budgetData.currentLanguage === 'ko' ? 'í•­ëª©ëª…' : 'Item name'}">
                                <input type="number" value="${item.amount}" id="edit-amount-${item.id}" placeholder="${budgetData.currentLanguage === 'ko' ? 'ê¸ˆì•¡' : 'Amount'}">
                            </div>
                            <div class="list-item-actions">
                                <button onclick="saveEdit('expenses','${item.id}')" class="btn-success">${budgetData.currentLanguage === 'ko' ? 'ì €ì¥' : 'Save'}</button>
                                <button onclick="cancelEdit()" class="btn-warning">${budgetData.currentLanguage === 'ko' ? 'ì·¨ì†Œ' : 'Cancel'}</button>
                            </div>`
                            :
                            `<div class="list-item-content">
                                <span class="badge">${categoryName || 'ğŸ“Œ ' + (budgetData.currentLanguage === 'ko' ? 'ê¸°íƒ€' : 'Other')}</span>
                                <span>${item.name}</span>
                            </div>
                            <span class="list-item-amount">$${formatMoney(item.amount)}</span>
                            <div class="list-item-actions">
                                <button onclick="editItem('expenses','${item.id}')" class="btn-info">${budgetData.currentLanguage === 'ko' ? 'ìˆ˜ì •' : 'Edit'}</button>
                                <button onclick="deleteItem('expenses','${item.id}')" class="btn-danger">${budgetData.currentLanguage === 'ko' ? 'ì‚­ì œ' : 'Delete'}</button>
                            </div>`
                        }
                    </div>
                `;
            }).join('');
        }

        // --- CRUD í•¨ìˆ˜ ---
        function deleteItem(type, id) {
            if (confirm(budgetData.currentLanguage === 'ko' ? 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'Are you sure you want to delete this item?')) {
                // budgetData[type]ì´ ìœ íš¨í•œ ë°°ì—´ì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
                if (Array.isArray(budgetData[type])) {
                    budgetData[type] = budgetData[type].filter(item => item.id !== id);
                    updateUI();
                } else {
                    // ì´ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚œë‹¤ë©´, 'type' ì¸ìê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ budgetData[type]ì´ ì†ìƒëœ ê²ƒ
                    console.error(`Error: budgetData.${type} is not an array. Cannot delete item.`);
                    alert(`Error: Cannot delete item. Data for '${type}' is corrupted.`);
                }
            }
        }

        function editItem(type, id) {
            cancelEdit();
            // budgetData[type]ì´ ìœ íš¨í•œ ë°°ì—´ì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
            if (Array.isArray(budgetData[type])) {
                const item = budgetData[type].find(item => item.id === id);
                if (item) {
                    editingItem = { ...item, type: type };
                    updateUI();
                }
            } else {
                console.error(`Error: budgetData.${type} is not an array. Cannot edit item.`);
                alert(`Error: Cannot edit item. Data for '${type}' is corrupted.`);
            }
        }

        function saveEdit(type, id) {
            // budgetData[type]ì´ ìœ íš¨í•œ ë°°ì—´ì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
            if (!Array.isArray(budgetData[type])) {
                console.error(`Error: budgetData.${type} is not an array. Cannot save item.`);
                alert(`Error: Cannot save item. Data for '${type}' is corrupted.`);
                return;
            }

            const idx = budgetData[type].findIndex(item => item.id === id);
            if (idx === -1) return;

            const newNameInput = document.getElementById(`edit-name-${id}`);
            const newAmountInput = document.getElementById(`edit-amount-${id}`);

            const newName = newNameInput ? newNameInput.value.trim() : '';
            const newAmount = parseFloat(newAmountInput ? newAmountInput.value : '');

            if (!newName) {
                alert(budgetData.currentLanguage === 'ko' ? 'í•­ëª©ëª…ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'Item name cannot be empty.');
                return;
            }
            if (isNaN(newAmount)) {
                alert(budgetData.currentLanguage === 'ko' ? 'ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a valid amount.');
                return;
            }

            budgetData[type][idx].name = newName;
            budgetData[type][idx].amount = newAmount;

            if (type === 'expenses') {
                const newCategorySelect = document.getElementById(`edit-category-${id}`);
                const newCategory = newCategorySelect ? newCategorySelect.value : '';
                budgetData[type][idx].category = newCategory;
            }
            editingItem = null;
            updateUI();
        }

        function cancelEdit() {
            editingItem = null;
            updateUI();
        }

        // --- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì´ˆê¸°í™” ---
        function saveData() {
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            alert(budgetData.currentLanguage === 'ko' ? 'ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'Data saved!');
        }

        function loadData() {
            const d = localStorage.getItem('budgetData');
            if (d) {
                const parsed = JSON.parse(d);

                budgetData.income = parsed.income || 0;
                // ê° ë°°ì—´ ì†ì„±ì´ ìœ íš¨í•œ ë°°ì—´ì¸ì§€ í™•ì¸í•˜ê³ , ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                budgetData.taxes = Array.isArray(parsed.taxes) ? parsed.taxes : [];
                budgetData.preTax = Array.isArray(parsed.preTax) ? parsed.preTax : [];
                budgetData.postTax = Array.isArray(parsed.postTax) ? parsed.postTax : [];
                budgetData.expenses = Array.isArray(parsed.expenses) ? parsed.expenses : [];

                if (Array.isArray(parsed.categories) && parsed.categories.length > 0) {
                    budgetData.categories = parsed.categories;
                } else {
                    // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ë¡œë“œ
                    budgetData.categories = [
                        { id: 'housing', name: 'ğŸ  ì£¼ê±°', nameEn: 'ğŸ  Housing' },
                        { id: 'food', name: 'ğŸ” ì‹ë¹„', nameEn: 'ğŸ” Food' },
                        { id: 'transportation', name: 'ğŸš— êµí†µ', nameEn: 'ğŸš— Transportation' },
                        { id: 'health', name: 'ğŸ¥ ê±´ê°•', nameEn: 'ğŸ¥ Health' },
                        { id: 'family', name: 'ğŸ‘ª ê°€ì¡±', nameEn: 'ğŸ‘ª Family' },
                        { id: 'shopping', name: 'ğŸ›ï¸ ì‡¼í•‘', nameEn: 'ğŸ›ï¸ Shopping' },
                        { id: 'finance', name: 'ğŸ’³ ê¸ˆìœµ', nameEn: 'ğŸ’³ Finance' },
                        { id: 'travel', name: 'âœˆï¸ ì—¬í–‰', nameEn: 'âœˆï¸ Travel' },
                        { id: 'saving', name: 'ğŸ’° ì €ì¶•', nameEn: 'ğŸ’° Saving' },
                        { id: 'business', name: 'ğŸ’¼ ì—…ë¬´', nameEn: 'ğŸ’¼ Business' }
                    ];
                }

                budgetData.currentLanguage = parsed.currentLanguage || 'ko';

                // localStorageì— ë°ì´í„°ê°€ ìˆì§€ë§Œ, ê¸°ë³¸ ì„¸ê¸ˆ/ê³µì œ í•­ëª©ì´ ì—†ëŠ” ê²½ìš° DEFAULT_DEDUCTIONSë¡œ ì´ˆê¸°í™”
                // (ì´ê²ƒì€ ì‚¬ìš©ìê°€ ì¼ë¶€ ë°ì´í„°ë¥¼ ì§€ì› ì„ ë•Œë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ ì¥ì¹˜)
                // ê¸°ì¡´ì— ì¶”ê°€ëœ í•­ëª©ê³¼ì˜ ì¤‘ë³µ ë°©ì§€
                DEFAULT_DEDUCTIONS.taxes.forEach(defaultItem => {
                    if (!budgetData.taxes.some(item => item.name === defaultItem.name)) {
                        budgetData.taxes.push({ ...defaultItem, id: generateUniqueId(), type: 'taxes' });
                    }
                });
                DEFAULT_DEDUCTIONS.preTax.forEach(defaultItem => {
                    if (!budgetData.preTax.some(item => item.name === defaultItem.name)) {
                        budgetData.preTax.push({ ...defaultItem, id: generateUniqueId(), type: 'preTax' });
                    }
                });
                DEFAULT_DEDUCTIONS.postTax.forEach(defaultItem => {
                    if (!budgetData.postTax.some(item => item.name === defaultItem.name)) {
                        budgetData.postTax.push({ ...defaultItem, id: generateUniqueId(), type: 'postTax' });
                    }
                });


            } else {
                console.log("No budgetData found in localStorage, initializing default data.");
                initDefaultData();
            }
            updateUI(); // loadData í›„ ë°˜ë“œì‹œ UI ì—…ë°ì´íŠ¸
            switchLanguage(budgetData.currentLanguage); // ì–¸ì–´ ì„¤ì •ë„ ë¡œë“œ í›„ ì ìš©
        }

        function resetData() {
            if (confirm(budgetData.currentLanguage === 'ko' ? 'ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'Reset all data? This action cannot be undone.')) {
                localStorage.removeItem('budgetData');
                initDefaultData(); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ í›„ ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                updateUI();
            }
        }

        function initDefaultData() {
            budgetData.income = 0;
            // ê¸°ë³¸ ê³µì œ/ì„¸ê¸ˆ í•­ëª©ì— ê³ ìœ  IDë¥¼ ë¶€ì—¬í•˜ì—¬ ì´ˆê¸°í™”
            budgetData.taxes = DEFAULT_DEDUCTIONS.taxes.map(item => ({ ...item, id: generateUniqueId(), type: 'taxes' }));
            budgetData.preTax = DEFAULT_DEDUCTIONS.preTax.map(item => ({ ...item, id: generateUniqueId(), type: 'preTax' }));
            budgetData.postTax = DEFAULT_DEDUCTIONS.postTax.map(item => ({ ...item, id: generateUniqueId(), type: 'postTax' }));
            budgetData.expenses = [];
            budgetData.categories = [
                { id: 'housing', name: 'ğŸ  ì£¼ê±°', nameEn: 'ğŸ  Housing' },
                { id: 'food', name: 'ğŸ” ì‹ë¹„', nameEn: 'ğŸ” Food' },
                { id: 'transportation', name: 'ğŸš— êµí†µ', nameEn: 'ğŸš— Transportation' },
                { id: 'health', name: 'ğŸ¥ ê±´ê°•', nameEn: 'ğŸ¥ Health' },
                { id: 'family', name: 'ğŸ‘ª ê°€ì¡±', nameEn: 'ğŸ‘ª Family' },
                { id: 'shopping', name: 'ğŸ›ï¸ ì‡¼í•‘', nameEn: 'ğŸ›ï¸ Shopping' },
                { id: 'finance', name: 'ğŸ’³ ê¸ˆìœµ', nameEn: 'ğŸ’³ Finance' },
                { id: 'travel', name: 'âœˆï¸ ì—¬í–‰', nameEn: 'âœˆï¸ Travel' },
                { id: 'saving', name: 'ğŸ’° ì €ì¶•', nameEn: 'ğŸ’° Saving' },
                { id: 'business', name: 'ğŸ’¼ ì—…ë¬´', nameEn: 'ğŸ’¼ Business' }
            ];
            budgetData.currentLanguage = 'ko';
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.getElementById('lang-ko').onclick = () => switchLanguage('ko');
        document.getElementById('lang-en').onclick = () => switchLanguage('en');

        window.onload = function() {
            loadData();
            // loadData í•¨ìˆ˜ ë‚´ì—ì„œ switchLanguageë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë‹¤ì‹œ í˜¸ì¶œí•  í•„ìš” ì—†ìŒ
        };

        document.getElementById('income-input').addEventListener('input', function(e) {
            budgetData.income = parseFloat(e.target.value) || 0;
            updateUI();
        });

        // ì§€ì¶œ ì¶”ê°€ í•¨ìˆ˜
        function addExpense() {
            const categorySelect = document.getElementById('category-select');
            const nameInput = document.getElementById('expense-name-input');
            const amountInput = document.getElementById('expense-amount-input-main');

            const category = categorySelect.value;
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (category === 'custom') {
                alert(budgetData.currentLanguage === 'ko' ? 'ë¨¼ì € ìƒˆ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.' : 'Please add a new category or select an existing one first.');
                return;
            }
            if (!name) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì§€ì¶œ í•­ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.' : 'Enter expense name.');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert(budgetData.currentLanguage === 'ko' ? 'ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.' : 'Enter a valid amount.');
                return;
            }

            budgetData.expenses.push({
                id: generateUniqueId(),
                name,
                amount,
                category
            });

            nameInput.value = '';
            amountInput.value = '';
            categorySelect.value = budgetData.categories[0]?.id || '';

            updateUI();
        }

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ í•¨ìˆ˜
        function addCategory() {
            const newCategoryInput = document.getElementById('new-category-input');
            const name = newCategoryInput.value.trim();
            if (!name) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.' : 'Enter category name.');
                return;
            }

            const existingCategory = budgetData.categories.find(
                cat => cat.name.toLowerCase() === name.toLowerCase() || cat.nameEn?.toLowerCase() === name.toLowerCase()
            );
            if (existingCategory) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.' : 'Category already exists.');
                return;
            }

            const id = generateUniqueId();
            const catObj = { id, name: name, nameEn: name }; // ì´ˆê¸°ì—ëŠ” ì˜ì–´ ì´ë¦„ë„ í•œê¸€ ì´ë¦„ìœ¼ë¡œ ì„¤ì •
            budgetData.categories.push(catObj);
            newCategoryInput.value = '';
            populateCategorySelect();
            document.getElementById('category-input-container').classList.add('hidden');
            document.getElementById('category-select').value = id;
            updateUI();
        }

        // ì„¸ê¸ˆ/ê³µì œ í•­ëª© ì¶”ê°€ í•¨ìˆ˜ (taxes, preTax, postTax)
        function addCategorizedItem(type) {
            let nameInput, amountInput, selectElement;
            let defaultName = ''; // ë¯¸ë¦¬ ì •ì˜ëœ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ í•­ëª©ì˜ ì´ë¦„ì„ ì €ì¥í•  ë³€ìˆ˜

            if (type === 'taxes') {
                selectElement = document.getElementById('tax-type-select');
                nameInput = document.getElementById('tax-custom-name-input');
                amountInput = document.getElementById('tax-amount-input');
                if (selectElement.value !== 'custom') defaultName = selectElement.value;
            } else if (type === 'preTax') {
                selectElement = document.getElementById('pre-tax-type-select');
                nameInput = document.getElementById('pre-tax-custom-name-input');
                amountInput = document.getElementById('pre-tax-amount-input');
                if (selectElement.value !== 'custom') defaultName = selectElement.value;
            } else if (type === 'postTax') {
                selectElement = document.getElementById('post-tax-type-select');
                nameInput = document.getElementById('post-tax-custom-name-input');
                amountInput = document.getElementById('post-tax-amount-input');
                if (selectElement.value !== 'custom') defaultName = selectElement.value;
            } else {
                console.error("Invalid type for addCategorizedItem:", type);
                return;
            }

            const name = defaultName || nameInput.value.trim(); // ë¯¸ë¦¬ ì •ì˜ëœ í•­ëª©ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
            const amount = parseFloat(amountInput.value);

            if (!name) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.' : 'Enter or select a name.');
                return;
            }
            if (isNaN(amount) || amount < 0) {
                alert(budgetData.currentLanguage === 'ko' ? 'ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.' : 'Enter a valid amount.');
                return;
            }

            // ê¸°ì¡´ í•­ëª©ê³¼ ì´ë¦„ì´ ì¤‘ë³µë˜ëŠ”ì§€ í™•ì¸
            const existingItem = budgetData[type].find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existingItem) {
                alert(budgetData.currentLanguage === 'ko' ? 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•­ëª©ì…ë‹ˆë‹¤. ìˆ˜ì •í•˜ë ¤ë©´ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”.' : 'This item already exists. To modify, select it from the list.');
                return;
            }

            budgetData[type].push({
                id: generateUniqueId(),
                name,
                amount,
                type // ì´ ì†ì„±ì€ ë””ë²„ê¹…ì´ë‚˜ íƒ€ì… ì‹ë³„ì— ìœ ìš©í•˜ì§€ë§Œ í•„ìˆ˜ ì•„ë‹˜
            });

            nameInput.value = '';
            amountInput.value = '';
            selectElement.value = ''; // ì„ íƒ ì´ˆê¸°í™”
            document.getElementById(`${type}-custom-container`).classList.add('hidden'); // ì‚¬ìš©ì ì •ì˜ ì…ë ¥ í•„ë“œ ìˆ¨ê¹€

            updateUI();
        }

        document.getElementById('category-select').addEventListener('change', function () {
            const container = document.getElementById('category-input-container');
            if (this.value === 'custom') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        });

        // ì„¸ê¸ˆ/ê³µì œ ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ë™ì‘ (ì‚¬ìš©ì ì •ì˜ í•„ë“œ í‘œì‹œ/ìˆ¨ê¸°ê¸°)
        document.getElementById('tax-type-select').addEventListener('change', function () {
            const customContainer = document.getElementById('tax-custom-container');
            if (this.value === 'custom') {
                customContainer.classList.remove('hidden');
                document.getElementById('tax-amount-input').value = ''; // ê¸ˆì•¡ ì´ˆê¸°í™”
                document.getElementById('tax-custom-name-input').value = ''; // ì´ë¦„ ì´ˆê¸°í™”
            } else if (this.value !== "") { // ë¯¸ë¦¬ ì •ì˜ëœ í•­ëª© ì„ íƒ ì‹œ
                customContainer.classList.add('hidden');
                const selectedDefaultItem = DEFAULT_DEDUCTIONS.taxes.find(item => item.name === this.value);
                if (selectedDefaultItem) {
                    // ì„ íƒëœ ë¯¸ë¦¬ ì •ì˜ëœ í•­ëª©ì˜ ì´ë¦„ê³¼ ê¸ˆì•¡ìœ¼ë¡œ í•„ë“œë¥¼ ìë™ ì±„ìš°ê³  ë°”ë¡œ ì¶”ê°€
                    document.getElementById('tax-custom-name-input').value = selectedDefaultItem.name;
                    document.getElementById('tax-amount-input').value = selectedDefaultItem.amount;
                    addCategorizedItem('taxes'); // ìë™ ì¶”ê°€
                }
            } else { // "ì„¸ê¸ˆ ìœ í˜• ì„ íƒ"ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ
                customContainer.classList.add('hidden');
                document.getElementById('tax-amount-input').value = '';
                document.getElementById('tax-custom-name-input').value = '';
            }
        });
        document.getElementById('pre-tax-type-select').addEventListener('change', function () {
            const customContainer = document.getElementById('pre-tax-custom-container');
            if (this.value === 'custom') {
                customContainer.classList.remove('hidden');
                document.getElementById('pre-tax-amount-input').value = '';
                document.getElementById('pre-tax-custom-name-input').value = '';
            } else if (this.value !== "") {
                customContainer.classList.add('hidden');
                const selectedDefaultItem = DEFAULT_DEDUCTIONS.preTax.find(item => item.name === this.value);
                if (selectedDefaultItem) {
                    document.getElementById('pre-tax-custom-name-input').value = selectedDefaultItem.name;
                    document.getElementById('pre-tax-amount-input').value = selectedDefaultItem.amount;
                    addCategorizedItem('preTax');
                }
            } else {
                customContainer.classList.add('hidden');
                document.getElementById('pre-tax-amount-input').value = '';
                document.getElementById('pre-tax-custom-name-input').value = '';
            }
        });
        document.getElementById('post-tax-type-select').addEventListener('change', function () {
            const customContainer = document.getElementById('post-tax-custom-container');
            if (this.value === 'custom') {
                customContainer.classList.remove('hidden');
                document.getElementById('post-tax-amount-input').value = '';
                document.getElementById('post-tax-custom-name-input').value = '';
            } else if (this.value !== "") {
                customContainer.classList.add('hidden');
                const selectedDefaultItem = DEFAULT_DEDUCTIONS.postTax.find(item => item.name === this.value);
                if (selectedDefaultItem) {
                    document.getElementById('post-tax-custom-name-input').value = selectedDefaultItem.name;
                    document.getElementById('post-tax-amount-input').value = selectedDefaultItem.amount;
                    addCategorizedItem('postTax');
                }
            } else {
                customContainer.classList.add('hidden');
                document.getElementById('post-tax-amount-input').value = '';
                document.getElementById('post-tax-custom-name-input').value = '';
            }
        });
    </script>
</body>
</html>
